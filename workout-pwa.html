<!DOCTYPE html>
<html lang="it">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>WorkoutTracker Web</title>
<title>WorkoutTracker Web</title>
<meta name="description" content="Il tuo tracker di allenamento locale.">

<!-- ‚úÖ PWA Manifest inline -->
<link rel="manifest" id="pwa-manifest">
<script>
const manifestData = {
    "name": "WorkoutTracker",
    "short_name": "Workout",
    "description": "Il tuo tracker di allenamento locale",
    "start_url": "/",
    "scope": "/",
    "id": "/",
    "display": "standalone",
    "display_override": ["standalone", "minimal-ui"],
    "background_color": "#111827",
    "theme_color": "#111827",
    "orientation": "portrait-primary",
    "categories": ["health", "fitness", "lifestyle"],
	"permissions": ["notifications"],
    "icons": [
        {
            "src": "https://rccremonesi-cmyk.github.io/workout/barbell-ico.png",
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "any"
        },
        {
            "src": "https://rccremonesi-cmyk.github.io/workout/barbell-ico.png",
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "maskable"
        },
        {
            "src": "https://rccremonesi-cmyk.github.io/workout/barbell-ico.png",
            "sizes": "144x144",
            "type": "image/png",
            "purpose": "any"
        }
    ],
    "screenshots": [
        {
            "src": "https://rccremonesi-cmyk.github.io/workout/barbell-ico.png",
            "sizes": "540x720",
            "type": "image/png",
            "form_factor": "narrow"
        }
    ],
    "shortcuts": [
        {
            "name": "Inizia Allenamento",
            "short_name": "Workout",
            "description": "Inizia subito un workout",
            "url": "/",
            "icons": [
                {
                    "src": "https://rccremonesi-cmyk.github.io/workout/barbell-ico.png",
                    "sizes": "192x192"
                }
            ]
        }
    ]
};

const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
const manifestURL = URL.createObjectURL(manifestBlob);
document.getElementById('pwa-manifest').setAttribute('href', manifestURL);
</script>

<meta name="theme-color" content="#111827">

<!-- ‚úÖ Apple PWA Meta Tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WorkoutTracker">
<link rel="apple-touch-icon" href="https://rccremonesi-cmyk.github.io/workout/barbell-ico.png">      
<!-- ‚úÖ Meta tag Android -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="WorkoutTracker">


<link rel="icon" type="image/png" href="https://rccremonesi-cmyk.github.io/workout/barbell-ico.png">

<meta name="apple-mobile-web-app-title" content="WorkoutTracker">
<link rel="apple-touch-icon" href="https://rccremonesi-cmyk.github.io/workout/barbell-ico.png">


      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://use.hugeicons.com/font/icons.css">
	  
	  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

      <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="0">

	   <script data-goatcounter="https://redmood.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
      <style>

	 
/* Progress Bar Workout - Stile Classico */
#progress-bar-container {
    background: #1f2937;
    border-radius: 0;
    overflow: hidden;
    border: 1px solid #374151;
	border-radius:3px;
}

#progress-bar-container > div {
    border-radius: 0 !important;
    border: none !important;
    box-shadow: none !important;
}



#progress-bar-container > div.current-segment {
   
    box-shadow: 0 0 12px rgba(192, 132, 252, 0.6) !important;
}



	 
input#editor-archived {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  width: 48px;
  height: 24px;
  background-color: #4b5563;
  border-radius: 24px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  outline: none;
  flex-shrink: 0;
  position:relative;
}

/* Stile quando √® checked */
input#editor-archived:checked {
  background-color: #5127f2; 
}

/* Il pallino del toggle */
input#editor-archived::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background-color: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Movimento del pallino quando √® checked */
input#editor-archived:checked::before {
  transform: translateX(24px);
}

/* Effetto hover */
input#editor-archived:hover {
  opacity: 0.9;
}

/* Focus per accessibilit√† */
input#editor-archived:focus {
  box-shadow: 0 0 0 3px rgba(59, 131, 246, 0.781)
}
	  
	  
	  
	  /* Coriandoli Animation */
/* Coriandoli Animation */
@keyframes confetti-fall {
  0% {
    transform: translateY(-100vh) rotate(0deg);
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg);
    opacity: 0;
  }
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #f0f;
  animation: confetti-fall 3s linear forwards;
  pointer-events: none;
  opacity: 0; /* ‚Üê AGGIUNGI QUESTA RIGA */
}

.emoji-rest-day {
  display: inline-block;
  animation: gentleBounce 2s ease-in-out infinite;
}
/* Progress Accordion Animation */
[id^="progress-content-"] {
    animation: fadeInOnly 0.3s ease-in-out;
}
	  
	  #footer-progress-text{
	 
    color: #c084fc;
	  }
	  
	  #weight-comparison{
		white-space:nowrap;
		color:#c084fc;
		    display: inline-block;
	  }
	  
#add-workout-fab, #add-btn, #badge-notification, #btn-start-workout  {
    animation: gentleBounce 1.8s ease-in-out infinite;
}
.workout-started main#app-container {
    margin-top: 0px !important;
}
@keyframes gentleBounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

#btn-main-action {
    animation: gentleBounce2 1.8s ease-in-out infinite;
}

/* Rating Stars Touch Feedback */
.star-rating-btn {
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

.star-rating-btn:active i {
    transform: scale(1.2);
    filter: brightness(1.5);
}

/* Hover progressivo sulle stelle */
.star-rating-btn:hover ~ .star-rating-btn i {
    color: rgb(55, 65, 81); /* gray-700 pi√π scuro */
}

@keyframes gentleBounce2 {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(5px);
    }
}

/* Variante alternativa pi√π delicata con scale */
@keyframes gentleBounceScale {
    0%, 100% {
        transform: translateY(0) scale(1);
    }
    50% {
        transform: translateY(-6px) scale(1.05);
    }
}	  

header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    transition: top 0.3s ease-in-out;
    z-index: 30;
	background-color: #111827 !important;
}

header.header-hidden {
    top: -100px;
}

#view-active.active ~ #app-container,
body:has(#view-active.active) main#app-container {
    margin-top: 0 !important;
}

main#app-container.no-margin {
    margin-top: 0;
}

	  
	  #view-settings .bg-darkCard .items-center{
	  font-size:14px;
	  }
	  
	  #view-settings input{
	      border: 1px solid #5127f2;
	  }

      #view-settings select{
	      border: 1px solid #5127f2;
	  }	  
	  
	  #view-settings{
	  /* Nascondi il checkbox originale */
input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  position: relative;
  width: 48px;
  height: 24px;
  background-color: #4b5563;
  border-radius: 24px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  outline: none;
}

/* Stile quando √® checked */
input[type="checkbox"]:checked {
  background-color: #5127f2; /* o usa var(--primary) se hai una variabile CSS */
}

/* Il pallino del toggle */
input[type="checkbox"]::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background-color: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Movimento del pallino quando √® checked */
input[type="checkbox"]:checked::before {
  transform: translateX(24px);
}

/* Effetto hover */
input[type="checkbox"]:hover {
  opacity: 0.9;
}

/* Focus per accessibilit√† */
input[type="checkbox"]:focus {
  box-shadow: 0 0 0 3px rgba(59, 131, 246, 0.781)
}
	  }
	  
.shadow-custom{
	  -webkit-box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.10);
    box-shadow: 0px 0px 10px 1px rgba(0, 0, 0, 0.10);
}

/* Workout Color Selection */
.workout-color-btn.selected {
   border-color: white !important;
   box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
   transform: scale(1.1);
}
	  
	  

nav button.text-primary{
color:#c084fc;
}
	  
	  /* Nasconde il checkbox nativo */
.editor-day-check {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

/* Stato base */
#editor-preferred-days label {
  transition: all 0.2s ease;
  user-select: none;
}

/* Hover */
#editor-preferred-days label:hover {
  transform: translateY(-1px);
}

/* Quando √® selezionato */
#editor-preferred-days label:has(.editor-day-check:checked) {
  background-color: #6d5dfc; /* viola app */
  color: #fff;
  box-shadow: 0 6px 16px rgba(109, 93, 252, 0.35);
}

/* Testo quando selezionato */
#editor-preferred-days label:has(.editor-day-check:checked) span {
  font-weight: 600;
}

/* Micro feedback click */
#editor-preferred-days label:active {
  transform: scale(0.96);
}

	  
@keyframes fadeInOnly {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.internal-section {
  animation: fadeInOnly 0.6s ease-in-out forwards;
}
	  
@keyframes beastShake {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  50% {
    opacity: 1;
    transform: scale(1.1);
  }
  70% {
    transform: scale(0.98) rotate(-1deg);
  }
  85% {
    transform: scale(1.02) rotate(1deg);
  }
  100% {
    transform: scale(1) rotate(0);
  }
}

#motivational-text {
  animation: beastShake 0.5s ease-out both;
}




         #exercise-modal input, #exercise-modal textarea{
         border:1px solid #5127f2;
		 background-color:#1f2937;
         }
         #exercise-modal select{
         border:1px solid #5127f2;
		 background-color:#1f2937;
         }
         @keyframes blink-rest {
         0%, 100% { opacity: 1; }
         50% { opacity: 0.2; }
         }
         .rest-blink {
         animation: blink-rest 0.6s ease-in-out infinite;
         }
         /* Layout mobile-first responsive */
         @media (min-width: 768px) {
			 .fixed.bottom-0.left-0.right-0.bg-gray-800.pb-safe.z-40{
				     max-width: 480px;
    left: 0 !important;
    right: 0 !important;
    margin: 0 auto !important;
			 }
         nav, main, header, section.view-section {
			 width:100%;
         max-width: 480px;
         margin: 0 auto;
         box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
         }
         }
         /* ... (mantieni il tuo stile CSS esistente qui) ... */
         /* Assicurati solo di non aver cancellato i tuoi stili custom */
         body { font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto; }
         .hide-scrollbar::-webkit-scrollbar { display: none; }
         .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
         .view-section { display: none !important; opacity: 0; transition: opacity 0.2s ease-in-out; }
         .view-section.active { display: block !important; opacity: 1; }
         #view-active.active { display: flex !important; }
         .timer-circle { 
         stroke: #5127F2; /* Forzatura colore se necessario */
         transition: stroke-dashoffset 1s linear; 
         transform: rotate(-90deg); 
         transform-origin: 50% 50%; 
         }
         .sortable-ghost { opacity: 0.4; background-color: #ede9fe; border: 2px dashed #5127F2; } /* Aggiornato colore ghost */
         .sortable-drag { cursor: grabbing; }
         .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
         .footer-action{ position: fixed; bottom: 0px; width: 100%; }
         /* Scrollbar personalizzata per workout preview */
         #workout-preview-content::-webkit-scrollbar {
         width: 8px;
         }
         #workout-preview-content::-webkit-scrollbar-track {
         background: #111827;
         }
         #workout-preview-content::-webkit-scrollbar-thumb {
         background: #5127F2;
         border-radius: 4px;
         }
         #workout-preview-content::-webkit-scrollbar-thumb:hover {
         background: #401eb5;
         }
         /* Per Firefox */
         #workout-preview-content {
         scrollbar-width: thin;
         scrollbar-color: #5127F2 #111827;
         }
         .workout-active-bg {
         background: #111827;
         position: relative;
         overflow: hidden;
         }
         .workout-active-bg::before {
         content: '';
         position: absolute;
         top: -50%;
         left: -50%;
         width: 200%;
         height: 200%;
         background: radial-gradient(circle, #5127F2 0%, transparent 70%);
         animation: energy-pulse 3s ease-in-out infinite;
         pointer-events: none;
         }
         .workout-active-bg::after {
         content: '';
         position: absolute;
         bottom: -50%;
         right: -50%;
         width: 200%;
         height: 200%;
         background: radial-gradient(circle, #7c3aed 0%, transparent 70%);
         animation: energy-pulse-2 4s ease-in-out infinite;
         pointer-events: none;
         }
         /* Toggle Switch */
         .sr-only {
         position: absolute;
         width: 1px;
         height: 1px;
         padding: 0;
         margin: -1px;
         overflow: hidden;
         clip: rect(0, 0, 0, 0);
         white-space: nowrap;
         border-width: 0;
         }
         .workout-rest-bg {
         background: #111827;
         transition: background 0.5s ease;
         position: relative;
         }
         /* Rimuovi gli pseudo-elementi durante il riposo */
         .workout-rest-bg::before,
         .workout-rest-bg::after {
         display: none;
         }
		 
		 /* Badge Animations */
@keyframes badgeSlideIn {
  0% {
    opacity: 0;
    transform: translateY(-30px) scale(0.9);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes badgeGlow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(81, 39, 242, 0.3);
  }
  50% {
    box-shadow: 0 0 40px rgba(81, 39, 242, 0.6);
  }
}

.badge-appear {
  animation: badgeSlideIn 0.5s ease-out, badgeGlow 2s ease-in-out infinite;
}

.badge-icon-locked {
  filter: grayscale(100%) opacity(0.3);
}

/* Stats Tabs */
.stats-tab {
   color: #9ca3af;
}

.stats-tab.active {
   background: linear-gradient(135deg, #5127F2, #7c3aed);
   color: white;
   box-shadow: 0 4px 12px rgba(81, 39, 242, 0.3);
}

      </style>
      <script>
         tailwind.config = {
             
             theme: {
                 extend: {
                     colors: {
                         // NEW COLOR: rgb(81 39 242) -> Hex #5127F2
                         primary: '#5127F2', 
                         primaryDark: '#401eb5', // Versione pi√π scura per hover
                         darkBg: '#111827',
                         darkCard: '#1f2937'
                     }
                 }
             }
         }
      </script>
   </head>
   <body class="bg-darkBg text-gray-100 h-screen flex flex-col overflow-hidden">
      <!-- HEADER -->
<header class="bg-darkCard shadow-sm z-20 px-4 py-3 grid grid-cols-3 items-center" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
   <!-- Sinistra (vuoto o future azioni) -->
   <div></div>
   <!-- Centro: LOGO con Icona -->
   <div class="flex items-center justify-center gap-2">
      <img src="https://rccremonesi-cmyk.github.io/workout/barbell-ico.png" 
           alt="WorkoutTracker" 
           class="w-8 h-8"
           style="border-radius: 33%; box-shadow: 0 2px 8px rgba(81, 39, 242, 0.3);">
      <h1 class="font-bold text-lg tracking-tight">WorkoutTracker</h1>
   </div>
   <!-- Destra -->
   <div class="flex justify-end">
   </div>
</header>
      <!-- MAIN CONTENT AREA -->
      <main id="app-container" class="flex-1 overflow-y-auto overflow-x-hidden relative hide-scrollbar" style="padding-bottom: 8.5rem;">
	  
	  
         <!-- VIEW: DASHBOARD (HOME) -->
         <section id="view-dashboard" class="view-section active p-4 " style="padding-bottom:100px;">
		  <button onclick="app.handlers.createNewWorkout()" id="add-workout-fab" 
   class="fixed bottom-[calc(5rem+env(safe-area-inset-bottom))] right-4 
   bg-primary text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 z-50" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
<i class="fa-solid fa-plus"></i> Crea Workout
</button>
		 <div class="internal-section">
		 
		 
		 
		 
		 
		 <div id="badge-notification" class="hidden" style="margin-bottom:15px;">
      <!-- Badge injected here -->
   </div>
   
            <!-- Quick Stats Card -->
<!-- Quick Stats Card -->
<div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden" style="margin-top:0px;">
   <!-- Decorative Background Elements -->
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
   
   <!-- Header -->
   <div class="relative z-10 flex items-center justify-between mb-5">
      <div>
         <h2 class="opacity-90 uppercase tracking-wider font-semibold flex items-center gap-2">
            <i id="stats-period-icon" class="fa-solid fa-calendar-week"></i>
            <span id="stats-period-title">Questa<br/>Settimana</span>
         </h2>
         <p class="text-sm opacity-75 mt-1" id="current-period-name">1-5 Gen 2026</p>
      </div>
      
      <!-- Toggle Switch -->
      <button onclick="app.handlers.toggleStatsPeriod()" class="bg-white/20 backdrop-blur-sm rounded-full p-2 hover:bg-white/30 transition-all active:scale-95">
         <div class="flex items-center gap-2 px-2">
            <i class="fa-solid fa-calendar-week text-sm" id="toggle-week-icon"></i>
            <div class="w-8 h-4 bg-white/30 rounded-full relative">
               <div id="stats-toggle-dot" class="absolute w-3 h-3 bg-white rounded-full top-0.5 left-0.5 transition-transform duration-200"></div>
            </div>
            <i class="fa-solid fa-calendar-days text-sm opacity-50" id="toggle-month-icon"></i>
         </div>
      </button>
   </div>
   
   <!-- Stats Grid -->
   <div class="relative z-10 grid grid-cols-2 gap-4">
      <!-- Allenamenti -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-custom">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-dumbbell text-lg"></i>
            </div>
            <span class="opacity-80" style="font-size: 14px; font-weight:500;">Workout<br/>eseguiti</span>
         </div>
         <span id="period-workouts-count" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Volume -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-custom">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-weight-hanging text-lg"></i>
            </div>
            <span class="opacity-80" style="font-size: 14px; font-weight:500;">kg <br/>Sollevati</span>
         </div>
         <span id="period-volume" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Calorie -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-custom">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-fire text-lg"></i>
            </div>
            <span class="opacity-80" style="font-size: 14px; font-weight:500;">kcal <br/>Bruciate</span>
         </div>
         <span id="period-calories" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Grasso -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 shadow-custom">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-droplet text-lg"></i>
            </div>
            <span class="opacity-80" style="font-size: 14px; font-weight:500;">gr di <br/>Grasso</span>
         </div>
         <span id="period-fat-burned" class="text-3xl font-bold block">0</span>
      </div>
   </div>
</div>

            <!-- Workouts List -->

            <!-- Workouts List -->
            <div>
               <div class="flex justify-between items-center mb-4">
                 
                
               </div>
               <div id="workout-list" class="space-y-3">
                  <!-- Dynamic Workout Cards injected here -->
                  <div class="text-center text-gray-400 py-8">Caricamento...</div>
               </div>
            </div>
			</div>
         </section>
		 
		 
		 
         <!-- VIEW: WORKOUT EDITOR --> 
         <section id="view-editor" class="view-section p-4 bg-darkBg bg-darkBg min-h-full inset-0 z-30 overflow-y-auto no-scrollbar fixed">
		 <div class="internal-section">
<div class="sticky bg-darkBg pt-4 pb-4 space-y-3 z-40" style="top: -17px;">
   <!-- Prima riga: Back + Name + Delete -->
   <div class="flex items-center gap-3">
      <!-- Back Button -->
      <button onclick="app.router.go('dashboard')" class="p-0 text-gray-400 hover:text-white hover:bg-gray-800 rounded-xl transition-all active:scale-95">
         <i class="fa-solid fa-arrow-left text-xl"></i>
      </button>
      
      <!-- Workout Name Input -->
      <input type="text" id="editor-name" 
         class="flex-1 font-bold bg-gray-800 border-2 border-primary/50 focus:border-primary rounded-xl px-4 py-3 placeholder-gray-500 focus:ring-0 focus:outline-none transition-all" 
         placeholder="Nome Workout (es. Leg Day)">
      
      <!-- Delete Button (hidden by default) -->
      <button onclick="app.handlers.deleteWorkout()" id="btn-delete-workout" 
         class="hidden bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-3 rounded-xl font-semibold transition-all active:scale-95 border border-red-500/30 flex items-center gap-2">
         <i class="fa-solid fa-trash"></i>
         <span class="hidden sm:inline">Elimina</span>
      </button>
   </div>
   
   <!-- Seconda riga: Icona + Colore -->
   <div class="flex items-center gap-2">
     
	  
<button onclick="app.handlers.openIconPicker()" 
   class="bg-gray-800 border-2 border-gray-700 hover:border-primary rounded-xl p-2 transition-all active:scale-95 flex items-center gap-2 group">
   <i id="editor-icon-preview" class="hgi hgi-stroke hgi-dumbbell-01 text-2xl text-white"></i>
   <i class="hgi hgi-stroke hgi-arrow-down-01 text-sm text-gray-500 group-hover:text-primary"></i>
</button>
      
      <!-- Colore Selezionato -->
<div class="flex gap-1 flex-1 overflow-x-auto hide-scrollbar">
    <button onclick="app.handlers.selectColor('#5127f2')" data-color="#5127f2" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #5127f2;">
    </button>
    
    <button onclick="app.handlers.selectColor('#a855f7')" data-color="#a855f7" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #a855f7;">
    </button>
    
    <button onclick="app.handlers.selectColor('#db2777')" data-color="#db2777" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #db2777;">
    </button>
    
    <button onclick="app.handlers.selectColor('#ea580c')" data-color="#ea580c" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #ea580c;">
    </button>
    
    <button onclick="app.handlers.selectColor('#ca8a04')" data-color="#ca8a04" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #ca8a04;">
    </button>
    
    <button onclick="app.handlers.selectColor('#16a34a')" data-color="#16a34a" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #16a34a;">
    </button>
    
    <button onclick="app.handlers.selectColor('#0891b2')" data-color="#0891b2" 
        class="workout-color-btn w-10 h-10 rounded-lg border-2 m-1 border-transparent transition-all active:scale-95" 
        style="background: #0891b2;">
    </button>
    

</div>


   </div>
   
   
</div>
			
			   <div class="mb-4 bg-gray-800 p-4 rounded-xl">
      <label class="text-sm font-semibold mb-3 block flex items-center gap-2">
         <i class="fa-regular fa-calendar-check"></i> Giorni preferiti (opzionale)
      </label>
      <div id="editor-preferred-days" class="grid grid-cols-7 gap-2">
         <!-- Injected by JS -->
      </div>
   </div>
   
<!-- Toggle Archiviazione -->
<div class="mb-4 bg-gray-800 p-4 rounded-xl toggle-class">
   <div class="flex items-center justify-between gap-4">
      <div class="flex-1">
         <label class="text-sm font-semibold flex items-center gap-2 mb-2">
            <i class="fa-solid fa-box-archive"></i> Archivia Workout
         </label>
         <p class="text-xs text-gray-400 leading-relaxed">
            I workout archiviati rimangono salvati ma vengono nascosti dalla lista principale. 
            Le statistiche e lo storico restano intatti.
         </p>
      </div>
      <input type="checkbox" id="editor-archived" class="editor-toggle-switch">
   </div>
</div>
			
            <div id="editor-exercises-list" class="space-y-4 mb-20" style="padding-bottom:100px;">
               <!-- Exercises injected here via SortableJS -->
            </div>
            <!-- Floating Action Button for Add Exercise -->
			<div class="fixed bottom-0 w-full h-[20px] right-0 z-10" style="box-shadow: rgb(17, 24, 39) 0px 0px 50px 64px; background-color: #111827;">&nbsp;</div>
			
            <div class="fixed bottom-6 right-6 z-40">
               <button onclick="app.handlers.addExerciseToEditor()" id="add-btn" class="bg-primary text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
               <i class="fa-solid fa-plus"></i> Agg. esercizio
               </button>
            </div>
            <div class="fixed bottom-6 left-6 z-40">
               <button onclick="app.handlers.saveWorkout()" class="bg-white text-black px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2">
               <i class="fa-solid fa-save"></i> Salva
               </button>
            </div>
           
			</div>
         </section>
         <!-- VIEW: ACTIVE WORKOUT MODE -->
         <section id="view-active" class="view-section bg-gray-900 text-white ">
		 <div class="internal-section h-screen absolute inset-0 z-50 flex flex-col overflow-hidden">
            <!-- Active Header -->
            <div class="px-4 py-4 flex items-center border-b border-gray-700">
               <!-- Sinistra -->
               <button onclick="app.handlers.confirmExitWorkout()" class="text-gray-400 px-2">
               <i class="fa-solid fa-xmark text-2xl"></i>
               </button>
               <!-- Centro -->
             <div
  class="flex-1 flex justify-center min-w-0 px-3"
  onclick="app.handlers.showWorkoutPreview()"
>
  <div class="flex items-center gap-3 min-w-0">
    <i class="fa-solid fa-list-check text-xl text-gray-400 shrink-0"></i>

    <div class="text-left min-w-0">
      <h3
        id="active-workout-name"
        class="font-bold text-xs text-gray-300 truncate"
      >
        A ‚Äì Upper Push (Petto alto &amp; Spalle)
      </h3>

      <div class="flex items-center gap-2 text-xs whitespace-nowrap truncate">
        <span>
          <i class="fa-regular fa-clock" style="font-size: 10px; color:#b9a9f6; margin-right:5px;"></i>
          <span id="active-timer-total" class="font-mono" style="color:#b9a9f6;">00:10</span>
        </span>
        <span class="text-gray-500">‚Ä¢</span>
        <span id="active-exercise-count" class="text-gray-400">1/5 es.</span>
      </div>
    </div>
  </div>
</div>

               <!-- Destra -->
               <button onclick="app.handlers.toggleSound()" id="sound-toggle" class="text-gray-400 px-2">
               <i class="fa-solid fa-volume-high"></i>
               </button>
            </div>
            <!-- Progress Bar -->
            <!-- Progress Bar with Exercise Navigation -->
            <div class="bg-gray-800 w-full">
               <div class="px-4 py-2 flex items-center justify-between text-xs" style="font-weight: 700;">
                  <div id="prev-exercise" class="text-gray-500 flex-1 text-left truncate">
                     <i class="fa-solid fa-check text-green-500 mr-1"></i>
                     <span>-</span>
                  </div>
                  <div class="text-gray-400 px-2"><i class="fa-solid fa-caret-right"></i></div>
                  <div id="next-exercise" class="text-gray-400 flex-1 text-right truncate">
                     <span>-</span>
                     <i class="fa-solid fa-arrow-right ml-1"></i>
                  </div>
               </div>
               <div class="h-1 bg-gray-800 w-full">
                  <div id="active-progress-bar" class=" relative h-full bg-primary transition-all duration-300 relative" style="width: 0%">

				  </div>
               </div>
            </div>
            <!-- Main Exercise Area -->
            <div class="flex-1 overflow-y-auto p-5 hide-scrollbar" style="padding-bottom: 300px;">
               <!-- Current Exercise Info -->
               <div class="text-center w-full animate-fade-in">
                  <h2 id="active-exercise-name" class="text-2xl font-bold mb-3 break-words">Nome Esercizio</h2>
                  <div class="flex justify-center gap-2 text-gray-400 text-sm mb-4">
                     <span id="active-set-display" class="bg-primary px-3 py-1 rounded-full border border-gray-700" style="color:#FFF;">Serie 1/4</span>
                     <span id="active-target-display" class="bg-gray-800 px-3 py-1 rounded-full border border-gray-700" style="color:#FFF; background-color: #425267;">10 Reps</span>
                  </div>
                  <!-- Weight Control -->
                  <!-- Weight Control -->
                  <div class="flex items-center justify-center gap-3 my-4">
                     <!-- Pulsanti -5 e -1 -->
                   <div class="flex flex-col gap-1">
					  <button onclick="app.handlers.adjustWeight(-0.5)" style="width: 5.5rem; margin-bottom:7px;" class="h-8 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">-0.5 kg</button>
					  <button onclick="app.handlers.adjustWeight(-1)" style="width: 5.5rem; margin-bottom:7px;" class="h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">-1 kg</button>
					  <button onclick="app.handlers.adjustWeight(-5)" style="width: 5.5rem;" class="h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">-5 kg</button>
				   </div>
                     <!-- Display Peso -->
                    <!-- Display Peso -->
<div class="text-center px-2" style="min-width: 125px;">
   <span id="active-weight-value" class="text-5xl font-bold font-mono text-white">0</span>
   <span class="text-l font-bold text-gray-500 block uppercase">kg</span>
   
    <!-- Reset Weight Button -->
   <button 
      onclick="app.handlers.resetWeight()" 
      id="btn-reset-weight"
      class="hidden  mt-3 bg-purple-500/20 text-white-400 hover:bg-purple-800 hover:text-white px-3 py-1.5 rounded-lg text-xs font-semibold transition-all active:scale-95 border border-purple-500/30 flex items-center gap-1 mx-auto w-full justify-center"
   >
      <i class="fa-solid fa-rotate-left"></i>
      Reset Kg
   </button>
   
   <div id="weight-comparison" class="text-xs mt-2 text-gray-400"></div>
   
  
</div>
                     <!-- Pulsanti +1 e +5 -->
                        <div class="flex flex-col gap-1">
      <button onclick="app.handlers.adjustWeight(0.5)" style="width: 5.5rem; margin-bottom:7px;" class="h-8 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">+0.5 kg</button>
      <button onclick="app.handlers.adjustWeight(1)" style="width: 5.5rem; margin-bottom:7px;" class="h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">+1 kg</button>
      <button onclick="app.handlers.adjustWeight(5)" style="width: 5.5rem;" class="h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">+5 kg</button>
   </div>
                  </div>
               </div>
               <!-- Timer / Rest Overlay -->
               <div id="rest-overlay" class="hidden flex-col items-center justify-center w-full py-0">
                  <div class="relative w-40 h-40">
                     <svg class="w-full h-full transform -rotate-90">
                        <circle cx="80" cy="80" r="72" stroke="currentColor" stroke-width="6" fill="transparent" class="text-gray-800" />
                        <circle id="rest-timer-circle" cx="80" cy="80" r="72" stroke="currentColor" stroke-width="6" fill="transparent" class="text-primary timer-circle" stroke-dasharray="452" stroke-dashoffset="0" />
                     </svg>
                     <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-gray-400 text-xs uppercase tracking-widest">Pausa</span>
                        <span id="rest-timer-text" class="text-3xl font-mono font-bold">00:00</span>
                        <div class="flex flex-col items-center gap-2">
                           <label for="auto-next-toggle" class="text-sm text-gray-300">
                           Auto-continua
                           </label>
                           <div class="relative">
                              <input type="checkbox" id="auto-next-toggle" class="sr-only peer">
                              <div
                                 class="w-11 h-6 bg-gray-700 rounded-full peer-checked:bg-primary transition-colors cursor-pointer"
                                 onclick="document.getElementById('auto-next-toggle').click()"
                                 ></div>
                              <div
                                 class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 pointer-events-none"
                                 ></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- AGGIUNGI QUESTO NUOVO BLOCCO -->
              <div id="work-overlay" class="flex-col items-center justify-center w-full ">
   <div class="w-full px-6 ">
      <!-- Icon & Status -->
      <div class="text-center mb-4">
         
         
		 <!-- Motivational Text -->
    <div class="frasi-motivazionali w-full text-center mb-4">
   <span id="motivational-text" class="w-full font-bold text-white inline-block px-4 py-2 bg-gray-800/50 rounded-xl border border-gray-700/50">
      Dai il massimo! üí™
   </span>
</div>
      </div>
      
      <!-- Timer Card -->
      <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700/50 mb-4">
         <div class="flex items-center justify-center gap-2">
            <i class="fa-regular fa-clock text-purple-400"></i>
            <span class="text-sm text-gray-400">Serie iniziata da:</span>
            <span id="exercise-timer" class="text-xl font-bold font-mono text-purple-300">00:00</span>
         </div>
      </div>
      
     
      
      <!-- Notes Section -->
      <div id="exercise-notes-container" class="hidden">
         <button onclick="app.handlers.toggleNotes()" 
            class="w-full bg-gray-800/50 rounded-2xl p-2 border text-gray-400 border-gray-700/50 mb-4" style="font-size:14px;">
            <i class="fa-regular fa-note-sticky text-purple-400 mr-2"></i>
            <span>Note salvate</span>
            <i id="notes-chevron" class="fa-solid fa-chevron-down text-xs ml-auto"></i>
         </button>
         <div id="exercise-notes-content" class="hidden bg-gray-800/50 border border-gray-700/50 rounded-xl p-4 text-left text-sm text-gray-300">
            <!-- Note inserite qui dinamicamente -->
         </div>
      </div>
	  
	   
   </div>
</div>
            </div>
            <!-- Controls Footer -->
            <!-- Controls Footer -->
            <div class="fixed bottom-0 left-0 right-0 bg-gray-800 pb-safe z-40" style="box-shadow: rgb(17, 24, 39) 0px 0px 50px 64px;">
           
<!-- NUOVA BARRA DI PROGRESSO COMPATTA -->
<!-- NUOVA BARRA DI PROGRESSO COMPATTA -->
<div class="px-4 pt-2 pb-3">
   <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
      <span id="footer-progress-text">Serie 1/12</span>
      <span id="footer-time-remaining">~15 min rimanenti</span>
   </div>
   
   <!-- Container barra segmentata -->
   <div id="progress-bar-container" class="flex h-3 items-stretch">
      <!-- Segmenti iniettati da JS -->
   </div>
</div>

               <div class="px-6 pb-6 rounded-t-3xl">
                  <button id="btn-main-action" onclick="app.handlers.completeSet()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold text-xl py-4 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center gap-3">
                  <i class="fa-solid fa-check"></i> <span>Serie Completata</span>
                  </button>
                  <div class="flex justify-between mt-4 px-2">
                     <button onclick="app.handlers.skipExercise()" class="text-gray-400 text-sm hover:text-white">Salta Esercizio</button>
                     <button onclick="app.handlers.finishWorkoutEarly()" class="text-red-400 text-sm hover:text-red-300">Termina Workout</button>
                  </div>
               </div>
            </div>
			</div>
         </section>
         <!-- VIEW: STATISTICS -->
         <section id="view-stats" class="view-section p-4 ">
           <div class="internal-section ">
		   
		   <!-- Tabs Navigation -->
<!-- Tabs Navigation -->
<div class="flex gap-2 mb-6 bg-darkCard rounded-xl p-1">
   <button onclick="app.handlers.switchStatsTab('history')" 
      class="stats-tab flex-1 px-3 py-3 rounded-lg font-semibold transition-all text-sm" 
      data-tab="history">
      <i class="fa-solid fa-clock-rotate-left mr-1"></i>
      Storico
   </button>
   <button onclick="app.handlers.switchStatsTab('progress')" 
      class="stats-tab flex-1 px-3 py-3 rounded-lg font-semibold transition-all text-sm" 
      data-tab="progress">
      <i class="fa-solid fa-chart-line mr-1"></i>
      Carichi
   </button>
   <button onclick="app.handlers.switchStatsTab('statistics')" 
      class="stats-tab flex-1 px-3 py-3 rounded-lg font-semibold transition-all text-sm" 
      data-tab="statistics">
      <i class="fa-solid fa-chart-simple mr-1"></i>
      Stats
   </button>
</div>



<!-- Tab Content: Progress -->
<div id="stats-tab-progress" class="stats-tab-content space-y-6 hidden">
<div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark mb-4 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>

   <div class="text-center">
      <h3 class="text-lg font-bold">
         <i class="fa-solid fa-chart-line text-5xl mb-3 opacity-90"></i><br>
         Carichi
      </h3>

      <p class="text-sm opacity-90 mt-2">
         In questa sezione puoi visualizzare i tuoi progressi per ogni esercizio,
         in base alle variazioni di peso registrate nel tempo.
      </p>
   </div>
</div>


   <div id="progress-workouts-container">
      <!-- Injected by JS -->
   </div>
</div>
<!-- Tab Content: Statistics -->
<div id="stats-tab-statistics" class="stats-tab-content space-y-6">
   <!-- Summary Card Calorie e Grasso -->
          <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark mb-4 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>

   <div class="text-center">
      <h3 class="text-lg font-bold">
         <i class="fa-solid fa-chart-simple text-5xl mb-3 opacity-90"></i><br>
         Statistiche
      </h3>

      <p class="text-sm opacity-90 mt-2">
         Analizza i tuoi dati tramite grafici dettagliati: volume settimanale,
         calorie bruciate e numero di allenamenti nel tempo.
      </p>
   </div>
</div>


            <!-- Charts Container -->
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Volume Settimanale (Kg)</h3>
               <canvas id="chart-volume" height="200"></canvas>
            </div>
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Calorie Bruciate (kcal)</h3>
               <canvas id="chart-calories" height="200"></canvas>
            </div>
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Allenamenti Mensili</h3>
               <canvas id="chart-consistency" height="200"></canvas>
            </div>
			
			<div class="bg-darkCard rounded-3xl p-6 shadow-sm ">
   <div class="flex items-start gap-3 mb-3">
      
      <div class="flex-1">
         <h3 class="font-bold  mb-1"><i class="fa-solid fa-ban mr-2"></i> Cancella le tue Statistiche</h3>
         <p class="text-sm text-gray-400">
            Elimina tutto lo storico dei tuoi allenamenti, traguardi e le statistiche. <strong>I workout salvati rimarranno intatti</strong>.
         </p>
        
      </div>
   </div>
   <button onclick="app.handlers.resetStatistics()" class="w-full border border-red-500 text-red-500 py-2 rounded-lg text-sm font-semibold hover:bg-red-500/10 transition">
      <i class="fa-solid fa-chart-line-up-down"></i> Cancella solo statistiche
   </button>
</div>
			
</div>

<!-- Tab Content: History -->
<div id="stats-tab-history" class="stats-tab-content space-y-6 hidden">
               <!-- History Log -->
            <div>
              
			  <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden mb-7">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
               <h3 class="text-sm opacity-90 uppercase tracking-wider font-semibold mb-4"><i class="fa-solid fa-clock-rotate-left mr-1"></i> Totale Storico</h3>
               <div class="grid grid-cols-2 gap-4">
                  <div>
                     <span id="total-calories" class="text-3xl font-bold block">0</span>
                     <span class="text-sm opacity-80"><i class="fa-solid fa-fire"></i> kcal Bruciate</span>
                  </div>
                  <div class="text-right">
                     <span id="total-fat-burned" class="text-3xl font-bold block">0</span>
                     <span class="text-sm opacity-80"><i class="fa-solid fa-weight-scale"></i> g di Grasso</span>
                  </div>
               </div>
               <div class="mt-3 pt-3 border-t border-white/20 text-xs opacity-75">
                  ~7.500 kcal = 1 kg di grasso corporeo
               </div>
            </div>
			
			<!-- ‚úÖ LEGENDA PALLINI (NUOVO) -->
			
		<div class="bg-darkCard rounded-2xl p-4 shadow-sm mb-6 border border-gray-700/50" style="display: ${localStorage.getItem('hideLegend') === 'true' ? 'none' : 'block'}">
				<div class="flex items-start gap-3 mb-3">
			
			  <div class="flex-1">
				 
				 <div class="space-y-2 text-xs">
					<!-- Pallino Verde -->
					<div class="flex items-center gap-2">
					   <span class="text-sm">üü¢</span>
					   <span class="text-gray-300">
						  <strong class="text-white">Workout Valido</strong> - Completato correttamente, traguardi assegnati
					   </span>
					</div>
					
					<!-- Pallino Rosso -->
					<div class="flex items-center gap-2">
					   <span class="text-sm">üî¥</span>
					   <span class="text-gray-300">
						  <strong class="text-red-400">Workout Sospetto</strong> - Completato troppo velocemente, traguardi non assegnati
					   </span>
					</div>
				 </div>
			  </div>
			  
			  <!-- Pulsante Chiudi (opzionale) -->
			  <button onclick="this.closest('.bg-darkCard').remove(); localStorage.setItem('hideLegend', 'true')" 
				 class="text-gray-500 hover:text-white transition-colors" 
				 title="Nascondi legenda">
				 <i class="fa-solid fa-xmark"></i>
			  </button>
		   </div>
			  
		</div>

               <div id="history-list" class="space-y-3 text-sm">
                  <!-- Logs injected here -->
               </div>
            </div>
</div>
			
			
			
			



            

			
			
			</div>
         </section>
		 
		 <!-- VIEW: BADGES -->
<section id="view-badges" class="view-section p-4 space-y-6 pb-20">
  <div class="internal-section">
   
   <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden mb-7">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
      <div class="text-center">
         <i class="fa-solid fa-trophy text-5xl mb-3 opacity-90"></i>
         <h3 class="text-lg font-bold">Sblocca i tuoi traguardi!</h3>
         <p class="text-sm opacity-90 mt-2">
            Completa allenamenti e raggiungi obiettivi per sbloccare badge esclusivi
         </p>
      </div>
   </div>
   
   <div id="badges-list" class="space-y-4">
      <!-- Injected by JS -->
   </div>
   </div>
</section>
		 
         <!-- VIEW: SETTINGS -->
         <section id="view-settings" class="view-section p-4 ">
		 <div class="internal-section space-y-6">
            <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark  mb-4 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
      <div class="text-center">
         
         <h3 class="text-lg font-bold"><i class="fa-solid fa-gear text-5xl mb-3 opacity-90"></i><br/> Impostazioni</h3>
         <p class="text-sm opacity-90 mt-2">
            <i class="fa-regular fa-envelope"></i>Inserisci i tuoi dati e preferenze per visualizzare statistiche accurate. </a>
         </p>
      </div>
   </div>
            <div class="bg-darkBg bg-darkCard rounded-xl overflow-hidden shadow-sm">
               <div class="bg-darkBg bg-darkCard rounded-xl overflow-hidden shadow-sm">
                  <h3 class="font-bold p-4 border-b border-gray-100 border-gray-700">Dati Personali
				  <p style="margin:0px; font-weight:normal;"><small>Inserisci qui i tuoi dati per ottimizzare i calcoli e statistiche</small></p>
				  </h3>
				   
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Peso corporeo (kg)</span>
                     <input type="number" id="setting-body-weight" step="0.1" class="bg-gray-100 bg-gray-800 rounded-lg px-3 py-1 w-20 text-right" placeholder="70">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Altezza (cm)</span>
                     <input type="number" id="setting-height" class="bg-gray-100 bg-gray-800 rounded-lg px-3 py-1 w-20 text-right" placeholder="175">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Et√† (anni)</span>
                     <input type="number" id="setting-age" class="bg-gray-100 bg-gray-800 rounded-lg px-3 py-1 w-20 text-right" placeholder="30">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Sesso</span>
                     <select id="setting-gender" class="bg-gray-100 bg-gray-800 rounded-lg px-3 py-1">
                        <option value="">Non specificato</option>
                        <option value="male">Maschio</option>
                        <option value="female">Femmina</option>
                     </select>
                  </div>
                  <!-- Aggiungi dopo il campo sesso nelle impostazioni -->
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Livello di Allenamento</span>
                     <select id="setting-training-level" class="bg-gray-100 bg-gray-800 rounded-lg px-3 py-1">
                        <option value="beginner">Principiante</option>
                        <option value="intermediate" selected>Intermedio</option>
                        <option value="advanced">Avanzato</option>
                        <option value="elite">Elite</option>
                     </select>
                  </div>
               </div>
               <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center" style="display:none;">
                  <span>Unit√† di peso</span>
                  <select id="setting-unit" class="bg-gray-100 bg-gray-800 rounded-lg px-2 py-1">
                     <option value="kg">KG</option>
                     <option value="lb">LB</option>
                  </select>
               </div>
               <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                  <span>Suoni Timer</span>
                  <input type="checkbox" id="setting-sound" checked class="accent-primary w-5 h-5">
               </div>
              <div class="p-4 flex justify-between items-center">
    <span>Vibrazione</span>
    <input type="checkbox" id="setting-vibrate" checked class="accent-primary w-5 h-5">
</div>

<!-- üî• NUOVO: Richiesta permessi notifiche -->
<div class="p-4 border-t border-gray-700">
    <button onclick="app.handlers.requestNotificationPermission()" 
        id="notification-permission-btn"
        class="w-full bg-gradient-to-r from-primary to-purple-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hover:from-primaryDark hover:to-purple-700 transition-all active:scale-95">
        <i class="fa-solid fa-bell"></i>
        <span id="notification-btn-text">Abilita Notifiche</span>
    </button>
    <p class="text-xs text-gray-400 mt-2 text-center">Ricevi avvisi quando il timer termina (anche in background)</p>
</div>

<!-- ‚úÖ PULSANTE INSTALLA PWA -->
<div id="pwa-install-section" class="p-4 border-t border-gray-700 hidden">
    <button onclick="app.handlers.installPWA()" class="w-full bg-gradient-to-r from-primary to-purple-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 hover:from-primaryDark hover:to-purple-700 transition-all active:scale-95">
        <i class="fa-solid fa-download"></i>
        Installa App sul Dispositivo
    </button>
    <p class="text-xs text-gray-400 mt-2 text-center">Usa WorkoutTracker come app nativa</p>
</div>

			   <div class="p-4 border-t border-gray-100 border-gray-700 flex justify-between items-center">
   <span>Frasi Motivazionali</span>
   <input type="checkbox" id="setting-motivational" checked class="accent-primary w-5 h-5">
</div>
            </div>
            <div class="bg-darkBg bg-darkCard rounded-xl p-4 shadow-sm space-y-4">
               <h3 class="font-bold"><i class="fa-regular fa-floppy-disk mr-2"></i> Salva o importa dati personali </h3>
			   <p style="margin:0px;"><small>Salva qui tutte le tue informazioni salvate nell'app</small></p>
               <div class="grid grid-cols-2 gap-4">
                  <button onclick="app.handlers.exportData()" class="bg-primary text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-600">Esporta JSON</button>
                  <label class="bg-gray-700 text-white py-2 rounded-lg text-sm font-semibold hover:bg-gray-600 text-center cursor-pointer">
                  Importa JSON
                  <input type="file" onchange="app.handlers.importData(this)" class="hidden" accept=".json">
                  </label>
               </div>
               <button onclick="app.handlers.resetAllData()" class="w-full border border-red-500 text-red-500 py-2 rounded-lg text-sm font-semibold hover:bg-red-50">Cancellazione Totale</button>
            </div>
			</div>
         </section>
      </main>
      <!-- BOTTOM NAVIGATION -->
     <nav class="fixed bottom-0 left-0 right-0 bg-darkCard border-t border-gray-200 border-gray-800 flex justify-around items-center h-16 pb-safe z-20 transition-colors duration-300" style="-webkit-box-shadow: 0px 0px 50px 64px #111827;
    box-shadow: 0px 0px 50px 64px #111827;">
   <button onclick="app.router.go('dashboard')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-purple-400 transition">
   <i class="fa-solid fa-house mb-1"></i>
   <span class="text-[10px] font-medium">Home</span> 
   </button>
   <button onclick="app.router.go('badges')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-purple-400 transition">
   <i class="fa-solid fa-trophy mb-1"></i>
   <span class="text-[10px] font-medium">Traguardi</span>
   </button>
   <button onclick="app.router.go('stats')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-purple-400 transition">
   <i class="fa-solid fa-chart-simple mb-1"></i>
   <span class="text-[10px] font-medium">Statistiche</span>
   </button>
   <button onclick="app.router.go('settings')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-purple-400 transition">
   <i class="fa-solid fa-gear mb-1"></i>
   <span class="text-[10px] font-medium">Impostazioni</span>
   </button>
   

</nav>
      <!-- Modal Template for Exercise Form -->
      <div id="exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-darkBg bg-darkCard rounded-2xl w-full max-w-sm p-6 space-y-4 shadow-2xl animate-fade-in-up">
           <h3 class="font-bold text-xl mb-2" id="modal-title"><i class="fa-solid fa-dumbbell mr-2"></i> Aggiungi Esercizio</h3>
            <input type="text" id="modal-ex-name" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3 border-none focus:ring-2 focus:ring-primary" placeholder="Nome (es. Panca Piana)">
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="text-xs text-gray-400 ml-1">Serie</label>
                  <input type="number" id="modal-ex-sets" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 4">
               </div>
               <div>
                  <label class="text-xs text-gray-400 ml-1">Reps <i class="fa-regular fa-circle-question"></i></label>
                  <input type="text" id="modal-ex-reps"  class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 8-10">
				  
               </div>
            </div>
			<small style="line-height: 17px;
    margin-top: 14px;
    display: block;"><i class="fa-regular fa-circle-question"></i> Reps: puoi inserire anche una parola al posto di un numero, per esempio: maxreps</small>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="text-xs text-gray-400 ml-1">Pausa</label>
                  <select id="modal-ex-rest" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3">
                     <option value="30">30 secondi</option>
                     <option value="60" selected>1 minuto</option>
                     <option value="90" >1:30 minuti</option>
                     <option value="120">2 minuti</option>
                     <option value="150">2:30 minuti</option>
                     <option value="180">3 minuti</option>
                     <option value="210">3:30 minuti</option>
                     <option value="240">4 minuti</option>
                     <option value="270">4:30 minuti</option>
                     <option value="300">5 minuti</option>
                     <option value="330">5:30 minuti</option>
                     <option value="360">6 minuti</option>
                     <option value="390">6:30 minuti</option>
                     <option value="420">7 minuti</option>
                  </select>
               </div>
               <div>
                  <label class="text-xs text-gray-400 ml-1">Peso Iniziale (Kg)</label>
                  <input type="number" id="modal-ex-weight" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 15">
               </div>
            </div>
            <div class="flex items-center gap-2  bg-gray-800 p-3 rounded-lg">
               <input type="checkbox" id="modal-ex-double" class="accent-primary w-5 h-5">
               <label class="text-sm">Peso doppio (es. 2 manubri)<br/><small>(usato solo per statistiche per calcoli peso totale, il peso indicato verr√† moltiplicato x2)</small></label>
            </div>
            <div>
               <label class="text-xs text-gray-400 ml-1 block mb-1">Note (opzionale)</label>
               <textarea id="modal-ex-notes" rows="3" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3 border-none focus:ring-2 focus:ring-primary text-sm resize-none" placeholder="Es: ROM completo, pausa in basso..."></textarea>
            </div>

            <div class="flex w-full justify-between mt-4 pt-2">
  <button
    onclick="document.getElementById('exercise-modal').classList.add('hidden')"
    class="bg-white text-black px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2"
  >
    Annulla
  </button>

  <button
    onclick="app.handlers.confirmAddExercise()"
    class="bg-primary text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2"
  >
    Aggiungi
  </button>
</div>

         </div>
      </div>
      <!-- Modal Workout Preview -->
      <div id="workout-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-gray-800 rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl animate-fade-in-up" style="border: 3px solid #374151;">
            <div class="sticky top-0 bg-gray-900 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
               <h3 class="font-bold text-xl text-white">Panoramica Workout</h3>
               <button onclick="document.getElementById('workout-preview-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
               <i class="fa-solid fa-xmark text-2xl"></i>
               </button>
            </div>
            <div id="workout-preview-content" class="p-6 space-y-3 overflow-y-auto max-h-[calc(80vh-80px)] text-white">
               <!-- Content injected by JS -->
            </div>
</div>
      </div>
	  
	  <!-- Modal Start Workout Confirmation -->
      <div id="start-workout-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-gradient-to-br from-darkCard to-gray-900 rounded-3xl w-full max-w-md shadow-2xl border-2 border-primary/30 flex flex-col max-h-[90vh]">
            
            <!-- Header Fisso -->
            <div class="bg-gradient-to-r from-primary to-purple-600 p-6 text-center relative overflow-hidden flex-shrink-0  rounded-tl-2xl rounded-tr-2xl">
               <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
               <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
               
               <div class="relative z-10">
                  <div class="text-5xl mb-3 emoji-rest-day">üöÄ</div>
                  <h2 class="text-2xl font-bold text-white">Stai per iniziare</h2>
               </div>
            </div>
            
            <!-- Contenuto Scrollabile -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4 hide-scrollbar">
               <!-- Workout Info Card -->
               <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                  <div class="flex items-center gap-3 mb-3">
                     <div id="start-modal-workout-icon" class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0" style="background: #5127f2">
                        <i class="hgi hgi-stroke hgi-dumbbell-01 text-3xl text-white"></i>
                     </div>
                     <h3 id="start-modal-workout-name" class="font-bold text-xl text-white flex-1">Nome Workout</h3>
                  </div>
               </div>
               
               <!-- Stats Preview -->
               <div class="grid grid-cols-2 gap-3">
                  <div class="bg-gray-800/30 rounded-xl p-3 border border-gray-700/50 text-center">
                     <div class="text-gray-400 text-xs mb-1">Tempo Stimato</div>
                     <div class="font-bold text-blue-400 text-lg" id="start-modal-time">0 min</div>
                  </div>
                  <div class="bg-gray-800/30 rounded-xl p-3 border border-gray-700/50 text-center">
                     <div class="text-gray-400 text-xs mb-1">Calorie Stimate</div>
                     <div class="font-bold text-orange-400 text-lg" id="start-modal-calories">~0 kcal</div>
                  </div>
               </div>
               
               <!-- Exercises List -->
               <div class="bg-gray-800/30 rounded-xl p-4 border border-gray-700/50">
                  <h4 class="font-semibold text-white mb-3 flex items-center gap-2">
                     <i class="fa-solid fa-list-check text-primary"></i>
                     Esercizi
                  </h4>
                  <div id="start-modal-exercises-list" class="space-y-2">
                     <!-- Injected by JS -->
                  </div>
               </div>
            </div>
            
            <!-- Footer Fisso -->
            <div class="p-6 pt-4 border-t border-gray-700/50 flex-shrink-0 space-y-3">
               <button id="btn-start-workout" onclick="app.handlers.confirmStartWorkout()" 
                  class="w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primaryDark hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                  <i class="fa-solid fa-play"></i>
                  Inizia Workout
               </button>
               <button onclick="app.handlers.closeStartModal()" 
                  class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-xl transition-all active:scale-95">
                  Annulla
               </button>
            </div>
         </div>
      </div>
      
      <!-- Modal Icon Picker -->
      <div id="icon-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-darkCard rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl">
            <div class="sticky top-0 bg-gray-900 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
               <h3 class="font-bold text-xl text-white">Scegli Icona</h3>
               <button onclick="document.getElementById('icon-picker-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                  <i class="fa-solid fa-xmark text-2xl"></i>
               </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(80vh-80px)] grid grid-cols-5 gap-3">
               <!-- Icone iniettate da JS -->
            </div>
         </div>
      </div>
      
      <!-- AUDIO ELEMENTS -->

      <!-- <audio id="audio-beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio> -->
      <audio id="audio-beep" src="https://cdn.freesound.org/previews/22/22627_7037-lq.ogg" preload="auto"></audio>
      <audio id="audio-complete" src="https://cdn.freesound.org/previews/619/619839_7614679-lq.ogg" preload="auto"></audio>
      <audio id="audio-auto-next" src="https://cdn.freesound.org/previews/108/108897_7037-lq.ogg" preload="auto"></audio>
	  
	  <!-- üî• NUOVO: Audio silenzioso per mantenere app attiva -->
<audio id="audio-keepalive" loop>
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
</audio>


      <!-- LOGIC SCRIPT -->
      <script>
         /**
          * INDEXED DB WRAPPER
          * Helper class for raw IndexedDB operations to ensure data persistence without libraries.
          */
         class DB {
             constructor() {
                 this.dbName = 'FitTrackerDB';
                 this.version = 2;
                 this.db = null;
             }
         
             async connect() {
                 return new Promise((resolve, reject) => {
                     const request = indexedDB.open(this.dbName, this.version);
request.onupgradeneeded = (e) => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains('workouts')) db.createObjectStore('workouts', { keyPath: 'id' });
    if (!db.objectStoreNames.contains('history')) db.createObjectStore('history', { keyPath: 'id' });
    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
    if (!db.objectStoreNames.contains('badges')) db.createObjectStore('badges', { keyPath: 'id' });
};
                     request.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                     request.onerror = (e) => reject(e);
                 });
             }
         
             async getAll(storeName) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve) => {
                     const tx = this.db.transaction(storeName, 'readonly');
                     const store = tx.objectStore(storeName);
                     const request = store.getAll();
                     request.onsuccess = () => resolve(request.result);
                 });
             }
         
             async put(storeName, item) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve, reject) => {
                     const tx = this.db.transaction(storeName, 'readwrite');
                     const store = tx.objectStore(storeName);
                     const request = store.put(item);
                     request.onsuccess = () => resolve(request.result);
                     request.onerror = () => reject("Put error");
                 });
             }
         
             async delete(storeName, key) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve) => {
                     const tx = this.db.transaction(storeName, 'readwrite');
                     tx.objectStore(storeName).delete(key);
                     tx.oncomplete = () => resolve();
                 });
             }
         
             async clearAll() {
                 if(!this.db) await this.connect();
                 const stores = ['workouts', 'history', 'settings'];
                 stores.forEach(name => {
                     const tx = this.db.transaction(name, 'readwrite');
                     tx.objectStore(name).clear();
                 });
             }
         }
         
         /**
          * APP LOGIC
          */
         const app = {
             db: new DB(),
             state: {
    currentView: 'dashboard',
    statsPeriod: 'week',
    workouts: [],
    history: [],
    editingWorkout: null,
    editingExerciseIndex: null,
    activeSession: null, 
	isSaving: false,        
    isDeleting: false,
deferredPrompt: null,	
 wakeLock: null,
    
    settings: { 
        unit: 'kg', 
        sound: true, 
        vibrate: true, 
        motivational: true, 
        bodyWeight: null, 
        height: null, 
        age: null, 
        gender: '', 
        autoNext: false 
    },
    
    badges: {
        strike4: { count: 0, lastUnlocked: null, seen: false },
        kcal500: { count: 0, lastUnlocked: null, seen: false },
        kcal7200: { count: 0, lastUnlocked: null, seen: false },
        kg10000: { count: 0, lastUnlocked: null, seen: false },
        month16: { count: 0, lastUnlocked: null, seen: false },
        bench100: { count: 0, lastUnlocked: null, seen: false, oneTime: true }
    },
    
    badgeDefinitions: {
        strike4: {
            name: 'Strike 4 Allenamenti',
            desc: 'Quattro allenamenti questa settimana, zero scuse. Costanza attivata üìÖ',
            icon: 'https://rccremonesi-cmyk.github.io/workout/4x.png',
            repeatable: true
        },
        kcal500: {
            name: '500 kcal Workout',
            desc: 'Allenamento incendiario: 500 kcal bruciate! üî•',
            icon: 'https://rccremonesi-cmyk.github.io/workout/500k.png',
            repeatable: true
        },
        kcal7200: {
            name: '7200 kcal Totali',
            desc: 'Energia trasformata in risultati: 7200 kcal consumate, 1kg perso! üß±',
            icon: 'https://rccremonesi-cmyk.github.io/workout/7200k.png',
            repeatable: true
        },
        kg10000: {
            name: '10.000 kg Sollevati',
            desc: 'Forza pura cumulativa: 10 tonnellate di ghisa! ü¶æ',
            icon: 'https://rccremonesi-cmyk.github.io/workout/10000kg.png',
            repeatable: true
        },
        month16: {
            name: '16 Allenamenti/Mese',
            desc: 'Un mese, sedici allenamenti. sei in pieno flow! ‚è≥',
            icon: 'https://rccremonesi-cmyk.github.io/workout/16x.png',
            repeatable: true
        },
        bench100: {
            name: 'Panca Piana 100kg',
            desc: 'Ora sei un vero uomo! üí™',
            icon: 'https://rccremonesi-cmyk.github.io/workout/100bench.png',
            repeatable: false
        }
    },
    
    pendingBadges: [],
    motivationalPhrases: [
        'Spacca tutto! üí™',
        'Hai preso il \ntuo preworkout? ü•§',
		'Hai gi√† fatto \nriscaldamento? üî•',
		'√à ora di \nspingere forte! üöÄ',
		'Un passo alla \nvolta, andiamo! üë£',
		'Pi√π costanza e meno scuse üí•',
		'Focus totale, \nsei in zona üéØ',
        'Ricordati di \nrimanere idratato! üíß',
		'Fatica oggi, \norgoglio domani üèÜ',
		'Spingi ora, \nrilassati dopo üòé',
		'Se brucia, \nfunziona üî•'
    ],
    preferredDays: []
},
       
             
init: async () => {
    await app.db.connect();
    await app.loadData();
    app.ui.applyTheme();
    app.router.go('dashboard');
    
    // üî• AGGIUNGI QUESTO
    // Aggiorna UI permessi notifiche
    setTimeout(() => {
        const btn = document.getElementById('notification-btn-text');
        if (btn && Notification.permission === 'granted') {
            btn.textContent = '‚úÖ Notifiche Attive';
        }
    }, 500);
},
         
loadData: async () => {
    app.state.workouts = await app.db.getAll('workouts');
    app.state.history = await app.db.getAll('history');
    const savedSettings = await app.db.getAll('settings');
    if (savedSettings.length > 0) {
        savedSettings.forEach(s => app.state.settings[s.key] = s.value);
    }
    
    // Load badges
    const savedBadges = await app.db.getAll('badges');
    if (savedBadges.length > 0) {
        savedBadges.forEach(b => {
            if (app.state.badges[b.id]) {
                app.state.badges[b.id] = b.data;
            }
        });
    }
},
         
         
         
         calculateCalories: (session) => {
         const settings = app.state.settings;
         
         // 1. Recupero Dati Utente (con fallback robusti)
         const weight = parseFloat(settings.bodyWeight) || 75; 
         const height = parseFloat(settings.height) || 175;    
         const age = parseFloat(settings.age) || 30;           
         const gender = settings.gender || 'male';
         const trainingLevel = settings.trainingLevel || 'intermediate';
         
         // 2. Calcolo Volume Totale (kg alzati)
         let totalVolume = 0;
         if (session.logs && session.logs.length > 0) {
         session.logs.forEach(l => {
            const w = parseFloat(l.weight) || 0;
            const r = parseFloat(l.reps) || 0;
            const m = l.multiplier || 1;
            totalVolume += (w * r * m);
         });
         }
         
         // --- ALGORITMO CALORIE ---
         
         // A. BMR (Mifflin-St Jeor) - Mantenuto per contesto metabolico
         let bmr = 0;
         if (gender === 'male') {
         bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
         } else {
         bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
         }
         
         // B. Coefficiente Base per Lavoro Meccanico
         // Circa 0.04-0.05 kcal per kg spostato
         let caloriesPerKg = 0.045;
         
         // C. Aggiustamento per Metabolismo Individuale (basato su BMR)
         // Chi ha BMR pi√π alto tende a bruciare pi√π calorie anche durante l'esercizio
         const bmrFactor = bmr / 1600; // Normalizzato su BMR medio (~1600 kcal/day)
         caloriesPerKg *= (0.85 + (bmrFactor * 0.15)); // Range: 0.85x - 1.15x circa
         
         // D. APPLICAZIONE LIVELLI (efficienza neuromuscolare)
         switch (trainingLevel) {
         case 'beginner':
            // I principianti sono meno coordinati e bruciano circa il 15% in pi√π
            caloriesPerKg *= 1.15; 
            break;
         case 'intermediate':
            // Valore standard di riferimento
            caloriesPerKg *= 1.00; 
            break;
         case 'advanced':
            // Gli avanzati sono pi√π efficienti
            caloriesPerKg *= 0.92; 
            break;
         case 'elite':
            // Massima efficienza biomeccanica
            caloriesPerKg *= 0.85; 
            break;
         default:
            caloriesPerKg *= 1.00;
         }
         
         // E. Calcolo Finale
         const totalCalories = totalVolume * caloriesPerKg;
         
         console.log(`üìä CALORIE REPORT:
         ‚Ä¢ Level: ${trainingLevel}
         ‚Ä¢ BMR: ${Math.round(bmr)} kcal/day
         ‚Ä¢ Total Volume: ${totalVolume.toFixed(0)} kg
         ‚Ä¢ Cal/kg Rate: ${caloriesPerKg.toFixed(4)}
         üëâ TOTAL: ${Math.round(totalCalories)} kcal`);
         
         return Math.round(totalCalories);
         },
		 


getLastWorkoutWeight: (workoutId, exerciseName) => {
    // Trova l'ultimo workout completato con questo ID
    const lastWorkout = app.state.history
        .filter(h => h.workoutId === workoutId)
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    
    if (!lastWorkout || !lastWorkout.logs) return null;
    
    // Trova i log di questo esercizio
    const exerciseLogs = lastWorkout.logs.filter(l => l.exercise === exerciseName);
    if (exerciseLogs.length === 0) return null;
    
    // Calcola peso medio
    const avgWeight = exerciseLogs.reduce((acc, l) => acc + parseFloat(l.weight), 0) / exerciseLogs.length;
    
    return {
        weight: avgWeight,
        date: new Date(lastWorkout.date)
    };
},

updateWeightComparison: () => {
    const session = app.state.activeSession;
    if (!session) return;
    
    const ex = session.workout.exercises[session.currentExIdx];
    const lastData = app.getLastWorkoutWeight(session.workout.id, ex.name);
    
    const comparisonEl = document.getElementById('weight-comparison');
    if (!comparisonEl) return;
    
    if (lastData === null) {
        // Prima volta - nascondi
        comparisonEl.innerHTML = '';
        return;
    }
    
    const dateStr = lastData.date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
    const weightStr = lastData.weight.toFixed(1);
    
    comparisonEl.innerHTML = `<i class="fa-regular fa-calendar font-bold mr-1" style="font-size: 11px;"></i> ${dateStr} - ${weightStr}kg`;
},
		 
checkBadges: async (session) => {
    const newBadges = [];
    const now = new Date(); // üî• DICHIARATA UNA SOLA VOLTA QUI
    
    // üî• 1Ô∏è‚É£ Strike 4 workouts questa settimana (FISSO)
    const weekStart = new Date(now);
    const dayOfWeek = now.getDay();
    // Se domenica (0), torna indietro di 6 giorni, altrimenti calcola normalmente
    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    weekStart.setDate(now.getDate() - daysToMonday);
    weekStart.setHours(0, 0, 0, 0);
    
    const thisWeekWorkouts = app.state.history.filter(h => new Date(h.date) >= weekStart);
    
    console.log(`üìä Workout questa settimana: ${thisWeekWorkouts.length}/4`);
    
    if (thisWeekWorkouts.length === 4 && !app.state.badges.strike4.seen) {
        newBadges.push('strike4');
        app.state.badges.strike4.count++;
        app.state.badges.strike4.lastUnlocked = new Date().toISOString();
        app.state.badges.strike4.seen = true;
    }
    
    // 2Ô∏è‚É£ 500 kcal in un workout
    const calories = session.caloriesBurned || 0;
    if (calories >= 500) {
        newBadges.push('kcal500');
        app.state.badges.kcal500.count++;
        app.state.badges.kcal500.lastUnlocked = new Date().toISOString();
    }
    
    // 3Ô∏è‚É£ 7200 kcal totali (cumulativo)
    const totalCal = app.state.history.reduce((acc, h) => acc + (parseFloat(h.caloriesBurned) || 0), 0);
    const kcal7200Milestone = Math.floor(totalCal / 7200);
    if (kcal7200Milestone > app.state.badges.kcal7200.count) {
        newBadges.push('kcal7200');
        app.state.badges.kcal7200.count = kcal7200Milestone;
        app.state.badges.kcal7200.lastUnlocked = new Date().toISOString();
    }
    
    // üî• 4Ô∏è‚É£ 10.000 kg TOTALI (FISSO) - Ora cumulativo come le calorie
    const totalVolume = app.state.history.reduce((acc, h) => acc + (parseFloat(h.totalVolume) || 0), 0);
    const kg10000Milestone = Math.floor(totalVolume / 10000);
    if (kg10000Milestone > app.state.badges.kg10000.count) {
        newBadges.push('kg10000');
        app.state.badges.kg10000.count = kg10000Milestone;
        app.state.badges.kg10000.lastUnlocked = new Date().toISOString();
    }
    
    // 5Ô∏è‚É£ 16 allenamenti questo mese
    const thisMonthWorkouts = app.state.history.filter(h => {
        const d = new Date(h.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    
    console.log(`üìä Workout questo mese: ${thisMonthWorkouts.length}/16`);
    
    if (thisMonthWorkouts.length === 16 && !app.state.badges.month16.seen) {
        newBadges.push('month16');
        app.state.badges.month16.count++;
        app.state.badges.month16.lastUnlocked = new Date().toISOString();
        app.state.badges.month16.seen = true;
    }
    
    // 6Ô∏è‚É£ Panca piana 100kg (one-time)
    if (app.state.badges.bench100.count === 0) {
        const hasBench = session.logs?.some(l => 
            l.exercise.toLowerCase().includes('panca piana') && parseFloat(l.weight) >= 100
        );
        if (hasBench) {
            newBadges.push('bench100');
            app.state.badges.bench100.count = 1;
            app.state.badges.bench100.lastUnlocked = new Date().toISOString();
        }
    }
    
    // Salva tutti i badge
    for (const key in app.state.badges) {
        await app.db.put('badges', { id: key, data: app.state.badges[key] });
    }
    
    app.state.pendingBadges.push(...newBadges);
},

resetWeeklyBadges: async () => {
    // Reset seen flags per badge settimanali
    app.state.badges.strike4.seen = false;
    await app.db.put('badges', { id: 'strike4', data: app.state.badges.strike4 });
},

resetMonthlyBadges: async () => {
    app.state.badges.month16.seen = false;
    await app.db.put('badges', { id: 'month16', data: app.state.badges.month16 });
},
         
         
         
router: {
    go: (viewId) => {
	
	        // ‚úÖ CONTROLLO SALVATAGGIO EDITOR
if (app.state.currentView === 'editor' && viewId === 'dashboard') {
    // ‚úÖ AGGIUNGI: Se stiamo eliminando, bypassa il controllo
    if (!app.state.isSaving && !app.state.isDeleting) {
        const confirmed = confirm('‚ö†Ô∏è Stai uscendo dall\'editor. Hai salvato le modifiche?');
        if (!confirmed) {
            return; // Blocca la navigazione
        }
    }
    // Reset dei flag
    app.state.isSaving = false;
    app.state.isDeleting = false; // ‚úÖ AGGIUNGI
}
		
		
        // ‚úÖ SCROLL TO TOP
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
            appContainer.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ‚úÖ GESTIONE HEADER E MARGINE
        const header = document.querySelector('header');
        const nav = document.querySelector('nav');
        
        if (viewId === 'active') {
            // Nascondi header e nav, rimuovi margine
            header.style.display = 'none';
            nav.style.display = 'none';
            if (appContainer) {
                appContainer.style.setProperty('margin-top', '0', 'important');
            }
        } else {
            // Mostra header e nav, ripristina margine
            header.style.display = 'grid';
            nav.style.display = 'flex';
			header.classList.remove('header-hidden');
            if (appContainer) {
                appContainer.style.setProperty('margin-top', '53px', 'important');
            }
        }
        
        // Cambia view attiva
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');
        
        // ‚úÖ RIMUOVI LA CLASSE ACTIVE DA TUTTI I BOTTONI
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-primary');
            btn.classList.remove('active');
        });
        
        // ‚úÖ AGGIUNGI LA CLASSE SOLO SE NON SEI IN EDITOR O ACTIVE
        if(viewId !== 'editor' && viewId !== 'active') {
            const navIndices = {'dashboard': 0, 'badges': 1, 'stats': 2, 'settings': 3};
            const targetBtn = document.querySelectorAll('.nav-btn')[navIndices[viewId]];
            if (targetBtn) {
                targetBtn.classList.add('text-primary');
                targetBtn.classList.add('active');
            }
        }
        
        app.state.currentView = viewId;
        if (viewId === 'dashboard') app.ui.renderDashboard();
        if (viewId === 'badges') app.ui.renderBadges();
        if (viewId === 'stats') app.ui.renderStats();
    }
},
         
             ui: {
                 applyTheme: () => {
                    
                 },
                 
renderDashboard: () => {
    const list = document.getElementById('workout-list');
    list.innerHTML = '';
    
    if (app.state.pendingBadges.length > 0) {
        app.ui.showBadgeNotification();
    }
    
    // Stats calculation based on period
    const now = new Date();
    let filteredHistory;
    let periodName;
    let iconClass;
    
	if (app.state.statsPeriod === 'week') {
		// Weekly stats (Monday to Sunday)
		const startOfWeek = new Date(now);
		const dayOfWeek = now.getDay();
		const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // üî• CORRETTO
		startOfWeek.setDate(now.getDate() + diff);
		startOfWeek.setHours(0, 0, 0, 0);
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        endOfWeek.setHours(23, 59, 59, 999);
        
        filteredHistory = app.state.history.filter(h => {
            const d = new Date(h.date);
            return d >= startOfWeek && d <= endOfWeek;
        });
        
        const startDay = startOfWeek.getDate();
        const endDay = endOfWeek.getDate();
        const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        periodName = `${startDay}-${endDay} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        iconClass = 'fa-calendar-week';
        
    } else {
        // Monthly stats
        filteredHistory = app.state.history.filter(h => {
            const d = new Date(h.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        
        const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        periodName = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        iconClass = 'fa-calendar-days';
    }
    
    // Update UI texts
    document.getElementById('stats-period-title').innerText = app.state.statsPeriod === 'week' ? 'Questa\nSettimana' : 'Questo\nMese';
    document.getElementById('current-period-name').innerText = periodName;
    document.getElementById('stats-period-icon').className = `fa-solid ${iconClass}`;
    
    // Update toggle position
    const toggleDot = document.getElementById('stats-toggle-dot');
    const weekIcon = document.getElementById('toggle-week-icon');
    const monthIcon = document.getElementById('toggle-month-icon');
    if (app.state.statsPeriod === 'week') {
        toggleDot.style.transform = 'translateX(0)';
        weekIcon.classList.remove('opacity-50');
        monthIcon.classList.add('opacity-50');
    } else {
        toggleDot.style.transform = 'translateX(16px)';
        weekIcon.classList.add('opacity-50');
        monthIcon.classList.remove('opacity-50');
    }
                 
    let totalVol = 0;
    let totalCal = 0;
    filteredHistory.forEach(h => {
        const vol = parseFloat(h.totalVolume);
        if (!isNaN(vol)) totalVol += vol;
        const cal = parseFloat(h.caloriesBurned);
        if (!isNaN(cal)) totalCal += cal;
    });
     
    // Calcolo grammi di grasso: 1g grasso = 9 kcal, quindi 1kg = ~7500 kcal
    const fatBurnedGrams = Math.round((totalCal / 7500) * 1000);
     
    document.getElementById('period-workouts-count').innerText = filteredHistory.length;
    document.getElementById('period-volume').innerText = Math.round(totalVol).toLocaleString();
    document.getElementById('period-calories').innerText = Math.round(totalCal).toLocaleString();
    document.getElementById('period-fat-burned').innerText = fatBurnedGrams;
     
    // Today's Recommended Workouts
const today = new Date().getDay(); // 0=Dom, 1=Lun, etc.
const todayWorkouts = app.state.workouts.filter(w => 
    w.preferredDays && w.preferredDays.includes(today) && !w.archived
);

    
// ‚úÖ MOSTRA SEZIONE SOLO SE CI SONO WORKOUT
const hasAnyWorkouts = app.state.workouts.some(w => !w.archived);

if (hasAnyWorkouts) {
    const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
    const monthNames2 = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const dateStr = `${dayNames[now.getDay()]} ${now.getDate()} ${monthNames2[now.getMonth()]} ${now.getFullYear()}`;
    
    list.innerHTML += `
        <div class="mb-0">
            <h3 class="p-3 rounded-xl shadow-sm font-bold text-lg mb-3 text-center">
                üìÖ Workout scelti per oggi:<br/> 
                <div style="font-size:15px; font-weight:400;">${dateStr}</div>
            </h3>
    `;

if (todayWorkouts.length > 0) {
    // ‚úÖ Caso: Ci sono workout per oggi
    const todayWorkoutsHTML = todayWorkouts.map(w => {
        // Check if completed this week
        const weekStart = new Date();
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
        weekStart.setHours(0, 0, 0, 0);
        
        const completedThisWeek = app.state.history
            .filter(h => h.workoutId === w.id && new Date(h.date) >= weekStart)
            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        
        return `
            <div class="bg-darkCard p-4 rounded-xl shadow-sm flex justify-between items-center border" style="border-width: 3px; border-color:rgb(111 60 207 / 40%);">
                <div class="flex items-center gap-3 flex-1">
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0" 
                         style="background: ${w.color || '#5127f2'}">
                        <i class="hgi hgi-stroke ${w.icon || 'hgi-dumbbell-01'} text-2xl text-white"></i>
                    </div>
                    <div onclick="app.handlers.openWorkoutEditor('${w.id}')" class="flex-1 cursor-pointer">
                        <h4 class="font-bold text-md">${w.name}</h4>
                       <p class="text-xs text-gray-400">${w.exercises.length} Esercizi${(() => {
    const estimatedTime = Math.round(
        w.exercises.reduce((acc, e) => {
            const sets = parseInt(e.sets);
            const rest = parseInt(e.rest);
            
            return acc + 
                ((sets - 1) * rest / 60) +  // Pause tra serie
                (sets * 1.2) +               // 1.5 min per serie invece di 1
                2;                           // 2 min buffer per setup
        }, 0)
    );
    return isNaN(estimatedTime) || estimatedTime === 0 ? '' : ' ‚Ä¢ ' + estimatedTime + ' min stimati';
})()}</p>
                        ${completedThisWeek ? `
                            <p class="text-xs text-purple-400 mt-1 flex items-center gap-1">
                                <i class="fa-solid fa-check"></i>
                                ${(() => {
                                    const completedDate = new Date(completedThisWeek.date);
                                    const today = new Date();
                                    const yesterday = new Date(today);
                                    yesterday.setDate(today.getDate() - 1);
                                    
                                    const isToday = completedDate.toDateString() === today.toDateString();
                                    const isYesterday = completedDate.toDateString() === yesterday.toDateString();
                                    
                                    if (isToday) return 'Lo hai completato oggi';
                                    if (isYesterday) return 'Lo hai completato ieri';
                                    return `Lo hai completato ${completedDate.toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric', month: 'short'})}`;
                                })()}
                            </p>
                        ` : ''}
                    </div>
                    <button onclick="app.handlers.startWorkout('${w.id}')" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-primaryDark">
                        <i class="fa-solid fa-play ml-1"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    list.innerHTML += `<div class="space-y-3">${todayWorkoutsHTML}</div>`;

    } else {
        // ‚úÖ Caso: Nessun workout oggi - Giorno di riposo
        const restMessages = [
            { emoji: 'üò¥', text: 'Oggi √® il tuo giorno di riposo!<br/>Rilassati e recupera energia' },
            { emoji: 'üõãÔ∏è', text: 'Nessun workout programmato oggi.<br/>Goditi il meritato riposo!' },
            { emoji: 'üßò', text: 'Rest day! <br/>Il riposo √® parte del progresso' },
            { emoji: '‚òï', text: 'Oggi rilassati.<br/>I muscoli crescono quando riposano!' },
            { emoji: '‚ú®', text: 'Niente allenamento oggi.<br/>Prenditi cura di te!' }
        ];
        
       const randomMessage = restMessages[Math.floor(Math.random() * restMessages.length)];
    
    list.innerHTML += `
        <div id="rest-day-card" class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm p-6 text-center relative overflow-hidden">
            <div class="text-6xl mb-3 emoji-rest-day">${randomMessage.emoji}</div>
            <p class="text-gray-300 font-semibold">${randomMessage.text}</p>
            <p class="text-sm text-gray-400 mt-2">Il recupero √® essenziale per migliorare le performance</p>
        </div>
    `;
    
    // ‚úÖ Trigger confetti dopo il render
    setTimeout(() => {
        const card = document.getElementById('rest-day-card');
        if (card) app.handlers.createConfetti(card);
    }, 100);
}

    list.innerHTML += `</div>`; // ‚Üê Chiusura div mb-10
	
}
     
    // Render Workouts
    
    if (app.state.workouts.length === 0) {
        list.innerHTML += `<div class="relative overflow-hidden bg-gradient-to-br from-darkCard to-gray-900 rounded-2xl shadow-xl p-8 border border-gray-800">
            <!-- Decorative elements -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl"></div>
            
            <div class="relative z-10 text-center space-y-4">
                <!-- Icon -->
                <div class="inline-flex items-center justify-center w-20 h-20 bg-primary/20 rounded-full mb-2" style="font-size:48px;">
                    üöÄ
                </div>
                
                <!-- Title -->
                <h3 class="text-xl font-bold text-white">Inizia il tuo percorso!</h3>
                
                <!-- Description -->
                <p class="text-gray-400 max-w-sm mx-auto">
                   
                    Crea il tuo primo allenamento e inizia a tracciare i tuoi progressi.
                </p>
                
                <!-- Settings reminder -->
                <div class="bg-primary/10 border border-primary/30 rounded-xl p-4 mt-6 cursor-pointer hover:bg-primary/20 transition-all" 
                    onclick="app.router.go('settings')">
                    <div class="flex items-start gap-3 text-left">
                        <div class="bg-primary/20 rounded-lg p-2 flex-shrink-0">
                            <i class="fa-solid fa-gear"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-white text-sm mb-1 flex items-center gap-2">
                                Prima di iniziare
                                <i class="fa-solid fa-arrow-right text-xs"></i>
                            </h4>
                            <p class="text-sm text-gray-400">
                                Configura peso, altezza ed et√† nelle <span class="text-primary font-semibold">Impostazioni</span> per monitorare calorie e progressi
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        return;
    }
	
	// Filtra workout attivi e archiviati
const activeWorkouts = app.state.workouts.filter(w => !w.archived);
const archivedWorkouts = app.state.workouts.filter(w => w.archived);
	
if (activeWorkouts.length > 0) {
    list.innerHTML += `<h3 class="p-3 rounded-xl shadow-sm font-bold text-lg mb-3 flex items-center justify-center gap-2 text-center" style="margin-top:50px !important;">üìÇ Tutti i tuoi Workout salvati</h3>`;
}



// Render workout attivi
activeWorkouts.forEach(w => {
    // Check if completed this week
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    weekStart.setHours(0, 0, 0, 0);
    
    const completedThisWeek = app.state.history
        .filter(h => h.workoutId === w.id && new Date(h.date) >= weekStart)
        .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    
    const el = document.createElement('div');
    el.className = 'bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm flex justify-between items-center transform transition active:scale-98';

    const dayLabels = ['D', 'L', 'M', 'M', 'G', 'V', 'S'];
    const preferredDaysHTML = (w.preferredDays && w.preferredDays.length > 0) ? `
        <div class="flex items-center gap-1 mt-1">
            <i class="fa-regular fa-calendar text-gray-500" style="font-size: 14px;"></i>
            ${dayLabels.map((day, idx) => {
                const isAssigned = w.preferredDays.includes(idx);
                return `<span class="text-[12px] font-semibold px-1.5 py-0.5 rounded ${isAssigned ? 'bg-primary/20 text-white' : 'bg-gray-800 text-gray-600'}">${day}</span>`;
            }).join('')}
        </div>
    ` : '';

    el.innerHTML = `
    <div class="flex items-center gap-3 flex-1">
        <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0" 
             style="background: ${w.color || '#5127f2'}">
            <i class="hgi hgi-stroke ${w.icon || 'hgi-dumbbell-01'} text-2xl text-white"></i>
        </div>
        <div onclick="app.handlers.openWorkoutEditor('${w.id}')" class="flex-1 cursor-pointer">
            <h4 class="font-bold text-md">${w.name}</h4>
           <p class="text-xs text-gray-400">${w.exercises.length} Esercizi${(() => {
    const estimatedTime = Math.round(
        w.exercises.reduce((acc, e) => {
            const sets = parseInt(e.sets);
            const rest = parseInt(e.rest);
            
            return acc + 
                ((sets - 1) * rest / 60) +  // Pause tra serie
                (sets * 1.2) +               // 1.5 min per serie invece di 1
                2;                           // 2 min buffer per setup
        }, 0)
    );
    return isNaN(estimatedTime) || estimatedTime === 0 ? '' : ' ‚Ä¢ ' + estimatedTime + ' min stimati';
})()}</p>
           ${completedThisWeek ? `
    <p class="text-xs text-purple-400 mt-1 flex items-center gap-1">
        <i class="fa-solid fa-check"></i>
        ${(() => {
            const completedDate = new Date(completedThisWeek.date);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            const isToday = completedDate.toDateString() === today.toDateString();
            const isYesterday = completedDate.toDateString() === yesterday.toDateString();
            
            if (isToday) return 'Lo hai completato oggi';
            if (isYesterday) return 'Lo hai completato ieri';
            return `Lo hai completato ${completedDate.toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric', month: 'short'})}`;
        })()}
    </p>
` : ''}
            ${preferredDaysHTML}
        </div>
        <button onclick="app.handlers.startWorkout('${w.id}')" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-primaryDark">
            <i class="fa-solid fa-play ml-1"></i>
        </button>
    `;
    list.appendChild(el);
});

// ‚úÖ SEZIONE WORKOUT ARCHIVIATI
if (archivedWorkouts.length > 0) {
    list.innerHTML += `<h3 class="p-3 rounded-xl shadow-sm font-bold text-lg mb-3 flex items-center justify-center gap-2 text-center " style="margin-top:50px !important;">
       üóÉÔ∏è Workout Archiviati
    </h3>`;
    
    archivedWorkouts.forEach(w => {
        const el = document.createElement('div');
        el.className = 'bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm flex justify-between items-center transform transition active:scale-98 opacity-60';

el.innerHTML = `
    <div class="flex items-center gap-3 flex-1">
        <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0 opacity-50" 
             style="background: ${w.color || '#5127f2'}">
            <i class="hgi hgi-stroke ${w.icon || 'hgi-dumbbell-01'} text-2xl text-white"></i>
        </div>
        <div onclick="app.handlers.openWorkoutEditor('${w.id}')" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2">
                
                <h4 class="font-bold text-md">${w.name}</h4>
            </div>
                <p class="text-xs text-gray-400">${w.exercises.length} Esercizi${(() => {
    const estimatedTime = Math.round(w.exercises.reduce((acc,e) => acc + ((parseInt(e.sets) - 1) * parseInt(e.rest)) / 60 + parseInt(e.sets), 0));
    return isNaN(estimatedTime) || estimatedTime === 0 ? '' : ' ‚Ä¢ ' + estimatedTime + ' min stimati';
})()}</p>
            </div>
        `;
        list.appendChild(el);
    });
}

},
				 
				 
				 
	     renderEditorPreferredDays: () => {
    const container = document.getElementById('editor-preferred-days');
    const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const selected = app.state.editingWorkout.preferredDays || [];
    
    container.innerHTML = days.map((day, idx) => `
        <label class="flex border border-gray-500/80 flex-col items-center  bg-gray-800 rounded-lg p-2 cursor-pointer hover:bg-gray-700 ${selected.includes(idx) ? 'ring-2 ' : ''}">
            <input type="checkbox" class="editor-day-check mb-1" value="${idx}" ${selected.includes(idx) ? 'checked' : ''}>
            <span class="text-xs">${day}</span>
        </label>
    `).join('');
    
    // Event listeners
    document.querySelectorAll('.editor-day-check').forEach(cb => {
        cb.addEventListener('change', () => {
            const checked = Array.from(document.querySelectorAll('.editor-day-check:checked')).map(c => parseInt(c.value));
            app.state.editingWorkout.preferredDays = checked;
        });
    });
},

showBadgeNotification: () => {
    const container = document.getElementById('badge-notification');
    if (!container || app.state.pendingBadges.length === 0) return;
    
    const badgeId = app.state.pendingBadges[0];
    const badge = app.state.badgeDefinitions[badgeId];
    
    container.innerHTML = `
        <div class="bg-gradient-to-r from-purple-600 to-primary rounded-2xl p-5 text-white shadow-2xl badge-appear relative">
            <button onclick="app.handlers.dismissBadge()" class="absolute top-3 right-3 text-white/80 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <div class="flex items-center gap-4">
                <img src="${badge.icon}" alt="${badge.name}" style="max-width: 90px;">
                <div class="flex-1">
                    <div class="text-xs opacity-90 uppercase tracking-wider font-semibold">Traguardo Sbloccato!</div>
                    <h3 class="text-xl font-bold mt-1">${badge.name}</h3>
                    <p class="text-sm opacity-90 mt-1">${badge.desc}</p>
                </div>
            </div>
        </div>
    `;
    
    container.classList.remove('hidden');
    
    // Sound & Vibrate
    if (app.state.settings.sound) {
        document.getElementById('audio-complete').play().catch(e => {});
    }
    if (app.state.settings.vibrate && navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
},

renderBadges: () => {
    const container = document.getElementById('badges-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (const [id, def] of Object.entries(app.state.badgeDefinitions)) {
        const data = app.state.badges[id];
        const unlocked = data.count > 0;
        
        const badgeEl = document.createElement('div');
        badgeEl.className = `bg-darkCard rounded-2xl p-5 flex items-center gap-4 shadow-lg transition-all ${unlocked ? 'border-2 border-primary' : 'opacity-90'}`;
        
        badgeEl.innerHTML = `
            <div class="relative flex-shrink-0">
                <img src="${def.icon}" alt="${def.name}" class="w-20 rounded-xl ${unlocked ? 'shadow-lg' : 'badge-icon-locked'}">
                ${data.count > 1 ? `
                    <span class="absolute -top-2 -right-2 bg-gradient-to-br from-purple-400 to-white-500 text-white text-sm font-bold px-2.5 py-1 rounded-full shadow-lg border-2 border-white">
                        √ó${data.count}
                    </span>
                ` : ''}
                ${unlocked ? `
                    <div class="absolute -bottom-1 -right-1 bg-green-500 rounded-full p-1.5 border-2 border-darkCard">
                        <i class="fa-solid fa-check text-white text-xs"></i>
                    </div>
                ` : `
                    <div class="absolute -bottom-1 -right-1 bg-gray-700 rounded-full p-1.5 border-2 border-darkCard">
                        <i class="fa-solid fa-lock text-gray-500 text-xs"></i>
                    </div>
                `}
            </div>
            <div class="flex-1 min-w-0">
                <h4 class="font-bold text-lg ${unlocked ? 'text-white' : 'text-gray-500'} truncate">${def.name}</h4>
                <p class="text-sm ${unlocked ? 'text-gray-300' : 'opacity-50'} mt-1 line-clamp-3">${def.desc}</p>
                ${unlocked && data.lastUnlocked ? `
                    <div class="flex items-center gap-1 mt-2 text-xs ">
                        <i class="fa-solid fa-calendar-check"></i>
                        <span>Ultimo: ${new Date(data.lastUnlocked).toLocaleDateString('it-IT', {day: 'numeric', month: 'short', year: 'numeric'})}</span>
                    </div>
                ` : `
                    <div class="flex items-center gap-1 mt-2 text-xs text-gray-600">
                        <i class="fa-solid fa-lock"></i>
                        <span>Non ancora sbloccato</span>
                    </div>
                `}
            </div>
        `;
        
        container.appendChild(badgeEl);
    }
},
         
         renderEditorExercises: () => {
         const container = document.getElementById('editor-exercises-list');
         container.innerHTML = '';
         
if (app.state.editingWorkout.exercises.length === 0) {
  // Nessun esercizio
  container.innerHTML = `
    <div class="text-center py-8">
      <i class="fa-solid fa-dumbbell text-gray-600 text-4xl mb-3"></i>
      <p class="text-gray-400">Nessun esercizio aggiunto</p>
      <p class="text-gray-500 text-sm mt-1">Aggiungi il primo esercizio per iniziare</p>
    </div>
  `;
} else if (app.state.editingWorkout.exercises.length === 1) {
  // Un solo esercizio - nessuna intestazione
  container.innerHTML = `
    <div class="mb-4 pb-3 border-b border-gray-700">
      <h3 class="text-lg font-bold text-white">Esercizi</h3>
    </div>
  `;
} else {
  // 2 o pi√π esercizi - mostra intestazione con drag
  container.innerHTML = `
    <div class="mb-4 mt-5 pb-3 border-b border-gray-700">
      <h3 class="text-lg font-bold text-white text-center"><i class="fa-solid fa-list-check"></i> Esercizi</h3>
      <p class="text-sm text-gray-400 text-center"><i class="fa-solid fa-arrows-up-down"></i> Riordina gli esercizi trascinandoli</p>
    </div>
  `;
}
         
         app.state.editingWorkout.exercises.forEach((ex, idx) => {
         const el = document.createElement('div');
         el.className = ' bg-gray-800 p-3 rounded-lg flex justify-between items-center group touch-manipulation';
         el.innerHTML = `
<div class="flex items-center gap-4 flex-1 overflow-hidden">
  <i class="fa-solid fa-grip-lines text-gray-400 cursor-move text-xl"></i>
  <div class="overflow-hidden">
    <div class="font-bold text-sm">${ex.name}</div>
    <div class="text-xs text-gray-400">${ex.sets} x ${ex.reps} ‚Ä¢ ${ex.rest}s${ex.isDouble ? ' ‚Ä¢ 2x' : ''}</div>
  </div>
</div>

<div class="flex items-center gap-2">
<button onclick="app.handlers.editExercise(${idx})" class="bg-primary/20 text-white hover:bg-primary hover:text-white px-3.5 py-2.5 rounded-lg font-semibold text-sm transition-all active:scale-95 flex items-center gap-2 border border-primary/30">
	<i class="fa-solid fa-pencil"></i>
	<span class="hidden sm:inline">Modifica</span>
</button>
<button onclick="app.handlers.removeExercise(${idx})" class="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-all active:scale-95 flex items-center gap-2 border border-red-500/30">
	<i class="fa-solid fa-times"></i>
	<span class="hidden sm:inline">Elimina</span>
</button>
</div>
`;
         container.appendChild(el);
         });
         
         // Init Sortable (rimane uguale)
         if (app.sortable) app.sortable.destroy();
         app.sortable = new Sortable(container, {
         animation: 150,
         handle: '.fa-grip-lines',
         ghostClass: 'sortable-ghost',
         onEnd: (evt) => {
         const item = app.state.editingWorkout.exercises.splice(evt.oldIndex, 1)[0];
         app.state.editingWorkout.exercises.splice(evt.newIndex, 0, item);
         }
         });
         },
         
                 updateActiveView: () => {
                     const session = app.state.activeSession;
                     if(!session) return;
                     
                     const ex = session.workout.exercises[session.currentExIdx];
					 
					 
                     
                     // Texts
                     document.getElementById('active-workout-name').innerText = session.workout.name;
                     document.getElementById('active-exercise-name').innerText = ex.name;
                     document.getElementById('active-set-display').innerText = `Serie ${session.currentSet + 1} / ${ex.sets}`;
                     document.getElementById('active-target-display').innerText = `${ex.reps} Reps`;
                     document.getElementById('active-weight-value').innerText = ex.lastWeight || 0;
					 
					     // ‚úÖ MOSTRA IL DELTA SE ESISTE
const kgLabel = document.querySelector('#active-weight-value + span');
if (kgLabel) {
    kgLabel.innerHTML = 'kg';
    
    if (session.weightDelta && Math.abs(session.weightDelta) > 0) {
        const deltaColor = session.weightDelta > 0 ? 'text-green-400' : 'text-orange-400';
        const deltaSign = session.weightDelta > 0 ? '+' : '';
        
        // Calcola percentuale
		const percentChange = session.lastSavedWeight > 0 
            ? ((session.weightDelta / session.lastSavedWeight) * 100).toFixed(0)
            : 0;
        
        const percentText = Math.abs(percentChange) > 0 
            ? ` <span class="text-xs opacity-75">(${percentChange > 0 ? '+' : ''}${percentChange}%)</span>` 
            : '';
        
        kgLabel.innerHTML = `kg <span class="${deltaColor} animate-pulse">${deltaSign}${session.weightDelta}${percentText}</span>`;
    }
}
                     
         // Progress Bar
         // Progress Bar
         const totalExercises = session.workout.exercises.length;
         const currentExercise = session.currentExIdx + 1;
         document.getElementById('active-exercise-count').innerText = `Esercizio: ${currentExercise}/${totalExercises}`;
         
         const totalSets = session.workout.exercises.reduce((acc, e) => acc + parseInt(e.sets), 0);
         const completedSets = session.workout.exercises.slice(0, session.currentExIdx).reduce((acc,e) => acc + parseInt(e.sets), 0) + session.currentSet;
         const pct = (completedSets / totalSets) * 100;
         document.getElementById('active-progress-bar').style.width = `${pct}%`;
         
         // Previous and Next Exercise Display
         const prevEl = document.getElementById('prev-exercise');
         const nextEl = document.getElementById('next-exercise');
         
         if (session.currentExIdx > 0) {
         const prevEx = session.workout.exercises[session.currentExIdx - 1];
         prevEl.innerHTML = `<i class="fa-solid fa-check text-green-500 mr-1"></i><span>${prevEx.name}</span>`;
         } else {
         prevEl.innerHTML = `<i class="fa-solid fa-check text-gray-700 mr-1"></i><span>Inizio</span>`;
         }
         
         if (session.currentExIdx < session.workout.exercises.length - 1) {
         const nextEx = session.workout.exercises[session.currentExIdx + 1];
         nextEl.innerHTML = `<span>${nextEx.name}</span><i class="fa-solid fa-arrow-right ml-1"></i>`;
         } else {
         nextEl.innerHTML = `<span>Fine!</span><i class="fa-solid fa-flag-checkered ml-1"></i>`;
         }
         
                     // Button State
                     const btn = document.getElementById('btn-main-action');
                     const restOverlay = document.getElementById('rest-overlay');
                     
         
         
         const workOverlay = document.getElementById('work-overlay'); // AGGIUNGI QUESTA RIGA
         
         if (session.status === 'rest') {
// ‚úÖ CONTROLLA SE √à L'ULTIMA PAUSA DELL'ESERCIZIO
    const ex = session.workout.exercises[session.currentExIdx];
    const isLastSet = session.currentSet === ex.sets - 1;
    const isLastExercise = session.currentExIdx === session.workout.exercises.length - 1;
    
    if (isLastSet && !isLastExercise) {
        // Ultima pausa di questo esercizio, ma ci sono altri esercizi
        btn.innerHTML = `<i class="fa-solid fa-arrow-right"></i> <span>Prossimo Esercizio</span>`;
    } else if (isLastSet && isLastExercise) {
        // Ultima pausa dell'ultimo esercizio
        btn.innerHTML = `<i class="fa-solid fa-flag-checkered"></i> <span>Termina Workout</span>`;
    } else {
        // Pausa normale tra serie
        btn.innerHTML = `<i class="fa-solid fa-forward"></i> <span>Salta Pausa</span>`;
    }
    
    btn.classList.replace('bg-primary', 'bg-gray-600');
    btn.onclick = app.handlers.skipRest;
    restOverlay.classList.remove('hidden');
    restOverlay.classList.add('flex');
    workOverlay.classList.add('hidden');
    workOverlay.classList.remove('flex');
         } else {
         btn.innerHTML = `<i class="fa-solid fa-check"></i> <span>Serie Completata</span>`;
         btn.classList.replace('bg-gray-600', 'bg-primary');
         btn.onclick = app.handlers.completeSet;
         restOverlay.classList.add('hidden');
         restOverlay.classList.remove('flex');
         workOverlay.classList.remove('hidden');     // AGGIUNGI
         workOverlay.classList.add('flex');          // AGGIUNGI
         }
         
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
		 
        
const currentEx = session.workout.exercises[session.currentExIdx];
const sets = parseInt(currentEx.sets);
const totalSegments = sets * 2; 

const container = document.getElementById('progress-bar-container');
container.innerHTML = '';
// Aggiungiamo classi al contenitore per gestire i bordi arrotondati e l'overflow
container.className = "flex h-4 w-full bg-gray-800 rounded-full overflow-hidden gap-0.5 p-0.5";

const currentStep = session.currentSet * 2 + (session.status === 'rest' ? 1 : 0);

for (let step = 0; step < totalSegments; step++) {
    const isSet = step % 2 === 0;
    const isPast = step < currentStep;
    const isCurrent = step === currentStep;
    
    const segment = document.createElement('div');
    segment.style.flex = isSet ? '2' : '1'; // Le serie sono pi√π larghe delle pause
    segment.className = 'h-full transition-all duration-500 relative overflow-hidden';

    if (isSet) {
        // --- üü¢ STILE SERIE (WORK) ---
        if (isPast) {
            segment.classList.add('bg-violet-500');
            segment.innerHTML = `<div class="flex items-center justify-center h-full"><!-- <i class="fa-solid fa-check text-[7px] text-white/80"></i>--></div>`;
        } else if (isCurrent) {
            segment.classList.add('bg-violet-400', 'animate-pulse', 'shadow-[0_0_8px_rgba(167,139,250,0.6)]');
        } else {
            segment.classList.add('bg-gray-700');
        }
    } else {
        // --- ‚òï STILE PAUSA (REST) ---
        if (isCurrent && session.status === 'rest') {
            const restDuration = parseInt(currentEx.rest);
            const restEl = document.getElementById('rest-timer-text');
            const timeLeftMatch = restEl?.innerText.match(/(\d+):(\d+)/);
            
            let percentComplete = 0;
            if (timeLeftMatch) {
                const timeLeft = parseInt(timeLeftMatch[1]) * 60 + parseInt(timeLeftMatch[2]);
                percentComplete = ((restDuration - timeLeft) / restDuration) * 100;
            }

            segment.classList.add('bg-gray-800');
            segment.innerHTML = `
                <div id="rest-progress-fill" class="h-full bg-emerald-400 transition-all duration-1000 ease-linear" 
                     style="width: ${percentComplete}%">
                </div>`;
            session.restProgressSegment = segment;
        } else if (isPast) {
            segment.classList.add('bg-violet-500'); // Verde spento per pause passate
        } else {
            segment.classList.add('bg-gray-800/50');
        }
    }
    
    container.appendChild(segment);
}








		 
		 
		 
		 
    const notesContainer = document.getElementById('exercise-notes-container');
    const notesContent = document.getElementById('exercise-notes-content');
    
    if (ex.notes && ex.notes.trim()) {
        notesContainer.classList.remove('hidden');
        notesContent.innerHTML = ex.notes.replace(/\n/g, '<br>');
        notesContent.classList.add('hidden'); // Chiuso di default
        document.getElementById('notes-chevron').classList.replace('fa-chevron-up', 'fa-chevron-down');
    } else {
        notesContainer.classList.add('hidden');
    }
	
	app.updateWeightComparison();
	
	// Applica visibilit√† frasi motivazionali
    const motivationalDiv = document.querySelector('.frasi-motivazionali');
    if (motivationalDiv) {
        motivationalDiv.style.display = app.state.settings.motivational !== false ? 'block' : 'none';
    }
},
                 
                 renderStats: () => {

// ‚úÖ FORZA RELOAD DEI DATI (sicurezza)
    if (app.state.history.length === 0) {
        console.warn('‚ö†Ô∏è History vuota - tento reload');
        setTimeout(() => {
            app.loadData().then(() => app.ui.renderStats());
        }, 100);
        return;
    }

				 // Logic to build Chart.js
                     const history = app.state.history;
                     const ctxVol = document.getElementById('chart-volume').getContext('2d');
                     const ctxCon = document.getElementById('chart-consistency').getContext('2d');
         
                     if(window.chartVol) window.chartVol.destroy();
                     if(window.chartCon) window.chartCon.destroy();
         
                     // Data Prep
                     // Volume Last 7 Workouts
                     const lastLogs = history.slice(-7);
                     window.chartVol = new Chart(ctxVol, {
                         type: 'bar',
                         data: {
                             labels: lastLogs.map(l => new Date(l.date).toLocaleDateString(undefined, {weekday:'short'})),
                             datasets: [{ label: 'Volume (kg)', data: lastLogs.map(l => l.totalVolume), backgroundColor: '#5127f2', borderRadius: 4 }]
                         },
						 			 
						 
                         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
                     });
         
                     // Consistency (Last 12 months count)
                     // Simplified: Just workouts per month
                     const monthCounts = {};
                     history.forEach(h => {
                         const k = new Date(h.date).toLocaleDateString(undefined, {month:'short'});
                         monthCounts[k] = (monthCounts[k] || 0) + 1;
                     });
                     
                     window.chartCon = new Chart(ctxCon, {
                         type: 'line',
                         data: {
                             labels: Object.keys(monthCounts),
                             datasets: [{ label: 'Sessioni', data: Object.values(monthCounts), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }]
                         },
                         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: {stepSize: 1} } } }
                     });
         
         // Calories Chart
         
         const ctxCal = document.getElementById('chart-calories');
         if (!ctxCal) return; // Safety check
         const ctxCalContext = ctxCal.getContext('2d');
         if(window.chartCal) window.chartCal.destroy();
         
         const logsWithCalories = lastLogs.filter(l => l.caloriesBurned && l.caloriesBurned > 0);
         if (logsWithCalories.length > 0) {
         window.chartCal = new Chart(ctxCalContext, {
         type: 'line',
         data: {
             labels: logsWithCalories.map(l => new Date(l.date).toLocaleDateString(undefined, {weekday:'short'})),
             datasets: [{ 
                 label: 'Calorie', 
                 data: logsWithCalories.map(l => l.caloriesBurned), 
                 borderColor: '#f97316', 
                 backgroundColor: 'rgba(249, 115, 22, 0.1)',
                 tension: 0.4, 
                 fill: true 
             }]
         },
         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
         });
         } else {
         // Show message if no calorie data
         const container = ctxCal.parentElement;
         container.innerHTML = '<div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Calorie Bruciate (kcal)</h3><p class="text-gray-400 text-center py-8 text-sm">üí° Imposta peso corporeo nelle impostazioni per vedere le calorie</p></div>';
         }
         
         // Calcolo totali storici
         let totalHistoricalCal = 0;
         history.forEach(h => {
         const cal = parseFloat(h.caloriesBurned);
         if (!isNaN(cal)) totalHistoricalCal += cal;
         });
         const totalFatGrams = Math.round((totalHistoricalCal / 7500) * 1000);
         
         document.getElementById('total-calories').innerText = Math.round(totalHistoricalCal).toLocaleString();
         document.getElementById('total-fat-burned').innerText = totalFatGrams.toLocaleString();
         
                     // List
// List with period grouping
const list = document.getElementById('history-list');

// Funzione helper per raggruppare per periodi
const groupByPeriod = (historyArray) => {
    const now = new Date();
    const groups = {
        thisWeek: [],
        lastWeek: [],
        months: {}
    };
    
    // Calcola inizio settimana corrente (luned√¨)
    const thisWeekStart = new Date(now);
    const dayOfWeek = now.getDay();
    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    thisWeekStart.setDate(now.getDate() + diff);
    thisWeekStart.setHours(0, 0, 0, 0);
    
    // Calcola inizio settimana scorsa
    const lastWeekStart = new Date(thisWeekStart);
    lastWeekStart.setDate(lastWeekStart.getDate() - 7);
    
    historyArray.forEach(h => {
        const date = new Date(h.date);
        
        if (date >= thisWeekStart) {
            groups.thisWeek.push(h);
        } else if (date >= lastWeekStart) {
            groups.lastWeek.push(h);
        } else {
            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
            if (!groups.months[monthKey]) {
                groups.months[monthKey] = {
                    date: date,
                    workouts: []
                };
            }
            groups.months[monthKey].workouts.push(h);
        }
    });
    
    return groups;
};

// Funzione per renderizzare un singolo workout
const renderWorkoutCard = (h, index, isFirstInGroup = false) => {
    const date = new Date(h.date);
	const isToday = date.toDateString() === new Date().toDateString();
	const isYesterday = date.toDateString() === new Date(Date.now() - 86400000).toDateString();

	// ‚úÖ DETERMINA COLORE PALLINO IN BASE A VALIDIT√Ä
	const isValid = h.isValid !== false; // Considera validi anche i vecchi workout
	const statusDot = isValid ? 'üü¢' : 'üî¥';

	let dateLabel;
	if (isToday) {
		dateLabel = `${statusDot} Oggi`;
	} else if (isYesterday) {
		dateLabel = `${statusDot} Ieri`;
	} else {
		dateLabel = `${statusDot} ${date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' })}`;
	}
    
    const timeLabel = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    
    // Verifica se il workout √® archiviato
const workout = app.state.workouts.find(w => w.id === h.workoutId);
const isArchived = workout && workout.archived;

return `
    <div class="bg-darkCard rounded-xl p-4 ${isToday ? 'border-green-500' : 'border-primary'} shadow-sm hover:shadow-md transition-all relative">
        <!-- Delete Button -->
        <button 
            onclick="app.handlers.deleteHistoryItem('${h.id}')" 
            class="absolute top-3 right-3 bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-3 py-2 rounded-lg text-xs transition-all active:scale-95 border border-red-500/30"
            title="Elimina questo allenamento"
        >
            <i class="fa-solid fa-trash"></i>
        </button>
        <div class="flex items-center justify-between mb-3 pr-10">
<div class="flex items-center gap-2">
    ${(() => {
        const workout = app.state.workouts.find(w => w.id === h.workoutId);
        if (!workout) return '';
        return `
            <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0" 
                 style="background: ${workout.color || '#5127f2'}">
                <i class="hgi hgi-stroke ${workout.icon || 'hgi-dumbbell-01'} text-sm text-white"></i>
            </div>
        `;
    })()}
    <div>
        <h4 class="font-bold text-white">${h.workoutName}${isArchived ? ' <span class="text-xs text-gray-500">(Archiviato)</span>' : ''}</h4>
                        <div class="flex items-center gap-2 text-xs text-gray-400 mt-0.5">
                            <i class="fa-regular fa-calendar"></i>
                            <span>${dateLabel}</span>
                            <span class="text-gray-600">‚Ä¢</span>
                            <i class="fa-regular fa-clock"></i>
                            <span>${timeLabel}</span>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <div class="bg-gray-900/50 rounded-lg p-2 text-center">
                    <div class="text-xs text-gray-400 mb-1">Volume</div>
                    <div class="font-bold flex items-center justify-center gap-1">
                        <i class="fa-solid fa-weight-hanging text-xs"></i>
                        <span>${Math.round(h.totalVolume).toLocaleString()}</span>
                        <span class="text-xs">kg</span>
                    </div>
                </div>
                
                ${h.caloriesBurned ? `
                    <div class="bg-gray-900/50 rounded-lg p-2 text-center">
                        <div class="text-xs text-gray-400 mb-1">Calorie</div>
                        <div class="font-bold text-orange-500 flex items-center justify-center gap-1">
                            <i class="fa-solid fa-fire text-xs"></i>
                            <span>${Math.round(h.caloriesBurned).toLocaleString()}</span>
                        </div>
                    </div>
                ` : `
                    <div class="bg-gray-900/50 rounded-lg p-2 text-center opacity-50">
                        <div class="text-xs text-gray-400 mb-1">Calorie</div>
                        <div class="font-bold text-gray-600 text-xs">N/D</div>
                    </div>
                `}
                
                <div class="bg-gray-900/50 rounded-lg p-2 text-center">
                    <div class="text-xs text-gray-400 mb-1">Durata</div>
                    <div class="font-bold text-blue-400 flex items-center justify-center gap-1">
                        <i class="fa-solid fa-stopwatch text-xs"></i>
                        <span>${h.durationMinutes || 0}</span>
                        <span class="text-xs">min</span>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// Raggruppa i dati
const grouped = groupByPeriod(history.slice().reverse());
let html = '';
// Questa settimana
if (grouped.thisWeek.length > 0) {
    html += `
        <div class="mb-6 mt-6">
            <h3 class="text-sm font-bold uppercase tracking-wider text-purple-300 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-calendar-week"></i>
                Questa Settimana
            </h3>
            <div class="space-y-3">
                ${grouped.thisWeek.map((h, i) => renderWorkoutCard(h, i, i === 0)).join('')}
            </div>
        </div>
    `;
}
// Settimana scorsa
if (grouped.lastWeek.length > 0) {
    html += `
        <div class="mb-6 mt-6">
            <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-calendar-week"></i>
                Settimana Scorsa
            </h3>
            <div class="space-y-3">
                ${grouped.lastWeek.map((h, i) => renderWorkoutCard(h, i)).join('')}
            </div>
        </div>
    `;
}
// Mesi precedenti
const monthKeys = Object.keys(grouped.months).sort((a, b) => {
    const [yearA, monthA] = a.split('-').map(Number);
    const [yearB, monthB] = b.split('-').map(Number);
    if (yearA !== yearB) return yearB - yearA;
    return monthB - monthA;
});
monthKeys.forEach(key => {
    const monthData = grouped.months[key];
    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const monthLabel = `${monthNames[monthData.date.getMonth()]} ${monthData.date.getFullYear()}`;
    
    html += `
        <div class="mb-6 mt-6">
            <h3 class="text-sm font-bold uppercase tracking-wider mt-10 text-gray-500 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-calendar"></i>
                ${monthLabel}
            </h3>
            <div class="space-y-3">
                ${monthData.workouts.map((h, i) => renderWorkoutCard(h, i)).join('')}
            </div>
        </div>
    `;
});
// Se non c'√® storico
if (html === '') {
    html = `
        <div class="text-center py-12 text-gray-400">
            <i class="fa-solid fa-clock-rotate-left text-5xl mb-4 opacity-50"></i>
            <p class="text-lg font-semibold">Nessun allenamento completato</p>
            <p class="text-sm mt-2">Inizia un workout per vedere lo storico!</p>
        </div>
    `;
}
list.innerHTML = html;
 app.handlers.switchStatsTab('history');
                 },
				 
				 renderProgress: () => {
    const container = document.getElementById('progress-workouts-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (app.state.workouts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12 text-gray-400">
                <i class="fa-solid fa-dumbbell text-5xl mb-4 opacity-50"></i>
                <p class="text-lg font-semibold">Nessun workout salvato</p>
            </div>
        `;
        return;
    }
    
    // Per ogni workout attivo
    app.state.workouts.forEach(workout => {
        // Trova tutti gli allenamenti completati per questo workout
        const workoutHistory = app.state.history
            .filter(h => h.workoutId === workout.id)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (workoutHistory.length === 0) {
            return; // Skip workout mai fatto
        }
        
        // Calcola statistiche temporali
        const firstDate = new Date(workoutHistory[0].date);
        const lastDate = new Date(workoutHistory[workoutHistory.length - 1].date);
        const daysPassed = Math.floor((Date.now() - firstDate) / (1000 * 60 * 60 * 24));
        const totalSessions = workoutHistory.length;
        
        // Raggruppa dati per esercizio
        const exerciseData = {};
        
        workoutHistory.forEach(session => {
            if (!session.logs) return;
            
            session.logs.forEach(log => {
                if (!exerciseData[log.exercise]) {
                    exerciseData[log.exercise] = {
                        weights: [],
                        dates: [],
                        sets: [],
                        reps: []
                    };
                }
                
                exerciseData[log.exercise].weights.push({
                    date: new Date(session.date),
                    weight: parseFloat(log.weight) * (log.multiplier || 1)
                });
                
                if (log.sets) exerciseData[log.exercise].sets.push(log.sets);
                if (log.targetReps) exerciseData[log.exercise].reps.push(log.targetReps);
            });
        });
        
        // Genera HTML per questo workout
        const workoutCard = document.createElement('div');
        workoutCard.className = 'bg-darkCard rounded-2xl p-5 shadow-lg mb-6';
        
workoutCard.innerHTML = `
    <div class="cursor-pointer" onclick="app.handlers.toggleProgressAccordion('${workout.id}')">
        <h3 class="text-l font-bold text-white flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0" 
                     style="background: ${workout.color || '#5127f2'}">
                    <i class="hgi hgi-stroke ${workout.icon || 'hgi-dumbbell-01'} text-xl text-white"></i>
                </div>
                <div class="flex items-center gap-2">
                    ${workout.archived ? '<i class="fa-solid fa-box-archive text-gray-500 text-sm"></i>' : ''}
                    <span>${workout.name}${workout.archived ? ' <span class="text-xs text-gray-400 font-normal">(Archiviato)</span>' : ''}</span>
                </div>
            <i class="fa-solid fa-chevron-down text-gray-400 ml-4 transition-transform duration-300" id="chevron-${workout.id}"></i>
        </h3>
		 <div id="progress-content-${workout.id}" class="hidden">
		 
                <div class="grid grid-cols-2 gap-3 mt-3 text-sm bg-gray-900/50 rounded-xl mb-4 p-4 border border-gray-700/50">
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-gray-400 text-xs mb-1">Prima volta del tuo workout</div>
                        <div class="font-bold text-white">
                            ${firstDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}
                        </div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-gray-400 text-xs mb-1">Giorni passati dal primo workout</div>
                        <div class="font-bold text-purple-300">${daysPassed} giorni</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-gray-400 text-xs mb-1">Sessioni totali del tuo workout</div>
                        <div class="font-bold text-green-400">${totalSessions}x</div>
                    </div>
                    <div class="bg-gray-800/50 rounded-lg p-3">
                        <div class="text-gray-400 text-xs mb-1">Ultima volta del tuo workout</div>
                        <div class="font-bold text-white">
                            ${lastDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })}
                        </div>
                    </div>
                </div>
           
            
            <div class="space-y-4">
                ${Object.entries(exerciseData).map(([exerciseName, data]) => {
                    // Calcola progressi
                    const avgWeights = [];
                    const dates = [];
                    
                    // Raggruppa per data (media dei pesi)
                    const weightsByDate = {};
                    data.weights.forEach(w => {
                        const dateKey = w.date.toLocaleDateString('it-IT');
                        if (!weightsByDate[dateKey]) {
                            weightsByDate[dateKey] = [];
                        }
                        weightsByDate[dateKey].push(w.weight);
                    });
                    
                    Object.entries(weightsByDate).forEach(([date, weights]) => {
                        dates.push(date);
                        avgWeights.push((weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1));
                    });
                    
                    const firstWeight = parseFloat(avgWeights[0]);
                    const lastWeight = parseFloat(avgWeights[avgWeights.length - 1]);
                    const improvement = lastWeight - firstWeight;
                    const improvementPct = firstWeight > 0 ? ((improvement / firstWeight) * 100).toFixed(1) : 0;
                    
                    // Variazioni sets/reps
                    const uniqueSets = [...new Set(data.sets)];
                    const uniqueReps = [...new Set(data.reps)];
                    const setsChanged = uniqueSets.length > 1;
                    const repsChanged = uniqueReps.length > 1;
                    
                    return `
                        <div class="bg-gray-800/30 rounded-xl p-4 border border-gray-700/50">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h4 class="font-bold text-white text-sm">${exerciseName}</h4>
                                    <div class="flex items-center gap-2 mt-1 text-xs">
                                        ${setsChanged ? '<span class="bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">Serie variate</span>' : ''}
                                        ${repsChanged ? '<span class="bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">Reps variate</span>' : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400">Progresso</div>
                                    <div class="font-bold ${improvement > 0 ? 'text-green-400' : improvement < 0 ? 'text-red-400' : 'text-gray-400'}">
                                        ${improvement > 0 ? '+' : ''}${improvement.toFixed(1)}kg
                                        ${improvementPct != 0 ? `<span class="text-xs opacity-75">(${improvementPct > 0 ? '+' : ''}${improvementPct}%)</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-900/50 rounded-lg p-3">
                                <canvas id="chart-progress-${workout.id}-${exerciseName.replace(/\s+/g, '-')}" height="80"></canvas>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mt-3 text-xs">
                                <div class="bg-gray-900/30 rounded p-2 text-center">
                                    <div class="text-gray-500">Primo</div>
                                    <div class="font-bold text-white">${firstWeight}kg</div>
                                </div>
                                <div class="bg-gray-900/30 rounded p-2 text-center">
                                    <div class="text-gray-500">Ultimo</div>
                                    <div class="font-bold text-purple-300">${lastWeight}kg</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
             </div>
        </div>
        `;
        
        container.appendChild(workoutCard);
        
        // Crea i grafici
        Object.entries(exerciseData).forEach(([exerciseName, data]) => {
            const canvasId = `chart-progress-${workout.id}-${exerciseName.replace(/\s+/g, '-')}`;
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) return;
            
            const avgWeights = [];
            const dates = [];
            
            const weightsByDate = {};
            data.weights.forEach(w => {
                const dateKey = w.date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
                if (!weightsByDate[dateKey]) {
                    weightsByDate[dateKey] = [];
                }
                weightsByDate[dateKey].push(w.weight);
            });
            
            Object.entries(weightsByDate).forEach(([date, weights]) => {
                dates.push(date);
                avgWeights.push((weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1));
            });
            
            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Peso (kg)',
                        data: avgWeights,
                        borderColor: '#5127f2',
                        backgroundColor: 'rgba(81, 39, 242, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#5127f2',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.parsed.y} kg`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#9ca3af',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        });
    });

},
				 
				 // ‚ú®‚ú®‚ú® AGGIUNGI QUESTA FUNZIONE QUI ‚ú®‚ú®‚ú®
showWorkoutSummaryModal: (stats) => {
    const modal = document.createElement('div');
    modal.id = 'workout-summary-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm';
    modal.style.animation = 'fadeInOnly 0.3s ease-in-out';
    
    modal.innerHTML = `
    <div class="bg-gradient-to-br from-darkCard to-gray-900 rounded-3xl w-full max-w-md shadow-2xl border-2 border-primary/30 flex flex-col max-h-[90vh]" style="animation: beastShake 0.5s ease-out">
        
        <!-- ‚úÖ HEADER FISSO -->
        <div class="bg-gradient-to-r from-primary to-purple-600 p-6 text-center relative overflow-hidden rounded-3xl flex-shrink-0">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
            <div class="relative z-10">
                <h2 class="text-2xl font-bold text-white">Ottimo Lavoro!</h2>
                <p class="text-white/90 mt-2">Allenamento Completato</p>
            </div>
        </div>
        
        <!-- ‚úÖ CONTENUTO SCROLLABILE -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4 hide-scrollbar">
            <h3 class="text-center text-gray-400 text-sm uppercase tracking-wider mb-4">Ecco il tuo riepilogo:</h3>
            
            <!-- Volume -->
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-primary/20 rounded-xl p-3">
                            <i class="fa-solid fa-weight-hanging text-primary text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 uppercase">Volume Totale</div>
                            <div class="text-2xl font-bold text-white">${stats.volume.toLocaleString()}<span class="text-sm text-gray-400 ml-1">kg</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Durata Totale -->
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500/20 rounded-xl p-3">
                            <i class="fa-solid fa-clock text-blue-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 uppercase">Durata Totale</div>
                            <div class="text-2xl font-bold text-white">${stats.totalDuration}<span class="text-sm text-gray-400 ml-1">min</span></div>
                            <div class="text-xs text-gray-500 mt-0.5">Esercizi + Pause</div>
                        </div>
                    </div>
                </div>
            </div>
			
			
            
            <!-- Durata Effettiva -->
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-500/20 rounded-xl p-3">
                            <i class="fa-solid fa-stopwatch text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 uppercase">Durata Effettiva</div>
                            <div class="text-2xl font-bold text-white">${stats.effectiveDuration}<span class="text-sm text-gray-400 ml-1">min</span></div>
                            <div class="text-xs text-gray-500 mt-0.5">Solo Esercizi</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calorie -->
            ${stats.calories > 0 ? `
                <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-500/20 rounded-xl p-3">
                                <i class="fa-solid fa-fire text-orange-400 text-xl"></i>
                            </div>
                            <div>
                                <div class="text-xs text-gray-400 uppercase">Calorie Bruciate</div>
                                <div class="text-2xl font-bold text-white">${stats.calories}<span class="text-sm text-gray-400 ml-1">kcal</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="bg-gray-800/50 rounded-2xl p-3 border border-gray-700/50 opacity-60">
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <i class="fa-solid fa-info-circle"></i>
                        <span>Imposta peso corporeo nelle impostazioni per vedere le calorie</span>
                    </div>
                </div>
            `}
        </div>
        
        <!-- ‚úÖ FOOTER FISSO -->
        <div class="p-6 pt-4 border-t border-gray-700/50 flex-shrink-0">
            <button onclick="app.handlers.closeWorkoutSummary()" class="w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primaryDark hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                <i class="fa-solid fa-house"></i>
                Torna alla Home
            </button>
        </div>
    </div>
`;
    
    document.body.appendChild(modal);
}
				 
             },  // ‚Üê QUESTA √® LA CHIUSURA DI app.ui
			 
         
             handlers: {
                 // Editor Handlers
				createNewWorkout: () => {
					app.state.editingWorkout = {
						id: 'w_' + Date.now(),
						name: '',
						exercises: [],
						preferredDays: [],
						archived: false,
						icon: 'hgi-dumbbell-01',
						color: '#5127f2'
					};
                     document.getElementById('editor-name').value = '';
                     document.getElementById('btn-delete-workout').classList.add('hidden');
                     app.ui.renderEditorExercises();
					 app.ui.renderEditorPreferredDays();
                     app.router.go('editor');
                 },
         
openWorkoutEditor: (id) => {
    const w = app.state.workouts.find(w => w.id === id);
    app.state.editingWorkout = JSON.parse(JSON.stringify(w));
    document.getElementById('editor-name').value = w.name;
    document.getElementById('btn-delete-workout').classList.remove('hidden');
    app.ui.renderEditorExercises();
    app.ui.renderEditorPreferredDays();
    
    // ‚úÖ AGGIUNGI QUESTE RIGHE
const archivedCheckbox = document.getElementById('editor-archived');
if (archivedCheckbox) {
    archivedCheckbox.checked = w.archived || false;
}

// ‚úÖ Carica icona e colore
const iconPreview = document.getElementById('editor-icon-preview');
if (iconPreview && w.icon) {
    iconPreview.className = `hgi hgi-stroke ${w.icon} text-2xl text-white`;
}

const colorBtn = document.querySelector(`[data-color="${w.color || '#5127f2'}"]`);
if (colorBtn) {
    document.querySelectorAll('.workout-color-btn').forEach(btn => btn.classList.remove('selected'));
    colorBtn.classList.add('selected');
}

app.router.go('editor');
},     
         
         // --- Sostituisci addExerciseToEditor ---
         addExerciseToEditor: () => {
         app.state.editingExerciseIndex = null; // Stiamo creando, non modificando
         
         // Reset form
         document.getElementById('modal-ex-name').value = '';
         document.getElementById('modal-ex-sets').value = '';
         document.getElementById('modal-ex-reps').value = '';
         document.getElementById('modal-ex-rest').value = '60';
         document.getElementById('modal-ex-weight').value = '';
         document.getElementById('modal-ex-double').checked = false;
         document.getElementById('modal-ex-notes').value = '';
         
         // Cambia testo bottone
         document.querySelector('#exercise-modal button.bg-primary').innerText = "Aggiungi";
         
         document.getElementById('exercise-modal').classList.remove('hidden');
         document.getElementById('modal-ex-name').focus();
         },
         
         // --- AGGIUNGI QUESTA NUOVA FUNZIONE ---
         editExercise: (idx) => {
         app.state.editingExerciseIndex = idx; // Salviamo l'indice che stiamo modificando
         const ex = app.state.editingWorkout.exercises[idx];
         
         // Popola il form con i dati esistenti
         document.getElementById('modal-ex-name').value = ex.name;
         document.getElementById('modal-ex-sets').value = ex.sets;
         document.getElementById('modal-ex-reps').value = ex.reps;
         document.getElementById('modal-ex-rest').value = ex.rest;
         document.getElementById('modal-ex-weight').value = ex.lastWeight || 0;
         document.getElementById('modal-ex-double').checked = ex.isDouble || false;
         document.getElementById('modal-ex-notes').value = ex.notes || '';
         
         // Cambia testo bottone per chiarezza
         document.querySelector('#exercise-modal button.bg-primary').innerText = "Salva Modifiche";
         
         document.getElementById('exercise-modal').classList.remove('hidden');
         },
         
         // --- Sostituisci confirmAddExercise ---
         confirmAddExercise: () => {
         const name = document.getElementById('modal-ex-name').value;
         if(!name) return;
         
         const exerciseData = {
         name,
         sets: document.getElementById('modal-ex-sets').value,
         reps: document.getElementById('modal-ex-reps').value,
         rest: document.getElementById('modal-ex-rest').value,
         lastWeight: document.getElementById('modal-ex-weight').value,
         isDouble: document.getElementById('modal-ex-double').checked,
         notes: document.getElementById('modal-ex-notes').value || ''
         };
         
         if (app.state.editingExerciseIndex !== null) {
         // MODIFICA ESISTENTE
         app.state.editingWorkout.exercises[app.state.editingExerciseIndex] = exerciseData;
         app.state.editingExerciseIndex = null; // Reset
         } else {
         // AGGIUNTA NUOVO
         app.state.editingWorkout.exercises.push(exerciseData);
         }
         
         document.getElementById('exercise-modal').classList.add('hidden');
         app.ui.renderEditorExercises();
         },
         
                 removeExercise: (idx) => {
                     if(confirm('Rimuovere esercizio?')) {
                         app.state.editingWorkout.exercises.splice(idx, 1);
                         app.ui.renderEditorExercises();
                     }
                 },
         
saveWorkout: async () => {
    const name = document.getElementById('editor-name').value || 'Workout Senza Nome';
    app.state.editingWorkout.name = name;
    
    // ‚úÖ SALVA STATO ARCHIVIAZIONE
    const archivedCheckbox = document.getElementById('editor-archived');
    app.state.editingWorkout.archived = archivedCheckbox ? archivedCheckbox.checked : false;
    
    // Save to DB
    await app.db.put('workouts', app.state.editingWorkout);
                     
                     // Update Local State
                     await app.loadData();
					 
					 app.state.isSaving = true;
					 
                     app.router.go('dashboard');
                 },
         
				deleteWorkout: async () => {
					if(confirm('Sei sicuro di voler cancellare questo workout?')) {
						// ‚úÖ AGGIUNGI: Imposta flag per bypassare il controllo di salvataggio
						app.state.isDeleting = true;
						
						await app.db.delete('workouts', app.state.editingWorkout.id);
						await app.loadData();
						app.router.go('dashboard');
					}
				},
         
                 // Execution Handlers
startWorkout: (id) => {
    const w = app.state.workouts.find(w => w.id === id);
    
    // Salva temporaneamente il workout da avviare
    app.state.pendingWorkoutStart = w;
    
    // Popola la modale
    app.handlers.showStartWorkoutModal(w);
},

confirmStartWorkout: () => {
    const w = app.state.pendingWorkoutStart;
    if (!w) return;
    
    // üî• RICHIEDI PERMESSI NOTIFICHE
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // üî• AVVIA AUDIO SILENZIOSO (mantiene app attiva in background)
    const keepAlive = document.getElementById('audio-keepalive');
    if (keepAlive) {
        keepAlive.volume = 0.01; // Quasi silenzioso
        keepAlive.play().catch(e => console.warn('KeepAlive audio blocked:', e));
    }
    
    // üî• RICHIEDI WAKE LOCK (impedisce standby)
    if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen').then(wakeLock => {
            app.state.wakeLock = wakeLock;
            console.log('‚úÖ Wake Lock attivo');
        }).catch(e => console.warn('Wake Lock error:', e));
    }
    
    document.getElementById('start-workout-modal').classList.add('hidden');
    document.body.classList.add('workout-started');
    
    const now = Date.now();
    
    app.state.activeSession = {
        workout: JSON.parse(JSON.stringify(w)),
        currentExIdx: 0,
        currentSet: 0,
        status: 'work',
        startTime: now,
        exerciseStartTime: now,
        exerciseDurations: [],
        logs: [],
        weightDelta: 0,
        lastSavedWeight: null 
    };
    
    app.router.go('active');
    app.handlers.startTotalTimer();
    app.handlers.startExerciseTimer();
    app.handlers.setRandomMotivation();
    app.ui.updateActiveView();
},
         
adjustWeight: (delta) => {
    const session = app.state.activeSession;
    const ex = session.workout.exercises[session.currentExIdx];
    
    // Salva il peso dell'ultimo workout (solo la prima volta)
    if (!session.lastSavedWeight) {
        const lastData = app.getLastWorkoutWeight(session.workout.id, ex.name);
        session.lastSavedWeight = lastData ? lastData.weight : parseFloat(ex.lastWeight) || 0;
    }
    
    let w = parseFloat(ex.lastWeight);
    if (isNaN(w)) w = 0;
    w += delta;
    if (w < 0) w = 0;
    ex.lastWeight = w;

    session.weightDelta += delta;

    // Calcola percentuale RISPETTO AL PESO SALVATO
    const currentWeight = session.lastSavedWeight + session.weightDelta;
    const percentChange = session.lastSavedWeight > 0 
        ? ((session.weightDelta / session.lastSavedWeight) * 100).toFixed(0)
        : 0;


    // Mostra delta + percentuale
    const kgLabel = document.querySelector('#active-weight-value + span');
    if (kgLabel) {
        if (Math.abs(session.weightDelta) > 0) {
            const deltaColor = session.weightDelta > 0 ? 'text-green-400' : 'text-orange-400';
            const deltaSign = session.weightDelta > 0 ? '+' : '';
            const percentText = Math.abs(percentChange) > 0 
                ? ` <span class="text-xs opacity-75">(${percentChange > 0 ? '+' : ''}${percentChange}%)</span>` 
                : '';
            
            kgLabel.innerHTML = `kg <span class="${deltaColor} animate-pulse">${deltaSign}${session.weightDelta}${percentText}</span>`;
        } else {
            kgLabel.innerHTML = 'kg';
        }
    }
	
	const resetBtn = document.getElementById('btn-reset-weight');
    if (resetBtn) {
        if (Math.abs(session.weightDelta) > 0) {
            resetBtn.classList.remove('hidden');
        } else {
            resetBtn.classList.add('hidden');
        }
    }

    app.ui.updateActiveView();
    app.updateWeightComparison();
},

resetWeight: () => {
    const session = app.state.activeSession;
    if (!session) return;
    
    const ex = session.workout.exercises[session.currentExIdx];
    
    // Recupera peso salvato dall'ultimo workout
    const lastData = app.getLastWorkoutWeight(session.workout.id, ex.name);
    const savedWeight = lastData ? lastData.weight : 0;
    
    // Reset al peso salvato
    ex.lastWeight = savedWeight;
    session.weightDelta = 0;
    session.lastSavedWeight = savedWeight;
    
    // Update UI
    document.getElementById('active-weight-value').innerText = savedWeight;
    
    const kgLabel = document.querySelector('#active-weight-value + span');
    if (kgLabel) {
        kgLabel.innerHTML = 'kg';
    }
    
    app.updateWeightComparison();
    
    // Feedback visivo + suono
    if (app.state.settings.vibrate && navigator.vibrate) {
        navigator.vibrate(50);
    }
    
    const btn = document.getElementById('btn-reset-weight');
    if (btn) {
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Ripristinato';
        btn.classList.replace('bg-orange-500/20', 'bg-green-500/20');
        btn.classList.replace('text-orange-400', 'text-green-400');
        btn.classList.replace('border-orange-500/30', 'border-green-500/30');
        
        setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-rotate-left"></i> Reset';
            btn.classList.replace('bg-green-500/20', 'bg-orange-500/20');
            btn.classList.replace('text-green-400', 'text-orange-400');
            btn.classList.replace('border-green-500/30', 'border-orange-500/30');
			btn.classList.add('hidden');
        }, 500);
    }
	
},
         
skipRest: (_, isNextExercise = false) => {
  if (app.restInterval) clearInterval(app.restInterval);
  
  const restText = document.getElementById('rest-timer-text');
  if (restText) restText.classList.remove('rest-blink');
  
  const session = app.state.activeSession;
  const ex = session.workout.exercises[session.currentExIdx];
  
  if(session.currentSet < ex.sets - 1) {
    session.currentSet++;
  } else {
    session.currentExIdx++;
    session.currentSet = 0;
    
    // ‚úÖ RESET DELTA QUANDO CAMBI ESERCIZIO
    session.weightDelta = 0;
	session.lastSavedWeight = null;
    const kgLabel = document.querySelector('#active-weight-value + span');
    if (kgLabel) {
        kgLabel.innerHTML = 'kg';
    }
	
	// ‚ú® NASCONDI PULSANTE RESET
  const resetBtn = document.getElementById('btn-reset-weight');
  if (resetBtn) resetBtn.classList.add('hidden');
  }
  
  app.handlers.startExerciseTimer();
  app.handlers.setRandomMotivation();
  
  session.status = 'work';
  app.ui.updateActiveView();
  app.updateWeightComparison();
},

skipExercise: () => {
  const restText = document.getElementById('rest-timer-text');
  if (restText) restText.classList.remove('rest-blink');
  
  const session = app.state.activeSession;
  if (session.currentExIdx < session.workout.exercises.length - 1) {
    session.currentExIdx++;
    session.currentSet = 0;
    
    // ‚úÖ RESET DELTA QUANDO CAMBI ESERCIZIO
   session.weightDelta = 0;
   session.lastSavedWeight = null;
    const kgLabel = document.querySelector('#active-weight-value + span');
    if (kgLabel) {
        kgLabel.innerHTML = 'kg';
    }
	
	// ‚ú® NASCONDI PULSANTE RESET
  const resetBtn = document.getElementById('btn-reset-weight');
  if (resetBtn) resetBtn.classList.add('hidden');
    
    app.handlers.startExerciseTimer();
    session.status = 'work';
    if (app.restInterval) clearInterval(app.restInterval);
    app.ui.updateActiveView();
  } else {
    app.handlers.finishWorkout();
  }
},

completeSet: () => {
    // ‚úÖ RIMUOVI LAMPEGGIO QUANDO COMPLETI UNA SERIE
    const restText = document.getElementById('rest-timer-text');
    if (restText) restText.classList.remove('rest-blink');
    
    const session = app.state.activeSession;
    const ex = session.workout.exercises[session.currentExIdx];
    
    // Log the set
    const weight = parseFloat(ex.lastWeight);
    
    // ‚úÖ PARSING MIGLIORATO DEL CAMPO REPS
    let reps = 0;
    const repsStr = String(ex.reps).toLowerCase().trim();
    
    // Gestisci parole chiave (maxreps, max, cedimento, ecc.)
    if (repsStr === 'maxreps' || repsStr === 'max' || repsStr === 'cedimento' || 
        repsStr === 'failure' || repsStr === 'massimo' || repsStr === 'esaurimento') {
        reps = 12;  // Stima conservativa per maxreps
    }
    // Gestisci range con - o / (es: "10-12" o "10/12")
    else if (repsStr.includes('-') || repsStr.includes('/')) {
        const separator = repsStr.includes('-') ? '-' : '/';
        const parts = repsStr.split(separator);
        const min = parseFloat(parts[0]);
        const max = parseFloat(parts[1]);
        
        if (!isNaN(min) && !isNaN(max)) {
            reps = Math.round((min + max) / 2);  // Media: "10-12" ‚Üí 11
        } else if (!isNaN(min)) {
            reps = min;  // Se solo il primo √® valido, usa quello
        }
    }
    // Gestisci numero singolo
    else {
        const parsed = parseFloat(repsStr);
        reps = isNaN(parsed) ? 0 : parsed;
    }
    
    const multiplier = ex.isDouble ? 2 : 1;
    
    console.log('Completing set:', { exercise: ex.name, weight, reps, multiplier });
    
    session.logs.push({
        exercise: ex.name,
        weight: isNaN(weight) ? 0 : weight,
        reps: isNaN(reps) ? 0 : reps,
		multiplier: multiplier,
        sets: ex.sets, // ‚ú® AGGIUNGI
        targetReps: ex.reps // ‚ú® AGGIUNGI
    });
    
    // Persist new weight to main DB so next time it's updated
    // We do this by updating the base workout object
    const baseWorkout = app.state.workouts.find(w => w.id === session.workout.id);
    if(baseWorkout) {
        baseWorkout.exercises[session.currentExIdx].lastWeight = ex.lastWeight;
        app.db.put('workouts', baseWorkout);
    }

    // Check if exercise finished
    if (session.currentSet < ex.sets - 1) {
        app.handlers.startExerciseTimer();
        app.handlers.startRest(ex.rest);
    } else {
        // ‚úÖ ESERCIZIO FINITO - MA NON RESETTARE ANCORA IL DELTA
        // Il reset avverr√† in skipRest quando effettivamente si passa al prossimo
        
        if (session.currentExIdx < session.workout.exercises.length - 1) {
            app.handlers.startExerciseTimer();
            app.handlers.startRest(ex.rest, true);
        } else {
            app.handlers.finishWorkout();
        }
    }
    
    app.handlers.setRandomMotivation();
},
         
startRest: (seconds, isNextExercise = false) => {
    const session = app.state.activeSession;
    session.status = 'rest';
    
    let timeLeft = parseInt(seconds);
    const timerEl = document.getElementById('rest-timer-text');
    const circle = document.getElementById('rest-timer-circle');
    
    const maxOffset = 452;
    circle.style.strokeDasharray = maxOffset;
    circle.style.strokeDashoffset = maxOffset;
    
    const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const secs = (timeLeft % 60).toString().padStart(2, '0');
    timerEl.innerText = `${mins}:${secs}`;
    
    app.ui.updateActiveView();
    
    setTimeout(() => {
        if (session?.restProgressSegment) {
            const fill = session.restProgressSegment.querySelector('#rest-progress-fill');
            if (fill) fill.style.width = '0%';
        }
    }, 50);
    
    // üî• AVVIA TIMER NEL SERVICE WORKER (background)
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const ex = session.workout.exercises[session.currentExIdx];
        navigator.serviceWorker.controller.postMessage({
            type: 'START_TIMER',
            data: {
                duration: seconds,
                exerciseName: ex.name
            }
        });
    }
    
    // üî• RICHIEDI PERMESSI NOTIFICHE SE NECESSARIO
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    const autoNextCheckbox = document.getElementById('auto-next-toggle');
    if (autoNextCheckbox) {
        autoNextCheckbox.checked = app.state.settings.autoNext || false;
    }
    
    // Timer locale (per UI)
    app.restInterval = setInterval(() => {
        timeLeft--;
        const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const secs = (timeLeft % 60).toString().padStart(2, '0');
        timerEl.innerText = `${mins}:${secs}`;
        
        const offset = maxOffset - ((timeLeft / seconds) * maxOffset);
        circle.style.strokeDashoffset = offset;
        
        const session = app.state.activeSession;
        if (session?.restProgressSegment) {
           const fill = session.restProgressSegment.querySelector('#rest-progress-fill');
           if (fill) {
              const percentComplete = ((seconds - timeLeft) / seconds) * 100;
              fill.style.width = `${percentComplete}%`;
           }
        }
        
        if (timeLeft <= 0) {
            clearInterval(app.restInterval);
            
            const restText = document.getElementById('rest-timer-text');
            restText.classList.add('rest-blink');
            
            const isAutoNext = document.getElementById('auto-next-toggle')?.checked || false;
            
            if (isAutoNext) {
                if(app.state.settings.sound) {
                    document.getElementById('audio-auto-next').play().catch(e=>{});
                }
                if(app.state.settings.vibrate && navigator.vibrate) {
                    navigator.vibrate([300, 100, 300]);
                }
                
                setTimeout(() => {
                    app.handlers.skipRest(null, isNextExercise);
                    app.handlers.setRandomMotivation();
                }, 1000);
            } else {
                app.handlers.notify();
            }
        }
    }, 1000);
},
         
// CERCA QUESTA FUNZIONE (circa riga 1100)
skipRest: (_, isNextExercise = false) => {
  // üî• FERMA TIMER NEL SERVICE WORKER
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({ type: 'STOP_TIMER' });
  }
  
  if (app.restInterval) clearInterval(app.restInterval);
  
  // ‚úÖ RIMUOVI LAMPEGGIO QUANDO SALTI IL RIPOSO
  const restText = document.getElementById('rest-timer-text');
  if (restText) restText.classList.remove('rest-blink');
  
  const session = app.state.activeSession;
  
  const ex = session.workout.exercises[session.currentExIdx];
  
  if(session.currentSet < ex.sets - 1) {
    session.currentSet++;
  } else {
    session.currentExIdx++;
    session.currentSet = 0;
	session.weightDelta = 0;
	session.lastSavedWeight = null;
  }
  
  // ‚ú® SPOSTA QUI: Resetta il timer PRIMA di cambiare status
  app.handlers.startExerciseTimer();
  app.handlers.setRandomMotivation();
  
  session.status = 'work';
  app.ui.updateActiveView();
},
         
// CERCA QUESTA FUNZIONE (circa riga 1150)
skipExercise: () => {
  // ‚úÖ RIMUOVI LAMPEGGIO QUANDO SALTI L'ESERCIZIO
  const restText = document.getElementById('rest-timer-text');
  if (restText) restText.classList.remove('rest-blink');
  
  const session = app.state.activeSession;
  if (session.currentExIdx < session.workout.exercises.length - 1) {
    session.currentExIdx++;
    session.currentSet = 0;
	session.weightDelta = 0;
	session.lastSavedWeight = null;
    // ‚ú® AGGIUNGI QUI:
    app.handlers.startExerciseTimer();
    session.status = 'work';
    if (app.restInterval) clearInterval(app.restInterval);
    app.ui.updateActiveView();
  } else {
    app.handlers.finishWorkout();
  }
},         
                 finishWorkoutEarly: () => {
                     if(confirm("Terminare l'allenamento ora?")) {
                         app.handlers.finishWorkout();
                     }
                 },
         
                confirmExitWorkout: () => {
    if(confirm("Vuoi uscire senza salvare?")) {
        // üî• FERMA AUDIO SILENZIOSO
        const keepAlive = document.getElementById('audio-keepalive');
        if (keepAlive) {
            keepAlive.pause();
            keepAlive.currentTime = 0;
        }
        
        // üî• RILASCIA WAKE LOCK
        if (app.state.wakeLock) {
            app.state.wakeLock.release();
            app.state.wakeLock = null;
        }
        
        if (app.restInterval) clearInterval(app.restInterval);
        if (app.totalTimerInt) clearInterval(app.totalTimerInt);
        if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);
        document.body.classList.remove('workout-started');
        app.router.go('dashboard');
    }
},
         
 finishWorkout: async () => {
    // üî• FERMA AUDIO SILENZIOSO
    const keepAlive = document.getElementById('audio-keepalive');
    if (keepAlive) {
        keepAlive.pause();
        keepAlive.currentTime = 0;
    }
    
    // üî• RILASCIA WAKE LOCK
    if (app.state.wakeLock) {
        app.state.wakeLock.release().then(() => {
            console.log('‚úÖ Wake Lock rilasciato');
            app.state.wakeLock = null;
        });
    }
    
    if (app.restInterval) clearInterval(app.restInterval);
    if (app.totalTimerInt) clearInterval(app.totalTimerInt);
    if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);
    
    document.getElementById('audio-complete').play().catch(e=>{});
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);

    const session = app.state.activeSession;
    
    // Calc Stats
    const volume = session.logs.reduce((acc, l) => {
        const weight = parseFloat(l.weight);
        const reps = parseFloat(l.reps);
        const multiplier = l.multiplier || 1;
        if (!isNaN(weight) && !isNaN(reps)) {
            return acc + (weight * reps * multiplier);
        }
        return acc;
    }, 0);
    
    const totalDuration = Math.round((Date.now() - session.startTime) / 1000 / 60);
    
    // ‚ú® CALCOLA DURATA EFFETTIVA
    const effectiveDuration = session.exerciseDurations 
        ? Math.round(session.exerciseDurations.reduce((a, b) => a + b, 0) / 60) 
        : 0;
    
    const calories = app.calculateCalories(session);
    
    const historyItem = {
        id: 'h_' + Date.now(),
        workoutId: session.workout.id,
        workoutName: session.workout.name,
        date: new Date().toISOString(),
        totalVolume: volume,
        durationMinutes: totalDuration,
        effectiveDurationMinutes: effectiveDuration,
        caloriesBurned: calories,
        logs: session.logs
    };
    
    await app.db.put('history', historyItem);
    await app.checkBadges(historyItem);
    await app.loadData();
    
    // ‚ú® MOSTRA MODALE
    app.ui.showWorkoutSummaryModal({
        volume: Math.round(volume),
        totalDuration: totalDuration,
        effectiveDuration: effectiveDuration,
        calories: calories
    });
	
	
// Mostra rating dopo 3 allenamenti
setTimeout(() => {
   app.handlers.showRatingModal();
}, 2000);
},
         
                 startTotalTimer: () => {
                     const start = Date.now();
                     const el = document.getElementById('active-timer-total');
					 el.innerText = '00:00';
                     app.totalTimerInt = setInterval(() => {
                         const diff = Math.floor((Date.now() - start) / 1000);
                         const m = Math.floor(diff / 60).toString().padStart(2, '0');
                         const s = (diff % 60).toString().padStart(2, '0');
                         el.innerText = `${m}:${s}`;
                     }, 1000);
                 },
         
// CERCA QUESTA FUNZIONE (circa riga 1300)
startExerciseTimer: () => {
  const session = app.state.activeSession;
  if (!session) return;

  // ‚ú® SALVA DURATA PRECEDENTE
  if (session.exerciseStartTime && session.status === 'work') {
    const duration = (Date.now() - session.exerciseStartTime) / 1000;
    if (!session.exerciseDurations) session.exerciseDurations = [];
    session.exerciseDurations.push(duration);
  }

  session.exerciseStartTime = Date.now();

  const el = document.getElementById('exercise-timer');
  if (!el) return;

// ‚ú® Calcola e mostra subito il tempo reale invece di 00:00
const initialDiff = Math.floor((Date.now() - session.exerciseStartTime) / 1000);
const initialM = Math.floor(initialDiff / 60).toString().padStart(2, '0');
const initialS = (initialDiff % 60).toString().padStart(2, '0');
el.innerText = `${initialM}:${initialS}`;

  // Pulisci eventuale timer precedente
  if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);

  app.exerciseTimerInt = setInterval(() => {
    if (!app.state.activeSession || app.state.activeSession.status === 'rest') {
      // ‚ú® MODIFICA: Durante il riposo, NON nascondere, ma mostra "00:00"
      el.innerText = '00:00';
      return;
    }

    const diff = Math.floor((Date.now() - session.exerciseStartTime) / 1000);
    const m = Math.floor(diff / 60).toString().padStart(2, '0');
    const s = (diff % 60).toString().padStart(2, '0');
    el.innerText = `${m}:${s}`;
  }, 1000);
},
         
requestNotificationPermission: async () => {
    if (!("Notification" in window)) {
        alert('‚ùå Il tuo browser non supporta le notifiche');
        return;
    }
    
    const btn = document.getElementById('notification-btn-text');
    
    if (Notification.permission === 'granted') {
        btn.textContent = '‚úÖ Notifiche Attive';
        
        // Test notifica
        new Notification('‚úÖ Notifiche Configurate', {
            body: 'Riceverai avvisi quando il timer finisce',
            icon: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
            vibrate: [200, 100, 200]
        });
        return;
    }
    
    if (Notification.permission === 'denied') {
        alert('‚ùå Notifiche bloccate dal browser.\n\nVai nelle impostazioni del sito e abilita le notifiche manualmente.');
        return;
    }
    
    // Richiedi permesso
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
        btn.textContent = '‚úÖ Notifiche Attive';
        
        new Notification('‚úÖ Notifiche Attivate!', {
            body: 'Riceverai avvisi quando il timer termina',
            icon: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
            vibrate: [200, 100, 200]
        });
    } else {
        btn.textContent = '‚ùå Permesso Negato';
    }
},
         
notify: () => {
    // üî• SUONO RIPETUTO (3 volte per essere sicuri)
    if(app.state.settings.sound) {
        const beep = document.getElementById('audio-beep');
        let playCount = 0;
        const playBeep = () => {
            if (playCount < 3) {
                beep.currentTime = 0;
                beep.play().catch(e => {});
                playCount++;
                setTimeout(playBeep, 800);
            }
        };
        playBeep();
    }
    
    // üî• VIBRAZIONE FORTE E LUNGA
    if(app.state.settings.vibrate && navigator.vibrate) {
        navigator.vibrate([500, 200, 500, 200, 500, 200, 500]);
    }
    
    // üî• NOTIFICA CON SUONO
    if ("Notification" in window && Notification.permission === "granted") {
        const notification = new Notification("‚è∞ RIPOSO TERMINATO!", { 
            body: "Tocca per continuare l'allenamento üí™",
            icon: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
            badge: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
            tag: 'workout-timer-urgent',
            requireInteraction: true,
            silent: false, // üî• IMPORTANTE: suono notifica
            vibrate: [500, 200, 500, 200, 500]
        });
        
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
    }
},
         showWorkoutPreview: () => {
         const session = app.state.activeSession;
         if (!session) return;
         
         const content = document.getElementById('workout-preview-content');
         content.innerHTML = session.workout.exercises.map((ex, idx) => {
         const isCurrent = idx === session.currentExIdx;
         const isPast = idx < session.currentExIdx;
         
         return `
         <div class="bg-gray-${isCurrent ? '700 border-2 border-primary' : isPast ? '900' : '800'} p-4 rounded-xl ${isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    ${isPast ? '<i class="fa-solid fa-check text-green-500"></i>' : isCurrent ? '<i class="fa-solid fa-arrow-right text-primary"></i>' : '<i class="fa-solid fa-circle text-gray-600 text-xs"></i>'}
                    <span class="font-bold text-lg">${ex.name}</span>
                </div>
                ${isCurrent ? '<span class="text-xs bg-primary px-2 py-1 rounded-full" style="white-space: nowrap;">IN CORSO</span>' : ''}
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm mt-3">
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Serie</div>
                    <div class="font-bold">${ex.sets}</div>
                </div>
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Reps</div>
                    <div class="font-bold">${ex.reps}</div>
                </div>
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Peso</div>
                    <div class="font-bold">${ex.lastWeight || 0}kg${ex.isDouble ? ' x2' : ''}</div>
                </div>
            </div>
            ${isCurrent ? `<div class="mt-2 text-xs font-semibold">Serie ${session.currentSet + 1}/${ex.sets}</div>` : ''}
         </div>
         `;
         }).join('');
		 
		

         
         document.getElementById('workout-preview-modal').classList.remove('hidden');
         },
                 
                 toggleSound: () => {
                     app.state.settings.sound = !app.state.settings.sound;
                     const icon = document.getElementById('sound-toggle').querySelector('i');
                     icon.className = app.state.settings.sound ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-xmark';
                 },
				 
				 setRandomMotivation: () => {
    const phrases = app.state.motivationalPhrases;
    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
    const el = document.getElementById('motivational-text');
    if (el) {
        el.innerText = randomPhrase;
    }
},


toggleNotes: () => {
    const content = document.getElementById('exercise-notes-content');
    const chevron = document.getElementById('notes-chevron');
    const scrollContainer = document.querySelector('.internal-section > div.flex-1.overflow-y-auto');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
        
        // ‚ú® Scrolla in fondo dopo che il contenuto si √® espanso
        setTimeout(() => {
            if (scrollContainer) {
                scrollContainer.scrollTo({
                    top: scrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }, 100);
    } else {
        content.classList.add('hidden');
        chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
        
        // ‚ú® Torna in alto quando chiudi
        if (scrollContainer) {
            scrollContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }
},

dismissBadge: () => {
    app.state.pendingBadges.shift();
    document.getElementById('badge-notification').classList.add('hidden');
    
    // Show next badge if any
    if (app.state.pendingBadges.length > 0) {
        setTimeout(() => app.ui.showBadgeNotification(), 500);
    }
},

createConfetti: (element) => {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
    const confettiCount = 30;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        
        // Random properties
        const color = colors[Math.floor(Math.random() * colors.length)];
        const left = Math.random() * 100;
        const delay = Math.random() * 0.5;
        const duration = 2 + Math.random() * 2;
        const size = 5 + Math.random() * 8;
        
        confetti.style.cssText = `
            background: ${color};
            left: ${left}%;
            animation-delay: ${delay}s;
            animation-duration: ${duration}s;
            width: ${size}px;
            height: ${size}px;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
        `;
        
        element.appendChild(confetti);
        
        // Remove after animation
        setTimeout(() => confetti.remove(), (duration + delay) * 1000);
    }
},

closeWorkoutSummary: () => {
    const modal = document.getElementById('workout-summary-modal');
    if (modal) {
        modal.style.animation = 'fadeInOnly 0.2s ease-in-out reverse';
        setTimeout(() => {
            modal.remove();
            document.body.classList.remove('workout-started');
            app.router.go('dashboard');
        }, 200);
    }
},

// Rating handlers
showRatingModal: () => {
   const hasRated = localStorage.getItem('hasRated');
   const workoutsCount = app.state.history.length;
   
   // Mostra dopo 2 allenamenti completati
   if (!hasRated && workoutsCount >= 2) {
      document.getElementById('rating-modal').classList.remove('hidden');
   }
},

// Preview sistema stelle
updateStarsPreview: (rating) => {
   const preview = document.getElementById('rating-preview');
   const stars = document.querySelectorAll('.star-rating-btn i');
   
   // Reset tutte le stelle
   stars.forEach((star, idx) => {
      if (idx < rating) {
         star.classList.remove('text-gray-700');
         star.classList.add('text-yellow-400');
         star.style.filter = 'drop-shadow(0 0 10px rgba(250, 204, 21, 0.8))';
      } else {
         star.classList.add('text-gray-700');
         star.classList.remove('text-yellow-400');
         star.style.filter = 'none';
      }
   });
   
   // Messaggi dinamici
   const messages = {
      1: { text: '1 Stella - Inutile', color: 'text-red-400', emoji: 'üòû' },
      2: { text: '2 Stelle - Scarsa', color: 'text-orange-400', emoji: 'üòï' },
      3: { text: '3 Stelle - Sufficiente', color: 'text-yellow-400', emoji: 'üòê' },
      4: { text: '4 Stelle - Ottima', color: 'text-green-400', emoji: 'üòä' },
      5: { text: '5 Stelle - Perfetta!', color: 'text-green-500', emoji: 'ü§©' }
   };
   
   const msg = messages[rating];
   preview.innerHTML = `
      <div class="space-y-2" style="animation: beastShake 0.3s ease-out">
         <p class="text-2xl">${msg.emoji}</p>
         <p class="${msg.color} font-bold text-lg">${msg.text}</p>
         <button onclick="app.handlers.confirmRating(${rating})" 
            class="mt-4 bg-gradient-to-r from-primary to-purple-600 hover:from-primaryDark hover:to-purple-700 text-white font-bold px-8 py-3 rounded-xl shadow-lg transform transition active:scale-95">
            <i class="fa-solid fa-check mr-2"></i>
            Conferma Voto
         </button>
      </div>
   `;
},

confirmRating: async (stars) => {
   // Questa sar√† la vecchia submitRating rinominata
   app.handlers.submitRating(stars);
},

submitRating: async (stars) => {
   const modal = document.getElementById('rating-modal');
   const modalContent = modal.querySelector('.bg-gradient-to-br');
   
   // Animazione di caricamento
   const starsContainer = modal.querySelector('.flex.flex-wrap.justify-center');
   starsContainer.innerHTML = `
      <div class="flex flex-col items-center gap-4 py-8">
         <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
         <p class="text-gray-400 text-sm">Invio in corso...</p>
      </div>
   `;
   
   const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfdeaHOwYZrf4okZdD2DNjBhIfNlYO3zkMK91OXkvZCqG7SMw/formResponse';
   const entryId = 'entry.1932136918';
   
   try {
      await fetch(formUrl, {
         method: 'POST',
         mode: 'no-cors',
         headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
         body: `${entryId}=${stars}`
      });
      
      localStorage.setItem('hasRated', 'true');
      
      // Messaggio di successo
      const successMessage = stars >= 4 
         ? 'Grazie mille! Il tuo supporto ci motiva! üí™' 
         : 'Grazie per il feedback! Lavoreremo per migliorare!';
      
      // Cambia contenuto modale
      modalContent.innerHTML = `
         <div class="bg-gradient-to-r from-green-600 to-green-500 p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
            <div class="relative z-10">
               <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4" style="animation: beastShake 0.5s ease-out">
                  <i class="fa-solid fa-check text-5xl text-white"></i>
               </div>
               <h2 class="text-2xl font-extrabold text-white">Grazie!</h2>
               <p class="text-white/90 mt-2 text-sm font-medium">Il tuo feedback √® stato inviato</p>
            </div>
         </div>
         
         <div class="p-8 text-center">
            <p class="text-gray-300 mb-6 text-lg">${successMessage}</p>
            
            <div class="space-y-3">
               <button onclick="app.handlers.closeRatingModal()" 
                  class="w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primaryDark hover:to-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                  <i class="fa-solid fa-house"></i>
                  Torna alla Home
               </button>
            </div>
         </div>
      `;
      
   } catch (error) {
      console.error('Rating error:', error);
      localStorage.setItem('hasRated', 'true');
      
      // Anche in caso di errore mostra grazie (dato che usiamo no-cors)
      modalContent.innerHTML = `
         <div class="bg-gradient-to-r from-primary to-purple-600 p-8 text-center relative overflow-hidden">
            <div class="relative z-10">
               <i class="fa-solid fa-heart text-5xl text-white mb-4"></i>
               <h2 class="text-2xl font-extrabold text-white">Grazie!</h2>
            </div>
         </div>
         
         <div class="p-8 text-center">
            <p class="text-gray-300 mb-6">Il tuo parere √® importante per noi! üí™</p>
            <button onclick="app.handlers.closeRatingModal()" 
               class="w-full bg-gradient-to-r from-primary to-purple-600 text-white font-bold py-4 rounded-2xl">
               Chiudi
            </button>
         </div>
      `;
   }
},

closeRatingModal: () => {
   const modal = document.getElementById('rating-modal');
   modal.style.animation = 'fadeInOnly 0.3s ease-in-out reverse';
   setTimeout(() => {
      modal.classList.add('hidden');
      modal.style.animation = '';
   }, 300);
},

showStartWorkoutModal: (workout) => {
    const modal = document.getElementById('start-workout-modal');
    
    // Icona e colore
    const iconEl = document.getElementById('start-modal-workout-icon');
    iconEl.style.background = workout.color || '#5127f2';
    iconEl.querySelector('i').className = `hgi hgi-stroke ${workout.icon || 'hgi-dumbbell-01'} text-3xl text-white`;
    
    // Nome
    document.getElementById('start-modal-workout-name').innerText = workout.name;
    
    // Calcola tempo stimato
    const estimatedTime = Math.round(
        workout.exercises.reduce((acc, e) => {
            const sets = parseInt(e.sets);
            const rest = parseInt(e.rest);
            return acc + ((sets - 1) * rest / 60) + (sets * 1.5) + 2;
        }, 0)
    );
    document.getElementById('start-modal-time').innerText = `${estimatedTime} min`;
    
    // Calcola calorie stimate (approssimazione)
    const estimatedVolume = workout.exercises.reduce((acc, e) => {
        const weight = parseFloat(e.lastWeight) || 0;
        const sets = parseInt(e.sets) || 0;
        const reps = parseInt(e.reps) || 10; // Fallback
        const multiplier = e.isDouble ? 2 : 1;
        return acc + (weight * sets * reps * multiplier);
    }, 0);
    
    const estimatedCalories = Math.round(estimatedVolume * 0.045);
    document.getElementById('start-modal-calories').innerText = estimatedCalories > 0 
        ? `~${estimatedCalories} kcal` 
        : 'N/D';
    
    // Lista esercizi
    const exercisesList = document.getElementById('start-modal-exercises-list');
exercisesList.innerHTML = workout.exercises.map(ex => `
    <div class="py-3 border-b border-gray-700/30 last:border-0">
        <div class="font-semibold text-white text-sm mb-2">${ex.name}</div>
        <div class="flex items-center gap-2 text-xs text-gray-400">
            <span class="bg-gray-700/50 px-2 py-1 rounded">${ex.sets} serie</span>
            <span class="bg-gray-700/50 px-2 py-1 rounded">${ex.reps} reps</span>
            <span class="bg-gray-700/50 px-2 py-1 rounded font-mono">${ex.lastWeight || 0}kg${ex.isDouble ? ' √ó2' : ''}</span>
        </div>
    </div>
`).join('');
    
    modal.classList.remove('hidden');
},

closeStartModal: () => {
    document.getElementById('start-workout-modal').classList.add('hidden');
    app.state.pendingWorkoutStart = null;
},

skipRating: () => {
   localStorage.setItem('hasRated', 'true');
   document.getElementById('rating-modal').classList.add('hidden');
},

openIconPicker: () => {
   const modal = document.getElementById('icon-picker-modal');
   const grid = modal.querySelector('.grid');
   
   const icons = [
      'hgi-back-muscle-body', 'hgi-body-part-leg', 'hgi-body-part-muscle', 
      'hgi-body-part-six-pack', 'hgi-body-weight', 'hgi-boxing-bag', 
      'hgi-boxing-glove-01', 'hgi-dumbbell-01', 'hgi-dumbbell-02', 
      'hgi-dumbbell-03', 'hgi-equipment-bench-press', 'hgi-equipment-chest-press', 
      'hgi-equipment-gym-01', 'hgi-equipment-gym-02', 'hgi-equipment-gym-03', 
      'hgi-equipment-weightlifting', 'hgi-gymnastic-rings', 'hgi-kettlebell', 
      'hgi-punching-ball-02', 'hgi-push-up-bar', 'hgi-running-shoes', 
      'hgi-shoulder', 'hgi-skipping-rope', 'hgi-treadmill-01', 
      'hgi-treadmill-02', 'hgi-walking', 
      'hgi-workout-gymnastics', 'hgi-workout-kicking', 'hgi-workout-run', 
      'hgi-workout-stretching', 'hgi-yoga-ball', 'hgi-yoga-mat'
   ];
   
   grid.innerHTML = icons.map(icon => `
      <button onclick="app.handlers.selectIcon('${icon}')" 
         class="bg-gray-800 hover:bg-primary/20 border-2 border-gray-700 hover:border-primary rounded-xl p-4 transition-all active:scale-95 flex items-center justify-center">
         <i class="hgi hgi-stroke ${icon} text-3xl"></i>
      </button>
   `).join('');
   
   modal.classList.remove('hidden');
},

selectIcon: (iconClass) => {
   app.state.editingWorkout.icon = iconClass;
   document.getElementById('editor-icon-preview').className = `hgi hgi-stroke ${iconClass} text-2xl text-white`;
   document.getElementById('icon-picker-modal').classList.add('hidden');
},

selectColor: (color) => {
   app.state.editingWorkout.color = color;
   
   // Update selected state
   document.querySelectorAll('.workout-color-btn').forEach(btn => {
      btn.classList.remove('selected');
   });
   document.querySelector(`[data-color="${color}"]`).classList.add('selected');
},

toggleStatsPeriod: () => {
    app.state.statsPeriod = app.state.statsPeriod === 'week' ? 'month' : 'week';
    app.ui.renderDashboard();
},
switchStatsTab: (tabName) => {
   // Update buttons
   document.querySelectorAll('.stats-tab').forEach(btn => {
      btn.classList.remove('active');
   });
   document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
   
   // Update content
   document.querySelectorAll('.stats-tab-content').forEach(content => {
      content.classList.add('hidden');
   });
   document.getElementById(`stats-tab-${tabName}`).classList.remove('hidden');
   
   // ‚ú® Render progress se necessario
   if (tabName === 'progress') {
      app.ui.renderProgress();
   }
},
toggleProgressAccordion: (workoutId) => {
    const content = document.getElementById(`progress-content-${workoutId}`);
    const chevron = document.getElementById(`chevron-${workoutId}`);

    if (!content || !chevron) return;

    const isOpen = !content.classList.contains('hidden');

    if (isOpen) {
        // Chiudi questo accordion
        content.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
        return;
    }

    // Chiudi tutti gli altri accordion
    document.querySelectorAll('[id^="progress-content-"]').forEach(el => {
        el.classList.add('hidden');
    });
    document.querySelectorAll('[id^="chevron-"]').forEach(el => {
        el.style.transform = 'rotate(0deg)';
    });

    // Apri questo accordion
    content.classList.remove('hidden');
    chevron.style.transform = 'rotate(180deg)';

    // üî• Scroll DOPO che il layout √® stabile
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            const card = content.closest('.bg-darkCard');
            if (card) {
                card.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
},
installPWA: () => {
    if (!app.state.deferredPrompt) {
        alert('üì± L\'app √® gi√† installata o il browser non supporta l\'installazione.');
        return;
    }
    
    app.state.deferredPrompt.prompt();
    
    app.state.deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('‚úÖ PWA installata');
            document.getElementById('pwa-install-section').classList.add('hidden');
        } else {
            console.log('‚ùå Installazione rifiutata');
        }
        app.state.deferredPrompt = null;
    });
},
         
                 // Settings Handlers
                 resetAllData: async () => {
    const confirmTxt = prompt("Scrivi 'DELETE' per cancellare tutti i dati permanentemente.");
    if (confirmTxt === 'DELETE') {
        // Cancella tutti gli store
        await app.db.clearAll();
        
        // ‚úÖ AGGIUNGI: Cancella anche i badge
        const txBadges = app.db.db.transaction('badges', 'readwrite');
        await txBadges.objectStore('badges').clear();
        
        // ‚úÖ AGGIUNGI: Reset anche localStorage (per flag rating, reset settimana/mese)
        localStorage.clear();
        
        location.reload();
    }
},
				 resetStatistics: async () => {
    const confirmTxt = prompt("Scrivi 'RESET' per cancellare SOLO lo storico allenamenti. I workout non verranno eliminati.");
    if (confirmTxt === 'RESET') {
        // Cancella solo la tabella history
        const tx = app.db.db.transaction('history', 'readwrite');
        await tx.objectStore('history').clear();
		
		// Reset anche i badge
        const txBadges = app.db.db.transaction('badges', 'readwrite');
        await txBadges.objectStore('badges').clear();
        
        // Reset state
        for (const key in app.state.badges) {
            app.state.badges[key] = { count: 0, lastUnlocked: null, seen: false };
            if (key === 'bench100') app.state.badges[key].oneTime = true;
        }
        
        // Ricarica i dati
        await app.loadData();
        
        // Aggiorna la vista
        app.ui.renderStats();
        
        alert('‚úÖ Statistiche cancellate! I tuoi workout sono al sicuro.');
    }
},
     deleteHistoryItem: async (historyId) => {
    if (!confirm('‚ö†Ô∏è Eliminare questo allenamento dallo storico?\n\nQuesta azione √® irreversibile e aggiorner√† tutte le statistiche.')) {
        return;
    }
    
    try {
        // Elimina dal DB
        await app.db.delete('history', historyId);
        
        // Ricarica dati
        await app.loadData();
        
        // Aggiorna vista corrente
        if (app.state.currentView === 'stats') {
            app.ui.renderStats();
        } else if (app.state.currentView === 'dashboard') {
            app.ui.renderDashboard();
        }
        
        // Feedback visivo
        if (app.state.settings.vibrate && navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        // Notifica successo
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 font-semibold';
        notification.style.animation = 'beastShake 0.5s ease-out';
        notification.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Allenamento eliminato';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'fadeInOnly 0.3s ease-in-out reverse';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
        
    } catch (error) {
        console.error('Errore eliminazione:', error);
        alert('‚ùå Errore durante l\'eliminazione. Riprova.');
    }
},            
         exportData: async () => {
         const settingsArray = await app.db.getAll('settings'); // AGGIUNTO
		 const badgesArray = await app.db.getAll('badges');
         const data = {
         workouts: app.state.workouts,
         history: app.state.history,
         settings: settingsArray,
		 badges: badgesArray
         };
         const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `fit_tracker_backup_${new Date().toISOString().slice(0,10)}.json`;
                     a.click();
                 },
         
                 importData: (input) => {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
    try {
       const data = JSON.parse(e.target.result);
       
       // ‚úÖ MIGRAZIONE AUTOMATICA - WORKOUTS
       if(data.workouts) {
           for (const w of data.workouts) {
               // Aggiungi preferredDays se mancante
               if (!w.preferredDays) w.preferredDays = [];
			   if (w.archived === undefined) w.archived = false; // ‚úÖ AGGIUNGI
			   if (!w.icon) w.icon = 'hgi-dumbbell-01';
				if (!w.color) w.color = '#5127f2';
			   
               
               // Normalizza esercizi
               if (w.exercises) {
                   w.exercises.forEach(ex => {
                       if (!ex.notes) ex.notes = '';
                       if (ex.isDouble === undefined) ex.isDouble = false;
                       if (!ex.lastWeight) ex.lastWeight = 0;
                   });
               }
               
               await app.db.put('workouts', w);
           }
       }
       
		// ‚úÖ MIGRAZIONE AUTOMATICA - HISTORY
		if(data.history) {
			for (const h of data.history) {
				// Aggiungi campi mancanti con valori di default
				if (!h.caloriesBurned) h.caloriesBurned = 0;
				if (!h.durationMinutes) h.durationMinutes = 0;
				if (!h.effectiveDurationMinutes) h.effectiveDurationMinutes = 0;
				if (!h.totalVolume) h.totalVolume = 0;
				
				// ‚ú® MIGRAZIONE LOGS PER PROGRESSI
				if (h.logs && Array.isArray(h.logs)) {
					h.logs.forEach(log => {
						if (!log.sets) log.sets = null;
						if (!log.targetReps) log.targetReps = null;
					});
				}
				
				await app.db.put('history', h);
			}
		}
       
       // ‚úÖ SETTINGS - Gestisce sia vecchio che nuovo formato
       if(data.settings) {
           // Controlla se settings √® un oggetto o un array
           if (Array.isArray(data.settings)) {
               // Nuovo formato (array)
               for (const s of data.settings) {
                   await app.db.put('settings', s);
               }
           } else {
               // Vecchio formato (oggetto) - converti in array
               for (const [key, value] of Object.entries(data.settings)) {
                   await app.db.put('settings', { key, value });
               }
           }
       }
       
       // ‚úÖ BADGES - Importa solo se esistono
       if(data.badges) {
           for (const b of data.badges) await app.db.put('badges', b);
       }
	   
	   // ‚úÖ RICARICA DATI NELLO STATE
		await app.loadData();

		// ‚úÖ FORZA RENDER DELLE VISTE
		if (app.state.currentView === 'stats') {
			app.ui.renderStats();
		}
		if (app.state.currentView === 'dashboard') {
			app.ui.renderDashboard();
		}
       
       alert("‚úÖ Importazione completata con successo!");
       location.reload();
       
    } catch(err) {
        console.error('Import error:', err);
        alert("‚ùå Errore: il file selezionato non √® un backup valido di WorkoutTracker.");
    }
    };
    reader.readAsText(file);
}
             }
         };
         
         
         
         
         // Personal Settings Listeners
         ['setting-body-weight', 'setting-height', 'setting-age', 'setting-gender', 'setting-training-level'].forEach(id => {
         const el = document.getElementById(id);
         const key = id.replace('setting-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
         
         // Load saved value
         if (app.state.settings[key]) {
         el.value = app.state.settings[key];
         }
         
         // Save on change
         el.addEventListener('change', () => {
         app.state.settings[key] = el.value;
         app.db.put('settings', { key: key, value: el.value });
         });
         });
         
         
         // Init App
         window.addEventListener('DOMContentLoaded', async () => {
         await app.init();
		 document.querySelectorAll('.nav-btn')[0]?.classList.add('text-primary');
		 
		 window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        app.state.deferredPrompt = e;
        
        // Mostra il pulsante di installazione
        const installSection = document.getElementById('pwa-install-section');
        if (installSection) {
            installSection.classList.remove('hidden');
        }
        
        console.log('üì± Prompt installazione disponibile');
    });
    
    // Controlla se gi√† installata
    window.addEventListener('appinstalled', () => {
        console.log('‚úÖ PWA installata con successo');
        app.state.deferredPrompt = null;
        document.getElementById('pwa-install-section')?.classList.add('hidden');
    });
		 
		 const lastResetWeek = localStorage.getItem('lastResetWeek');
const lastResetMonth = localStorage.getItem('lastResetMonth');
const now = new Date();
const weekNum = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / 604800000);
const monthKey = `${now.getFullYear()}-${now.getMonth()}`;

if (lastResetWeek !== String(weekNum)) {
    app.resetWeeklyBadges();
    localStorage.setItem('lastResetWeek', weekNum);
}

if (lastResetMonth !== monthKey) {
    app.resetMonthlyBadges();
    localStorage.setItem('lastResetMonth', monthKey);
}

// ========== SCROLL HEADER ANIMATION ==========
    let lastScrollTop = 0;
    const header = document.querySelector('header');
    const appContainer = document.getElementById('app-container');
    const scrollThreshold = 20; // Pixel minimi di scroll prima di nascondere
    
appContainer.addEventListener('scroll', () => {
    if (app.state.currentView === 'active') return;
    
    const currentScroll = appContainer.scrollTop;
    
    if (currentScroll > scrollThreshold) {
        if (currentScroll > lastScrollTop) {
            // Scrolling DOWN - Nascondi header
            header.classList.add('header-hidden');
            appContainer.style.marginTop = '0'; // ‚Üê AGGIUNGI QUESTA RIGA
        } else {
            // Scrolling UP - Mostra header
            header.classList.remove('header-hidden');
            appContainer.style.marginTop = '53px'; // ‚Üê AGGIUNGI QUESTA RIGA
        }
    } else {
        // Vicino al top - Mostra sempre
        header.classList.remove('header-hidden');
        appContainer.style.marginTop = '53px'; // ‚Üê AGGIUNGI QUESTA RIGA
    }
    
    lastScrollTop = currentScroll;
});
         
         // Personal Settings Listeners (after init so settings are loaded)
         ['setting-body-weight', 'setting-height', 'setting-age', 'setting-gender'].forEach(id => {
         const el = document.getElementById(id);
         const key = id.replace('setting-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
         
         // Load saved value
         if (app.state.settings[key]) {
             el.value = app.state.settings[key];
         }
         
         // Save on change
         el.addEventListener('change', () => {
             app.state.settings[key] = el.value;
             app.db.put('settings', { key: key, value: el.value });
         });
         });
		 
		 // Toggle Motivational Phrases
const motivationalToggle = document.getElementById('setting-motivational');
if (motivationalToggle) {
   // Carica stato salvato
   motivationalToggle.checked = app.state.settings.motivational !== false;
   
   // Applica lo stato iniziale
   const motivationalDiv = document.querySelector('.frasi-motivazionali');
   if (motivationalDiv) {
      motivationalDiv.style.display = motivationalToggle.checked ? 'block' : 'none';
   }
   
   // Salva quando cambia
   motivationalToggle.addEventListener('change', () => {
      app.state.settings.motivational = motivationalToggle.checked;
      app.db.put('settings', { key: 'motivational', value: motivationalToggle.checked });
      
      // Mostra/nascondi il div
      const motivationalDiv = document.querySelector('.frasi-motivazionali');
      if (motivationalDiv) {
         motivationalDiv.style.display = motivationalToggle.checked ? 'block' : 'none';
      }
   });
}
         
         document.addEventListener('change', (e) => {
         if (e.target.id === 'auto-next-toggle') {
         app.state.settings.autoNext = e.target.checked;
         app.db.put('settings', { key: 'autoNext', value: e.target.checked });
         }
         });
         
         });
         
      </script>
	  
	  
	  <!-- Rating Modal -->
<div id="rating-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-md">
   <div class="bg-gradient-to-br from-gray-800 to-black rounded-3xl w-full max-w-md overflow-hidden shadow-[0_20px_50px_rgba(0,0,0,0.5)] border border-white/10" style="animation: beastShake 0.5s ease-out">
      
      <div class="bg-gradient-to-r from-primary to-purple-600 p-8 text-center relative overflow-hidden">
         <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-2xl"></div>
         <div class="absolute bottom-0 left-0 w-24 h-24 bg-purple-500/20 rounded-full -ml-12 -mb-12 blur-xl"></div>
         
         <div class="relative z-10">
            
            <h2 class="text-2xl font-extrabold text-white tracking-tight">Ti piace WorkoutTracker?</h2>
            <p class="text-white/80 mt-2 text-sm font-medium">Un tuo parere per noi √® importante!<br/>Grazie mille per il tuo tempo.</p>
         </div>
      </div>
      
      <div class="p-3 py-6">
	     <!-- Preview Rating Selected -->
   <div id="rating-preview" class="text-center mb-4 min-h-[60px] flex flex-col items-center justify-center">
      <p class="text-gray-400 text-sm">Seleziona il numero di stelle</p>
   </div>
   
<div class="flex flex-wrap justify-center gap-1 mb-8">
    <button onclick="app.handlers.updateStarsPreview(1)" class="star-rating-btn group relative p-1 transition-all active:scale-90" data-rating="1">
        <i class="fa-solid fa-star text-4xl text-gray-700 transition-all duration-200"></i>
        
    </button>

    <button onclick="app.handlers.updateStarsPreview(2)" class="star-rating-btn group relative p-1 transition-all active:scale-90" data-rating="2">
        <i class="fa-solid fa-star text-4xl text-gray-700 transition-all duration-200"></i>
    </button>

    <button onclick="app.handlers.updateStarsPreview(3)" class="star-rating-btn group relative p-1 transition-all active:scale-90" data-rating="3">
        <i class="fa-solid fa-star text-4xl text-gray-700 transition-all duration-200"></i>
    </button>

    <button onclick="app.handlers.updateStarsPreview(4)" class="star-rating-btn group relative p-1 transition-all active:scale-90" data-rating="4">
        <i class="fa-solid fa-star text-4xl text-gray-700 transition-all duration-200"></i>
    </button>

    <button onclick="app.handlers.updateStarsPreview(5)" class="star-rating-btn group relative p-1 transition-all active:scale-90" data-rating="5">
    <i class="fa-solid fa-star text-4xl text-gray-700 transition-all duration-200"></i>
</button>
</div>
         
         <div class="flex flex-col items-center gap-4 mb-3">
             <div class="inline-flex items-center px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[11px] text-gray-400 uppercase tracking-widest">
                <i class="fa-solid fa-shield-halved mr-2 text-primary"></i>
                La valutazione √® anonima
             </div>
             
             <!-- <button onclick="app.handlers.skipRating()" class="text-gray-500 hover:text-white text-sm font-medium transition-colors duration-200 border-b border-transparent hover:border-white/20 pb-1">
                Forse pi√π tardi
             </button> -->
         </div>
      </div>
   </div>
</div>
	  <!-- ‚úÖ Service Worker inline per PWA -->
<script>
<script>
if ('serviceWorker' in navigator) {
    const swCode = `
    const CACHE_NAME = 'workout-tracker-v4';
    const urlsToCache = [
        '/',
        'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png'
    ];
        
    self.addEventListener('install', event => {
        event.waitUntil(
            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
        );
        self.skipWaiting(); // üî• Attiva subito
    });
    
    self.addEventListener('activate', event => {
        event.waitUntil(self.clients.claim()); // üî• Prendi controllo subito
    });
    
    self.addEventListener('fetch', event => {
        event.respondWith(
            caches.match(event.request).then(response => response || fetch(event.request))
        );
    });
    
    // üî• NUOVO: Timer in background
    let timers = new Map();
    
    self.addEventListener('message', event => {
        const { type, data } = event.data;
        
        if (type === 'START_TIMER') {
            const { duration, exerciseName } = data;
            const endTime = Date.now() + (duration * 1000);
            
            timers.set('rest-timer', {
                endTime,
                exerciseName,
                interval: setInterval(() => {
                    const remaining = endTime - Date.now();
                    
                    if (remaining <= 0) {
                        clearInterval(timers.get('rest-timer').interval);
                        timers.delete('rest-timer');
                        
                        // Mostra notifica
                        self.registration.showNotification('‚è∞ Riposo Terminato!', {
                            body: \`Inizia la prossima serie üí™\`,
                            icon: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
                            badge: 'https://rccremonesi-cmyk.github.io/workout/barbell-ico.png',
                            vibrate: [500, 200, 500, 200, 500],
                            tag: 'workout-timer',
                            requireInteraction: true,
                            silent: false,
                            data: { action: 'timer-complete' }
                        });
                        
                        // Invia messaggio al client
                        self.clients.matchAll().then(clients => {
                            clients.forEach(client => {
                                client.postMessage({ type: 'TIMER_COMPLETE' });
                            });
                        });
                    }
                }, 1000)
            });
        }
        
        if (type === 'STOP_TIMER') {
            const timer = timers.get('rest-timer');
            if (timer) {
                clearInterval(timer.interval);
                timers.delete('rest-timer');
            }
        }
    });
    
    self.addEventListener('notificationclick', event => {
        event.notification.close();
        event.waitUntil(
            clients.openWindow('/').then(windowClient => {
                if (windowClient) windowClient.focus();
            })
        );
    });
    `;
    
    // üî• REGISTRA IL SERVICE WORKER
    if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl).then(reg => {
            console.log('‚úÖ Service Worker registrato');
            
            // üî• Listener per messaggi dal SW
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'TIMER_COMPLETE') {
                    // Esegui azioni quando il timer finisce
                    if (app.state.settings.sound) {
                        document.getElementById('audio-beep').play().catch(e => {});
                    }
                    if (app.state.settings.vibrate && navigator.vibrate) {
                        navigator.vibrate([500, 200, 500]);
                    }
                }
            });
        }).catch(err => {
            console.error('‚ùå Errore SW:', err);
        });
    }
}
</script>
</body>
</html>
