<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Investimenti</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>

<!-- jQuery (necessario per Select2) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS (dopo jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
		.table-responsive {
  scroll-behavior: smooth;
  scrollbar-gutter: stable both-edges;
}
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --info-color: #06b6d4;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-info: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            --gradient-purple: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        body {
            background: linear-gradient(to bottom right, #f8fafc 0%, #e0e7ff 100%);
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1e293b;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
        }
        .card {
            border: none;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.08);
            margin-bottom: 20px;
            border-radius: 16px;
            transition: transform 0.3s, box-shadow 0.3s;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.15);
        }
        .card-header {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
            font-weight: 600;
            border-radius: 16px 16px 0 0 !important;
            padding: 18px 24px;
            color: var(--primary-color);
        }
        .nav-tabs {
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
        }
        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 14px 24px;
            font-weight: 500;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%);
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%);
        }
        .table {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
        }
        .table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .badge-custom {
            font-size: 0.85rem;
            padding: 0.4em 0.75em;
            border-radius: 24px;
            font-weight: 500;
        }
        .stat-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.25);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-4px);
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-label {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        
        .btn-clone {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
			border-radius:6px !important;
        }
        .year-tab {
            cursor: pointer;
            padding: 12px 24px;
            margin-right: 8px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            display: inline-block;
            margin-bottom: 12px;
            transition: all 0.3s;
            font-weight: 500;
            border: 2px solid transparent;
        }
        .year-tab:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: rgba(99, 102, 241, 0.3);
        }
        .year-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .investment-group {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
        }
        .versamento-row {
            background-color: white;
            margin-bottom: 5px;
        }
        .total-row {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            font-weight: bold;
        }
        .sub-table {
            margin-top: 10px;
            margin-bottom: 0;
        }
		.sub-table th{
		width:15%;
		}
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5558e3 0%, #6d42a0 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            font-weight: 500;
            border-width: 1px;
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .btn-outline-success {
            border-radius: 10px;
            font-weight: 500;
            border-width: 2px;
        }
        .btn-outline-success:hover {
            transform: translateY(-2px);
        }
        h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.15);
        }
        .alert-info {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 2px solid rgba(6, 182, 212, 0.3);
            color: #0e7490;
            border-radius: 12px;
        }
        .notes-editor {
            min-height: 400px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            background-color: white;
        }
        .notes-toolbar {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 12px;
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #e2e8f0;
        }
        .notes-content {
            min-height: 350px;
            padding: 15px;
            outline: none;
        }
        .notes-actions {
            padding: 12px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 0 0 12px 12px;
            border-top: 2px solid #e2e8f0;
        }
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
            transition: all 0.3s;
        }
        .floating-action-btn:hover {
            transform: scale(1.15) rotate(360deg);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.45);
        }
        .custom-tooltip {
            position: relative;
            display: inline-block;
        }
        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
		.select2-container--default .select2-selection--multiple {
            background-color: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 0px 10px 12px;
        }
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: var(--primary-color);
        }
	
	.forecast-input-card {
        background: var(--gradient-purple);
        color: #1e293b;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 24px rgba(168, 237, 234, 0.3);
    }
    
    .badge {
        border-radius: 20px;
        padding: 0.5em 0.9em;
        font-weight: 500;
    }
    
    .badge.bg-primary {
        background: var(--gradient-primary) !important;
    }
    
    .badge.bg-info {
        background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%) !important;
    }
    
    .badge.bg-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    .badge.bg-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    .badge.bg-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
    }
		.year-forecast-inputs {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s;
}

.year-forecast-inputs:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
}
.table-secondary td{
background-color:#e4e3fa;
}

.table-hover>tbody>tr:hover>*,
.table-hover>tbody>td:hover>*{
background-color:#e4e3fa6e !important;
--bs-table-bg-state:#e4e3fa6e !important;
}

.table tfoot td{
background-color:#7552a8;
}

    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i> Gestione Investimenti Annuali</h1>
            <div>
                <button class="btn btn-outline-success me-2" onclick="exportData()">
                    <i class="fas fa-download me-1"></i> Esporta Dati
                </button>
                <button class="btn btn-outline-primary" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload me-1"></i> Importa Dati
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button">
                    <i class="fas fa-plus-circle me-1"></i> Inserimento
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" onclick="loadSummary()">
                    <i class="fas fa-table me-1"></i> Riepilogo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix" type="button" onclick="loadMatrix()">
                    <i class="fas fa-th me-1"></i> Vista Matriciale
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" onclick="loadAnalytics()">
                    <i class="fas fa-chart-pie me-1"></i> Analytics
                </button>
            </li>
			<li class="nav-item" role="presentation">
    <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" onclick="loadForecast()">
        <i class="fas fa-chart-line me-1"></i> Previsioni
    </button>
</li><li class="nav-item" role="presentation">
    <button class="nav-link" id="exposure-tab" data-bs-toggle="tab" data-bs-target="#exposure" type="button" onclick="loadExposure()">
        <i class="fas fa-globe-americas me-1"></i> Esposizione Geografica/Settoriale
    </button>
</li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" onclick="loadNotes()">
                    <i class="fas fa-sticky-note me-1"></i> Appunti
                </button>
            </li>
			
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- TAB INSERIMENTO -->
            <div class="tab-pane fade show active" id="input" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Nuovo Investimento / Versamento</h5>
                    </div>
                    <div class="card-body">
                        <form id="investmentForm">
                            <input type="hidden" id="investmentId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-calendar-alt me-1"></i> Data Versamento</label>
                                    <input type="date" class="form-control" id="dataInvestimento" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-percentage me-1"></i> Costo Annuale (TER) %</label>
                                    <input type="number" step="0.01" class="form-control" id="ter" placeholder="Es. 0.25" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-folder me-1"></i> Tipologia Investimento</label>
                                    <select class="form-select" id="tipologia" required>
                                        <option value="">Seleziona...</option>
                                        <option value="ETF">ETF</option>
                                        <option value="BOND">BOND</option>
                                        <option value="IBOND">IBOND</option>
                                        <option value="STOCK">STOCK</option>
                                        <option value="METALLI PREZIOSI">METALLI PREZIOSI</option>
                                    </select>
                                </div>
                               <div class="col-md-6 mb-3">
    <label class="form-label"><i class="fas fa-tags me-1"></i> Settore (Tags)</label>
    <select class="form-select tag-select" id="tagSelect" multiple data-allow-new="true"></select>
</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-signature me-1"></i> Nome Investimento <small class="text-muted">(usa lo stesso nome per versamenti successivi)</small></label>
                                    <input type="text" class="form-control" id="nome" required list="nomiList">
                                    <datalist id="nomiList"></datalist>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-link me-1"></i> Link (URL)</label>
                                    <input type="url" class="form-control" id="link" placeholder="https://...">
                                </div>
                            </div>
                          <div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label"><i class="fas fa-euro-sign me-1"></i> Importo Versamento (€)</label>
        <input type="number" step="0.01" class="form-control" id="totaleInvestito" required>
    </div>
<div class="col-md-6 mb-3">
    <label class="form-label"><i class="fas fa-receipt me-1"></i> Commissioni (€) <small class="text-muted">(opzionale)</small></label>
    <div class="row g-2">
        <div class="col-7">
            <input type="number" step="0.01" class="form-control" id="commissioni" placeholder="0.00">
        </div>
        <div class="col-5">
            <select class="form-select" id="commissioniTipo">
                <option value="sottratta">Già inclusa</option>
                <option value="aggiuntiva">Da aggiungere</option>
            </select>
        </div>
    </div>
    <small class="text-muted">
        <strong>Già inclusa:</strong> commissione già compresa nell'importo versamento<br>
        <strong>Da aggiungere:</strong> commissione da sommare all'importo
    </small>
</div>
</div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i> <strong>Nota:</strong> Per aggiungere denaro a un investimento esistente, usa lo stesso nome e cambia solo la data e l'importo del versamento.
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Salva Versamento
                            </button>
                            <button type="button" class="btn btn-primary" onclick="resetForm()" style="margin-left:10px;">
                                <i class="fas fa-times me-1"></i> Annulla
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TAB RIEPILOGO -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i> Riepilogo Investimenti</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearTabs" class="mb-3"></div>
                        <div id="summaryContent"></div>
                    </div>
                </div>
            </div>

            <!-- TAB VISTA MATRICIALE -->
            <div class="tab-pane fade" id="matrix" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-th me-2"></i> Vista Matriciale - Tutti gli Anni</h5>
                    </div>
                    <div class="card-body">
                        <div id="matrixContent"></div>
                    </div>
                </div>
            </div>

            <!-- TAB ANALYTICS -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div id="analyticsContent"></div>
            </div>

            <!-- TAB APPUNTI -->
            <div class="tab-pane fade" id="notes" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i> Appunti e Note</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="notes-toolbar">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="insertLink()"><i class="fas fa-link"></i></button>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="saveNotes()"><i class="fas fa-save me-1"></i> Salva Appunti</button>
                        </div>
                        <div class="notes-editor">
                            <div id="notesContent" class="notes-content" contenteditable="true"></div>
                        </div>
                        <div class="notes-actions">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span id="charCount" class="text-muted">0 caratteri</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="clearNotes()"><i class="fas fa-trash me-1"></i> Pulisci</button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="saveNotes()"><i class="fas fa-save me-1"></i> Salva</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			
<!-- TAB ESPOSIZIONE GEOGRAFICA/SETTORIALE -->
<div class="tab-pane fade" id="exposure" role="tabpanel">
    <div class="row">
        <!-- Colonna sinistra: Input dati -->
        <div class="col-md-4">
            <!-- Card Gestione Tipi Esposizione -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-cog me-2"></i> Gestione Tipi Esposizione</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label"><small>Tipi esistenti:</small></label>
                        <div id="exposureTypesList" class="mb-2"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" id="newExposureType" placeholder="Nuovo tipo (es. valutaria)">
                        <button class="btn btn-sm btn-success" onclick="addExposureType()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i> Carica Esposizioni</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-chart-pie me-1"></i> Seleziona Investimento</label>
                        <select class="form-select" id="exposureInvestmentSelect" onchange="loadExposureData()">
                            <option value="">-- Seleziona --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-tag me-1"></i> Tipo Esposizione</label>
                        <div id="exposureTypeRadios"></div>
                    </div>
                    
<div class="mb-3">
    <label class="form-label"><i class="fas fa-file-import me-1"></i> Formato Input</label>
    <select class="form-select" id="inputFormatSelect">
        <option value="separate">Separato: prima % poi nomi</option>
        <option value="inline">In linea: nome + percentuale</option>
    </select>
</div>

<div class="alert alert-info" id="formatHint">
    <small>
        <strong>Formato "Separato":</strong><br>
        Incolla prima le percentuali, poi i nomi (uno per riga):<br>
        <code>23,03 %<br>16,04 %<br>Regno Unito<br>Francia</code>
    </small>
</div>

<div class="mb-3">
    <label class="form-label"><i class="fas fa-paste me-1"></i> Incolla Dati Esposizione</label>
    <textarea class="form-control" id="exposureDataInput" rows="12" placeholder="Incolla qui i dati..."></textarea>
</div>
                    
                    <button class="btn btn-primary w-100 mb-2" onclick="parseAndSaveExposure()">
                        <i class="fas fa-save me-1"></i> Salva Esposizione
                    </button>
                    
                    <button class="btn btn-outline-danger w-100" onclick="deleteExposureData()">
                        <i class="fas fa-trash me-1"></i> Elimina Dati Correnti
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Colonna destra: Analisi -->
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Analisi Esposizione</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-filter me-1"></i> Filtra per Investimenti</label>
                        <select class="form-select" id="exposureFilterSelect" multiple style="height: 300px;" onchange="renderExposureAnalysis()">
                            <option value="ALL" selected><i class="fa-solid fa-list-check"></i> Seleziona tutti gli investimenti</option>
                        </select>
                        <small class="text-muted">Tieni premuto CTRL (o CMD su Mac) per selezionare più investimenti</small>
                    </div>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <button class="btn btn-outline-success" onclick="selectAllExposures()">
                            <i class="fas fa-check-double me-1"></i> Seleziona Tutti
                        </button>
                        <button class="btn btn-outline-secondary" onclick="deselectAllExposures()">
                            <i class="fas fa-times me-1"></i> Deseleziona Tutti
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-chart-pie me-1"></i> Visualizza</label>
                        <div id="exposureViewTypeRadios"></div>
                    </div>
                </div>
            </div>
            
            <div id="exposureResults"></div>
        </div>
    </div>
</div>
			
			<!-- TAB PREVISIONI -->
<div class="tab-pane fade" id="forecast" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Previsioni di Crescita</h5>
        </div>
        <div class="card-body">
			
            <div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label"><i class="fas fa-calendar me-1"></i> Anno Target</label>
       <input type="number" class="form-control" id="targetYear" min="2025" max="2100" placeholder="Es. 2030" onchange="generateYearlyReturnsInputs()">
    </div>
    <div class="col-md-4">
        <label class="form-label"><i class="fas fa-chart-line me-1"></i> Valore Attuale di Mercato (€)</label>
        <div class="input-group">
            <span class="input-group-text">€</span>
            <input type="number" step="0.01" class="form-control" id="marketValue" placeholder="Valore reale del portafoglio" onchange="updateMarketValue()">
            <button class="btn btn-outline-secondary" type="button" onclick="autoFillMarketValue()" title="Usa totale investito">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <small class="text-muted">Capitale attuale considerando guadagni/perdite</small>
    </div>
    <div class="col-md-4">
        <label class="form-label"><i class="fas fa-info-circle me-1"></i> Tipologia di Calcolo</label>
        <select class="form-select" id="calcMode" onchange="calculateForecast()">
            <option value="compound">Interesse Composto (Rendimento su totale progressivo)</option>
            <option value="simple">Interesse Semplice (Rendimento solo su versamenti)</option>
        </select>
    </div>
</div>

          <div class="card mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-percentage me-1"></i> Rendimenti e Versamenti Annuali Attesi</h6>
    </div>
    <div class="card-body">
        <div id="yearlyReturnsInputs"></div>
    </div>
</div>

            <div id="forecastResults"></div>
        </div>
    </div>
</div>
			
        </div>
    </div>

    <button class="floating-action-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
        let investments = [];
        let selectedTags = [];
        let allTags = new Set();
        let allNomi = new Set();
        let exposureData = {}; // Struttura: { nomeInvestimento: { geografica: [{nome, perc}], settoriale: [{nome, perc}] } }
        let exposureTypes = ['geografica', 'settoriale']; // Tipi di esposizione configurabili
        let currentYear = 'all';
        let forecastReturns = {};
        let forecastDeposits = {};
        let forecastInflation = {};
        let currentMarketValue = 0;
        let forecastChart = null;

        // Caricamento dati da localStorage
        function loadData() {
            const saved = localStorage.getItem('investments');
            if (saved) {
                investments = JSON.parse(saved);
                investments.forEach(inv => {
                    inv.settori.forEach(tag => allTags.add(tag));
                    allNomi.add(inv.nome);
                });
                
                updateNomiList();
            }
            
            // Carica appunti
            const savedNotes = localStorage.getItem('investmentNotes');
            if (savedNotes !== null) {
                const notesEl = document.getElementById('notesContent');
                if (notesEl) {
                    notesEl.innerHTML = savedNotes;
                }
            }
            updateCharCount();
            
            // Carica previsioni
            const savedForecast = localStorage.getItem('forecastReturns');
            if (savedForecast) {
                forecastReturns = JSON.parse(savedForecast);
            }
            const savedDeposits = localStorage.getItem('forecastDeposits');
            if (savedDeposits) {
                forecastDeposits = JSON.parse(savedDeposits);
            }

            const savedInflation = localStorage.getItem('forecastInflation');
            if (savedInflation) {
                forecastInflation = JSON.parse(savedInflation);
            }

            const savedMarketValue = localStorage.getItem('currentMarketValue');
            if (savedMarketValue) {
                currentMarketValue = parseFloat(savedMarketValue);
            }
            
            // Carica esposizioni
            const savedExposure = localStorage.getItem('exposureData');
            if (savedExposure) {
                exposureData = JSON.parse(savedExposure);
            }
            
            // Carica tipi esposizione
            const savedExposureTypes = localStorage.getItem('exposureTypes');
            if (savedExposureTypes) {
                exposureTypes = JSON.parse(savedExposureTypes);
            }
        }

        // Salvataggio dati
        function saveData() {
            localStorage.setItem('investments', JSON.stringify(investments));
        }

        // Gestione nomi investimenti
        function updateNomiList() {
            const datalist = document.getElementById('nomiList');
            datalist.innerHTML = '';
            allNomi.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                datalist.appendChild(option);
            });
        }

        // Auto-fill quando si seleziona un nome esistente
        document.getElementById('nome').addEventListener('change', function() {
            const nomeSelezionato = this.value;
            const invEsistente = investments.find(inv => inv.nome === nomeSelezionato);
            if (invEsistente) {
                document.getElementById('ter').value = invEsistente.ter;
                document.getElementById('tipologia').value = invEsistente.tipologia;
                selectedTags = [...invEsistente.settori];

                document.getElementById('link').value = invEsistente.link;
            }
        });

        // Form submit
        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('investmentId').value || Date.now().toString();
            const commissioni = parseFloat(document.getElementById('commissioni').value) || 0;
            const commissioniTipo = document.getElementById('commissioniTipo').value;

            const investment = {
                id: id,
                data: document.getElementById('dataInvestimento').value,
                anno: new Date(document.getElementById('dataInvestimento').value).getFullYear(),
                ter: parseFloat(document.getElementById('ter').value),
                tipologia: document.getElementById('tipologia').value,
                settori: [...selectedTags],
                nome: document.getElementById('nome').value,
                link: document.getElementById('link').value,
                totale: parseFloat(document.getElementById('totaleInvestito').value),
                commissioni: commissioni,
                commissioniTipo: commissioniTipo || 'sottratta'
            };

            const existingIndex = investments.findIndex(inv => inv.id === id);
            if (existingIndex !== -1) {
                investments[existingIndex] = investment;
            } else {
                investments.push(investment);
                allNomi.add(investment.nome);
                updateNomiList();
            }

            saveData();
            resetForm();
            alert('Versamento salvato con successo!');
        });

        function resetForm() {
            document.getElementById('investmentForm').reset();
            document.getElementById('investmentId').value = '';
            document.getElementById('commissioni').value = '';
            document.getElementById('commissioniTipo').value = 'sottratta';
        }

        function cloneInvestment(id) {
            const inv = investments.find(i => i.id === id);
            if (inv) {
                document.getElementById('investmentId').value = '';
                document.getElementById('dataInvestimento').value = '';
                document.getElementById('ter').value = inv.ter;
                document.getElementById('tipologia').value = inv.tipologia;
                selectedTags = [...inv.settori];
                document.getElementById('nome').value = inv.nome;
                document.getElementById('link').value = inv.link;
                document.getElementById('totaleInvestito').value = '';
                document.getElementById('commissioni').value = inv.commissioni || 0;
                document.getElementById('commissioniTipo').value = inv.commissioniTipo || 'sottratta';
                
                // Vai al tab inserimento
                document.getElementById('input-tab').click();
            }
        }

        function editInvestment(id) {
            const inv = investments.find(i => i.id === id);
            if (inv) {
                document.getElementById('investmentId').value = id;
                document.getElementById('dataInvestimento').value = inv.data;
                document.getElementById('ter').value = inv.ter;
                document.getElementById('tipologia').value = inv.tipologia;
                selectedTags = [...inv.settori];
                document.getElementById('nome').value = inv.nome;
                document.getElementById('link').value = inv.link;
                document.getElementById('totaleInvestito').value = inv.totale;
                document.getElementById('commissioni').value = inv.commissioni || 0;
                document.getElementById('commissioniTipo').value = inv.commissioniTipo || 'sottratta';
                
                document.getElementById('input-tab').click();
            }
        }

        function deleteInvestment(id) {
            if (confirm('Sei sicuro di voler eliminare questo versamento?')) {
                investments = investments.filter(inv => inv.id !== id);
                saveData();
                loadSummary();
            }
        }

        function loadSummary() {
            const years = [...new Set(investments.map(inv => inv.anno))].sort((a, b) => b - a);
            
            // Calcola totali per tab usando capitale netto
            const totaleAll = calcolaCapitaleNetto(investments);
            const totaliPerAnno = {};
            years.forEach(year => {
                const investimentiAnno = investments.filter(inv => inv.anno === year);
                totaliPerAnno[year] = calcolaCapitaleNetto(investimentiAnno);
            });

            // Render year tabs
            const yearTabsHtml = `
                <div class="year-tab ${currentYear === 'all' ? 'active' : ''}" onclick="filterByYear('all')">
                    Tutti gli anni
                    <div style="font-size: 0.85rem; margin-top: 3px;">€${totaleAll.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                ${years.map(year => `
                    <div class="year-tab ${currentYear === year ? 'active' : ''}" onclick="filterByYear(${year})">
                        ${year}
                        <div style="font-size: 0.85rem; margin-top: 3px;">€${totaliPerAnno[year].toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                `).join('')}
            `;
            document.getElementById('yearTabs').innerHTML = yearTabsHtml;

            const filtered = currentYear === 'all' ? investments : investments.filter(inv => inv.anno === currentYear);
            
            if (filtered.length === 0) {
                document.getElementById('summaryContent').innerHTML = '<p class="text-muted">Nessun investimento registrato.</p>';
                return;
            }

            // Raggruppa per tipologia e poi per nome
            const byType = {};
            filtered.forEach(inv => {
                if (!byType[inv.tipologia]) byType[inv.tipologia] = {};
                if (!byType[inv.tipologia][inv.nome]) byType[inv.tipologia][inv.nome] = [];
                byType[inv.tipologia][inv.nome].push(inv);
            });

            let html = '';
            Object.keys(byType).sort().forEach(tipo => {
                const investimenti = byType[tipo];
                const totaleType = Object.values(investimenti).flat().reduce((sum, inv) => {
                    const totale = inv.totale;
                    const commissioni = inv.commissioni || 0;
                    const tipo = inv.commissioniTipo || 'sottratta';
                    
                    if (tipo === 'sottratta') {
                        return sum + (totale - commissioni);
                    } else {
                        return sum + totale;
                    }
                }, 0);
                
                html += `
                    <h5 class="mt-4 mb-3">${tipo} <span class="badge bg-secondary">${Object.keys(investimenti).length} investimenti - €${totaleType.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span></h5>
                `;

                Object.keys(investimenti).sort().forEach(nomeInv => {
                    const versamenti = investimenti[nomeInv].sort((a, b) => new Date(a.data) - new Date(b.data));
                    const totaleInvestimento = versamenti.reduce((sum, inv) => {
                        const totale = inv.totale;
                        const commissioni = inv.commissioni || 0;
                        const tipo = inv.commissioniTipo || 'sottratta';
                        
                        if (tipo === 'sottratta') {
                            return sum + (totale - commissioni);
                        } else {
                            return sum + totale;
                        }
                    }, 0);
                    const lastVersamento = versamenti[versamenti.length - 1];

                    html += `
                        <div class="investment-group">
                            <h6 class="mb-3">
                                ${lastVersamento.link ? `<a href="${lastVersamento.link}" target="_blank">${nomeInv}</a>` : nomeInv}
                                <span class="badge bg-primary ms-2">€${totaleInvestimento.toLocaleString('it-IT', {minimumFractionDigits: 2})} netto</span>
                                <span class="badge bg-info ms-1">${versamenti.length} versament${versamenti.length !== 1 ? 'i' : 'o'}</span>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm sub-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Anno</th>
                                            <th>Settori</th>
                                            <th>TER %</th>
                                            <th>Versamento €</th>
                                            <th>Commissioni €</th>
                                            <th>Progressivo €</th>
                                            <th style="min-width:114px;">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    let progressivo = 0;
                    versamenti.forEach((inv, index) => {
                        const capitaleNettoVersamento = (() => {
                            const totale = inv.totale;
                            const commissioni = inv.commissioni || 0;
                            const tipo = inv.commissioniTipo || 'sottratta';
                            
                            if (tipo === 'sottratta') {
                                return totale - commissioni;
                            } else {
                                return totale;
                            }
                        })();
                        
                        progressivo += capitaleNettoVersamento;
                        html += `
                            <tr class="versamento-row">
                                <td>${new Date(inv.data).toLocaleDateString('it-IT')}</td>
                                <td>${inv.anno}</td>
                                <td>
                                    ${inv.settori.map(s => `<span class="badge bg-info badge-custom">${s}</span>`).join(' ')}
                                </td>
                                <td>${inv.ter}%</td>
                                <td>€${inv.totale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                <td>
                                    ${inv.commissioni > 0 ? 
                                        `€${inv.commissioni.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                                        <small class="text-muted">(${inv.commissioniTipo === 'aggiuntiva' ? '+' : 'incl.'})</small>` 
                                        : '-'}
                                </td>
                                <td><strong>€${progressivo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary btn-clone custom-tooltip" onclick="cloneInvestment('${inv.id}')" title="Clona per nuovo versamento">
                                        <i class="fas fa-clone"></i>
                                        <span class="tooltip-text">Clona per nuovo versamento</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary btn-clone custom-tooltip" onclick="editInvestment('${inv.id}')" title="Modifica">
                                        <i class="fas fa-edit"></i>
                                        <span class="tooltip-text">Modifica</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-clone custom-tooltip" onclick="deleteInvestment('${inv.id}')" title="Elimina">
                                        <i class="fas fa-trash"></i>
                                        <span class="tooltip-text">Elimina</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('summaryContent').innerHTML = html;
        }

        function filterByYear(year) {
            currentYear = year;
            loadSummary();
        }

        function loadMatrix() {
            if (investments.length === 0) {
                document.getElementById('matrixContent').innerHTML = '<p class="text-muted">Nessun investimento registrato.</p>';
                return;
            }

            // Raggruppa per nome investimento
            const byNome = {};
            investments.forEach(inv => {
                if (!byNome[inv.nome]) {
                    byNome[inv.nome] = {
                        nome: inv.nome,
                        tipologia: inv.tipologia,
                        link: inv.link,
                        ter: inv.ter,
                        versamenti: []
                    };
                }
                byNome[inv.nome].versamenti.push(inv);
            });

            // Ottieni tutti gli anni ordinati
            const years = [...new Set(investments.map(inv => inv.anno))].sort((a, b) => a - b);

            // Calcola versamenti per anno per ogni investimento (NETTI)
            const matrixData = Object.keys(byNome).sort().map(nome => {
                const inv = byNome[nome];
                const row = {
    nome: inv.nome,
    tipologia: inv.tipologia,
    link: inv.link,
    ter: inv.ter,
    versamenti: {},
    totale: 0,
    commissioni: 0,  // AGGIUNGI QUESTA LINEA
    costoTER: 0
};

                years.forEach(anno => {
                    const versamentiAnno = inv.versamenti.filter(v => v.anno === anno);
                    row.versamenti[anno] = versamentiAnno.reduce((sum, v) => {
                        const totale = v.totale;
                        const commissioni = v.commissioni || 0;
                        const tipo = v.commissioniTipo || 'sottratta';
                        
                        if (tipo === 'sottratta') {
                            return sum + (totale - commissioni);
                        } else {
                            return sum + totale;
                        }
                    }, 0);
                });

                // Calcola totale investito NETTO
   // Calcola totale investito NETTO
row.totale = inv.versamenti.reduce((sum, v) => {
    const totale = v.totale;
    const commissioni = v.commissioni || 0;
    const tipo = v.commissioniTipo || 'sottratta';
    
    if (tipo === 'sottratta') {
        return sum + (totale - commissioni);
    } else {
        return sum + totale;
    }
}, 0);

// Calcola totale commissioni per questo investimento
row.commissioni = inv.versamenti.reduce((sum, v) => {
    return sum + (v.commissioni || 0);
}, 0);

// Calcola costo TER annuale sul capitale netto
row.costoTER = row.totale * (row.ter / 100);

                return row;
            });

            // Calcola totali per anno
            const totaliAnno = {};
            years.forEach(anno => {
                totaliAnno[anno] = matrixData.reduce((sum, row) => sum + (row.versamenti[anno] || 0), 0);
            });

           const granTotale = matrixData.reduce((sum, row) => sum + row.totale, 0);
const totaleCostiTER = matrixData.reduce((sum, row) => sum + row.costoTER, 0);

// Calcola totale commissioni globali
const totaleCommissioniGlobali = investments.reduce((sum, inv) => {
    return sum + (inv.commissioni || 0);
}, 0);

            // Calcola percentuali per tipologia
            const percentualiTipologia = {};
            matrixData.forEach(row => {
                if (!percentualiTipologia[row.tipologia]) {
                    percentualiTipologia[row.tipologia] = 0;
                }
                percentualiTipologia[row.tipologia] += row.totale;
            });

            // Calcola totale Bond/iBond/Metalli
            const totaleBondIBondMetalli = (percentualiTipologia['BOND'] || 0) + 
                                           (percentualiTipologia['IBOND'] || 0) + 
                                           (percentualiTipologia['METALLI PREZIOSI'] || 0);
            
            // Calcola totale ETF/Stocks
            const totaleETFStocks = (percentualiTipologia['ETF'] || 0) + 
                                    (percentualiTipologia['STOCK'] || 0);

            let html = `
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                      <thead class="table-light">
    <tr>
        <th>Investimento</th>
        <th>Tipologia</th>
        <th>TER %</th>
        ${years.map(anno => `<th class="text-center">${anno}</th>`).join('')}
        <th class="text-end">Totale €</th>
        <th class="text-end">% sul Totale</th>
        <th class="text-end">Commissioni €</th> <!-- AGGIUNGI QUESTA COLONNA -->
        <th class="text-end">Costo TER €/anno</th>
    </tr>
</thead>
                        <tbody>
            `;

            // Raggruppa per tipologia
            const byTipologia = {};
            matrixData.forEach(row => {
                if (!byTipologia[row.tipologia]) byTipologia[row.tipologia] = [];
                byTipologia[row.tipologia].push(row);
            });

            Object.keys(byTipologia).sort().forEach(tipologia => {
                const rows = byTipologia[tipologia];
                const totaleTipologia = rows.reduce((sum, row) => sum + row.totale, 0);
                
                // Header tipologia
                html += `
                    <tr class="table-secondary">
    <td colspan="${3 + years.length + 4}" style="font-weight: bold;"> <!-- CAMBIA 3 in 4 -->
        <i class="fas fa-folder"></i> ${tipologia} 
        <span class="badge bg-primary ms-2">€${totaleTipologia.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
        <span class="badge bg-info ms-1">${((totaleTipologia / granTotale) * 100).toFixed(2)}%</span>
    </td>
</tr>
                `;

                // Righe investimenti
                rows.forEach(row => {
                    html += `
                        <tr>
                            <td style="position: sticky; left: 0; background-color: white; z-index: 1;">
                                ${row.link ? `<a href="${row.link}" target="_blank">${row.nome}</a>` : row.nome}
                            </td>
                            <td><span class="badge bg-secondary badge-custom">${row.tipologia}</span></td>
                            <td class="text-end">${row.ter}%</td>
                            
							${years.map(anno => {
    const val = row.versamenti[anno] || 0;
    return `<td class="text-end">${val > 0 ? '€' + val.toLocaleString('it-IT', {minimumFractionDigits: 2}) : '-'}</td>`;
}).join('')}
<td class="text-end"><strong>€${row.totale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
<td class="text-end">${((row.totale / granTotale) * 100).toFixed(2)}%</td>
<td class="text-end">
    ${row.commissioni > 0 ? 
        '€' + row.commissioni.toLocaleString('it-IT', {minimumFractionDigits: 2}) : 
        '-'}
</td>
<td class="text-end">€${row.costoTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
            });

            // Riga totali
            html += `
                        </tbody>
                        <tfoot class="table-dark">
    <tr>
        <td colspan="3" style="position: sticky; left: 0; background-color: #7552a8; z-index: 2;"><strong>TOTALI</strong></td>
        ${years.map(anno => `<td class="text-end"><strong>€${totaliAnno[anno].toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>`).join('')}
        <td class="text-end"><strong>€${granTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
        <td class="text-end"><strong>100%</strong></td>
        <td class="text-end"><strong>€${totaleCommissioniGlobali.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
        <td class="text-end"><strong>€${totaleCostiTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
    </tr>
</tfoot>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Riepilogo per Tipologia</div>
                            <div class="card-body">
                                <table class="table ">
                                    <thead>
                                        <tr>
                                            <th>Tipologia</th>
                                            <th class="text-end">Totale €</th>
                                            <th class="text-end">% Portafoglio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(percentualiTipologia).sort((a, b) => b[1] - a[1]).map(([tipo, val]) => `
                                            <tr>
                                                <td><strong>${tipo}</strong></td>
                                                <td class="text-end">€${val.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td class="text-end"><span class="badge bg-primary">${((val / granTotale) * 100).toFixed(2)}%</span></td>
                                            </tr>
                                        `).join('')}
                                        <tr class="table-info">
                                            <td><strong>Bond / iBond / Metalli Preziosi</strong></td>
                                            <td class="text-end"><strong>€${totaleBondIBondMetalli.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                            <td class="text-end"><span class="badge bg-success">${((totaleBondIBondMetalli / granTotale) * 100).toFixed(2)}%</span></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td><strong>ETF / Stocks</strong></td>
                                            <td class="text-end"><strong>€${totaleETFStocks.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                            <td class="text-end"><span class="badge bg-success">${((totaleETFStocks / granTotale) * 100).toFixed(2)}%</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Costi TER per Investimento</div>
                            <div class="card-body">
                                <table class="table ">
                                    <thead>
                                        <tr>
                                            <th>Investimento</th>
                                            <th class="text-end">TER %</th>
                                            <th class="text-end">Costo €/anno</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${matrixData.sort((a, b) => b.costoTER - a.costoTER).slice(0, 10).map(row => `
                                            <tr>
                                                <td>${row.nome}</td>
                                                <td class="text-end">${row.ter}%</td>
                                                <td class="text-end">€${row.costoTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            </tr>
                                        `).join('')}
										<tfoot>
                                        <tr class="table-dark">
                                            <td colspan="2"><strong>TOTALE COSTI TER</strong></td>
                                            <td class="text-end"><strong>€${totaleCostiTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                        </tr>
										</tfoot>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('matrixContent').innerHTML = html;
        }

        function loadAnalytics() {
            const filtered = currentYear === 'all' ? investments : investments.filter(inv => inv.anno === currentYear);
            
            if (filtered.length === 0) {
                document.getElementById('analyticsContent').innerHTML = '<p class="text-muted">Nessun dato disponibile.</p>';
                return;
            }

            // Raggruppa per nome investimento per calcolare i totali progressivi
            const byNome = {};
            investments.forEach(inv => {
                if (!byNome[inv.nome]) byNome[inv.nome] = [];
                byNome[inv.nome].push(inv);
            });

            // Calcola i totali per anno considerando tutti i versamenti fino a quell'anno (NETTI)
            const totaliPerAnno = {};
            const years = [...new Set(investments.map(inv => inv.anno))].sort();
            
            years.forEach(anno => {
                totaliPerAnno[anno] = 0;
                Object.keys(byNome).forEach(nome => {
                    const versamentiFinoAdAnno = byNome[nome].filter(inv => inv.anno <= anno);
                    if (versamentiFinoAdAnno.length > 0) {
                        totaliPerAnno[anno] += versamentiFinoAdAnno.reduce((sum, inv) => {
                            const totale = inv.totale;
                            const commissioni = inv.commissioni || 0;
                            const tipo = inv.commissioniTipo || 'sottratta';
                            
                            if (tipo === 'sottratta') {
                                return sum + (totale - commissioni);
                            } else {
                                return sum + totale;
                            }
                        }, 0);
                    }
                });
            });

            // Calcola capitale netto investito (escluse commissioni)
            const capitaleNettoInvestito = calcolaCapitaleNetto(filtered);
            
            // Calcola TER sul totale progressivo dell'anno selezionato (sul capitale netto)
            let totaleTER = 0;
            if (currentYear === 'all') {
                // Per "tutti gli anni" calcola il TER più recente di ogni investimento
                Object.keys(byNome).forEach(nome => {
                    const versamenti = byNome[nome].sort((a, b) => new Date(b.data) - new Date(a.data));
                    const ultimo = versamenti[0];
                    const totaleInv = versamenti.reduce((sum, inv) => {
                        const totale = inv.totale;
                        const commissioni = inv.commissioni || 0;
                        const tipo = inv.commissioniTipo || 'sottratta';
                        
                        if (tipo === 'sottratta') {
                            return sum + (totale - commissioni);
                        } else {
                            return sum + totale;
                        }
                    }, 0);
                    totaleTER += totaleInv * (ultimo.ter / 100);
                });
            } else {
                // Per un anno specifico, calcola TER sui versamenti di quell'anno
                Object.keys(byNome).forEach(nome => {
                    const versamentiAnno = byNome[nome].filter(inv => inv.anno === currentYear);
                    if (versamentiAnno.length > 0) {
                        const totaleInv = byNome[nome].filter(inv => inv.anno <= currentYear).reduce((sum, inv) => {
                            const totale = inv.totale;
                            const commissioni = inv.commissioni || 0;
                            const tipo = inv.commissioniTipo || 'sottratta';
                            
                            if (tipo === 'sottratta') {
                                return sum + (totale - commissioni);
                            } else {
                                return sum + totale;
                            }
                        }, 0);
                        const ultimo = versamentiAnno.sort((a, b) => new Date(b.data) - new Date(a.data))[0];
                        totaleTER += totaleInv * (ultimo.ter / 100);
                    }
                });
            }

            // Calcoli per tipologia (sul totale progressivo NETTO)
            const byType = {};
            Object.keys(byNome).forEach(nome => {
                const versamenti = byNome[nome];
                const versamentiValidi = currentYear === 'all' ? versamenti : versamenti.filter(inv => inv.anno <= currentYear);
                if (versamentiValidi.length > 0) {
                    const totaleInv = versamentiValidi.reduce((sum, inv) => {
                        const totale = inv.totale;
                        const commissioni = inv.commissioni || 0;
                        const tipo = inv.commissioniTipo || 'sottratta';
                        
                        if (tipo === 'sottratta') {
                            return sum + (totale - commissioni);
                        } else {
                            return sum + totale;
                        }
                    }, 0);
                    const tipo = versamentiValidi[versamentiValidi.length - 1].tipologia;
                    if (!byType[tipo]) byType[tipo] = 0;
                    byType[tipo] += totaleInv;
                }
            });

            // Calcoli per settore (sul totale progressivo NETTO)
            const bySector = {};
            Object.keys(byNome).forEach(nome => {
                const versamenti = byNome[nome];
                const versamentiValidi = currentYear === 'all' ? versamenti : versamenti.filter(inv => inv.anno <= currentYear);
                if (versamentiValidi.length > 0) {
                    const totaleInv = versamentiValidi.reduce((sum, inv) => {
                        const totale = inv.totale;
                        const commissioni = inv.commissioni || 0;
                        const tipo = inv.commissioniTipo || 'sottratta';
                        
                        if (tipo === 'sottratta') {
                            return sum + (totale - commissioni);
                        } else {
                            return sum + totale;
                        }
                    }, 0);
                    const ultimo = versamentiValidi[versamentiValidi.length - 1];
                    if (ultimo.settori && ultimo.settori.length > 0) {
                        ultimo.settori.forEach(settore => {
                            if (!bySector[settore]) bySector[settore] = 0;
                            bySector[settore] += totaleInv;
                        });
                    }
                }
            });

            const totaleProgressivo = currentYear === 'all' ? 
                Object.values(byType).reduce((sum, val) => sum + val, 0) : 
                totaliPerAnno[currentYear] || 0;

            // Totali specifici
            const stockTotal = byType['STOCK'] || 0;
            const bondTotal = (byType['BOND'] || 0) + (byType['IBOND'] || 0) + (byType['METALLI PREZIOSI'] || 0);
            const etfTotal = byType['ETF'] || 0;

            // Calcola totale commissioni
            const totaleCommissioni = filtered.reduce((sum, inv) => sum + (inv.commissioni || 0), 0);

            // Calcola totale reale speso (versamenti + commissioni aggiuntive)
            const totaleRealeSpeso = filtered.reduce((sum, inv) => {
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                return sum + totale + (tipo === 'aggiuntiva' ? commissioni : 0);
            }, 0);

            let html = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value">€${capitaleNettoInvestito.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                            <div class="stat-label">Capitale Netto Investito</div>
                            <small style="opacity: 0.9; font-size: 0.75rem;">Totale speso: €${totaleRealeSpeso.toLocaleString('it-IT', {minimumFractionDigits: 0})}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-warning);">
                            <div class="stat-value">€${totaleTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="stat-label">Costo TER Annuale</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-danger);">
                            <div class="stat-value" style="color:#575252;">${totaleCommissioni > 0 ? '€' + totaleCommissioni.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}</div>
                            <div class="stat-label" style="color:#575252;">${totaleCommissioni > 0 ? 'Commissioni Totali' : 'Nessuna Commissione'}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-success);">
                            <div class="stat-value">${Object.keys(byNome).length}</div>
                            <div class="stat-label">Investimenti Attivi</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="stat-card" style="background: var(--gradient-info);">
                            <div class="stat-value">${totaleProgressivo > 0 ? (totaleTER / totaleProgressivo * 100).toFixed(2) : 0}%</div>
                            <div class="stat-label">TER Medio</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" style="background: var(--gradient-secondary);">
                            <div class="stat-value">€${(totaleTER + totaleCommissioni).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="stat-label">Costi Totali (TER + Commissioni)</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card" >
                            <div class="stat-value">${totaleProgressivo > 0 ? ((totaleTER + totaleCommissioni) / totaleProgressivo * 100).toFixed(2) : 0}%</div>
                            <div class="stat-label">% Costi sul Totale</div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong><i class="fas fa-info-circle me-2"></i>Capitale Netto Investito:</strong><br>
                                    <small>Importo effettivamente al lavoro (escluse commissioni)</small><br>
                                    <strong class="text-primary">€${capitaleNettoInvestito.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="fas fa-wallet me-2"></i>Totale Realmente Speso:</strong><br>
                                    <small>Versamenti + commissioni aggiuntive</small><br>
                                    <strong class="text-warning">€${totaleRealeSpeso.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="fas fa-receipt me-2"></i>Commissioni Totali:</strong><br>
                                    <small>Somma di tutte le commissioni pagate</small><br>
                                    <strong class="text-danger">€${totaleCommissioni.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${years.length > 1 ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Evoluzione Investimenti per Anno</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Anno</th>
                                                <th>Nuovi Versamenti</th>
                                                <th>Totale Progressivo</th>
                                                <th>Crescita</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${years.map((anno, idx) => {
                                                const versamentiAnno = calcolaCapitaleNetto(investments.filter(inv => inv.anno === anno));
                                                const progressivo = totaliPerAnno[anno];
                                                const crescita = idx > 0 ? ((progressivo - totaliPerAnno[years[idx - 1]]) / totaliPerAnno[years[idx - 1]] * 100).toFixed(2) : 0;
                                                return `
                                                    <tr>
                                                        <td><strong>${anno}</strong></td>
                                                        <td>€${versamentiAnno.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                                        <td><strong>€${progressivo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                                        <td>${crescita > 0 ? `<span class="badge bg-success">+${crescita}%</span>` : idx === 0 ? '-' : `<span class="badge bg-secondary">${crescita}%</span>`}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

               <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Tipologia (Torta)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="typeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Settore (Torta)</div>
                            <div class="card-body">
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="chart-container">
                                        <canvas id="sectorChart"></canvas>
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Tipologia (Barre)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="typeBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Settore (Barre)</div>
                            <div class="card-body">
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="chart-container">
                                        <canvas id="sectorBarChart"></canvas>
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">STOCK</div>
                            <div class="card-body">
                                <h3>€${stockTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (stockTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">BOND + IBOND + METALLI</div>
                            <div class="card-body">
                                <h3>€${bondTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (bondTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">ETF</div>
                            <div class="card-body">
                                <h3>€${etfTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (etfTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Dettaglio Percentuali</div>
                            <div class="card-body">
                                <h6>Per Tipologia:</h6>
                                <div class="row">
                                    ${Object.entries(byType).map(([tipo, val]) => `
                                        <div class="col-md-4 mb-2">
                                            <strong>${tipo}:</strong> €${val.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                                            <span class="text-muted">(${totaleProgressivo > 0 ? (val / totaleProgressivo * 100).toFixed(2) : 0}%)</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <hr>
                                <h6>Per Settore:</h6>
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="row">
                                        ${Object.entries(bySector).sort((a, b) => b[1] - a[1]).map(([settore, val]) => `
                                            <div class="col-md-4 mb-2">
                                                <strong>${settore}:</strong> €${val.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                                                <span class="text-muted">(${totaleProgressivo > 0 ? (val / totaleProgressivo * 100).toFixed(2) : 0}%)</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('analyticsContent').innerHTML = html;

            // Grafici
            setTimeout(() => {
                const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'];
                
                // Grafico tipologia - Torta
                const typeCtx = document.getElementById('typeChart');
                if (typeCtx) {
                    new Chart(typeCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(byType),
                            datasets: [{
                                data: Object.values(byType),
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico tipologia - Barre
                const typeBarCtx = document.getElementById('typeBarChart');
                if (typeBarCtx) {
                    new Chart(typeBarCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(byType),
                            datasets: [{
                                label: 'Importo \u20AC',
                                data: Object.values(byType),
                                backgroundColor: chartColors,
                                borderColor: chartColors.map(c => c),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '\u20AC' + value.toLocaleString('it-IT');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico settori - Torta
                const sectorCtx = document.getElementById('sectorChart');
                if (sectorCtx && Object.keys(bySector).length > 0) {
                    new Chart(sectorCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(bySector),
                            datasets: [{
                                data: Object.values(bySector),
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico settori - Barre
                const sectorBarCtx = document.getElementById('sectorBarChart');
                if (sectorBarCtx && Object.keys(bySector).length > 0) {
                    const sortedSectors = Object.entries(bySector).sort((a, b) => b[1] - a[1]);
                    
                    new Chart(sectorBarCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedSectors.map(s => s[0]),
                            datasets: [{
                                label: 'Importo \u20AC',
                                data: sortedSectors.map(s => s[1]),
                                backgroundColor: chartColors,
                                borderColor: chartColors.map(c => c),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '\u20AC' + value.toLocaleString('it-IT');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Funzioni per il tab Appunti
        function loadNotes() {
            updateCharCount(); // Solo aggiorna il conteggio
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('notesContent').focus();
            updateCharCount();
        }

        function insertLink() {
            const url = prompt('Inserisci URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
            document.getElementById('notesContent').focus();
        }

        function saveNotes() {
            const notesContent = document.getElementById('notesContent').innerHTML;
            localStorage.setItem('investmentNotes', notesContent);
            updateCharCount();
            alert('Appunti salvati con successo!');
        }

        function clearNotes() {
            if (confirm('Sei sicuro di voler cancellare tutti gli appunti?')) {
                document.getElementById('notesContent').innerHTML = '';
                localStorage.removeItem('investmentNotes');
                updateCharCount();
            }
        }

        function updateCharCount() {
            const text = document.getElementById('notesContent').innerText;
            const charCount = text.length;
            document.getElementById('charCount').textContent = `${charCount} caratteri`;
        }

        // Calcola il capitale netto investito (escluse commissioni)
        function calcolaCapitaleNetto(investimenti) {
            return investimenti.reduce((sum, inv) => {
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                
                if (tipo === 'aggiuntiva') {
                    return sum + totale;
                } else {
                    return sum + (totale - commissioni);
                }
            }, 0);
        }

        // Calcola il totale reale speso (versamenti + commissioni aggiuntive)
        function calcolaTotaleRealeSpeso(investimenti) {
            return investimenti.reduce((sum, inv) => {
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                return sum + totale + (tipo === 'aggiuntiva' ? commissioni : 0);
            }, 0);
        }

        // Formattazione campo marketValue a 2 decimali
        const marketValueInput = document.getElementById('marketValue');
        if (marketValueInput) {
            marketValueInput.addEventListener('blur', function() {
                const value = parseFloat(this.value) || 0;
                this.value = value.toFixed(2);
            });
        }

        // Aggiungi listener per aggiornare il conteggio caratteri
        document.getElementById('notesContent').addEventListener('input', updateCharCount);

        // Funzione per esportare i dati
        function exportData() {
            if (investments.length === 0 && !localStorage.getItem('investmentNotes')) {
                alert('Non ci sono dati da esportare!');
                return;
            }

            const notesContent = document.getElementById('notesContent');
            const currentNotes = notesContent ? notesContent.innerHTML : (localStorage.getItem('investmentNotes') || '');

            const dataToExport = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                investments: investments,
                allTags: Array.from(allTags),
                allNomi: Array.from(allNomi),
                notes: currentNotes,
                forecastReturns: forecastReturns,
                forecastDeposits: forecastDeposits,
                forecastInflation: forecastInflation,
                currentMarketValue: currentMarketValue,
                exposureData: exposureData,
                exposureTypes: exposureTypes
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `investimenti_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Dati esportati con successo!');
        }

        // Funzione per importare i dati
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.investments || !Array.isArray(importedData.investments)) {
                        throw new Error('Formato file non valido');
                    }

                    if (investments.length > 0) {
                        const confirmMsg = 'Attenzione: ci sono già ' + investments.length + ' investimenti salvati.\n\n' +
                                         'Scegli:\n' +
                                         'OK = SOSTITUISCI tutti i dati attuali con quelli importati\n' +
                                         'Annulla = AGGIUNGI i dati importati a quelli esistenti';
                        
                        if (confirm(confirmMsg)) {
                            investments = importedData.investments;
                        } else {
                            importedData.investments.forEach(inv => {
                                inv.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                investments.push(inv);
                            });
                        }
                    } else {
                        investments = importedData.investments;
                    }

                    allTags.clear();
                    allNomi.clear();
                    investments.forEach(inv => {
                        if (inv.settori) inv.settori.forEach(tag => allTags.add(tag));
                        allNomi.add(inv.nome);
                    });

                    // IMPORTA ANCHE GLI APPUNTI
                    if (importedData.notes !== undefined) {
                        localStorage.setItem('investmentNotes', importedData.notes);
                        const notesEl = document.getElementById('notesContent');
                        if (notesEl) {
                            notesEl.innerHTML = importedData.notes;
                            updateCharCount();
                        }
                    }
                    
                    // Importa previsioni
                    if (importedData.forecastReturns) {
                        forecastReturns = importedData.forecastReturns;
                        localStorage.setItem('forecastReturns', JSON.stringify(forecastReturns));
                    }

                    if (importedData.forecastDeposits) {
                        forecastDeposits = importedData.forecastDeposits;
                        localStorage.setItem('forecastDeposits', JSON.stringify(forecastDeposits));
                    }

                    if (importedData.forecastInflation) {
                        forecastInflation = importedData.forecastInflation;
                        localStorage.setItem('forecastInflation', JSON.stringify(forecastInflation));
                    }		

                    if (importedData.currentMarketValue !== undefined) {
                        currentMarketValue = parseFloat(importedData.currentMarketValue);
                        localStorage.setItem('currentMarketValue', currentMarketValue.toString());
                    }
                    
                    // Importa esposizioni
                    if (importedData.exposureData) {
                        exposureData = importedData.exposureData;
                        localStorage.setItem('exposureData', JSON.stringify(exposureData));
                    }

                    // Importa tipi esposizione
                    if (importedData.exposureTypes) {
                        exposureTypes = importedData.exposureTypes;
                        localStorage.setItem('exposureTypes', JSON.stringify(exposureTypes));
                    }
                    
                    saveData();
                    updateNomiList();
                    
                    alert('Dati importati con successo!\nImportati: ' + importedData.investments.length + ' investimenti');
                    
                    const activeTab = document.querySelector('.nav-link.active');
                    if (activeTab) {
                        if (activeTab.id === 'summary-tab') loadSummary();
                        else if (activeTab.id === 'matrix-tab') loadMatrix();
                        else if (activeTab.id === 'analytics-tab') loadAnalytics();
                    }

                } catch (error) {
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // Funzione per tornare in cima alla pagina
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        document.getElementById('notes-tab').addEventListener('shown.bs.tab', function () {
            const savedNotes = localStorage.getItem('investmentNotes');
            const notesEl = document.getElementById('notesContent');
            if (savedNotes && notesEl && notesEl.innerHTML.trim() === '') {
                notesEl.innerHTML = savedNotes;
                updateCharCount();
            }
        });

        // Inizializza Select2 con autocomplete e creazione tag
        $(document).ready(function() {
            $('#tagSelect').select2({
                tags: true,
                tokenSeparators: [',', ' '],
                placeholder: "Digita per cercare o aggiungere tag...",
                allowClear: true,
                createTag: function(params) {
                    const term = $.trim(params.term);
                    if (term === '') return null;
                    return { id: term, text: term, newTag: true };
                }
            }).on('select2:select', function(e) {
                const tag = e.params.data.text;
                if (!selectedTags.includes(tag)) {
                    selectedTags.push(tag);
                    allTags.add(tag);
                }
            }).on('select2:unselect', function(e) {
                selectedTags = selectedTags.filter(t => t !== e.params.data.text);
            });

            // Carica tag esistenti
            allTags.forEach(tag => $('#tagSelect').append(`<option value="${tag}">${tag}</option>`));
            $('#tagSelect').val(selectedTags).trigger('change');
        });

        // Aggiorna selectedTags da Select2 prima del submit
        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            selectedTags = $('#tagSelect').val() || [];
        });

        // FUNZIONI PREVISIONI
        function loadForecast() {
            if (investments.length === 0) {
                document.getElementById('forecastResults').innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Non ci sono investimenti da analizzare. Inserisci prima alcuni investimenti.</div>';
                return;
            }

            const currentYearNum = new Date().getFullYear();
            const targetYearInput = document.getElementById('targetYear');
            if (!targetYearInput.value) {
                targetYearInput.value = currentYearNum + 2;
            }
            
            // Imposta valore di mercato basato sul CAPITALE NETTO (escluse commissioni)
            const capitaleNetto = calcolaCapitaleNetto(investments);
            const marketValueInput = document.getElementById('marketValue');

            // Usa il capitale netto come default
            marketValueInput.value = capitaleNetto.toFixed(2);
            currentMarketValue = capitaleNetto;
            localStorage.setItem('currentMarketValue', currentMarketValue.toString());

            generateYearlyReturnsInputs();
        }

        function updateMarketValue() {
            const marketValue = parseFloat(document.getElementById('marketValue').value) || 0;
            currentMarketValue = marketValue;
            localStorage.setItem('currentMarketValue', currentMarketValue.toString());
            calculateForecast(); // Ricalcola tutto quando cambia il valore di mercato
        }

        function autoFillMarketValue() {
            const capitaleNetto = calcolaCapitaleNetto(investments);
            document.getElementById('marketValue').value = capitaleNetto.toFixed(2);
            updateMarketValue();
        }

        function generateYearlyReturnsInputs() {
            const targetYear = parseInt(document.getElementById('targetYear').value);
            const currentYearNum = new Date().getFullYear();
            
            if (!targetYear || targetYear <= currentYearNum) {
                document.getElementById('yearlyReturnsInputs').innerHTML = '<div class="col-12"><p class="text-muted">Inserisci un anno target futuro per iniziare.</p></div>';
                document.getElementById('forecastResults').innerHTML = '';
                return;
            }

            // Verifica se è stato impostato il valore di mercato
            const capitaleNetto = calcolaCapitaleNetto(investments);
            const marketValue = parseFloat(document.getElementById('marketValue').value) || 0;
            const showWarning = marketValue === 0 || marketValue === capitaleNetto;

            // Calcola versamenti netti per anno
            const versamentiNettoPerAnno = {};
            investments.forEach(inv => {
                if (!versamentiNettoPerAnno[inv.anno]) {
                    versamentiNettoPerAnno[inv.anno] = 0;
                }
                
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                
                if (tipo === 'sottratta') {
                    versamentiNettoPerAnno[inv.anno] += (totale - commissioni);
                } else {
                    versamentiNettoPerAnno[inv.anno] += totale;
                }
            });

            // Calcola versamento medio storico netto
            const years = Object.keys(versamentiNettoPerAnno).map(Number);
            const avgAnnualDeposit = years.length > 0 
                ? Math.round(Object.values(versamentiNettoPerAnno).reduce((a, b) => a + b, 0) / years.length)
                : 5000;

            const numYears = targetYear - currentYearNum + 1;
            let html = '';

            if (showWarning) {
                html += `
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attenzione:</strong> Non hai impostato il valore attuale di mercato del tuo portafoglio, o è uguale al capitale netto investito. 
                        Le previsioni useranno solo i versamenti senza considerare guadagni/perdite già maturati. 
                        <button class="btn btn-sm btn-outline-warning ms-2" onclick="document.getElementById('marketValue').focus()">
                            <i class="fas fa-edit me-1"></i>Imposta ora
                        </button>
                    </div>
                `;
            }

            html += `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Istruzioni:</strong> Inserisci il rendimento atteso (%) e eventuali versamenti aggiuntivi previsti (€) per ogni anno dal ${currentYearNum} al ${targetYear} (${numYears} anni). 
                    I calcoli si aggiornano in tempo reale. Il versamento medio storico netto è di €${avgAnnualDeposit.toLocaleString('it-IT')}/anno.
                </div>
            `;
            
            for (let year = currentYearNum; year <= targetYear; year++) {
                const savedReturn = forecastReturns[year] || '';
                const savedDeposit = forecastDeposits[year] || (year > currentYearNum ? avgAnnualDeposit : '');
                const versamentoEffettivo = versamentiNettoPerAnno[year] || 0;
                const hasVersamento = versamentoEffettivo > 0;
                
                const savedInflation = forecastInflation[year] || '';

                html += `
                    <div class="year-forecast-inputs">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-calendar me-1"></i><strong>${year}</strong></h6>
                                ${hasVersamento ? `<small class="text-success"><i class="fas fa-check-circle me-1"></i>Dati presenti</small>` : `<small class="text-muted">Previsione</small>`}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label mb-1"><small>Rendimento Atteso (%)</small></label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="return_${year}" value="${savedReturn}" 
                                           placeholder="Es. 7.5" oninput="updateYearForecast(${year})">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label mb-1"><small>Inflazione (%)</small></label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="inflation_${year}" value="${savedInflation}" 
                                           placeholder="Es. 2.5" oninput="updateYearForecast(${year})">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label mb-1">
                                    <small>Versamento ${hasVersamento ? 'Aggiuntivo' : 'Previsto'} (€)</small>
                                    ${hasVersamento ? `<span class="badge bg-success ms-2">Già investito: €${versamentoEffettivo.toLocaleString('it-IT', {minimumFractionDigits: 0})}</span>` : ''}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="number" step="100" class="form-control" id="deposit_${year}" value="${savedDeposit}" 
                                           placeholder="${hasVersamento ? 'Aggiungi altro...' : 'Es. ' + avgAnnualDeposit}" oninput="updateYearForecast(${year})">
                                    ${hasVersamento ? `<span class="input-group-text bg-info text-white" title="Totale con versamento già effettuato"><i class="fas fa-calculator"></i></span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-primary fw-bold" id="preview_${year}"></small>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('yearlyReturnsInputs').innerHTML = html;
            calculateForecast();
        }

        function updateYearForecast(year) {
            const returnVal = parseFloat(document.getElementById(`return_${year}`).value) || 0;
            const depositVal = parseFloat(document.getElementById(`deposit_${year}`).value) || 0;
            const inflationVal = parseFloat(document.getElementById(`inflation_${year}`).value) || 0;
            
            forecastReturns[year] = returnVal;
            forecastDeposits[year] = depositVal;
            forecastInflation[year] = inflationVal;
            
            localStorage.setItem('forecastReturns', JSON.stringify(forecastReturns));
            localStorage.setItem('forecastDeposits', JSON.stringify(forecastDeposits));
            localStorage.setItem('forecastInflation', JSON.stringify(forecastInflation));
            
            calculateForecast();
        }

        function calculateForecast() {
            const targetYear = parseInt(document.getElementById('targetYear').value);
            const currentYearNum = new Date().getFullYear();
            const calcMode = document.getElementById('calcMode').value;

            if (!targetYear || targetYear <= currentYearNum) {
                document.getElementById('forecastResults').innerHTML = '';
                return;
            }

            // Calcola CAPITALE NETTO INVESTITO (escluse commissioni)
            const capitaleNetto = calcolaCapitaleNetto(investments);

            // Usa valore di mercato salvato o quello inserito nel campo
            let marketValue = parseFloat(document.getElementById('marketValue').value);
            if (!marketValue || marketValue === 0) {
                // Se non c'è valore di mercato, usa il valore salvato o il CAPITALE NETTO
                marketValue = currentMarketValue > 0 ? currentMarketValue : capitaleNetto;
                document.getElementById('marketValue').value = marketValue.toFixed(2);
            }

            // Aggiorna il valore salvato
            currentMarketValue = marketValue;
            localStorage.setItem('currentMarketValue', currentMarketValue.toString());

            const currentCapital = marketValue;
            // Guadagno/Perdita = Valore Mercato - Capitale Netto Investito
            const currentGainLoss = marketValue - capitaleNetto;
            const currentGainLossPerc = capitaleNetto > 0 ? ((currentGainLoss / capitaleNetto) * 100) : 0;

            // Calcola TER medio sul capitale netto
            const byNome = {};
            investments.forEach(inv => {
                if (!byNome[inv.nome]) byNome[inv.nome] = [];
                byNome[inv.nome].push(inv);
            });
            
            let totaleTER = 0;
            Object.keys(byNome).forEach(nome => {
                const versamenti = byNome[nome].sort((a, b) => new Date(b.data) - new Date(a.data));
                const ultimo = versamenti[0];
                const totaleInv = versamenti.reduce((sum, inv) => {
                    const totale = inv.totale;
                    const commissioni = inv.commissioni || 0;
                    const tipo = inv.commissioniTipo || 'sottratta';
                    
                    if (tipo === 'sottratta') {
                        return sum + (totale - commissioni);
                    } else {
                        return sum + totale;
                    }
                }, 0);
                totaleTER += totaleInv * (ultimo.ter / 100);
            });
            const avgTER = capitaleNetto > 0 ? (totaleTER / capitaleNetto * 100) : 0;

            // Simulazioni
            const scenarios = [
                { name: 'Ottimistica (100%)', multiplier: 1, color: 'success' },
                { name: 'Realistica (-30%)', multiplier: 0.7, color: 'info' },
                { name: 'Moderata (-50%)', multiplier: 0.5, color: 'warning' },
                { name: 'Prudente (-70%)', multiplier: 0.3, color: 'danger' }
            ];

            const results = scenarios.map(scenario => {
                // IMPORTANTE: Parte dal valore di mercato reale (currentCapital include già guadagni/perdite)
                let capital = currentCapital;
                const yearlyData = [];
                // totalDeposited parte dal CAPITALE NETTO già investito finora
                let totalDeposited = capitaleNetto;
                
                // Calcola versamenti netti per anno
                const versamentiNettoPerAnno = {};
                investments.forEach(inv => {
                    if (!versamentiNettoPerAnno[inv.anno]) {
                        versamentiNettoPerAnno[inv.anno] = 0;
                    }
                    
                    const totale = inv.totale;
                    const commissioni = inv.commissioni || 0;
                    const tipo = inv.commissioniTipo || 'sottratta';
                    
                    if (tipo === 'sottratta') {
                        versamentiNettoPerAnno[inv.anno] += (totale - commissioni);
                    } else {
                        versamentiNettoPerAnno[inv.anno] += totale;
                    }
                });
                
                let cumulativeInflation = 1; // Per calcolare inflazione cumulativa

                for (let year = currentYearNum; year <= targetYear; year++) {
                    const depositPrevisto = parseFloat(forecastDeposits[year]) || 0;
                    const depositEffettivo = versamentiNettoPerAnno[year] || 0;
                    const inflationRate = (forecastInflation[year] || 0) / 100;
                    
                    // Aggiorna inflazione cumulativa
                    cumulativeInflation *= (1 + inflationRate);
                    
                    // Gestione corretta dei versamenti
                    let depositTotale = 0;
                    if (year === currentYearNum) {
                        depositTotale = depositPrevisto;
                    } else if (year > currentYearNum) {
                        depositTotale = depositPrevisto + depositEffettivo;
                    }
                    
                    // Aggiungi versamento PRIMA di calcolare il rendimento
                    if (depositTotale > 0) {
                        capital += depositTotale;
                        totalDeposited += depositTotale;
                    }
                    
                    // Calcola rendimento sul capitale aggiornato
                    const returnRate = (forecastReturns[year] || 0) * scenario.multiplier / 100;
                    let gain = 0;
                    
                    if (returnRate !== 0) {
                        if (calcMode === 'compound') {
                            gain = capital * returnRate;
                        } else {
                            gain = totalDeposited * returnRate;
                        }
                        capital += gain;
                    }
                    
                    // Sottrai TER solo se c'è capitale
                    const terCost = capital > 0 ? capital * (avgTER / 100) : 0;
                    capital -= terCost;
                    
                    // Calcola capitale reale corretto per inflazione
                    const realCapital = capital / cumulativeInflation;
                    
                    yearlyData.push({
                        year,
                        capital: capital,
                        realCapital: realCapital,
                        gain: gain,
                        terCost: terCost,
                        deposited: totalDeposited,
                        inflation: inflationRate * 100,
                        cumulativeInflation: cumulativeInflation
                    });
                }
                        
                const finalData = yearlyData[yearlyData.length - 1];
                const totalGain = finalData.capital - finalData.deposited;
                const capitalGainTax = totalGain > 0 ? totalGain * 0.26 : 0;
                const netCapital = finalData.capital - capitalGainTax;
                const realNetCapital = finalData.realCapital - (capitalGainTax / finalData.cumulativeInflation);

                return {
                    ...scenario,
                    finalCapital: finalData.capital,
                    realFinalCapital: finalData.realCapital,
                    totalDeposited: finalData.deposited,
                    totalGain: totalGain,
                    capitalGainTax: capitalGainTax,
                    netCapital: netCapital,
                    realNetCapital: realNetCapital,
                    cumulativeInflation: finalData.cumulativeInflation,
                    yearlyData: yearlyData
                };
            });

            // Aggiorna preview in tempo reale
            // Calcola versamenti netti per anno
            const versamentiNettoPerAnno = {};
            investments.forEach(inv => {
                if (!versamentiNettoPerAnno[inv.anno]) {
                    versamentiNettoPerAnno[inv.anno] = 0;
                }
                
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                
                if (tipo === 'sottratta') {
                    versamentiNettoPerAnno[inv.anno] += (totale - commissioni);
                } else {
                    versamentiNettoPerAnno[inv.anno] += totale;
                }
            });

            // Calcola preview con capitale progressivo
            let capitalProgressivo = currentCapital;
            let totaleVersatoProgressivo = capitaleNetto;

            for (let year = currentYearNum; year <= targetYear; year++) {
                const previewEl = document.getElementById(`preview_${year}`);
                const returnVal = forecastReturns[year] || 0;
                const depositPrevisto = forecastDeposits[year] || 0;
                const depositEffettivo = versamentiNettoPerAnno[year] || 0;
                
                let depositTotale = 0;
                if (year === currentYearNum) {
                    depositTotale = depositPrevisto;
                } else if (year > currentYearNum) {
                    depositTotale = depositPrevisto + depositEffettivo;
                }
                
                // Aggiungi versamento al capitale progressivo
                if (depositTotale > 0) {
                    capitalProgressivo += depositTotale;
                    totaleVersatoProgressivo += depositTotale;
                }
                
                // Calcola guadagno basato sul capitale progressivo
                const calcMode = document.getElementById('calcMode').value;
                let estimatedGain = 0;
                if (returnVal) {
                    if (calcMode === 'compound') {
                        estimatedGain = capitalProgressivo * (returnVal / 100);
                    } else {
                        estimatedGain = totaleVersatoProgressivo * (returnVal / 100);
                    }
                }
                
                // Applica guadagno al capitale progressivo per anno successivo
                capitalProgressivo += estimatedGain;
                
                // Sottrai TER
                const terCost = capitalProgressivo * (avgTER / 100);
                capitalProgressivo -= terCost;
                
                if (previewEl) {
                    let previewText = '';
                    
                    if (depositEffettivo > 0 && depositPrevisto > 0) {
                        previewText = `💰 TOTALE anno: €${depositTotale.toLocaleString('it-IT')} (già investito: €${depositEffettivo.toLocaleString('it-IT')} + previsto: €${depositPrevisto.toLocaleString('it-IT')})`;
                    } else if (depositTotale > 0) {
                        previewText = `💵 Versamento totale: €${depositTotale.toLocaleString('it-IT')}`;
                    }
                    
                    if (returnVal) {
                        previewText += (previewText ? ' | ' : '') + `📈 Guadagno stimato con ${returnVal}%: €${estimatedGain.toLocaleString('it-IT', {minimumFractionDigits: 0})} | 💼 Capitale fine anno: €${capitalProgressivo.toLocaleString('it-IT', {minimumFractionDigits: 0})}`;
                    }
                    
                    previewEl.textContent = previewText || '';
                }
            }

            renderForecastResults(results, capitaleNetto, currentCapital, currentGainLoss, currentGainLossPerc, avgTER, targetYear);
        }

        function renderForecastResults(results, capitaleNetto, currentCapital, currentGainLoss, currentGainLossPerc, avgTER, targetYear) {
            const currentYearNum = new Date().getFullYear();
            const yearsToTarget = targetYear - currentYearNum + 1;

            let html = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="card border-secondary">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Capitale Netto Investito</h6>
                                <h3 class="text-secondary mb-0">€${capitaleNetto.toLocaleString('it-IT', {minimumFractionDigits: 0})}</h3>
                                <small class="text-muted">(escluse commissioni)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Valore di Mercato</h6>
                                <h3 class="text-primary mb-0">€${currentCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</h3>
                                <small class="${currentGainLoss >= 0 ? 'text-success' : 'text-danger'}">
                                    ${currentGainLoss >= 0 ? '+' : ''}€${currentGainLoss.toLocaleString('it-IT', {minimumFractionDigits: 0})} 
                                    (${currentGainLossPerc >= 0 ? '+' : ''}${currentGainLossPerc.toFixed(2)}%)
                                </small>
                                <br>
                                <small class="text-muted">vs capitale netto: €${capitaleNetto.toLocaleString('it-IT', {minimumFractionDigits: 0})}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">TER Medio</h6>
                                <h3 class="text-warning mb-0">${avgTER.toFixed(2)}%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Anni di Investimento</h6>
                                <h3 class="text-success mb-0">${yearsToTarget}</h3>
                            </div>
                        </div>
                    </div>
                </div>  

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Simulazioni di Crescita al ${targetYear}</h5>
                    </div>
                    <div class="card-body">
					<!-- Accordion Bootstrap con versione semplificata -->
<div class="accordion mt-3 mb-4" id="accordionCalcolo">
    <div class="accordion-item border-0">
        <h2 class="accordion-header" id="headingCalcolo">
            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCalcolo" aria-expanded="false" aria-controls="collapseCalcolo" style="background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
                <div class="d-flex align-items-center w-100">
                    <i class="fas fa-calculator me-3" style="color: #17a2b8;"></i>
                    <div class="flex-grow-1 text-start">
                        <span class="fw-bold">Nota sui calcoli</span>
                        <span class="text-muted ms-2" style="font-size: 0.9rem;">I risultati usano la capitalizzazione composta con inclusione TER</span>
                    </div>
                    
                </div>
            </button>
        </h2>
        <div id="collapseCalcolo" class="accordion-collapse collapse" aria-labelledby="headingCalcolo" data-bs-parent="#accordionCalcolo">
            <div class="accordion-body pt-3" style="background-color: #f8f9fa;">
                <div class="row">
                    <div class="col-md-6 border-end pe-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-chart-line me-2" style="color: #17a2b8;"></i>
                            Formula utilizzata
                        </h6>
                        <div class="alert alert-light border bg-white">
                            <code class="fs-6">Capitale × (1 + rendimento)<sup>tempo</sup></code>
                            <div class="mt-2 text-muted" style="font-size: 0.9rem;">
                                <strong>Esempio pratico:</strong><br>
                                €52.000 × (1.0976)<sup>1</sup> = €57.076,53
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 ps-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-question-circle me-2" style="color: #17a2b8;"></i>
                            Perché non è lineare?
                        </h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-center py-2 px-0" style="background: transparent; border-color: #dee2e6;">
                                <i class="fas fa-check-circle text-success me-3"></i>
                                <div>
                                    <strong>Rendimento netto:</strong> 10% - TER 0.20% = 9.80%
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center py-2 px-0" style="background: transparent; border-color: #dee2e6;">
                                <i class="fas fa-check-circle text-success me-3"></i>
                                <div>
                                    <strong>Capitalizzazione composta</strong> (non semplice)
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center py-2 px-0" style="background: transparent; border-color: #dee2e6;">
                                <i class="fas fa-check-circle text-success me-3"></i>
                                <div>
                                    <strong>Differenza:</strong> -€123,47 vs calcolo lineare
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info border-info mb-0" style="background-color: rgba(23, 162, 184, 0.05);">
                            <div class="d-flex">
                                <i class="fas fa-lightbulb fs-5 me-3" style="color: #17a2b8;"></i>
                                <div>
                                    <strong>Perché questa differenza?</strong><br>
                                    Con la capitalizzazione composta mensile e il TER, il rendimento effettivo netto è circa 
                                    <span class="fw-bold">9.76%</span> invece del 10% atteso.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                        <div class="row">
            `;

            results.forEach(result => {
                const roi = ((result.finalCapital - result.totalDeposited) / result.totalDeposited * 100);
                const realRoi = ((result.realNetCapital - result.totalDeposited) / result.totalDeposited * 100);
                const purchasingPowerLoss = ((result.netCapital - result.realNetCapital) / result.netCapital * 100);
                
                html += `
                    <div class="col-md-6 mb-4">
                        <div class="card border-${result.color}">
                            <div class="card-header bg-${result.color} text-white">
                                <h6 class="mb-0">${result.name}</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td><strong>Capitale Finale (lordo):</strong></td>
                                        <td class="text-end"><strong class="text-${result.color}">\u20AC${result.finalCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Totale Versato:</td>
                                        <td class="text-end">\u20AC${result.totalDeposited.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                                    </tr>
                                    <tr>
                                        <td>Guadagno Totale:</td>
                                        <td class="text-end text-success">+\u20AC${result.totalGain.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                                    </tr>
                                    <tr>
                                        <td>ROI (nominale):</td>
                                        <td class="text-end"><span class="badge bg-${result.color}">${roi.toFixed(1)}%</span></td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Tasse Capital Gain (26%):</strong></td>
                                        <td class="text-end"><strong class="text-danger">-\u20AC${result.capitalGainTax.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Capitale Finale (netto):</strong></td>
                                        <td class="text-end"><strong class="text-success">\u20AC${result.netCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Capitale Reale (corretto inflazione):</strong></td>
                                        <td class="text-end"><strong class="text-info">\u20AC${result.realNetCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                                    </tr>
                                    <tr>
                                        <td><small>ROI reale:</small></td>
                                        <td class="text-end"><small><span class="badge bg-secondary">${realRoi.toFixed(1)}%</span></small></td>
                                    </tr>
                                    <tr>
                                        <td><small>Perdita potere d'acquisto:</small></td>
                                        <td class="text-end"><small class="text-warning">-${purchasingPowerLoss.toFixed(1)}%</small></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Grafico Comparativo</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="forecastChart" style="height: 400px;"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Dettaglio Anno per Anno</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Anno</th>
                                        <th class="text-end">Versato Progressivo</th>
                                        ${results.map(r => `<th class="text-end text-${r.color}">${r.name.split(' ')[0]}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
            `;

            const maxYears = results[0].yearlyData.length;
            for (let i = 0; i < maxYears; i++) {
                const year = results[0].yearlyData[i].year;
                html += `
                    <tr>
                        <td><strong>${year}</strong></td>
                        <td class="text-end">\u20AC${results[0].yearlyData[i].deposited.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                        ${results.map(r => `<td class="text-end">\u20AC${r.yearlyData[i].capital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>`).join('')}
                    </tr>
                `;
            }

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('forecastResults').innerHTML = html;
            renderForecastChart(results);
        }

        function renderForecastChart(results) {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;

            if (forecastChart) {
                forecastChart.destroy();
            }

            const colors = {
                'success': 'rgba(25, 135, 84, 0.8)',
                'info': 'rgba(13, 202, 240, 0.8)',
                'warning': 'rgba(255, 193, 7, 0.8)',
                'danger': 'rgba(220, 53, 69, 0.8)'
            };

            const datasets = results.map(result => ({
                label: result.name,
                data: result.yearlyData.map(d => d.capital),
                borderColor: colors[result.color],
                backgroundColor: colors[result.color].replace('0.8', '0.2'),
                borderWidth: 2,
                tension: 0.4,
                fill: false
            }));

            datasets.push({
                label: 'Totale Versato',
                data: results[0].yearlyData.map(d => d.deposited),
                borderColor: 'rgba(108, 117, 125, 0.8)',
                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                fill: false
            });

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results[0].yearlyData.map(d => d.year),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': \u20AC' + context.parsed.y.toLocaleString('it-IT', {minimumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '\u20AC' + value.toLocaleString('it-IT', {minimumFractionDigits: 0});
                                }
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // FUNZIONI ESPOSIZIONE GEOGRAFICA/SETTORIALE
        // ============================================

        function loadExposure() {
            // Render tipi esposizione
            renderExposureTypesList();
            renderExposureTypeRadios();
            renderExposureViewTypeRadios();
            
            // Popola select investimenti
            const select = document.getElementById('exposureInvestmentSelect');
            const filterSelect = document.getElementById('exposureFilterSelect');
            
            select.innerHTML = '<option value="">-- Seleziona --</option>';
            filterSelect.innerHTML = '<option value="ALL" selected><i class="fa-solid fa-list-check"></i> Seleziona tutti gli investimenti</option>';
            
            // Ottieni lista investimenti unici
            const uniqueInvestments = [...new Set(investments.map(inv => inv.nome))].sort();
            
            uniqueInvestments.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                select.appendChild(option);
                
                const filterOption = document.createElement('option');
                filterOption.value = nome;
                filterOption.textContent = nome + (exposureData[nome] ? ' ✓' : '');
                if (exposureData[nome]) {
                    filterOption.selected = true;
                }
                filterSelect.appendChild(filterOption);
            });
            
            renderExposureAnalysis();
        }

        function renderExposureTypesList() {
            const container = document.getElementById('exposureTypesList');
            if (!container) return;
            
            let html = '';
            exposureTypes.forEach(type => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge bg-secondary">${type}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteExposureType('${type}')" title="Elimina tipo">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<small class="text-muted">Nessun tipo definito</small>';
        }

        function renderExposureTypeRadios() {
            const container = document.getElementById('exposureTypeRadios');
            if (!container) return;
            
            let html = '<div class="btn-group w-100" role="group">';
            exposureTypes.forEach((type, idx) => {
                html += `
                    <input type="radio" class="btn-check" name="exposureType" id="exposureType${idx}" value="${type}" ${idx === 0 ? 'checked' : ''} onchange="loadExposureData()">
                    <label class="btn btn-outline-primary" for="exposureType${idx}">${type.charAt(0).toUpperCase() + type.slice(1)}</label>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderExposureViewTypeRadios() {
            const container = document.getElementById('exposureViewTypeRadios');
            if (!container) return;
            
            let html = '<div class="btn-group w-100" role="group">';
            exposureTypes.forEach((type, idx) => {
                html += `
                    <input type="radio" class="btn-check" name="viewType" id="viewType${idx}" value="${type}" ${idx === 0 ? 'checked' : ''} onchange="renderExposureAnalysis()">
                    <label class="btn btn-outline-info" for="viewType${idx}">${type.charAt(0).toUpperCase() + type.slice(1)}</label>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function addExposureType() {
            const input = document.getElementById('newExposureType');
            const newType = input.value.trim().toLowerCase();
            
            if (!newType) {
                alert('Inserisci un nome per il tipo di esposizione!');
                return;
            }
            
            if (exposureTypes.includes(newType)) {
                alert('Questo tipo esiste già!');
                return;
            }
            
            exposureTypes.push(newType);
            localStorage.setItem('exposureTypes', JSON.stringify(exposureTypes));
            
            // Inizializza il nuovo tipo per tutti gli investimenti esistenti
            Object.keys(exposureData).forEach(invName => {
                if (!exposureData[invName][newType]) {
                    exposureData[invName][newType] = [];
                }
            });
            localStorage.setItem('exposureData', JSON.stringify(exposureData));
            
            input.value = '';
            loadExposure();
            alert(`Tipo "${newType}" aggiunto con successo!`);
        }

        function deleteExposureType(type) {
            if (exposureTypes.length <= 1) {
                alert('Devi avere almeno un tipo di esposizione!');
                return;
            }
            
            if (!confirm(`Vuoi eliminare il tipo "${type}"?\n\nATTENZIONE: Verranno eliminati tutti i dati di esposizione di questo tipo per TUTTI gli investimenti!`)) {
                return;
            }
            
            // Rimuovi tipo dall'array
            exposureTypes = exposureTypes.filter(t => t !== type);
            localStorage.setItem('exposureTypes', JSON.stringify(exposureTypes));
            
            // Rimuovi dati di questo tipo da tutti gli investimenti
            Object.keys(exposureData).forEach(invName => {
                if (exposureData[invName][type]) {
                    delete exposureData[invName][type];
                }
                
                // Se l'investimento non ha più dati, rimuovilo completamente
                if (Object.keys(exposureData[invName]).length === 0) {
                    delete exposureData[invName];
                }
            });
            localStorage.setItem('exposureData', JSON.stringify(exposureData));
            
            loadExposure();
            alert(`Tipo "${type}" eliminato!`);
        }

        function loadExposureData() {
            const investmentName = document.getElementById('exposureInvestmentSelect').value;
            if (!investmentName || !exposureData[investmentName]) {
                document.getElementById('exposureDataInput').value = '';
                return;
            }
            
            // Mostra i dati salvati in formato modificabile
            const type = document.querySelector('input[name="exposureType"]:checked').value;
            const data = exposureData[investmentName][type];
            
            if (data && data.length > 0) {
                const format = document.getElementById('inputFormatSelect').value;
                let text = '';
                
                if (format === 'inline') {
                    // Formato in linea: "Nome 12,34"
                    data.forEach(item => {
                        text += `${item.nome} ${item.perc.toFixed(2)}\n`;
                    });
                } else {
                    // Formato separato
                    data.forEach(item => {
                        text += item.perc.toFixed(2) + ' %\n';
                    });
                    data.forEach(item => {
                        text += item.nome + '\n';
                    });
                }
                
                document.getElementById('exposureDataInput').value = text;
            } else {
                document.getElementById('exposureDataInput').value = '';
            }
        }

        function parseAndSaveExposure() {
            const investmentName = document.getElementById('exposureInvestmentSelect').value;
            if (!investmentName) {
                alert('Seleziona un investimento!');
                return;
            }
            
            const rawData = document.getElementById('exposureDataInput').value.trim();
            if (!rawData) {
                alert('Inserisci i dati da parsare!');
                return;
            }
            
            const type = document.querySelector('input[name="exposureType"]:checked').value;
            
            // Parse dei dati in base al formato selezionato
            const format = document.getElementById('inputFormatSelect').value;
            const lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
            let parsedData = [];

            if (format === 'inline') {
                // Formato: "Stati Uniti 71,94"
                lines.forEach(line => {
                    // Cerca pattern: testo seguito da numero
                    const match = line.match(/^(.+?)\s+([\d,\.]+)\s*%?\s*$/);
                    if (match) {
                        const nome = match[1].trim();
                        const perc = parseFloat(match[2].replace(',', '.'));
                        if (!isNaN(perc)) {
                            parsedData.push({ nome, perc });
                        }
                    }
                });
                
                if (parsedData.length === 0) {
                    alert('Nessun dato valido trovato! Verifica il formato:\nOgni riga deve contenere: Nome Percentuale\nEs: Stati Uniti 71,94');
                    return;
                }
                
            } else {
                // Formato separato: prima % poi nomi
                const percentages = [];
                const names = [];
                
                lines.forEach(line => {
                    // Controlla se la riga contiene una percentuale
                    if (line.match(/[\d,\.]+\s*%/)) {
                        // Estrai il numero
                        const num = parseFloat(line.replace(',', '.').replace('%', '').trim());
                        percentages.push(num);
                    } else {
                        names.push(line);
                    }
                });
                
                if (percentages.length !== names.length) {
                    alert(`Errore: trovate ${percentages.length} percentuali e ${names.length} nomi. Devono essere uguali!`);
                    return;
                }
                
                // Crea array di oggetti
                parsedData = names.map((nome, idx) => ({
                    nome: nome,
                    perc: percentages[idx]
                }));
            }
            
            // Salva
            if (!exposureData[investmentName]) {
                exposureData[investmentName] = {};
                exposureTypes.forEach(t => {
                    exposureData[investmentName][t] = [];
                });
            }
            
            exposureData[investmentName][type] = parsedData;
            localStorage.setItem('exposureData', JSON.stringify(exposureData));
            
            alert(`Salvati ${parsedData.length} elementi per ${investmentName} (${type})!`);
            document.getElementById('exposureDataInput').value = '';
            loadExposure();
        }

        function deleteExposureData() {
            const investmentName = document.getElementById('exposureInvestmentSelect').value;
            if (!investmentName) {
                alert('Seleziona un investimento!');
                return;
            }
            
            const type = document.querySelector('input[name="exposureType"]:checked').value;
            
            if (confirm(`Vuoi eliminare i dati di esposizione ${type} per ${investmentName}?`)) {
                if (exposureData[investmentName]) {
                    exposureData[investmentName][type] = [];
                    
                    // Controlla se l'investimento ha ancora dati
                    const hasData = exposureTypes.some(t => exposureData[investmentName][t] && exposureData[investmentName][t].length > 0);
                    
                    if (!hasData) {
                        delete exposureData[investmentName];
                    }
                }
                localStorage.setItem('exposureData', JSON.stringify(exposureData));
                document.getElementById('exposureDataInput').value = '';
                loadExposure();
                alert('Dati eliminati!');
            }
        }

        function selectAllExposures() {
            const select = document.getElementById('exposureFilterSelect');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
            renderExposureAnalysis();
        }

        function deselectAllExposures() {
            const select = document.getElementById('exposureFilterSelect');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            renderExposureAnalysis();
        }

        function renderExposureAnalysis() {
            const viewType = document.querySelector('input[name="viewType"]:checked')?.value;
            if (!viewType) return;
            
            const filterSelect = document.getElementById('exposureFilterSelect');
            const selectedOptions = Array.from(filterSelect.selectedOptions).map(opt => opt.value);
            
            if (selectedOptions.length === 0) {
                document.getElementById('exposureResults').innerHTML = '<div class="alert alert-warning">Seleziona almeno un investimento!</div>';
                return;
            }
            
            // Determina quali investimenti includere
            let investmentsToAnalyze = [];
            if (selectedOptions.includes('ALL')) {
                investmentsToAnalyze = Object.keys(exposureData);
            } else {
                investmentsToAnalyze = selectedOptions.filter(name => exposureData[name]);
            }
            
            if (investmentsToAnalyze.length === 0) {
                document.getElementById('exposureResults').innerHTML = '<div class="alert alert-info">Nessun dato di esposizione disponibile per gli investimenti selezionati.</div>';
                return;
            }
            
            // Calcola capitale netto investito per ogni investimento
            const investmentNetTotals = {};
            investments.forEach(inv => {
                if (!investmentNetTotals[inv.nome]) {
                    investmentNetTotals[inv.nome] = 0;
                }
                const totale = inv.totale;
                const commissioni = inv.commissioni || 0;
                const tipo = inv.commissioniTipo || 'sottratta';
                
                if (tipo === 'sottratta') {
                    investmentNetTotals[inv.nome] += (totale - commissioni);
                } else {
                    investmentNetTotals[inv.nome] += totale;
                }
            });

            // Calcola totale SOLO degli investimenti analizzati (con dati esposizione)
            const totalPortfolio = investmentsToAnalyze.reduce((sum, invName) => {
                return sum + (investmentNetTotals[invName] || 0);
            }, 0);
            
            // Aggrega esposizioni
            const aggregated = {};
            let totalWeightedExposure = 0;
            
            investmentsToAnalyze.forEach(invName => {
                const invTotal = investmentNetTotals[invName] || 0;
                const invWeight = totalPortfolio > 0 ? invTotal / totalPortfolio : 0;
                
                const exposures = exposureData[invName][viewType] || [];
                
                exposures.forEach(exp => {
                    if (!aggregated[exp.nome]) {
                        aggregated[exp.nome] = 0;
                    }
                    aggregated[exp.nome] += (exp.perc / 100) * invWeight * 100;
                });
                
                totalWeightedExposure += invWeight * 100;
            });
            
            // Normalizza le percentuali
            const normalizedAggregated = {};
            Object.keys(aggregated).forEach(key => {
                normalizedAggregated[key] = totalWeightedExposure > 0 ? (aggregated[key] / totalWeightedExposure) * 100 : 0;
            });
            
            // Ordina per percentuale
            const sorted = Object.entries(normalizedAggregated).sort((a, b) => b[1] - a[1]);
            
            // Render risultati
            let html = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Esposizione ${viewType.charAt(0).toUpperCase() + viewType.slice(1)} Aggregata
                        </h5>
                        <small>Analisi su ${investmentsToAnalyze.length} investiment${investmentsToAnalyze.length !== 1 ? 'i' : 'o'}</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="exposureChart"></canvas>
                        </div>
                        
                        <div class="table-responsive mt-4">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Posizione</th>
                                        <th>${viewType.charAt(0).toUpperCase() + viewType.slice(1)}</th>
                                        <th class="text-end">% Portafoglio</th>
                                        <th class="text-end">Valore Stimato (€)</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            sorted.forEach((item, idx) => {
                const [nome, perc] = item;
                const value = totalPortfolio * (perc / 100);
                html += `
                    <tr>
                        <td><strong>#${idx + 1}</strong></td>
                        <td>${nome}</td>
                        <td class="text-end"><span class="badge bg-primary">${perc.toFixed(2)}%</span></td>
                        <td class="text-end">€${value.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                                <tfoot class="table-dark">
                                    <tr>
                                        <td colspan="2"><strong>TOTALE</strong></td>
                                        <td class="text-end"><strong>100%</strong></td>
                                        <td class="text-end"><strong>€${totalPortfolio.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Investimenti Analizzati:</h6>
                            <div>
                                ${investmentsToAnalyze.map(name => `
                                    <span class="badge bg-secondary me-1 mb-1">
                                        ${name} (€${investmentNetTotals[name].toLocaleString('it-IT', {minimumFractionDigits: 0})})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('exposureResults').innerHTML = html;
            
            // Render chart
            setTimeout(() => {
                const ctx = document.getElementById('exposureChart');
                if (ctx) {
                    const chartColors = [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384',
                        '#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#06B6D4'
                    ];
                    
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: sorted.map(item => item[0]),
                            datasets: [{
                                data: sorted.map(item => item[1]),
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'right',
                                    labels: {
                                        font: { size: 11 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const euroValue = totalPortfolio * (value / 100);
                                            return `${label}: ${value.toFixed(2)}% (€${euroValue.toLocaleString('it-IT', {minimumFractionDigits: 0})})`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Event listener per cambio formato input
        document.addEventListener('DOMContentLoaded', function() {
            const formatSelect = document.getElementById('inputFormatSelect');
            if (formatSelect) {
                formatSelect.addEventListener('change', updateFormatHint);
                updateFormatHint(); // Inizializza
            }
        });

        function updateFormatHint() {
            const format = document.getElementById('inputFormatSelect').value;
            const hintEl = document.getElementById('formatHint');
            
            if (format === 'separate') {
                hintEl.innerHTML = `
                    <small>
                        <strong>Formato "Separato":</strong><br>
                        Incolla prima le percentuali, poi i nomi (uno per riga):<br>
                        <code>23,03 %<br>16,04 %<br>Regno Unito<br>Francia</code>
                    </small>
                `;
            } else {
                hintEl.innerHTML = `
                    <small>
                        <strong>Formato "In linea":</strong><br>
                        Ogni riga contiene nome e percentuale separati da spazio:<br>
                        <code>Stati Uniti 71,94<br>Giappone 5,44<br>Regno Unito 3,68</code>
                    </small>
                `;
            }
        }

        // Inizializzazione
        loadData();
    </script>
</body>
</html>
