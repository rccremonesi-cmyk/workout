<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Investimenti</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“Š</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>

<!-- jQuery (necessario per Select2) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS (dopo jQuery) -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --info-color: #4895ef;
            --warning-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --gradient-secondary: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
            --gradient-success: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
            --gradient-warning: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
            --gradient-info: linear-gradient(135deg, #4895ef 0%, #4361ee 100%);
        }
        
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        .container {
            max-width: 1400px;
        }
        .card {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
            color: var(--primary-color);
        }
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(67, 97, 238, 0.08);
        }
        .table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .table thead {
            background-color: #f8f9fa;
        }
        .badge-custom {
            font-size: 0.85rem;
            padding: 0.35em 0.65em;
            border-radius: 20px;
        }
        .stat-card {
            background: var(--gradient-primary);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        
        .btn-clone {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
			border-radius:4px !important;
        }
        .year-tab {
            cursor: pointer;
            padding: 10px 20px;
            margin-right: 5px;
            border-radius: 8px;
            background-color: #e9ecef;
            display: inline-block;
            margin-bottom: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .year-tab:hover {
            background-color: #dee2e6;
        }
        .year-tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        .investment-group {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .versamento-row {
            background-color: white;
            margin-bottom: 5px;
        }
        .total-row {
            background-color: #e7f1ff;
            font-weight: bold;
        }
        .sub-table {
            margin-top: 10px;
            margin-bottom: 0;
        }
		.sub-table th{
		width:15%;
		}
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        h1 {
            color: var(--primary-color);
            font-weight: 700;
        }
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        .alert-info {
            background-color: rgba(76, 201, 240, 0.1);
            border-color: rgba(76, 201, 240, 0.3);
            color: #0c5460;
            border-radius: 8px;
        }
        .notes-editor {
            min-height: 400px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            background-color: white;
        }
        .notes-toolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #ced4da;
        }
        .notes-content {
            min-height: 350px;
            padding: 15px;
            outline: none;
        }
        .notes-actions {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            border-top: 1px solid #ced4da;
        }
        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
            transition: all 0.3s;
        }
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .custom-tooltip {
            position: relative;
            display: inline-block;
        }
        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
        }
        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
		.select2-container--default .select2-selection--multiple {
    background-color: white;
    border: 1px solid #ced4da;
    padding: 7px 0px 10px 10px;
	}
	
	.forecast-input-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
}
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0"><i class="fas fa-chart-line me-2"></i> Gestione Investimenti Annuali</h1>
            <div>
                <button class="btn btn-outline-success me-2" onclick="exportData()">
                    <i class="fas fa-download me-1"></i> Esporta Dati
                </button>
                <button class="btn btn-outline-primary" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload me-1"></i> Importa Dati
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="input-tab" data-bs-toggle="tab" data-bs-target="#input" type="button">
                    <i class="fas fa-plus-circle me-1"></i> Inserimento
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" onclick="loadSummary()">
                    <i class="fas fa-table me-1"></i> Riepilogo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix" type="button" onclick="loadMatrix()">
                    <i class="fas fa-th me-1"></i> Vista Matriciale
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" onclick="loadAnalytics()">
                    <i class="fas fa-chart-pie me-1"></i> Analytics
                </button>
            </li>
			<li class="nav-item" role="presentation">
    <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" onclick="loadForecast()">
        <i class="fas fa-chart-line me-1"></i> Previsioni
    </button>
</li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" onclick="loadNotes()">
                    <i class="fas fa-sticky-note me-1"></i> Appunti
                </button>
            </li>
			
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- TAB INSERIMENTO -->
            <div class="tab-pane fade show active" id="input" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i> Nuovo Investimento / Versamento</h5>
                    </div>
                    <div class="card-body">
                        <form id="investmentForm">
                            <input type="hidden" id="investmentId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-calendar-alt me-1"></i> Data Versamento</label>
                                    <input type="date" class="form-control" id="dataInvestimento" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-percentage me-1"></i> Costo Annuale (TER) %</label>
                                    <input type="number" step="0.01" class="form-control" id="ter" placeholder="Es. 0.25" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-folder me-1"></i> Tipologia Investimento</label>
                                    <select class="form-select" id="tipologia" required>
                                        <option value="">Seleziona...</option>
                                        <option value="ETF">ETF</option>
                                        <option value="BOND">BOND</option>
                                        <option value="IBOND">IBOND</option>
                                        <option value="STOCK">STOCK</option>
                                        <option value="METALLI PREZIOSI">METALLI PREZIOSI</option>
                                    </select>
                                </div>
                               <div class="col-md-6 mb-3">
    <label class="form-label"><i class="fas fa-tags me-1"></i> Settore (Tags)</label>
    <select class="form-select tag-select" id="tagSelect" multiple data-allow-new="true"></select>
</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-signature me-1"></i> Nome Investimento <small class="text-muted">(usa lo stesso nome per versamenti successivi)</small></label>
                                    <input type="text" class="form-control" id="nome" required list="nomiList">
                                    <datalist id="nomiList"></datalist>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-link me-1"></i> Link (URL)</label>
                                    <input type="url" class="form-control" id="link" placeholder="https://...">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fas fa-euro-sign me-1"></i> Importo Versamento (â‚¬)</label>
                                    <input type="number" step="0.01" class="form-control" id="totaleInvestito" required>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i> <strong>Nota:</strong> Per aggiungere denaro a un investimento esistente, usa lo stesso nome e cambia solo la data e l'importo del versamento.
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Salva Versamento
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-times me-1"></i> Annulla
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TAB RIEPILOGO -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i> Riepilogo Investimenti</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearTabs" class="mb-3"></div>
                        <div id="summaryContent"></div>
                    </div>
                </div>
            </div>

            <!-- TAB VISTA MATRICIALE -->
            <div class="tab-pane fade" id="matrix" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-th me-2"></i> Vista Matriciale - Tutti gli Anni</h5>
                    </div>
                    <div class="card-body">
                        <div id="matrixContent"></div>
                    </div>
                </div>
            </div>

            <!-- TAB ANALYTICS -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div id="analyticsContent"></div>
            </div>

            <!-- TAB APPUNTI -->
            <div class="tab-pane fade" id="notes" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i> Appunti e Note</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="notes-toolbar">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="formatText('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="insertLink()"><i class="fas fa-link"></i></button>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="saveNotes()"><i class="fas fa-save me-1"></i> Salva Appunti</button>
                        </div>
                        <div class="notes-editor">
                            <div id="notesContent" class="notes-content" contenteditable="true"></div>
                        </div>
                        <div class="notes-actions">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span id="charCount" class="text-muted">0 caratteri</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="clearNotes()"><i class="fas fa-trash me-1"></i> Pulisci</button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="saveNotes()"><i class="fas fa-save me-1"></i> Salva</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			
			
			
			<!-- TAB PREVISIONI -->
<div class="tab-pane fade" id="forecast" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Previsioni di Crescita</h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-calendar me-1"></i> Anno Target</label>
                   <input type="number" class="form-control" id="targetYear" min="2025" max="2100" placeholder="Es. 2030" onchange="generateYearlyReturnsInputs()">
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-info-circle me-1"></i> Tipologia di Calcolo</label>
                    <select class="form-select" id="calcMode" onchange="calculateForecast()">
                        <option value="compound">Interesse Composto (Rendimento su totale progressivo)</option>
                        <option value="simple">Interesse Semplice (Rendimento solo su versamenti)</option>
                    </select>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-percentage me-1"></i> Rendimenti Annuali Attesi</h6>
                </div>
                <div class="card-body">
                    <div id="yearlyReturnsInputs" class="row"></div>
                </div>
            </div>

            <div id="forecastResults"></div>
        </div>
    </div>
</div>
			
        </div>
    </div>

    <button class="floating-action-btn" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let investments = [];
        let selectedTags = [];
        let allTags = new Set();
        let allNomi = new Set();
        let currentYear = 'all';
		let forecastReturns = {};
		let forecastChart = null;

        // Caricamento dati da localStorage
        function loadData() {
            const saved = localStorage.getItem('investments');
            if (saved) {
                investments = JSON.parse(saved);
                investments.forEach(inv => {
                    inv.settori.forEach(tag => allTags.add(tag));
                    allNomi.add(inv.nome);
                });
                
                updateNomiList();
            }
            
            // Carica appunti
            const savedNotes = localStorage.getItem('investmentNotes');
			if (savedNotes !== null) {
				const notesEl = document.getElementById('notesContent');
				if (notesEl) {
					notesEl.innerHTML = savedNotes;
				}
			}
			updateCharCount();
			
			
			// Carica previsioni
			const savedForecast = localStorage.getItem('forecastReturns');
			if (savedForecast) {
				forecastReturns = JSON.parse(savedForecast);
			}
        }

        // Salvataggio dati
        function saveData() {
            localStorage.setItem('investments', JSON.stringify(investments));
        }

       

        // Gestione nomi investimenti
        function updateNomiList() {
            const datalist = document.getElementById('nomiList');
            datalist.innerHTML = '';
            allNomi.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                datalist.appendChild(option);
            });
        }

        // Auto-fill quando si seleziona un nome esistente
        document.getElementById('nome').addEventListener('change', function() {
            const nomeSelezionato = this.value;
            const invEsistente = investments.find(inv => inv.nome === nomeSelezionato);
            if (invEsistente) {
                document.getElementById('ter').value = invEsistente.ter;
                document.getElementById('tipologia').value = invEsistente.tipologia;
                selectedTags = [...invEsistente.settori];

                document.getElementById('link').value = invEsistente.link;
            }
        });

       



       




        // Form submit
        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('investmentId').value || Date.now().toString();
            const investment = {
                id: id,
                data: document.getElementById('dataInvestimento').value,
                anno: new Date(document.getElementById('dataInvestimento').value).getFullYear(),
                ter: parseFloat(document.getElementById('ter').value),
                tipologia: document.getElementById('tipologia').value,
                settori: [...selectedTags],
                nome: document.getElementById('nome').value,
                link: document.getElementById('link').value,
                totale: parseFloat(document.getElementById('totaleInvestito').value)
            };

            const existingIndex = investments.findIndex(inv => inv.id === id);
            if (existingIndex !== -1) {
                investments[existingIndex] = investment;
            } else {
                investments.push(investment);
                allNomi.add(investment.nome);
                updateNomiList();
            }

            saveData();
            resetForm();
            alert('Versamento salvato con successo!');
        });

        function resetForm() {
            document.getElementById('investmentForm').reset();
            document.getElementById('investmentId').value = '';
           
        }

        function cloneInvestment(id) {
            const inv = investments.find(i => i.id === id);
            if (inv) {
                document.getElementById('investmentId').value = '';
                document.getElementById('dataInvestimento').value = '';
                document.getElementById('ter').value = inv.ter;
                document.getElementById('tipologia').value = inv.tipologia;
                selectedTags = [...inv.settori];
                document.getElementById('nome').value = inv.nome;
                document.getElementById('link').value = inv.link;
                document.getElementById('totaleInvestito').value = '';
                
                // Vai al tab inserimento
                document.getElementById('input-tab').click();
            }
        }

        function editInvestment(id) {
            const inv = investments.find(i => i.id === id);
            if (inv) {
                document.getElementById('investmentId').value = id;
                document.getElementById('dataInvestimento').value = inv.data;
                document.getElementById('ter').value = inv.ter;
                document.getElementById('tipologia').value = inv.tipologia;
                selectedTags = [...inv.settori];
                document.getElementById('nome').value = inv.nome;
                document.getElementById('link').value = inv.link;
                document.getElementById('totaleInvestito').value = inv.totale;
                
                document.getElementById('input-tab').click();
            }
        }

        function deleteInvestment(id) {
            if (confirm('Sei sicuro di voler eliminare questo versamento?')) {
                investments = investments.filter(inv => inv.id !== id);
                saveData();
                loadSummary();
            }
        }

        function loadSummary() {
            const years = [...new Set(investments.map(inv => inv.anno))].sort((a, b) => b - a);
            
            // Calcola totali per tab
            const totaleAll = investments.reduce((sum, inv) => sum + inv.totale, 0);
            const totaliPerAnno = {};
            years.forEach(year => {
                totaliPerAnno[year] = investments.filter(inv => inv.anno === year).reduce((sum, inv) => sum + inv.totale, 0);
            });

            // Render year tabs
            const yearTabsHtml = `
                <div class="year-tab ${currentYear === 'all' ? 'active' : ''}" onclick="filterByYear('all')">
                    Tutti gli anni
                    <div style="font-size: 0.85rem; margin-top: 3px;">â‚¬${totaleAll.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                ${years.map(year => `
                    <div class="year-tab ${currentYear === year ? 'active' : ''}" onclick="filterByYear(${year})">
                        ${year}
                        <div style="font-size: 0.85rem; margin-top: 3px;">â‚¬${totaliPerAnno[year].toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                `).join('')}
            `;
            document.getElementById('yearTabs').innerHTML = yearTabsHtml;

            const filtered = currentYear === 'all' ? investments : investments.filter(inv => inv.anno === currentYear);
            
            if (filtered.length === 0) {
                document.getElementById('summaryContent').innerHTML = '<p class="text-muted">Nessun investimento registrato.</p>';
                return;
            }

            // Raggruppa per tipologia e poi per nome
            const byType = {};
            filtered.forEach(inv => {
                if (!byType[inv.tipologia]) byType[inv.tipologia] = {};
                if (!byType[inv.tipologia][inv.nome]) byType[inv.tipologia][inv.nome] = [];
                byType[inv.tipologia][inv.nome].push(inv);
            });

            let html = '';
            Object.keys(byType).sort().forEach(tipo => {
                const investimenti = byType[tipo];
                const totaleType = Object.values(investimenti).flat().reduce((sum, inv) => sum + inv.totale, 0);
                
                html += `
                    <h5 class="mt-4 mb-3">${tipo} <span class="badge bg-secondary">${Object.keys(investimenti).length} investimenti - â‚¬${totaleType.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span></h5>
                `;

                Object.keys(investimenti).sort().forEach(nomeInv => {
                    const versamenti = investimenti[nomeInv].sort((a, b) => new Date(a.data) - new Date(b.data));
                    const totaleInvestimento = versamenti.reduce((sum, inv) => sum + inv.totale, 0);
                    const lastVersamento = versamenti[versamenti.length - 1];

                    html += `
                        <div class="investment-group">
                            <h6 class="mb-3">
                                ${lastVersamento.link ? `<a href="${lastVersamento.link}" target="_blank">${nomeInv}</a>` : nomeInv}
                                <span class="badge bg-primary ms-2">â‚¬${totaleInvestimento.toLocaleString('it-IT', {minimumFractionDigits: 2})} totale</span>
                                <span class="badge bg-info ms-1">${versamenti.length} versament${versamenti.length !== 1 ? 'i' : 'o'}
</span>
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm sub-table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Anno</th>
                                            <th>Settori</th>
                                            <th>TER %</th>
                                            <th>Versamento â‚¬</th>
                                            <th>Progressivo â‚¬</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    let progressivo = 0;
                    versamenti.forEach((inv, index) => {
                        progressivo += inv.totale;
                        html += `
                            <tr class="versamento-row">
                                <td>${new Date(inv.data).toLocaleDateString('it-IT')}</td>
                                <td>${inv.anno}</td>
                                <td>
                                    ${inv.settori.map(s => `<span class="badge bg-info badge-custom">${s}</span>`).join(' ')}
                                </td>
                                <td>${inv.ter}%</td>
                                <td>â‚¬${inv.totale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                <td><strong>â‚¬${progressivo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary btn-clone custom-tooltip" onclick="cloneInvestment('${inv.id}')" title="Clona per nuovo versamento">
                                        <i class="fas fa-clone"></i>
                                        <span class="tooltip-text">Clona per nuovo versamento</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary btn-clone custom-tooltip" onclick="editInvestment('${inv.id}')" title="Modifica">
                                        <i class="fas fa-edit"></i>
                                        <span class="tooltip-text">Modifica</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-clone custom-tooltip" onclick="deleteInvestment('${inv.id}')" title="Elimina">
                                        <i class="fas fa-trash"></i>
                                        <span class="tooltip-text">Elimina</span>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('summaryContent').innerHTML = html;
        }

        function filterByYear(year) {
            currentYear = year;
            loadSummary();
        }

        function loadMatrix() {
            if (investments.length === 0) {
                document.getElementById('matrixContent').innerHTML = '<p class="text-muted">Nessun investimento registrato.</p>';
                return;
            }

            // Raggruppa per nome investimento
            const byNome = {};
            investments.forEach(inv => {
                if (!byNome[inv.nome]) {
                    byNome[inv.nome] = {
                        nome: inv.nome,
                        tipologia: inv.tipologia,
                        link: inv.link,
                        ter: inv.ter,
                        versamenti: []
                    };
                }
                byNome[inv.nome].versamenti.push(inv);
            });

            // Ottieni tutti gli anni ordinati
            const years = [...new Set(investments.map(inv => inv.anno))].sort((a, b) => a - b);

            // Calcola versamenti per anno per ogni investimento
            const matrixData = Object.keys(byNome).sort().map(nome => {
                const inv = byNome[nome];
                const row = {
                    nome: inv.nome,
                    tipologia: inv.tipologia,
                    link: inv.link,
                    ter: inv.ter,
                    versamenti: {},
                    totale: 0,
                    costoTER: 0
                };

                years.forEach(anno => {
                    const versamentiAnno = inv.versamenti.filter(v => v.anno === anno);
                    row.versamenti[anno] = versamentiAnno.reduce((sum, v) => sum + v.totale, 0);
                });

                // Calcola totale investito
                row.totale = inv.versamenti.reduce((sum, v) => sum + v.totale, 0);
                // Calcola costo TER annuale
                row.costoTER = row.totale * (row.ter / 100);

                return row;
            });

            // Calcola totali per anno
            const totaliAnno = {};
            years.forEach(anno => {
                totaliAnno[anno] = matrixData.reduce((sum, row) => sum + (row.versamenti[anno] || 0), 0);
            });

            const granTotale = matrixData.reduce((sum, row) => sum + row.totale, 0);
            const totaleCostiTER = matrixData.reduce((sum, row) => sum + row.costoTER, 0);

            // Calcola percentuali per tipologia
            const percentualiTipologia = {};
            matrixData.forEach(row => {
                if (!percentualiTipologia[row.tipologia]) {
                    percentualiTipologia[row.tipologia] = 0;
                }
                percentualiTipologia[row.tipologia] += row.totale;
            });

            // Calcola totale Bond/iBond/Metalli
            const totaleBondIBondMetalli = (percentualiTipologia['BOND'] || 0) + 
                                           (percentualiTipologia['IBOND'] || 0) + 
                                           (percentualiTipologia['METALLI PREZIOSI'] || 0);
            
            // Calcola totale ETF/Stocks
            const totaleETFStocks = (percentualiTipologia['ETF'] || 0) + 
                                    (percentualiTipologia['STOCK'] || 0);

            let html = `
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Investimento</th>
                                <th>Tipologia</th>
                                <th>TER %</th>
                                ${years.map(anno => `<th class="text-center">${anno}</th>`).join('')}
                                <th class="text-end">Totale â‚¬</th>
                                <th class="text-end">% sul Totale</th>
                                <th class="text-end">Costo TER â‚¬/anno</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Raggruppa per tipologia
            const byTipologia = {};
            matrixData.forEach(row => {
                if (!byTipologia[row.tipologia]) byTipologia[row.tipologia] = [];
                byTipologia[row.tipologia].push(row);
            });

            Object.keys(byTipologia).sort().forEach(tipologia => {
                const rows = byTipologia[tipologia];
                const totaleTipologia = rows.reduce((sum, row) => sum + row.totale, 0);
                
                // Header tipologia
                html += `
                    <tr class="table-secondary">
                        <td colspan="${3 + years.length + 3}" style="font-weight: bold;">
                            <i class="fas fa-folder"></i> ${tipologia} 
                            <span class="badge bg-primary ms-2">â‚¬${totaleTipologia.toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                            <span class="badge bg-info ms-1">${((totaleTipologia / granTotale) * 100).toFixed(2)}%</span>
                        </td>
                    </tr>
                `;

                // Righe investimenti
                rows.forEach(row => {
                    html += `
                        <tr>
                            <td style="position: sticky; left: 0; background-color: white; z-index: 1;">
                                ${row.link ? `<a href="${row.link}" target="_blank">${row.nome}</a>` : row.nome}
                            </td>
                            <td><span class="badge bg-secondary badge-custom">${row.tipologia}</span></td>
                            <td class="text-end">${row.ter}%</td>
                            ${years.map(anno => {
                                const val = row.versamenti[anno] || 0;
                                return `<td class="text-end">${val > 0 ? 'â‚¬' + val.toLocaleString('it-IT', {minimumFractionDigits: 2}) : '-'}</td>`;
                            }).join('')}
                            <td class="text-end"><strong>â‚¬${row.totale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                            <td class="text-end">${((row.totale / granTotale) * 100).toFixed(2)}%</td>
                            <td class="text-end">â‚¬${row.costoTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                });
            });

            // Riga totali
            html += `
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <td colspan="3" style="position: sticky; left: 0; background-color: #212529; z-index: 2;"><strong>TOTALI</strong></td>
                                ${years.map(anno => `<td class="text-end"><strong>â‚¬${totaliAnno[anno].toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>`).join('')}
                                <td class="text-end"><strong>â‚¬${granTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                <td class="text-end"><strong>100%</strong></td>
                                <td class="text-end"><strong>â‚¬${totaleCostiTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Riepilogo per Tipologia</div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipologia</th>
                                            <th class="text-end">Totale â‚¬</th>
                                            <th class="text-end">% Portafoglio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(percentualiTipologia).sort((a, b) => b[1] - a[1]).map(([tipo, val]) => `
                                            <tr>
                                                <td><strong>${tipo}</strong></td>
                                                <td class="text-end">â‚¬${val.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                <td class="text-end"><span class="badge bg-primary">${((val / granTotale) * 100).toFixed(2)}%</span></td>
                                            </tr>
                                        `).join('')}
                                        <tr class="table-info">
                                            <td><strong>Bond / iBond / Metalli Preziosi</strong></td>
                                            <td class="text-end"><strong>â‚¬${totaleBondIBondMetalli.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                            <td class="text-end"><span class="badge bg-success">${((totaleBondIBondMetalli / granTotale) * 100).toFixed(2)}%</span></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td><strong>ETF / Stocks</strong></td>
                                            <td class="text-end"><strong>â‚¬${totaleETFStocks.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                            <td class="text-end"><span class="badge bg-success">${((totaleETFStocks / granTotale) * 100).toFixed(2)}%</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Costi TER per Investimento</div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Investimento</th>
                                            <th class="text-end">TER %</th>
                                            <th class="text-end">Costo â‚¬/anno</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${matrixData.sort((a, b) => b.costoTER - a.costoTER).slice(0, 10).map(row => `
                                            <tr>
                                                <td>${row.nome}</td>
                                                <td class="text-end">${row.ter}%</td>
                                                <td class="text-end">â‚¬${row.costoTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            </tr>
                                        `).join('')}
                                        <tr class="table-dark">
                                            <td colspan="2"><strong>TOTALE COSTI TER</strong></td>
                                            <td class="text-end"><strong>â‚¬${totaleCostiTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('matrixContent').innerHTML = html;
        }

        function loadAnalytics() {
            const filtered = currentYear === 'all' ? investments : investments.filter(inv => inv.anno === currentYear);
            
            if (filtered.length === 0) {
                document.getElementById('analyticsContent').innerHTML = '<p class="text-muted">Nessun dato disponibile.</p>';
                return;
            }

            // Raggruppa per nome investimento per calcolare i totali progressivi
            const byNome = {};
            investments.forEach(inv => {
                if (!byNome[inv.nome]) byNome[inv.nome] = [];
                byNome[inv.nome].push(inv);
            });

            // Calcola i totali per anno considerando tutti i versamenti fino a quell'anno
            const totaliPerAnno = {};
            const years = [...new Set(investments.map(inv => inv.anno))].sort();
            
            years.forEach(anno => {
                totaliPerAnno[anno] = 0;
                Object.keys(byNome).forEach(nome => {
                    const versamentiFinoAdAnno = byNome[nome].filter(inv => inv.anno <= anno);
                    if (versamentiFinoAdAnno.length > 0) {
                        totaliPerAnno[anno] += versamentiFinoAdAnno.reduce((sum, inv) => sum + inv.totale, 0);
                    }
                });
            });

            // Per i calcoli correnti, usa solo i versamenti filtrati
            const totalInvestito = filtered.reduce((sum, inv) => sum + inv.totale, 0);
            
            // Calcola TER sul totale progressivo dell'anno selezionato
            let totaleTER = 0;
            if (currentYear === 'all') {
                // Per "tutti gli anni" calcola il TER piÃ¹ recente di ogni investimento
                Object.keys(byNome).forEach(nome => {
                    const versamenti = byNome[nome].sort((a, b) => new Date(b.data) - new Date(a.data));
                    const ultimo = versamenti[0];
                    const totaleInv = versamenti.reduce((sum, inv) => sum + inv.totale, 0);
                    totaleTER += totaleInv * (ultimo.ter / 100);
                });
            } else {
                // Per un anno specifico, calcola TER sui versamenti di quell'anno
                Object.keys(byNome).forEach(nome => {
                    const versamentiAnno = byNome[nome].filter(inv => inv.anno === currentYear);
                    if (versamentiAnno.length > 0) {
                        const totaleInv = byNome[nome].filter(inv => inv.anno <= currentYear).reduce((sum, inv) => sum + inv.totale, 0);
                        const ultimo = versamentiAnno.sort((a, b) => new Date(b.data) - new Date(a.data))[0];
                        totaleTER += totaleInv * (ultimo.ter / 100);
                    }
                });
            }

            // Calcoli per tipologia (sul totale progressivo)
            const byType = {};
            Object.keys(byNome).forEach(nome => {
                const versamenti = byNome[nome];
                const versamentiValidi = currentYear === 'all' ? versamenti : versamenti.filter(inv => inv.anno <= currentYear);
                if (versamentiValidi.length > 0) {
                    const totaleInv = versamentiValidi.reduce((sum, inv) => sum + inv.totale, 0);
                    const tipo = versamentiValidi[versamentiValidi.length - 1].tipologia;
                    if (!byType[tipo]) byType[tipo] = 0;
                    byType[tipo] += totaleInv;
                }
            });

            // Calcoli per settore
            const bySector = {};
            Object.keys(byNome).forEach(nome => {
                const versamenti = byNome[nome];
                const versamentiValidi = currentYear === 'all' ? versamenti : versamenti.filter(inv => inv.anno <= currentYear);
                if (versamentiValidi.length > 0) {
                    const totaleInv = versamentiValidi.reduce((sum, inv) => sum + inv.totale, 0);
                    const ultimo = versamentiValidi[versamentiValidi.length - 1];
                    if (ultimo.settori && ultimo.settori.length > 0) {
                        ultimo.settori.forEach(settore => {
                            if (!bySector[settore]) bySector[settore] = 0;
                            bySector[settore] += totaleInv;
                        });
                    }
                }
            });

            const totaleProgressivo = currentYear === 'all' ? 
                Object.values(byType).reduce((sum, val) => sum + val, 0) : 
                totaliPerAnno[currentYear] || 0;

            // Totali specifici
            const stockTotal = byType['STOCK'] || 0;
            const bondTotal = (byType['BOND'] || 0) + (byType['IBOND'] || 0) + (byType['METALLI PREZIOSI'] || 0);
            const etfTotal = byType['ETF'] || 0;

            let html = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value">â‚¬${totaleProgressivo.toLocaleString('it-IT', {minimumFractionDigits: 0})}</div>
                            <div class="stat-label">Totale Investito ${currentYear !== 'all' ? 'al ' + currentYear : ''}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-warning);">
                            <div class="stat-value">â‚¬${totaleTER.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div class="stat-label">Costo TER Annuale</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-success);">
                            <div class="stat-value">${Object.keys(byNome).length}</div>
                            <div class="stat-label">Investimenti Attivi</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: var(--gradient-info);">
                            <div class="stat-value">${totaleProgressivo > 0 ? (totaleTER / totaleProgressivo * 100).toFixed(2) : 0}%</div>
                            <div class="stat-label">TER Medio</div>
                        </div>
                    </div>
                </div>

                ${years.length > 1 ? `
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Evoluzione Investimenti per Anno</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Anno</th>
                                                <th>Nuovi Versamenti</th>
                                                <th>Totale Progressivo</th>
                                                <th>Crescita</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${years.map((anno, idx) => {
                                                const versamentiAnno = investments.filter(inv => inv.anno === anno).reduce((sum, inv) => sum + inv.totale, 0);
                                                const progressivo = totaliPerAnno[anno];
                                                const crescita = idx > 0 ? ((progressivo - totaliPerAnno[years[idx - 1]]) / totaliPerAnno[years[idx - 1]] * 100).toFixed(2) : 0;
                                                return `
                                                    <tr>
                                                        <td><strong>${anno}</strong></td>
                                                        <td>â‚¬${versamentiAnno.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                                                        <td><strong>â‚¬${progressivo.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                                                        <td>${crescita > 0 ? `<span class="badge bg-success">+${crescita}%</span>` : idx === 0 ? '-' : `<span class="badge bg-secondary">${crescita}%</span>`}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

               <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Tipologia (Torta)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="typeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Settore (Torta)</div>
                            <div class="card-body">
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="chart-container">
                                        <canvas id="sectorChart"></canvas>
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Tipologia (Barre)</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="typeBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Distribuzione per Settore (Barre)</div>
                            <div class="card-body">
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="chart-container">
                                        <canvas id="sectorBarChart"></canvas>
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">STOCK</div>
                            <div class="card-body">
                                <h3>â‚¬${stockTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (stockTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">BOND + IBOND + METALLI</div>
                            <div class="card-body">
                                <h3>â‚¬${bondTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (bondTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">ETF</div>
                            <div class="card-body">
                                <h3>â‚¬${etfTotal.toLocaleString('it-IT', {minimumFractionDigits: 2})}</h3>
                                <p class="text-muted">${totaleProgressivo > 0 ? (etfTotal / totaleProgressivo * 100).toFixed(2) : 0}% del totale</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">Dettaglio Percentuali</div>
                            <div class="card-body">
                                <h6>Per Tipologia:</h6>
                                <div class="row">
                                    ${Object.entries(byType).map(([tipo, val]) => `
                                        <div class="col-md-4 mb-2">
                                            <strong>${tipo}:</strong> â‚¬${val.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                                            <span class="text-muted">(${totaleProgressivo > 0 ? (val / totaleProgressivo * 100).toFixed(2) : 0}%)</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <hr>
                                <h6>Per Settore:</h6>
                                ${Object.keys(bySector).length > 0 ? `
                                    <div class="row">
                                        ${Object.entries(bySector).sort((a, b) => b[1] - a[1]).map(([settore, val]) => `
                                            <div class="col-md-4 mb-2">
                                                <strong>${settore}:</strong> â‚¬${val.toLocaleString('it-IT', {minimumFractionDigits: 2})} 
                                                <span class="text-muted">(${totaleProgressivo > 0 ? (val / totaleProgressivo * 100).toFixed(2) : 0}%)</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-muted">Nessun settore definito</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('analyticsContent').innerHTML = html;

            // Grafici
setTimeout(() => {
                const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'];
                
                // Grafico tipologia - Torta
                const typeCtx = document.getElementById('typeChart');
                if (typeCtx) {
                    new Chart(typeCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(byType),
                            datasets: [{
                                data: Object.values(byType),
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;

                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico tipologia - Barre
                const typeBarCtx = document.getElementById('typeBarChart');
                if (typeBarCtx) {
                    new Chart(typeBarCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(byType),
                            datasets: [{
                                label: 'Importo \u20AC',
                                data: Object.values(byType),
                                backgroundColor: chartColors,
                                borderColor: chartColors.map(c => c),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                           return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;

                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '\u20AC' + value.toLocaleString('it-IT');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico settori - Torta
                const sectorCtx = document.getElementById('sectorChart');
                if (sectorCtx && Object.keys(bySector).length > 0) {
                    new Chart(sectorCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(bySector),
                            datasets: [{
                                data: Object.values(bySector),
                                backgroundColor: chartColors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Grafico settori - Barre
                const sectorBarCtx = document.getElementById('sectorBarChart');
                if (sectorBarCtx && Object.keys(bySector).length > 0) {
                    const sortedSectors = Object.entries(bySector).sort((a, b) => b[1] - a[1]);
                    
                    new Chart(sectorBarCtx, {
                        type: 'bar',
                        data: {
                            labels: sortedSectors.map(s => s[0]),
                            datasets: [{
                                label: 'Importo \u20AC',
                                data: sortedSectors.map(s => s[1]),
                                backgroundColor: chartColors,
                                borderColor: chartColors.map(c => c),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(2);
                                            return `\u20AC${value.toLocaleString('it-IT', { minimumFractionDigits: 2 })} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '\u20AC' + value.toLocaleString('it-IT');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        // Funzioni per il tab Appunti
       function loadNotes() {
			updateCharCount(); // Solo aggiorna il conteggio
		}

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('notesContent').focus();
            updateCharCount();
        }

        function insertLink() {
            const url = prompt('Inserisci URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
            document.getElementById('notesContent').focus();
        }

        function saveNotes() {
            const notesContent = document.getElementById('notesContent').innerHTML;
            localStorage.setItem('investmentNotes', notesContent);
            updateCharCount();
            alert('Appunti salvati con successo!');
        }

        function clearNotes() {
            if (confirm('Sei sicuro di voler cancellare tutti gli appunti?')) {
                document.getElementById('notesContent').innerHTML = '';
                localStorage.removeItem('investmentNotes');
                updateCharCount();
            }
        }

        function updateCharCount() {
            const text = document.getElementById('notesContent').innerText;
            const charCount = text.length;
            document.getElementById('charCount').textContent = `${charCount} caratteri`;
        }

        // Inizializzazione
        loadData();


        // Aggiungi listener per aggiornare il conteggio caratteri
        document.getElementById('notesContent').addEventListener('input', updateCharCount);

        // Funzione per esportare i dati
function exportData() {
    if (investments.length === 0 && !localStorage.getItem('investmentNotes')) {
        alert('Non ci sono dati da esportare!');
        return;
    }

    const notesContent = document.getElementById('notesContent');
    const currentNotes = notesContent ? notesContent.innerHTML : (localStorage.getItem('investmentNotes') || '');

    const dataToExport = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        investments: investments,
        allTags: Array.from(allTags),
        allNomi: Array.from(allNomi),
        notes: currentNotes
    };

    const dataStr = JSON.stringify(dataToExport, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `investimenti_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    alert('Dati esportati con successo!');
}

        // Funzione per importare i dati
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (!importedData.investments || !Array.isArray(importedData.investments)) {
                throw new Error('Formato file non valido');
            }

            if (investments.length > 0) {
                const confirmMsg = 'Attenzione: ci sono già ' + investments.length + ' investimenti salvati.\n\n' +
                                 'Scegli:\n' +
                                 'OK = SOSTITUISCI tutti i dati attuali con quelli importati\n' +
                                 'Annulla = AGGIUNGI i dati importati a quelli esistenti';
                
                if (confirm(confirmMsg)) {
                    investments = importedData.investments;
                } else {
                    importedData.investments.forEach(inv => {
                        inv.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        investments.push(inv);
                    });
                }
            } else {
                investments = importedData.investments;
            }

            allTags.clear();
            allNomi.clear();
            investments.forEach(inv => {
                if (inv.settori) inv.settori.forEach(tag => allTags.add(tag));
                allNomi.add(inv.nome);
            });

            // IMPORTA ANCHE GLI APPUNTI
if (importedData.notes !== undefined) {
    localStorage.setItem('investmentNotes', importedData.notes);
    const notesEl = document.getElementById('notesContent');
    if (notesEl) {
        notesEl.innerHTML = importedData.notes;
        updateCharCount();
    }
}

            saveData();
            updateNomiList();
            
            alert('Dati esportati con successo!\nImportati: ' + importedData.investments.length + ' investimenti');
            
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                if (activeTab.id === 'summary-tab') loadSummary();
                else if (activeTab.id === 'matrix-tab') loadMatrix();
                else if (activeTab.id === 'analytics-tab') loadAnalytics();
            }

        } catch (error) {
            alert('Errore durante l\'importazione: ' + error.message);
        }
    };
    reader.readAsText(file);
    
    event.target.value = '';
}

        // Funzione per tornare in cima alla pagina
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
		
		
		document.getElementById('notes-tab').addEventListener('shown.bs.tab', function () {
    const savedNotes = localStorage.getItem('investmentNotes');
    const notesEl = document.getElementById('notesContent');
    if (savedNotes && notesEl && notesEl.innerHTML.trim() === '') {
        notesEl.innerHTML = savedNotes;
        updateCharCount();
    }
});



// Inizializza Select2 con autocomplete e creazione tag
$(document).ready(function() {
    $('#tagSelect').select2({
        tags: true,
        tokenSeparators: [',', ' '],
        placeholder: "Digita per cercare o aggiungere tag...",
        allowClear: true,
        createTag: function(params) {
            const term = $.trim(params.term);
            if (term === '') return null;
            return { id: term, text: term, newTag: true };
        }
    }).on('select2:select', function(e) {
        const tag = e.params.data.text;
        if (!selectedTags.includes(tag)) {
            selectedTags.push(tag);
            allTags.add(tag);
        }
    }).on('select2:unselect', function(e) {
        selectedTags = selectedTags.filter(t => t !== e.params.data.text);
    });

    // Carica tag esistenti
    allTags.forEach(tag => $('#tagSelect').append(`<option value="${tag}">${tag}</option>`));
    $('#tagSelect').val(selectedTags).trigger('change');
});

// Aggiorna selectedTags da Select2 prima del submit
document.getElementById('investmentForm').addEventListener('submit', function(e) {
    selectedTags = $('#tagSelect').val() || [];
});




// FUNZIONI PREVISIONI
function loadForecast() {
    if (investments.length === 0) {
        document.getElementById('forecastResults').innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Non ci sono investimenti da analizzare. Inserisci prima alcuni investimenti.</div>';
        return;
    }

    const currentYearNum = new Date().getFullYear();
    const targetYearInput = document.getElementById('targetYear');
    if (!targetYearInput.value) {
        targetYearInput.value = currentYearNum + 5;
    }

    generateYearlyReturnsInputs();
}

function generateYearlyReturnsInputs() {
    const targetYear = parseInt(document.getElementById('targetYear').value);
    const currentYearNum = new Date().getFullYear();
    
    if (!targetYear || targetYear <= currentYearNum) {
        document.getElementById('yearlyReturnsInputs').innerHTML = '<div class="col-12"><p class="text-muted">Inserisci un anno target futuro per iniziare.</p></div>';
        document.getElementById('forecastResults').innerHTML = '';
        return;
    }

    const numYears = targetYear - currentYearNum + 1;
    let html = `<div class="col-12 mb-3">
        <p class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Inserisci il rendimento atteso (%) per ogni anno dal ${currentYearNum} al ${targetYear} (${numYears} anni). 
            I calcoli si aggiornano in tempo reale.
        </p>
    </div>`;
    
    for (let year = currentYearNum; year <= targetYear; year++) {
        const savedValue = forecastReturns[year] || '';
        html += `
            <div class="col-md-3 col-sm-6 mb-3">
                <label class="form-label"><strong>${year}</strong></label>
                <div class="input-group">
                    <input type="number" step="0.01" class="form-control" id="return_${year}" value="${savedValue}" 
                           placeholder="Es. 7.5" oninput="updateYearReturn(${year}, this.value)">
                    <span class="input-group-text">%</span>
                </div>
                <small class="text-muted" id="gain_${year}"></small>
            </div>
        `;
    }

    document.getElementById('yearlyReturnsInputs').innerHTML = html;
    calculateForecast();
}

function updateYearReturn(year, value) {
    forecastReturns[year] = parseFloat(value) || 0;
    localStorage.setItem('forecastReturns', JSON.stringify(forecastReturns));
    calculateForecast();
}

function calculateForecast() {
    const targetYear = parseInt(document.getElementById('targetYear').value);
    const currentYearNum = new Date().getFullYear();
    const calcMode = document.getElementById('calcMode').value;

    if (!targetYear || targetYear <= currentYearNum) {
        document.getElementById('forecastResults').innerHTML = '';
        return;
    }

    // Calcola totale attuale e versamento medio annuale
    const years = [...new Set(investments.map(inv => inv.anno))].sort();
    const totalInvested = investments.reduce((sum, inv) => sum + inv.totale, 0);
    
    const versamentiPerAnno = {};
    years.forEach(year => {
        versamentiPerAnno[year] = investments.filter(inv => inv.anno === year).reduce((sum, inv) => sum + inv.totale, 0);
    });
    
    const avgAnnualDeposit = Object.values(versamentiPerAnno).reduce((a, b) => a + b, 0) / years.length;

    // Calcola TER medio
    const byNome = {};
    investments.forEach(inv => {
        if (!byNome[inv.nome]) byNome[inv.nome] = [];
        byNome[inv.nome].push(inv);
    });
    
    let totaleTER = 0;
    Object.keys(byNome).forEach(nome => {
        const versamenti = byNome[nome].sort((a, b) => new Date(b.data) - new Date(a.data));
        const ultimo = versamenti[0];
        const totaleInv = versamenti.reduce((sum, inv) => sum + inv.totale, 0);
        totaleTER += totaleInv * (ultimo.ter / 100);
    });
    const avgTER = (totaleTER / totalInvested * 100);

    // Simulazioni
    const scenarios = [
        { name: 'Ottimistica (100%)', multiplier: 1, color: 'success' },
        { name: 'Realistica (-30%)', multiplier: 0.7, color: 'info' },
        { name: 'Moderata (-50%)', multiplier: 0.5, color: 'warning' },
        { name: 'Prudente (-70%)', multiplier: 0.3, color: 'danger' }
    ];

    const results = scenarios.map(scenario => {
        let capital = totalInvested;
        const yearlyData = [];
        
        for (let year = currentYearNum; year <= targetYear; year++) {
            if (year > currentYearNum) {
                capital += avgAnnualDeposit;
            }
            
            const returnRate = (forecastReturns[year] || 0) * scenario.multiplier / 100;
            let gain = 0;
            
            if (calcMode === 'compound') {
                gain = capital * returnRate;
            } else {
                gain = totalInvested * returnRate + (year > currentYearNum ? avgAnnualDeposit * (year - currentYearNum) * returnRate : 0);
            }
            
            capital += gain;
            
            const terCost = capital * (avgTER / 100);
            capital -= terCost;
            
            yearlyData.push({
                year,
                capital: capital,
                gain: gain,
                terCost: terCost,
                deposited: totalInvested + (year > currentYearNum ? avgAnnualDeposit * (year - currentYearNum) : 0)
            });
        }
        
        const finalData = yearlyData[yearlyData.length - 1];
        const totalGain = finalData.capital - finalData.deposited;
        const capitalGainTax = totalGain > 0 ? totalGain * 0.26 : 0;
        const netCapital = finalData.capital - capitalGainTax;
        
        return {
            ...scenario,
            finalCapital: finalData.capital,
            totalDeposited: finalData.deposited,
            totalGain: totalGain,
            capitalGainTax: capitalGainTax,
            netCapital: netCapital,
            yearlyData: yearlyData
        };
    });

    // Aggiorna guadagni in tempo reale
    for (let year = currentYearNum; year <= targetYear; year++) {
        const gainEl = document.getElementById(`gain_${year}`);
        if (gainEl && forecastReturns[year]) {
            const estimatedCapital = totalInvested + avgAnnualDeposit * Math.max(0, year - currentYearNum);
            const gain = estimatedCapital * (forecastReturns[year] / 100);
            gainEl.textContent = `\u20AC${gain.toLocaleString('it-IT', {minimumFractionDigits: 0})} guadagno`;
            gainEl.className = 'text-success';
        }
    }

    renderForecastResults(results, avgAnnualDeposit, totalInvested, avgTER, targetYear);
}

function renderForecastResults(results, avgDeposit, totalInvested, avgTER, targetYear) {
    const currentYearNum = new Date().getFullYear();
    const yearsToTarget = targetYear - currentYearNum;

    let html = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Capitale Attuale</h6>
                        <h3 class="text-primary mb-0">\u20AC${totalInvested.toLocaleString('it-IT', {minimumFractionDigits: 0})}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Versamento Medio Annuale</h6>
                        <h3 class="text-info mb-0">\u20AC${avgDeposit.toLocaleString('it-IT', {minimumFractionDigits: 0})}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">TER Medio</h6>
                        <h3 class="text-warning mb-0">${avgTER.toFixed(2)}%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Anni di Investimento</h6>
                        <h3 class="text-success mb-0">${yearsToTarget}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Simulazioni di Crescita al ${targetYear}</h5>
            </div>
            <div class="card-body">
                <div class="row">
    `;

    results.forEach(result => {
        const roi = ((result.finalCapital - result.totalDeposited) / result.totalDeposited * 100);
        html += `
            <div class="col-md-6 mb-4">
                <div class="card border-${result.color}">
                    <div class="card-header bg-${result.color} text-white">
                        <h6 class="mb-0">${result.name}</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td><strong>Capitale Finale (lordo):</strong></td>
                                <td class="text-end"><strong class="text-${result.color}">\u20AC${result.finalCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                            </tr>
                            <tr>
                                <td>Totale Versato:</td>
                                <td class="text-end">\u20AC${result.totalDeposited.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                            </tr>
                            <tr>
                                <td>Guadagno Totale:</td>
                                <td class="text-end text-success">+\u20AC${result.totalGain.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                            </tr>
                            <tr>
                                <td>ROI:</td>
                                <td class="text-end"><span class="badge bg-${result.color}">${roi.toFixed(1)}%</span></td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>Tasse Capital Gain (26%):</strong></td>
                                <td class="text-end"><strong class="text-danger">-\u20AC${result.capitalGainTax.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>Capitale Finale (netto):</strong></td>
                                <td class="text-end"><strong class="text-success">\u20AC${result.netCapital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Grafico Comparativo</h5>
            </div>
            <div class="card-body">
                <canvas id="forecastChart" style="height: 400px;"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Dettaglio Anno per Anno</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Anno</th>
                                <th class="text-end">Versato Progressivo</th>
                                ${results.map(r => `<th class="text-end text-${r.color}">${r.name.split(' ')[0]}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;

    const maxYears = results[0].yearlyData.length;
    for (let i = 0; i < maxYears; i++) {
        const year = results[0].yearlyData[i].year;
        html += `
            <tr>
                <td><strong>${year}</strong></td>
                <td class="text-end">\u20AC${results[0].yearlyData[i].deposited.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>
                ${results.map(r => `<td class="text-end">\u20AC${r.yearlyData[i].capital.toLocaleString('it-IT', {minimumFractionDigits: 0})}</td>`).join('')}
            </tr>
        `;
    }

    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    document.getElementById('forecastResults').innerHTML = html;
    renderForecastChart(results);
}

function renderForecastChart(results) {
    const ctx = document.getElementById('forecastChart');
    if (!ctx) return;

    if (forecastChart) {
        forecastChart.destroy();
    }

    const colors = {
        'success': 'rgba(25, 135, 84, 0.8)',
        'info': 'rgba(13, 202, 240, 0.8)',
        'warning': 'rgba(255, 193, 7, 0.8)',
        'danger': 'rgba(220, 53, 69, 0.8)'
    };

    const datasets = results.map(result => ({
        label: result.name,
        data: result.yearlyData.map(d => d.capital),
        borderColor: colors[result.color],
        backgroundColor: colors[result.color].replace('0.8', '0.2'),
        borderWidth: 2,
        tension: 0.4,
        fill: false
    }));

    datasets.push({
        label: 'Totale Versato',
        data: results[0].yearlyData.map(d => d.deposited),
        borderColor: 'rgba(108, 117, 125, 0.8)',
        backgroundColor: 'rgba(108, 117, 125, 0.1)',
        borderWidth: 2,
        borderDash: [5, 5],
        tension: 0.4,
        fill: false
    });

    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: results[0].yearlyData.map(d => d.year),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': \u20AC' + context.parsed.y.toLocaleString('it-IT', {minimumFractionDigits: 0});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '\u20AC' + value.toLocaleString('it-IT', {minimumFractionDigits: 0});
                        }
                    }
                }
            }
        }
    });
}
    </script>
</body>
</html>
