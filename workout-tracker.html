<!DOCTYPE html>
<html lang="it">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>WorkoutTracker Web</title>
      <meta name="description" content="Il tuo tracker di allenamento locale.">
      <meta name="theme-color" content="#5127F2">
      <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C!-- Icona dumbbell di Font Awesome (simil-v6) --%3E%3Cpath fill='%235127F2' d='M88.75 35.5h-9.87c-1.39 0-2.5 1.12-2.5 2.5v22c0 1.38 1.11 2.5 2.5 2.5h9.87c1.38 0 2.5-1.12 2.5-2.5v-22c0-1.38-1.12-2.5-2.5-2.5zm-66.25 0h-9.87c-1.38 0-2.5 1.12-2.5 2.5v22c0 1.38 1.12 2.5 2.5 2.5h9.87c1.38 0 2.5-1.12 2.5-2.5v-22c0-1.38-1.12-2.5-2.5-2.5zM36.1 48h27.8c1.38 0 2.5-1.12 2.5-2.5s-1.12-2.5-2.5-2.5h-27.8c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5z' /%3E%3C/svg%3E">
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	  
	  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

      <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
      <meta http-equiv="Pragma" content="no-cache">
      <meta http-equiv="Expires" content="0">
      <style>	  
	  
@keyframes fadeInOnly {
  from { opacity: 0; }
  to   { opacity: 1; }
}

.internal-section {
  animation: fadeInOnly 0.6s ease-in-out forwards;
}
	  
@keyframes beastShake {
  0% {
    opacity: 0;
    transform: scale(0.8);
  }
  50% {
    opacity: 1;
    transform: scale(1.1);
  }
  70% {
    transform: scale(0.98) rotate(-1deg);
  }
  85% {
    transform: scale(1.02) rotate(1deg);
  }
  100% {
    transform: scale(1) rotate(0);
  }
}

#motivational-text {
  animation: beastShake 0.5s ease-out both;
}




         #exercise-modal input, #exercise-modal textarea{
         border:1px solid #5127f2;
		 background-color:#1f2937;
         }
         #exercise-modal select{
         border:1px solid #5127f2;
		 background-color:#1f2937;
         }
         @keyframes blink-rest {
         0%, 100% { opacity: 1; }
         50% { opacity: 0.2; }
         }
         .rest-blink {
         animation: blink-rest 0.6s ease-in-out infinite;
         }
         /* Layout mobile-first responsive */
         @media (min-width: 768px) {
         nav, main {
         max-width: 480px;
         margin: 0 auto;
         box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
         }
         }
         /* ... (mantieni il tuo stile CSS esistente qui) ... */
         /* Assicurati solo di non aver cancellato i tuoi stili custom */
         body { font-family: "Montserrat", sans-serif;
  font-optical-sizing: auto; }
         .hide-scrollbar::-webkit-scrollbar { display: none; }
         .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
         .view-section { display: none !important; opacity: 0; transition: opacity 0.2s ease-in-out; }
         .view-section.active { display: block !important; opacity: 1; }
         #view-active.active { display: flex !important; }
         .timer-circle { 
         stroke: #5127F2; /* Forzatura colore se necessario */
         transition: stroke-dashoffset 1s linear; 
         transform: rotate(-90deg); 
         transform-origin: 50% 50%; 
         }
         .sortable-ghost { opacity: 0.4; background-color: #ede9fe; border: 2px dashed #5127F2; } /* Aggiornato colore ghost */
         .sortable-drag { cursor: grabbing; }
         .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
         .footer-action{ position: fixed; bottom: 0px; width: 100%; }
         /* Scrollbar personalizzata per workout preview */
         #workout-preview-content::-webkit-scrollbar {
         width: 8px;
         }
         #workout-preview-content::-webkit-scrollbar-track {
         background: #111827;
         }
         #workout-preview-content::-webkit-scrollbar-thumb {
         background: #5127F2;
         border-radius: 4px;
         }
         #workout-preview-content::-webkit-scrollbar-thumb:hover {
         background: #401eb5;
         }
         /* Per Firefox */
         #workout-preview-content {
         scrollbar-width: thin;
         scrollbar-color: #5127F2 #111827;
         }
         .workout-active-bg {
         background: #111827;
         position: relative;
         overflow: hidden;
         }
         .workout-active-bg::before {
         content: '';
         position: absolute;
         top: -50%;
         left: -50%;
         width: 200%;
         height: 200%;
         background: radial-gradient(circle, #5127F2 0%, transparent 70%);
         animation: energy-pulse 3s ease-in-out infinite;
         pointer-events: none;
         }
         .workout-active-bg::after {
         content: '';
         position: absolute;
         bottom: -50%;
         right: -50%;
         width: 200%;
         height: 200%;
         background: radial-gradient(circle, #7c3aed 0%, transparent 70%);
         animation: energy-pulse-2 4s ease-in-out infinite;
         pointer-events: none;
         }
         /* Toggle Switch */
         .sr-only {
         position: absolute;
         width: 1px;
         height: 1px;
         padding: 0;
         margin: -1px;
         overflow: hidden;
         clip: rect(0, 0, 0, 0);
         white-space: nowrap;
         border-width: 0;
         }
         .workout-rest-bg {
         background: #111827;
         transition: background 0.5s ease;
         position: relative;
         }
         /* Rimuovi gli pseudo-elementi durante il riposo */
         .workout-rest-bg::before,
         .workout-rest-bg::after {
         display: none;
         }
		 
		 /* Badge Animations */
@keyframes badgeSlideIn {
  0% {
    opacity: 0;
    transform: translateY(-30px) scale(0.9);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes badgeGlow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(81, 39, 242, 0.3);
  }
  50% {
    box-shadow: 0 0 40px rgba(81, 39, 242, 0.6);
  }
}

.badge-appear {
  animation: badgeSlideIn 0.5s ease-out, badgeGlow 2s ease-in-out infinite;
}

.badge-icon-locked {
  filter: grayscale(100%) opacity(0.3);
}

/* Stats Tabs */
.stats-tab {
   color: #9ca3af;
}

.stats-tab.active {
   background: linear-gradient(135deg, #5127F2, #7c3aed);
   color: white;
   box-shadow: 0 4px 12px rgba(81, 39, 242, 0.3);
}

      </style>
      <script>
         tailwind.config = {
             
             theme: {
                 extend: {
                     colors: {
                         // NEW COLOR: rgb(81 39 242) -> Hex #5127F2
                         primary: '#5127F2', 
                         primaryDark: '#401eb5', // Versione pi√π scura per hover
                         darkBg: '#111827',
                         darkCard: '#1f2937'
                     }
                 }
             }
         }
      </script>
   </head>
   <body class="bg-darkBg text-gray-100 h-screen flex flex-col overflow-hidden">
      <!-- HEADER -->
      <header class="bg-darkCard shadow-sm z-20 px-4 py-3 grid grid-cols-3 items-center" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
         <!-- Sinistra (vuoto o future azioni) -->
         <div></div>
         <!-- Centro: LOGO -->
         <div class="flex items-center justify-center gap-2">
            <i class="fa-solid fa-dumbbell text-primary text-xl"></i>
            <h1 class="font-bold text-lg tracking-tight">WorkoutTracker</h1>
         </div>
         <!-- Destra -->
         <div class="flex justify-end">
         </div>
      </header>
      <!-- MAIN CONTENT AREA -->
      <main id="app-container" class="flex-1 overflow-y-auto overflow-x-hidden relative hide-scrollbar" style="padding-bottom: 12rem;">
	  
	  
         <!-- VIEW: DASHBOARD (HOME) -->
         <section id="view-dashboard" class="view-section active p-4 ">
		  <button onclick="app.handlers.createNewWorkout()" id="add-workout-fab" 
   class="fixed bottom-[calc(5rem+env(safe-area-inset-bottom))] right-4 
   bg-primary text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 z-50" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
<i class="fa-solid fa-plus"></i> Crea Workout
</button>
		 <div class="internal-section">
		 
		 
		 
		 
		 
		 <div id="badge-notification" class="hidden" style="margin-bottom:15px;">
      <!-- Badge injected here -->
   </div>
   
            <!-- Quick Stats Card -->
<div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden" style="margin-top:0px;">
   <!-- Decorative Background Elements -->
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
   
   <!-- Header -->
   <div class="relative z-10 flex items-center justify-between mb-5">
      <div>
         <h2 class=" opacity-90 uppercase tracking-wider font-semibold flex items-center gap-2">
            <i class="fa-solid fa-calendar-days"></i>
            Questo Mese
         </h2>
         <p class="text-sm opacity-75 mt-1" id="current-month-name">Gennaio 2026</p>
      </div>
      <div class="bg-white/20 backdrop-blur-sm rounded-full p-3">
         <i class="fa-solid fa-chart-line text-2xl"></i>
      </div>
   </div>
   
   <!-- Stats Grid -->
   <div class="relative z-10 grid grid-cols-2 gap-4">
      <!-- Allenamenti -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-dumbbell text-lg"></i>
            </div>
            <span class="opacity-80">Workout<br/>eseguiti</span>
         </div>
         <span id="monthly-workouts-count" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Volume -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-weight-hanging text-lg"></i>
            </div>
            <span class="opacity-80">kg <br/>Sollevati</span>
         </div>
         <span id="monthly-volume" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Calorie -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-fire text-lg"></i>
            </div>
            <span class="opacity-80">kcal <br/>Bruciate</span>
         </div>
         <span id="monthly-calories" class="text-3xl font-bold block">0</span>
      </div>
      
      <!-- Grasso -->
      <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
         <div class="flex items-center gap-2 mb-2">
            <div class="bg-white/20 rounded-lg p-2">
               <i class="fa-solid fa-droplet text-lg"></i>
            </div>
            <span class="opacity-80">gr di <br/>Grasso</span>
         </div>
         <span id="monthly-fat-burned" class="text-3xl font-bold block">0</span>
      </div>
   </div>
</div>

<script>
// Aggiungi questo codice nella funzione renderDashboard per aggiornare il nome del mese
const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
const currentMonthEl = document.getElementById('current-month-name');
if (currentMonthEl) {
   const now = new Date();
   currentMonthEl.innerText = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
}
</script>
            <!-- Workouts List -->
            <div>
               <div class="flex justify-between items-center mb-4">
                 
                
               </div>
               <div id="workout-list" class="space-y-3">
                  <!-- Dynamic Workout Cards injected here -->
                  <div class="text-center text-gray-400 py-8">Caricamento...</div>
               </div>
            </div>
			</div>
         </section>
		 
		 
		 
         <!-- VIEW: WORKOUT EDITOR -->
         <section id="view-editor" class="view-section p-4 bg-darkBg bg-darkBg min-h-full absolute inset-0 z-30">
		 <div class="internal-section">
            <div class="flex items-center gap-3 mb-6">
   <!-- Back Button -->
   <button onclick="app.router.go('dashboard')" class="p-0 text-gray-400 hover:text-white hover:bg-gray-800 rounded-xl transition-all active:scale-95">
      <i class="fa-solid fa-arrow-left text-xl"></i>
   </button>
   
   <!-- Workout Name Input -->
   <input type="text" id="editor-name" 
      class="flex-1 font-bold bg-gray-800 border-2 border-primary/50 focus:border-primary rounded-xl px-4 py-3 placeholder-gray-500 focus:ring-0 focus:outline-none transition-all" 
      placeholder="Nome Workout (es. Leg Day)">
   
   <!-- Delete Button (hidden by default) -->
   <button onclick="app.handlers.deleteWorkout()" id="btn-delete-workout" 
      class="hidden bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-3 rounded-xl font-semibold transition-all active:scale-95 border border-red-500/30 flex items-center gap-2">
      <i class="fa-solid fa-trash"></i>
      <span class="hidden sm:inline">Elimina</span>
   </button>
</div>
			
			   <div class="mb-4 bg-gray-800 p-4 rounded-xl">
      <label class="text-sm font-semibold mb-3 block flex items-center gap-2">
         üóìÔ∏è Giorni preferiti (opzionale)
      </label>
      <div id="editor-preferred-days" class="grid grid-cols-7 gap-2">
         <!-- Injected by JS -->
      </div>
   </div>
			
            <div id="editor-exercises-list" class="space-y-4 mb-20">
               <!-- Exercises injected here via SortableJS -->
            </div>
            <!-- Floating Action Button for Add Exercise -->
            <div class="fixed bottom-6 right-6 z-40">
               <button onclick="app.handlers.addExerciseToEditor()" class="bg-primary text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2" style="-webkit-box-shadow: 0px 0px 22px 4px #111827;
    box-shadow: 0px 0px 22px 4px #111827;">
               <i class="fa-solid fa-plus"></i> Agg. esercizio
               </button>
            </div>
            <div class="fixed bottom-6 left-6 z-40">
               <button onclick="app.handlers.saveWorkout()" class="bg-gray-800 bg-white dark:text-gray-900 text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2">
               <i class="fa-solid fa-save"></i> Salva
               </button>
            </div>
           
			</div>
         </section>
         <!-- VIEW: ACTIVE WORKOUT MODE -->
         <section id="view-active" class="view-section bg-gray-900 text-white h-screen absolute inset-0 z-50 flex flex-col overflow-hidden">
		 <div class="internal-section">
            <!-- Active Header -->
            <div class="px-4 py-4 flex items-center border-b border-gray-700">
               <!-- Sinistra -->
               <button onclick="app.handlers.confirmExitWorkout()" class="text-gray-400">
               <i class="fa-solid fa-xmark text-2xl"></i>
               </button>
               <!-- Centro -->
               <div class="flex-1 flex justify-center" onclick="app.handlers.showWorkoutPreview()">
                  <div class="flex items-center gap-3">
                     <i class="fa-solid fa-list-check text-xl text-gray-400"></i>
                     <div class="text-left">
                        <h3 id="active-workout-name" class="font-bold text-xs text-gray-300">
                           A ‚Äì Upper Push (Petto alto &amp; Spalle)
                        </h3>
                        <div class="flex items-center gap-2 text-xs">
                           <span><i class="fa-regular fa-clock" style="font-size: 10px; color:#b9a9f6; margin-right:5px;"></i><span id="active-timer-total" class=" font-mono" style="color:#b9a9f6;"> 00:10</span>
                           <span class="text-gray-500">‚Ä¢</span>
                           <span id="active-exercise-count" class="text-gray-400">1/5 es.</span>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- Destra -->
               <button onclick="app.handlers.toggleSound()" id="sound-toggle" class="text-gray-400">
               <i class="fa-solid fa-volume-high"></i>
               </button>
            </div>
            <!-- Progress Bar -->
            <!-- Progress Bar with Exercise Navigation -->
            <div class="bg-gray-800 w-full">
               <div class="px-4 py-2 flex items-center justify-between text-xs" style="font-weight: 700;">
                  <div id="prev-exercise" class="text-gray-500 flex-1 text-left truncate">
                     <i class="fa-solid fa-check text-green-500 mr-1"></i>
                     <span>-</span>
                  </div>
                  <div class="text-gray-400 px-2"><i class="fa-solid fa-caret-right"></i></div>
                  <div id="next-exercise" class="text-gray-400 flex-1 text-right truncate">
                     <span>-</span>
                     <i class="fa-solid fa-arrow-right ml-1"></i>
                  </div>
               </div>
               <div class="h-1 bg-gray-800 w-full">
                  <div id="active-progress-bar" class=" relative h-full bg-primary transition-all duration-300 relative" style="width: 0%">
				  <div style="
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #a68ef8;
    border-radius: 50%;
    top: -2px;
    right: 0px;
"></div>
				  </div>
               </div>
            </div>
            <!-- Main Exercise Area -->
            <div class="flex-1 overflow-y-auto p-5 hide-scrollbar" style="padding-bottom: 220px;">
               <!-- Current Exercise Info -->
               <div class="text-center w-full animate-fade-in">
                  <h2 id="active-exercise-name" class="text-2xl font-bold mb-5 break-words">Nome Esercizio</h2>
                  <div class="flex justify-center gap-2 text-gray-400 text-sm mb-4">
                     <span id="active-set-display" class="bg-primary px-3 py-1 rounded-full border border-gray-700" style="color:#FFF;">Serie 1/4</span>
                     <span id="active-target-display" class="bg-gray-800 px-3 py-1 rounded-full border border-gray-700" style="color:#FFF; background-color: #425267;">10 Reps</span>
                  </div>
                  <!-- Weight Control -->
                  <!-- Weight Control -->
                  <div class="flex items-center justify-center gap-3 my-4">
                     <!-- Pulsanti -5 e -1 -->
                     <div class="flex flex-col gap-1">
                        <button onclick="app.handlers.adjustWeight(-0.5)" style="width: 5.5rem; margin-bottom:7px;" class=" h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">-0.5 kg</button>
                        <button onclick="app.handlers.adjustWeight(-1)" style="width: 5.5rem;" class=" h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">-1 kg</button>
                     </div>
                     <!-- Display Peso -->
                     <div class="text-center px-2">
                        <span id="active-weight-value" class="text-5xl font-bold font-mono text-white">0</span>
                        <span class="text-sm text-gray-500 block uppercase">kg</span>
                     </div>
                     <!-- Pulsanti +1 e +5 -->
                     <div class="flex flex-col gap-1">
                        <button onclick="app.handlers.adjustWeight(0.5)" style="width: 5.5rem; margin-bottom:7px;" class=" h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">+0.5 kg</button>
                        <button onclick="app.handlers.adjustWeight(1)" style="width: 5.5rem;" class=" h-10 rounded-lg bg-gray-800 border border-gray-600 text-sm font-bold active:scale-95">+1 kg</button>
                     </div>
                  </div>
               </div>
               <!-- Timer / Rest Overlay -->
               <div id="rest-overlay" class="hidden flex-col items-center justify-center w-full py-0">
                  <div class="relative w-40 h-40">
                     <svg class="w-full h-full transform -rotate-90">
                        <circle cx="80" cy="80" r="72" stroke="currentColor" stroke-width="6" fill="transparent" class="text-gray-800" />
                        <circle id="rest-timer-circle" cx="80" cy="80" r="72" stroke="currentColor" stroke-width="6" fill="transparent" class="text-primary timer-circle" stroke-dasharray="452" stroke-dashoffset="0" />
                     </svg>
                     <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-gray-400 text-xs uppercase tracking-widest">Pausa</span>
                        <span id="rest-timer-text" class="text-3xl font-mono font-bold">00:00</span>
                        <div class="flex flex-col items-center gap-2">
                           <label for="auto-next-toggle" class="text-sm text-gray-300">
                           Auto-continua
                           </label>
                           <div class="relative">
                              <input type="checkbox" id="auto-next-toggle" class="sr-only peer">
                              <div
                                 class="w-11 h-6 bg-gray-700 rounded-full peer-checked:bg-primary transition-colors cursor-pointer"
                                 onclick="document.getElementById('auto-next-toggle').click()"
                                 ></div>
                              <div
                                 class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5 pointer-events-none"
                                 ></div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- AGGIUNGI QUESTO NUOVO BLOCCO -->
               <div id="work-overlay" class="flex-col items-center justify-center w-full py-2">
                  <div class="text-center" style="
    width:100%;
    padding: 15px 30px;
    border-radius: 18px;
    -webkit-box-shadow: 0px 0px 12px 6px #0d1423;
    box-shadow: 0px 0px 12px 6px #0d1423;
    background-color: #1f2937;
">
                     <i class="fa-solid fa-dumbbell text-primary text-4xl mb-3 animate-pulse"></i>
                     <span class="text-gray-400 text-sm uppercase tracking-widest block">Serie in corso</span>
                     <!-- ‚ú® AGGIUNGI TIMER ESERCIZIO -->
                     <span class="text-gray-400 text-sm  tracking-widest block">Iniziata da: <span id="exercise-timer" style="font-weight:bold;">00:00</span></span>
                     <span id="motivational-text" class="text-xl font-bold mt-2 block">Dai il massimo! üí™</span>
                     <div id="exercise-notes-container" class="mt-4 hidden">
                        <button onclick="app.handlers.toggleNotes()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm flex items-center gap-2 mx-auto transition">
                        <i class="fa-regular fa-note-sticky"></i>
                        <span>Leggi Note</span>
                        <i id="notes-chevron" class="fa-solid fa-chevron-down text-xs"></i>
                        </button>
                        <div id="exercise-notes-content" class="hidden  bg-gray-800 rounded-lg p-4 text-left text-sm text-gray-300 max-w-md mx-auto">
                           <!-- Note inserite qui dinamicamente -->
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Controls Footer -->
            <!-- Controls Footer -->
            <div class="fixed bottom-0 left-0 right-0 bg-gray-800 pb-safe z-40">
               <!-- NUOVA BARRA DI PROGRESSO COMPATTA -->
               <!-- NUOVA BARRA DI PROGRESSO COMPATTA -->
               <div class="px-4 pt-2 pb-3">
                  <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
                     <span id="footer-progress-text">Serie 1/12</span>
                     <span id="footer-time-remaining">~15 min rimanenti</span>
                  </div>
                  <div class="relative h-1.5 bg-gray-700 rounded-full overflow-visible">
                     <!-- Step Markers -->
                     <div id="progress-steps" class="absolute inset-0 flex items-center justify-between px-0">
                        <!-- Injected by JS -->
                     </div>
                     <!-- Fill Bar -->
                     <div id="footer-progress-fill" class="h-full bg-gradient-to-r from-primary to-purple-500 transition-all duration-300 relative z-10" style="width: 8%"></div>
                  </div>
               </div>
               <div class="px-6 pb-6 rounded-t-3xl">
                  <button id="btn-main-action" onclick="app.handlers.completeSet()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold text-xl py-4 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center gap-3">
                  <i class="fa-solid fa-check"></i> <span>Serie Completata</span>
                  </button>
                  <div class="flex justify-between mt-4 px-2">
                     <button onclick="app.handlers.skipExercise()" class="text-gray-400 text-sm hover:text-white">Salta Esercizio</button>
                     <button onclick="app.handlers.finishWorkoutEarly()" class="text-red-400 text-sm hover:text-red-300">Termina Workout</button>
                  </div>
               </div>
            </div>
			</div>
         </section>
         <!-- VIEW: STATISTICS -->
         <section id="view-stats" class="view-section p-4  pb-20">
           <div class="internal-section ">
		   
		   <!-- Tabs Navigation -->
<div class="flex gap-2 mb-6 bg-darkCard rounded-xl p-1">
   <button onclick="app.handlers.switchStatsTab('statistics')" 
      class="stats-tab flex-1 px-4 py-3 rounded-lg font-semibold transition-all" 
      data-tab="statistics">
      <i class="fa-solid fa-chart-line mr-2"></i>
      Statistiche
   </button>
   <button onclick="app.handlers.switchStatsTab('history')" 
      class="stats-tab flex-1 px-4 py-3 rounded-lg font-semibold transition-all" 
      data-tab="history">
      <i class="fa-solid fa-clock-rotate-left mr-2"></i>
      Storico
   </button>
</div>

<!-- Tab Content: Statistics -->
<div id="stats-tab-statistics" class="stats-tab-content space-y-6">
   <!-- Summary Card Calorie e Grasso -->
          
<div class="bg-darkCard rounded-3xl p-6 shadow-sm ">
   <div class="flex items-start gap-3 mb-3">
      
      <div class="flex-1">
         <h3 class="font-bold  mb-1">Cancella le tue Statistiche</h3>
         <p class="text-xs text-gray-400">
            Elimina tutto lo storico dei tuoi allenamenti, traguardi e le statistiche. <strong>I workout salvati rimarranno intatti</strong>.
         </p>
        
      </div>
   </div>
   <button onclick="app.handlers.resetStatistics()" class="w-full border border-red-500 text-red-500 py-2 rounded-lg text-sm font-semibold hover:bg-red-500/10 transition">
      <i class="fa-solid fa-chart-line-up-down"></i> Cancella Solo Statistiche
   </button>
</div>
            <!-- Charts Container -->
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Volume Settimanale (Kg)</h3>
               <canvas id="chart-volume" height="200"></canvas>
            </div>
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Calorie Bruciate (kcal)</h3>
               <canvas id="chart-calories" height="200"></canvas>
            </div>
            <div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm">
               <h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Allenamenti Mensili</h3>
               <canvas id="chart-consistency" height="200"></canvas>
            </div>
			
			
			
</div>

<!-- Tab Content: History -->
<div id="stats-tab-history" class="stats-tab-content space-y-6 hidden">
               <!-- History Log -->
            <div>
              
			  <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden mb-7">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
               <h3 class="text-sm opacity-90 uppercase tracking-wider font-semibold mb-4">Totale Storico</h3>
               <div class="grid grid-cols-2 gap-4">
                  <div>
                     <span id="total-calories" class="text-3xl font-bold block">0</span>
                     <span class="text-sm opacity-80"><i class="fa-solid fa-fire"></i> kcal Bruciate</span>
                  </div>
                  <div class="text-right">
                     <span id="total-fat-burned" class="text-3xl font-bold block">0</span>
                     <span class="text-sm opacity-80"><i class="fa-solid fa-weight-scale"></i> g di Grasso</span>
                  </div>
               </div>
               <div class="mt-3 pt-3 border-t border-white/20 text-xs opacity-75">
                  ~7.500 kcal = 1 kg di grasso corporeo
               </div>
            </div>
               <div id="history-list" class="space-y-3 text-sm">
                  <!-- Logs injected here -->
               </div>
            </div>
</div>
			
			
			
			



            

			
			
			</div>
         </section>
		 
		 <!-- VIEW: BADGES -->
<section id="view-badges" class="view-section p-4 space-y-6 pb-20">
  <div class="internal-section">
   
   <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden mb-7">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
      <div class="text-center">
         <i class="fa-solid fa-medal text-5xl mb-3 opacity-90"></i>
         <h3 class="text-lg font-bold">Sblocca i tuoi traguardi!</h3>
         <p class="text-sm opacity-90 mt-2">
            Completa allenamenti e raggiungi obiettivi per sbloccare badge esclusivi
         </p>
      </div>
   </div>
   
   <div id="badges-list" class="space-y-4">
      <!-- Injected by JS -->
   </div>
   </div>
</section>
		 
         <!-- VIEW: SETTINGS -->
         <section id="view-settings" class="view-section p-4 ">
		 <div class="internal-section space-y-6">
            <div class="bg-gradient-to-br from-primary via-purple-600 to-primaryDark  mb-4 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
   <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-12 -mb-12"></div>
      <div class="text-center">
         
         <h3 class="text-lg font-bold"><i class="fa-solid fa-gear text-5xl mb-3 opacity-90"></i><br/> Impostazioni</h3>
         <p class="text-sm opacity-90 mt-2">
            <i class="fa-regular fa-envelope"></i> Per infomazioni o collaborazioni inviami una email a: <a href="mailto:devcode8493@gmail.com">devcode8493@gmail.com</a>
         </p>
      </div>
   </div>
            <div class="bg-darkBg bg-darkCard rounded-xl overflow-hidden shadow-sm">
               <div class="bg-darkBg bg-darkCard rounded-xl overflow-hidden shadow-sm">
                  <h3 class="font-bold p-4 border-b border-gray-100 border-gray-700">Dati Personali
				  <p style="margin:0px; font-weight:normal;"><small>Inserisci qui i tuoi dati per ottimizzare i calcoli e statistiche</small></p>
				  </h3>
				   
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Peso corporeo (kg)</span>
                     <input type="number" id="setting-body-weight" step="0.1" class="bg-gray-100 bg-gray-800 rounded px-3 py-1 w-20 text-right" placeholder="70">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Altezza (cm)</span>
                     <input type="number" id="setting-height" class="bg-gray-100 bg-gray-800 rounded px-3 py-1 w-20 text-right" placeholder="175">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Et√† (anni)</span>
                     <input type="number" id="setting-age" class="bg-gray-100 bg-gray-800 rounded px-3 py-1 w-20 text-right" placeholder="30">
                  </div>
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Sesso</span>
                     <select id="setting-gender" class="bg-gray-100 bg-gray-800 rounded px-3 py-1">
                        <option value="">Non specificato</option>
                        <option value="male">Maschio</option>
                        <option value="female">Femmina</option>
                     </select>
                  </div>
                  <!-- Aggiungi dopo il campo sesso nelle impostazioni -->
                  <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                     <span>Livello di Allenamento</span>
                     <select id="setting-training-level" class="bg-gray-100 bg-gray-800 rounded px-3 py-1">
                        <option value="beginner">Principiante</option>
                        <option value="intermediate" selected>Intermedio</option>
                        <option value="advanced">Avanzato</option>
                        <option value="elite">Elite</option>
                     </select>
                  </div>
               </div>
               <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center" style="display:none;">
                  <span>Unit√† di peso</span>
                  <select id="setting-unit" class="bg-gray-100 bg-gray-800 rounded px-2 py-1">
                     <option value="kg">KG</option>
                     <option value="lb">LB</option>
                  </select>
               </div>
               <div class="p-4 border-b border-gray-100 border-gray-700 flex justify-between items-center">
                  <span>Suoni Timer</span>
                  <input type="checkbox" id="setting-sound" checked class="accent-primary w-5 h-5">
               </div>
               <div class="p-4 flex justify-between items-center">
                  <span>Vibrazione</span>
                  <input type="checkbox" id="setting-vibrate" checked class="accent-primary w-5 h-5">
               </div>
            </div>
            <div class="bg-darkBg bg-darkCard rounded-xl p-4 shadow-sm space-y-4">
               <h3 class="font-bold">Salva o importa dati personali </h3>
			   <p style="margin:0px;"><small>Salva qui tutte le tue informazioni salvate nell'app</small></p>
               <div class="grid grid-cols-2 gap-4">
                  <button onclick="app.handlers.exportData()" class="bg-primary text-white py-2 rounded-lg text-sm font-semibold hover:bg-blue-600">Esporta JSON</button>
                  <label class="bg-gray-700 text-white py-2 rounded-lg text-sm font-semibold hover:bg-gray-600 text-center cursor-pointer">
                  Importa JSON
                  <input type="file" onchange="app.handlers.importData(this)" class="hidden" accept=".json">
                  </label>
               </div>
               <button onclick="app.handlers.resetAllData()" class="w-full border border-red-500 text-red-500 py-2 rounded-lg text-sm font-semibold hover:bg-red-50">Cancellazione Totale</button>
            </div>
			</div>
         </section>
      </main>
      <!-- BOTTOM NAVIGATION -->
     <nav class="fixed bottom-0 left-0 right-0 bg-darkCard border-t border-gray-200 border-gray-800 flex justify-around items-center h-16 pb-safe z-20 transition-colors duration-300" style="-webkit-box-shadow: 0px 0px 50px 64px #111827;
    box-shadow: 0px 0px 50px 64px #111827;">
   <button onclick="app.router.go('dashboard')" class="nav-btn active flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-primary transition">
   <i class="fa-solid fa-house mb-1"></i>
   <span class="text-[10px] font-medium">Home</span> 
   </button>
   <button onclick="app.router.go('badges')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-primary transition">
   <i class="fa-solid fa-trophy mb-1"></i>
   <span class="text-[10px] font-medium">Traguardi</span>
   </button>
   <button onclick="app.router.go('stats')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-primary transition">
   <i class="fa-solid fa-chart-simple mb-1"></i>
   <span class="text-[10px] font-medium">Statistiche</span>
   </button>
   <button onclick="app.router.go('settings')" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-primary transition">
   <i class="fa-solid fa-gear mb-1"></i>
   <span class="text-[10px] font-medium">Impostazioni</span>
   </button>
   

</nav>
      <!-- Modal Template for Exercise Form -->
      <div id="exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-darkBg bg-darkCard rounded-2xl w-full max-w-sm p-6 space-y-4 shadow-2xl animate-fade-in-up">
           <h3 class="font-bold text-xl mb-2" id="modal-title">Aggiungi Esercizio</h3>
            <input type="text" id="modal-ex-name" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3 border-none focus:ring-2 focus:ring-primary" placeholder="Nome (es. Panca Piana)">
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="text-xs text-gray-500 ml-1">Serie</label>
                  <input type="number" id="modal-ex-sets" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 4">
               </div>
               <div>
                  <label class="text-xs text-gray-500 ml-1">Reps <i class="fa-regular fa-circle-question"></i></label>
                  <input type="text" id="modal-ex-reps"  class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 8-10">
				  
               </div>
            </div>
			<small style="line-height: 17px;
    margin-top: 14px;
    display: block;"><i class="fa-regular fa-circle-question"></i> Reps: puoi inserire anche una parola al posto di un numero, per esempio: maxreps</small>
            <div class="grid grid-cols-2 gap-4">
               <div>
                  <label class="text-xs text-gray-500 ml-1">Pausa</label>
                  <select id="modal-ex-rest" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3">
                     <option value="30">30 secondi</option>
                     <option value="60" selected>1 minuto</option>
                     <option value="90" >1:30 minuti</option>
                     <option value="120">2 minuti</option>
                     <option value="150">2:30 minuti</option>
                     <option value="180">3 minuti</option>
                     <option value="210">3:30 minuti</option>
                     <option value="240">4 minuti</option>
                     <option value="270">4:30 minuti</option>
                     <option value="300">5 minuti</option>
                     <option value="330">5:30 minuti</option>
                     <option value="360">6 minuti</option>
                     <option value="390">6:30 minuti</option>
                     <option value="420">7 minuti</option>
                  </select>
               </div>
               <div>
                  <label class="text-xs text-gray-500 ml-1">Peso Iniziale (Kg)</label>
                  <input type="number" id="modal-ex-weight" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3" placeholder="es. 15">
               </div>
            </div>
            <div class="flex items-center gap-2  bg-gray-800 p-3 rounded-lg">
               <input type="checkbox" id="modal-ex-double" class="accent-primary w-5 h-5">
               <label class="text-sm">Peso doppio (es. 2 manubri)<br/><small>(usato solo per statistiche per calcoli peso totale, il peso indicato verr√† moltiplicato x2)</small></label>
            </div>
            <div>
               <label class="text-xs text-gray-500 ml-1 block mb-1">Note (opzionale)</label>
               <textarea id="modal-ex-notes" rows="3" class="w-full bg-gray-100 bg-gray-800 rounded-lg p-3 border-none focus:ring-2 focus:ring-primary text-sm resize-none" placeholder="Es: ROM completo, pausa in basso..."></textarea>
            </div>

            <div class="flex gap-3 mt-4 pt-2">
               <button onclick="document.getElementById('exercise-modal').classList.add('hidden')" class="flex-1 py-3 text-gray-500 font-semibold">Annulla</button>
               <button onclick="app.handlers.confirmAddExercise()" class="flex-1 bg-primary text-white py-3 rounded-full font-bold hover:bg-primaryDark shadow-lg">Aggiungi</button>
            </div>
         </div>
      </div>
      <!-- Modal Workout Preview -->
      <div id="workout-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-gray-800 rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden shadow-2xl animate-fade-in-up" style="border: 3px solid #374151;">
            <div class="sticky top-0 bg-gray-900 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
               <h3 class="font-bold text-xl text-white">Panoramica Workout</h3>
               <button onclick="document.getElementById('workout-preview-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">
               <i class="fa-solid fa-xmark text-2xl"></i>
               </button>
            </div>
            <div id="workout-preview-content" class="p-6 space-y-3 overflow-y-auto max-h-[calc(80vh-80px)] text-white">
               <!-- Content injected by JS -->
            </div>
         </div>
      </div>
      <!-- AUDIO ELEMENTS -->
      <!-- <audio id="audio-beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio> -->
      <audio id="audio-beep" src="https://cdn.freesound.org/previews/22/22627_7037-lq.ogg" preload="auto"></audio>
      <audio id="audio-complete" src="https://cdn.freesound.org/previews/619/619839_7614679-lq.ogg" preload="auto"></audio>
      <audio id="audio-auto-next" src="https://cdn.freesound.org/previews/108/108897_7037-lq.ogg" preload="auto"></audio>
      <!-- LOGIC SCRIPT -->
      <script>
         /**
          * INDEXED DB WRAPPER
          * Helper class for raw IndexedDB operations to ensure data persistence without libraries.
          */
         class DB {
             constructor() {
                 this.dbName = 'FitTrackerDB';
                 this.version = 2;
                 this.db = null;
             }
         
             async connect() {
                 return new Promise((resolve, reject) => {
                     const request = indexedDB.open(this.dbName, this.version);
request.onupgradeneeded = (e) => {
    const db = e.target.result;
    if (!db.objectStoreNames.contains('workouts')) db.createObjectStore('workouts', { keyPath: 'id' });
    if (!db.objectStoreNames.contains('history')) db.createObjectStore('history', { keyPath: 'id' });
    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
    if (!db.objectStoreNames.contains('badges')) db.createObjectStore('badges', { keyPath: 'id' });
};
                     request.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
                     request.onerror = (e) => reject(e);
                 });
             }
         
             async getAll(storeName) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve) => {
                     const tx = this.db.transaction(storeName, 'readonly');
                     const store = tx.objectStore(storeName);
                     const request = store.getAll();
                     request.onsuccess = () => resolve(request.result);
                 });
             }
         
             async put(storeName, item) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve, reject) => {
                     const tx = this.db.transaction(storeName, 'readwrite');
                     const store = tx.objectStore(storeName);
                     const request = store.put(item);
                     request.onsuccess = () => resolve(request.result);
                     request.onerror = () => reject("Put error");
                 });
             }
         
             async delete(storeName, key) {
                 if(!this.db) await this.connect();
                 return new Promise((resolve) => {
                     const tx = this.db.transaction(storeName, 'readwrite');
                     tx.objectStore(storeName).delete(key);
                     tx.oncomplete = () => resolve();
                 });
             }
         
             async clearAll() {
                 if(!this.db) await this.connect();
                 const stores = ['workouts', 'history', 'settings'];
                 stores.forEach(name => {
                     const tx = this.db.transaction(name, 'readwrite');
                     tx.objectStore(name).clear();
                 });
             }
         }
         
         /**
          * APP LOGIC
          */
         const app = {
             db: new DB(),
             state: {
                 currentView: 'dashboard',
                 workouts: [],
                 history: [],
                 editingWorkout: null,
         editingExerciseIndex: null,
                 activeSession: null, // { workout, currentExIdx, currentSet, timer, status: 'work'|'rest' }
                 settings: { unit: 'kg', sound: true, vibrate: true, bodyWeight: null, height: null, age: null, gender: '', autoNext: false },
				 badges: {
    strike4: { count: 0, lastUnlocked: null, seen: false },
    kcal500: { count: 0, lastUnlocked: null, seen: false },
    kcal7200: { count: 0, lastUnlocked: null, seen: false },
    kg10000: { count: 0, lastUnlocked: null, seen: false },
    month16: { count: 0, lastUnlocked: null, seen: false },
    bench100: { count: 0, lastUnlocked: null, seen: false, oneTime: true }
},
badgeDefinitions: {
    strike4: {
        name: 'Strike 4 Allenamenti',
        desc: 'Quattro allenamenti questa settimana, zero scuse. Costanza attivata üìÖ',
        icon: 'https://rccremonesi-cmyk.github.io/workout/4x.png',
        repeatable: true
    },
    kcal500: {
        name: '500 kcal Workout',
        desc: 'Allenamento incendiario: 500 kcal bruciate! üî•',
        icon: 'https://rccremonesi-cmyk.github.io/workout/500k.png',
        repeatable: true
    },
    kcal7200: {
        name: '7200 kcal Totali',
        desc: 'Energia trasformata in risultati: 7200 kcal consumate, 1kg perso! üß±',
        icon: 'https://rccremonesi-cmyk.github.io/workout/7200k.png',
        repeatable: true
    },
    kg10000: {
        name: '10.000 kg Sollevati',
        desc: 'Forza pura: 10 tonnellate di ghisa! ü¶æ',
        icon: 'https://rccremonesi-cmyk.github.io/workout/10000kg.png',
        repeatable: true
    },
    month16: {
        name: '16 Allenamenti/Mese',
        desc: 'Un mese, sedici allenamenti. sei in pieno flow! ‚è≥',
        icon: 'https://rccremonesi-cmyk.github.io/workout/16x.png',
        repeatable: true
    },
    bench100: {
        name: 'Panca Piana 100kg',
        desc: 'Ora sei un vero uomo! üí™',
        icon: 'https://rccremonesi-cmyk.github.io/workout/100bench.png',
        repeatable: false
    }
},
pendingBadges: [],
    
    motivationalPhrases: [
        'Spacca tutto! üí™',
        'Fallo bene brother! üî•',
        'Non fare lo scoppiato! üí•',
        'Secco mai üò§',
        'Vai Uomooo! üí™',
        'Non mollare! ‚úä',
        'Beast mode! üêª',
        'Dai il tuo üíØ%!',
        'Focus totale üéØ',
        'Non vedi l\'ora di andare a casa a mangiare la pasta e fagioli! üçù',
        'Saitama te fa na pippa! üëä'
    ],
	preferredDays: []
},
       
             
             init: async () => {
                 await app.db.connect();
                 await app.loadData();
                 app.ui.applyTheme();
                 app.router.go('dashboard');
                 app.handlers.requestNotificationPermission();
             },
         
loadData: async () => {
    app.state.workouts = await app.db.getAll('workouts');
    app.state.history = await app.db.getAll('history');
    const savedSettings = await app.db.getAll('settings');
    if (savedSettings.length > 0) {
        savedSettings.forEach(s => app.state.settings[s.key] = s.value);
    }
    
    // Load badges
    const savedBadges = await app.db.getAll('badges');
    if (savedBadges.length > 0) {
        savedBadges.forEach(b => {
            if (app.state.badges[b.id]) {
                app.state.badges[b.id] = b.data;
            }
        });
    }
},
         
         
         
         calculateCalories: (session) => {
         const settings = app.state.settings;
         
         // 1. Recupero Dati Utente (con fallback robusti)
         const weight = parseFloat(settings.bodyWeight) || 75; 
         const height = parseFloat(settings.height) || 175;    
         const age = parseFloat(settings.age) || 30;           
         const gender = settings.gender || 'male';
         const trainingLevel = settings.trainingLevel || 'intermediate';
         
         // 2. Calcolo Volume Totale (kg alzati)
         let totalVolume = 0;
         if (session.logs && session.logs.length > 0) {
         session.logs.forEach(l => {
            const w = parseFloat(l.weight) || 0;
            const r = parseFloat(l.reps) || 0;
            const m = l.multiplier || 1;
            totalVolume += (w * r * m);
         });
         }
         
         // --- ALGORITMO CALORIE ---
         
         // A. BMR (Mifflin-St Jeor) - Mantenuto per contesto metabolico
         let bmr = 0;
         if (gender === 'male') {
         bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
         } else {
         bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
         }
         
         // B. Coefficiente Base per Lavoro Meccanico
         // Circa 0.04-0.05 kcal per kg spostato
         let caloriesPerKg = 0.045;
         
         // C. Aggiustamento per Metabolismo Individuale (basato su BMR)
         // Chi ha BMR pi√π alto tende a bruciare pi√π calorie anche durante l'esercizio
         const bmrFactor = bmr / 1600; // Normalizzato su BMR medio (~1600 kcal/day)
         caloriesPerKg *= (0.85 + (bmrFactor * 0.15)); // Range: 0.85x - 1.15x circa
         
         // D. APPLICAZIONE LIVELLI (efficienza neuromuscolare)
         switch (trainingLevel) {
         case 'beginner':
            // I principianti sono meno coordinati e bruciano circa il 15% in pi√π
            caloriesPerKg *= 1.15; 
            break;
         case 'intermediate':
            // Valore standard di riferimento
            caloriesPerKg *= 1.00; 
            break;
         case 'advanced':
            // Gli avanzati sono pi√π efficienti
            caloriesPerKg *= 0.92; 
            break;
         case 'elite':
            // Massima efficienza biomeccanica
            caloriesPerKg *= 0.85; 
            break;
         default:
            caloriesPerKg *= 1.00;
         }
         
         // E. Calcolo Finale
         const totalCalories = totalVolume * caloriesPerKg;
         
         console.log(`üìä CALORIE REPORT:
         ‚Ä¢ Level: ${trainingLevel}
         ‚Ä¢ BMR: ${Math.round(bmr)} kcal/day
         ‚Ä¢ Total Volume: ${totalVolume.toFixed(0)} kg
         ‚Ä¢ Cal/kg Rate: ${caloriesPerKg.toFixed(4)}
         üëâ TOTAL: ${Math.round(totalCalories)} kcal`);
         
         return Math.round(totalCalories);
         },
		 
		 checkBadges: async (session) => {
    const newBadges = [];
    
    // 1Ô∏è‚É£ Strike 4 workouts questa settimana
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    weekStart.setHours(0, 0, 0, 0);
    
    const thisWeekWorkouts = app.state.history.filter(h => new Date(h.date) >= weekStart);
    if (thisWeekWorkouts.length === 4 && !app.state.badges.strike4.seen) {
        newBadges.push('strike4');
        app.state.badges.strike4.count++;
        app.state.badges.strike4.lastUnlocked = new Date().toISOString();
        app.state.badges.strike4.seen = true;
    }
    
    // 2Ô∏è‚É£ 500 kcal in un workout
    const calories = session.caloriesBurned || 0;
    if (calories >= 500) {
        newBadges.push('kcal500');
        app.state.badges.kcal500.count++;
        app.state.badges.kcal500.lastUnlocked = new Date().toISOString();
    }
    
    // 3Ô∏è‚É£ 7200 kcal totali (cumulativo)
    const totalCal = app.state.history.reduce((acc, h) => acc + (parseFloat(h.caloriesBurned) || 0), 0);
    const kcal7200Milestone = Math.floor(totalCal / 7200);
    if (kcal7200Milestone > app.state.badges.kcal7200.count) {
        newBadges.push('kcal7200');
        app.state.badges.kcal7200.count = kcal7200Milestone;
        app.state.badges.kcal7200.lastUnlocked = new Date().toISOString();
    }
    
    // 4Ô∏è‚É£ 10.000 kg questa settimana
    const thisWeekVolume = thisWeekWorkouts.reduce((acc, h) => acc + (parseFloat(h.totalVolume) || 0), 0);
    if (thisWeekVolume >= 10000 && !app.state.badges.kg10000.seen) {
        newBadges.push('kg10000');
        app.state.badges.kg10000.count++;
        app.state.badges.kg10000.lastUnlocked = new Date().toISOString();
        app.state.badges.kg10000.seen = true;
    }
    
    // 5Ô∏è‚É£ 16 allenamenti questo mese
    const now = new Date();
    const thisMonthWorkouts = app.state.history.filter(h => {
        const d = new Date(h.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    if (thisMonthWorkouts.length === 16 && !app.state.badges.month16.seen) {
        newBadges.push('month16');
        app.state.badges.month16.count++;
        app.state.badges.month16.lastUnlocked = new Date().toISOString();
        app.state.badges.month16.seen = true;
    }
    
    // 6Ô∏è‚É£ Panca piana 100kg (one-time)
    if (app.state.badges.bench100.count === 0) {
        const hasBench = session.logs?.some(l => 
            l.exercise.toLowerCase().includes('panca piana') && parseFloat(l.weight) >= 100
        );
        if (hasBench) {
            newBadges.push('bench100');
            app.state.badges.bench100.count = 1;
            app.state.badges.bench100.lastUnlocked = new Date().toISOString();
        }
    }
    
    // Salva tutti i badge
    for (const key in app.state.badges) {
        await app.db.put('badges', { id: key, data: app.state.badges[key] });
    }
    
    // Aggiungi ai pending
    app.state.pendingBadges.push(...newBadges);
},

resetWeeklyBadges: async () => {
    // Reset seen flags per badge settimanali
    app.state.badges.strike4.seen = false;
    app.state.badges.kg10000.seen = false;
    await app.db.put('badges', { id: 'strike4', data: app.state.badges.strike4 });
    await app.db.put('badges', { id: 'kg10000', data: app.state.badges.kg10000 });
},

resetMonthlyBadges: async () => {
    app.state.badges.month16.seen = false;
    await app.db.put('badges', { id: 'month16', data: app.state.badges.month16 });
},
         
         
         
router: {
go: (viewId) => {
// ‚úÖ SCROLL TO TOP
const appContainer = document.getElementById('app-container');
if (appContainer) {
   appContainer.scrollTo({ top: 0, behavior: 'smooth' });
}

// Hide bottom nav if active workout
document.querySelector('nav').style.display = viewId === 'active' ? 'none' : 'flex';

// Nascondi header in workout attivo
document.querySelector('header').style.display = viewId === 'active' ? 'none' : 'grid';

document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
document.getElementById(`view-${viewId}`).classList.add('active');

document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-primary'));
if(viewId !== 'editor' && viewId !== 'active') {
   // Highlight nav
   const navIndices = {'dashboard': 0, 'badges': 1, 'stats': 2, 'settings': 3};
   document.querySelectorAll('.nav-btn')[navIndices[viewId]]?.classList.add('text-primary');
}

app.state.currentView = viewId;
if (viewId === 'dashboard') app.ui.renderDashboard();
if (viewId === 'badges') app.ui.renderBadges();
if (viewId === 'stats') app.ui.renderStats();
}
},
         
             ui: {
                 applyTheme: () => {
                    
                 },
                 
                 renderDashboard: () => {
                     const list = document.getElementById('workout-list');
                     list.innerHTML = '';
					 
					 if (app.state.pendingBadges.length > 0) {
							app.ui.showBadgeNotification();
						}
                     
                     // Monthly stats calculation
                     const now = new Date();
                     const thisMonthHistory = app.state.history.filter(h => {
                         const d = new Date(h.date);
                         return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                     });
                     
         let totalVol = 0;
         let totalCal = 0;
         thisMonthHistory.forEach(h => {
         const vol = parseFloat(h.totalVolume);
         if (!isNaN(vol)) totalVol += vol;
         const cal = parseFloat(h.caloriesBurned);
         if (!isNaN(cal)) totalCal += cal;
         });
         
         // Calcolo grammi di grasso: 1g grasso = 9 kcal, quindi 1kg = ~7500 kcal
         const fatBurnedGrams = Math.round((totalCal / 7500) * 1000);
         
         document.getElementById('monthly-workouts-count').innerText = thisMonthHistory.length;
         document.getElementById('monthly-volume').innerText = Math.round(totalVol).toLocaleString();
         document.getElementById('monthly-calories').innerText = Math.round(totalCal).toLocaleString();
         document.getElementById('monthly-fat-burned').innerText = fatBurnedGrams;
         
		 
		 // Today's Recommended Workouts
const today = new Date().getDay(); // 0=Dom, 1=Lun, etc.
const todayWorkouts = app.state.workouts.filter(w => 
    w.preferredDays && w.preferredDays.includes(today)
);

if (todayWorkouts.length > 0) {
    const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const now = new Date();
    const dateStr = `${dayNames[now.getDay()]} ${now.getDate()} ${monthNames[now.getMonth()]} ${now.getFullYear()}`;
    
    list.innerHTML += `
        <div class="mb-10">
            <h3 class=" p-3 rounded-xl shadow-sm font-bold text-lg mb-3   text-center">
                
				
                üìÖ Workout scelti per oggi:<br/> <div style="font-size:15px; font-weight:400;">${dateStr}</div>
            </h3>
            <div class="space-y-3">
                ${todayWorkouts.map(w => {
                    // Check if completed this week
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    
                    const completedThisWeek = app.state.history.find(h => 
                        h.workoutId === w.id && new Date(h.date) >= weekStart
                    );
                    
                    return `
                        <div class="bg-darkCard p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 border-primary">
                            <div onclick="app.handlers.openWorkoutEditor('${w.id}')" class="flex-1 cursor-pointer">
                                <h4 class="font-bold text-md">${w.name}</h4>
                                <p class="text-xs text-gray-500">${w.exercises.length} Esercizi</p>
                                ${completedThisWeek ? `
                                    <p class="text-xs text-purple-400 mt-1 flex items-center gap-1">
                                        <i class="fa-solid fa-check"></i>
                                        Lo hai completato ${new Date(completedThisWeek.date).toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric', month: 'short'})}
                                    </p>
                                ` : ''}
                            </div>
                            <button onclick="app.handlers.startWorkout('${w.id}')" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-primaryDark">
                                <i class="fa-solid fa-play ml-1"></i>
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        <h3 class="p-3 rounded-xl shadow-sm font-bold text-lg mb-3 flex items-center justify-center gap-2 text-center">üìÇ Tutti i tuoi Workout salvati</h3>
    `;
}
		 
                     // Render Workouts
					 list.innerHTML += `<h3 class="p-3 rounded-xl shadow-sm font-bold text-lg mb-3 flex items-center justify-center gap-2 text-center">üìÇ Tutti i tuoi Workout salvati</h3>`;
                     if (app.state.workouts.length === 0) {
                         list.innerHTML = `<div class="relative overflow-hidden bg-gradient-to-br from-darkCard to-gray-900 rounded-2xl shadow-xl p-8 border border-gray-800">
   <!-- Decorative elements -->
   <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl"></div>
   <div class="absolute bottom-0 left-0 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl"></div>
   
   <div class="relative z-10 text-center space-y-4">
      <!-- Icon -->
      <div class="inline-flex items-center justify-center w-20 h-20 bg-primary/20 rounded-full mb-2">
         <i class="fa-solid fa-dumbbell text-4xl text-primary animate-pulse"></i>
      </div>
      
      <!-- Title -->
      <h3 class="text-xl font-bold text-white">Inizia il tuo percorso!</h3>
      
      <!-- Description -->
      <p class="text-gray-400 max-w-sm mx-auto">
         Non hai ancora creato nessun workout.<br/>
         Crea il tuo primo allenamento e inizia a tracciare i tuoi progressi.
      </p>
      
      <!-- Settings reminder -->
      <div class="bg-primary/10 border border-primary/30 rounded-xl p-4 mt-6 cursor-pointer hover:bg-primary/20 transition-all" 
           onclick="app.router.go('settings')">
         <div class="flex items-start gap-3 text-left">
            <div class="bg-primary/20 rounded-lg p-2 flex-shrink-0">
               <i class="fa-solid fa-gear"></i>
            </div>
            <div class="flex-1">
               <h4 class="font-semibold text-white text-sm mb-1 flex items-center gap-2">
                  Prima di iniziare
                  <i class="fa-solid fa-arrow-right text-xs"></i>
               </h4>
               <p class="text-sm text-gray-400">
                  Configura peso, altezza ed et√† nelle <span class="text-primary font-semibold">Impostazioni</span> per monitorare calorie e progressi
               </p>
            </div>
         </div>
      </div>
   </div>
</div>`;
                         return;
                     }
         
                  app.state.workouts.forEach(w => {
    // Check if completed this week
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    weekStart.setHours(0, 0, 0, 0);
    
    const completedThisWeek = app.state.history.find(h => 
        h.workoutId === w.id && new Date(h.date) >= weekStart
    );
    
    const el = document.createElement('div');
    el.className = 'bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm flex justify-between items-center transform transition active:scale-98';
    el.innerHTML = `
        <div onclick="app.handlers.openWorkoutEditor('${w.id}')" class="flex-1 cursor-pointer">
            <h4 class="font-bold text-md">${w.name}</h4>
            <p class="text-xs text-gray-500">${w.exercises.length} Esercizi ‚Ä¢ ${w.exercises.reduce((acc,e) => acc+parseInt(e.rest),0)/60 | 0} min stimati</p>
            ${completedThisWeek ? `
                <p class="text-xs text-purple-400 mt-1 flex items-center gap-1">
                    <i class="fa-solid fa-check"></i>
                    Lo hai completato ${new Date(completedThisWeek.date).toLocaleDateString('it-IT', {weekday: 'short', day: 'numeric', month: 'short'})}
                </p>
            ` : ''}
        </div>
                             <button onclick="app.handlers.startWorkout('${w.id}')" class="bg-primary text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-primaryDark">
                                 <i class="fa-solid fa-play ml-1"></i>
                             </button>
                         `;
                         list.appendChild(el);
                     });
                 },
				 
	     renderEditorPreferredDays: () => {
    const container = document.getElementById('editor-preferred-days');
    const days = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const selected = app.state.editingWorkout.preferredDays || [];
    
    container.innerHTML = days.map((day, idx) => `
        <label class="flex flex-col items-center bg-gray-800 rounded-lg p-2 cursor-pointer hover:bg-gray-700 ${selected.includes(idx) ? 'ring-2 ring-primary' : ''}">
            <input type="checkbox" class="editor-day-check mb-1" value="${idx}" ${selected.includes(idx) ? 'checked' : ''}>
            <span class="text-xs">${day}</span>
        </label>
    `).join('');
    
    // Event listeners
    document.querySelectorAll('.editor-day-check').forEach(cb => {
        cb.addEventListener('change', () => {
            const checked = Array.from(document.querySelectorAll('.editor-day-check:checked')).map(c => parseInt(c.value));
            app.state.editingWorkout.preferredDays = checked;
        });
    });
},

showBadgeNotification: () => {
    const container = document.getElementById('badge-notification');
    if (!container || app.state.pendingBadges.length === 0) return;
    
    const badgeId = app.state.pendingBadges[0];
    const badge = app.state.badgeDefinitions[badgeId];
    
    container.innerHTML = `
        <div class="bg-gradient-to-r from-purple-600 to-primary rounded-2xl p-5 text-white shadow-2xl badge-appear relative">
            <button onclick="app.handlers.dismissBadge()" class="absolute top-3 right-3 text-white/80 hover:text-white">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <div class="flex items-center gap-4">
                <img src="${badge.icon}" alt="${badge.name}" class="w-20 h-20">
                <div class="flex-1">
                    <div class="text-sm opacity-90 uppercase tracking-wider font-semibold">üèÜ Traguardo Sbloccato!</div>
                    <h3 class="text-xl font-bold mt-1">${badge.name}</h3>
                    <p class="text-sm opacity-90 mt-1">${badge.desc}</p>
                </div>
            </div>
        </div>
    `;
    
    container.classList.remove('hidden');
    
    // Sound & Vibrate
    if (app.state.settings.sound) {
        document.getElementById('audio-complete').play().catch(e => {});
    }
    if (app.state.settings.vibrate && navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
},

renderBadges: () => {
    const container = document.getElementById('badges-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (const [id, def] of Object.entries(app.state.badgeDefinitions)) {
        const data = app.state.badges[id];
        const unlocked = data.count > 0;
        
        const badgeEl = document.createElement('div');
        badgeEl.className = `bg-darkCard rounded-2xl p-5 flex items-center gap-4 shadow-lg transition-all ${unlocked ? 'border-2 border-primary' : 'opacity-90'}`;
        
        badgeEl.innerHTML = `
            <div class="relative flex-shrink-0">
                <img src="${def.icon}" alt="${def.name}" class="w-20 rounded-xl ${unlocked ? 'shadow-lg' : 'badge-icon-locked'}">
                ${data.count > 1 ? `
                    <span class="absolute -top-2 -right-2 bg-gradient-to-br from-yellow-400 to-orange-500 text-white text-sm font-bold px-2.5 py-1 rounded-full shadow-lg border-2 border-white">
                        √ó${data.count}
                    </span>
                ` : ''}
                ${unlocked ? `
                    <div class="absolute -bottom-1 -right-1 bg-green-500 rounded-full p-1.5 border-2 border-darkCard">
                        <i class="fa-solid fa-check text-white text-xs"></i>
                    </div>
                ` : `
                    <div class="absolute -bottom-1 -right-1 bg-gray-700 rounded-full p-1.5 border-2 border-darkCard">
                        <i class="fa-solid fa-lock text-gray-500 text-xs"></i>
                    </div>
                `}
            </div>
            <div class="flex-1 min-w-0">
                <h4 class="font-bold text-lg ${unlocked ? 'text-white' : 'text-gray-500'} truncate">${def.name}</h4>
                <p class="text-sm ${unlocked ? 'text-gray-300' : 'text-gray-600'} mt-1 line-clamp-2">${def.desc}</p>
                ${unlocked && data.lastUnlocked ? `
                    <div class="flex items-center gap-1 mt-2 text-xs ">
                        <i class="fa-solid fa-calendar-check"></i>
                        <span>Ultimo: ${new Date(data.lastUnlocked).toLocaleDateString('it-IT', {day: 'numeric', month: 'short', year: 'numeric'})}</span>
                    </div>
                ` : `
                    <div class="flex items-center gap-1 mt-2 text-xs text-gray-600">
                        <i class="fa-solid fa-lock"></i>
                        <span>Non ancora sbloccato</span>
                    </div>
                `}
            </div>
        `;
        
        container.appendChild(badgeEl);
    }
},
         
         renderEditorExercises: () => {
         const container = document.getElementById('editor-exercises-list');
         container.innerHTML = '';
         
         app.state.editingWorkout.exercises.forEach((ex, idx) => {
         const el = document.createElement('div');
         el.className = ' bg-gray-800 p-3 rounded-lg flex justify-between items-center group touch-manipulation';
         el.innerHTML = `
<div class="flex items-center gap-3 flex-1 overflow-hidden">
<i class="fa-solid fa-grip-lines text-gray-400 cursor-move text-xl"></i>
<div class="truncate">
	<div class="font-bold truncate">${ex.name}</div>
	<div class="text-xs text-gray-500 truncate">${ex.sets} x ${ex.reps} ‚Ä¢ ${ex.rest}s${ex.isDouble ? ' ‚Ä¢ 2x' : ''}</div>
</div>
</div>
<div class="flex items-center gap-2">
<button onclick="app.handlers.editExercise(${idx})" class="bg-primary/20 text-white hover:bg-primary hover:text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-all active:scale-95 flex items-center gap-2 border border-primary/30">
	<i class="fa-solid fa-pen"></i>
	<span class="hidden sm:inline">Modifica</span>
</button>
<button onclick="app.handlers.removeExercise(${idx})" class="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-2.5 rounded-lg font-semibold text-sm transition-all active:scale-95 flex items-center gap-2 border border-red-500/30">
	<i class="fa-solid fa-times"></i>
	<span class="hidden sm:inline">Elimina</span>
</button>
</div>
`;
         container.appendChild(el);
         });
         
         // Init Sortable (rimane uguale)
         if (app.sortable) app.sortable.destroy();
         app.sortable = new Sortable(container, {
         animation: 150,
         handle: '.fa-grip-lines',
         ghostClass: 'sortable-ghost',
         onEnd: (evt) => {
         const item = app.state.editingWorkout.exercises.splice(evt.oldIndex, 1)[0];
         app.state.editingWorkout.exercises.splice(evt.newIndex, 0, item);
         }
         });
         },
         
                 updateActiveView: () => {
                     const session = app.state.activeSession;
                     if(!session) return;
                     
                     const ex = session.workout.exercises[session.currentExIdx];
                     
                     // Texts
                     document.getElementById('active-workout-name').innerText = session.workout.name;
                     document.getElementById('active-exercise-name').innerText = ex.name;
                     document.getElementById('active-set-display').innerText = `Serie ${session.currentSet + 1} / ${ex.sets}`;
                     document.getElementById('active-target-display').innerText = `${ex.reps} Reps`;
                     document.getElementById('active-weight-value').innerText = ex.lastWeight || 0;
                     
         // Progress Bar
         // Progress Bar
         const totalExercises = session.workout.exercises.length;
         const currentExercise = session.currentExIdx + 1;
         document.getElementById('active-exercise-count').innerText = `Esercizio: ${currentExercise}/${totalExercises}`;
         
         const totalSets = session.workout.exercises.reduce((acc, e) => acc + parseInt(e.sets), 0);
         const completedSets = session.workout.exercises.slice(0, session.currentExIdx).reduce((acc,e) => acc + parseInt(e.sets), 0) + session.currentSet;
         const pct = (completedSets / totalSets) * 100;
         document.getElementById('active-progress-bar').style.width = `${pct}%`;
         
         // Previous and Next Exercise Display
         const prevEl = document.getElementById('prev-exercise');
         const nextEl = document.getElementById('next-exercise');
         
         if (session.currentExIdx > 0) {
         const prevEx = session.workout.exercises[session.currentExIdx - 1];
         prevEl.innerHTML = `<i class="fa-solid fa-check text-green-500 mr-1"></i><span>${prevEx.name}</span>`;
         } else {
         prevEl.innerHTML = `<i class="fa-solid fa-check text-gray-700 mr-1"></i><span>Inizio</span>`;
         }
         
         if (session.currentExIdx < session.workout.exercises.length - 1) {
         const nextEx = session.workout.exercises[session.currentExIdx + 1];
         nextEl.innerHTML = `<span>${nextEx.name}</span><i class="fa-solid fa-arrow-right ml-1"></i>`;
         } else {
         nextEl.innerHTML = `<span>Fine!</span><i class="fa-solid fa-flag-checkered ml-1"></i>`;
         }
         
                     // Button State
                     const btn = document.getElementById('btn-main-action');
                     const restOverlay = document.getElementById('rest-overlay');
                     
         
         
         const workOverlay = document.getElementById('work-overlay'); // AGGIUNGI QUESTA RIGA
         
         if (session.status === 'rest') {
         btn.innerHTML = `<i class="fa-solid fa-forward"></i> <span>Salta Pausa</span>`;
         btn.classList.replace('bg-primary', 'bg-gray-600');
         btn.onclick = app.handlers.skipRest;
         restOverlay.classList.remove('hidden');
         restOverlay.classList.add('flex');
         workOverlay.classList.add('hidden');        // AGGIUNGI
         workOverlay.classList.remove('flex');       // AGGIUNGI
         } else {
         btn.innerHTML = `<i class="fa-solid fa-check"></i> <span>Serie Completata</span>`;
         btn.classList.replace('bg-gray-600', 'bg-primary');
         btn.onclick = app.handlers.completeSet;
         restOverlay.classList.add('hidden');
         restOverlay.classList.remove('flex');
         workOverlay.classList.remove('hidden');     // AGGIUNGI
         workOverlay.classList.add('flex');          // AGGIUNGI
         }
         
         // Update Footer Progress Bar (SINGOLO ESERCIZIO)
         // Update Footer Progress Bar (SINGOLO ESERCIZIO)
         const currentEx = session.workout.exercises[session.currentExIdx];
         const totalStepsInExercise = parseInt(currentEx.sets) * 2 - 1;
         let currentStep = session.currentSet * 2;
         if (session.status === 'rest') currentStep++;
         
         const progressPct = (currentStep / totalStepsInExercise) * 100;
         
         document.getElementById('footer-progress-fill').style.width = `${Math.min(progressPct, 100)}%`;
         
         // Render Step Markers
         const stepsContainer = document.getElementById('progress-steps');
         stepsContainer.innerHTML = '';
         for (let i = 0; i < parseInt(currentEx.sets); i++) {
         const stepPosition = (i / (parseInt(currentEx.sets) - 1)) * 100;
         const isPast = i < session.currentSet;
         const isCurrent = i === session.currentSet;
         
         const marker = document.createElement('div');
         marker.className = 'absolute transform -translate-x-1/2';
         marker.style.left = `${stepPosition}%`;
         marker.innerHTML = `
         <div class="w-3 h-3 rounded-full border-2 ${
            isPast ? 'bg-primary border-primary' : 
            isCurrent && session.status === 'work' ? 'bg-darkBg border-primary animate-pulse' :
            isCurrent && session.status === 'rest' ? 'bg-purple-500 border-purple-500 animate-pulse' :
            'bg-gray-700 border-gray-600'
         } shadow-lg"></div>
         `;
         stepsContainer.appendChild(marker);
         }
         
         // Testo dinamico
         let statusText = '';
         if (session.status === 'rest') {
         statusText = `Pausa ${session.currentSet + 1}/${currentEx.sets}`;
         } else {
         statusText = `Serie ${session.currentSet + 1}/${currentEx.sets}`;
         }
         document.getElementById('footer-progress-text').innerText = statusText;
         
         // Tempo rimanente per questo esercizio
         const remainingSetsEx = parseInt(currentEx.sets) - session.currentSet - 1;
         const restTime = parseInt(currentEx.rest);
         const estimatedSecondsEx = session.status === 'rest' 
         ? (remainingSetsEx * restTime) 
         : (remainingSetsEx * restTime + restTime);
         const estimatedMinutesEx = Math.ceil(estimatedSecondsEx / 60);
         
         if (estimatedMinutesEx > 0) {
         document.getElementById('footer-time-remaining').innerText = `~${estimatedMinutesEx} min questo esercizio`;
         } else if (session.status === 'rest') {
         document.getElementById('footer-time-remaining').innerText = 'Ultima pausa!';
         } else {
         document.getElementById('footer-time-remaining').innerText = 'Ultima serie!';
         }
		 
		 
    const notesContainer = document.getElementById('exercise-notes-container');
    const notesContent = document.getElementById('exercise-notes-content');
    
    if (ex.notes && ex.notes.trim()) {
        notesContainer.classList.remove('hidden');
        notesContent.innerHTML = ex.notes.replace(/\n/g, '<br>');
        notesContent.classList.add('hidden'); // Chiuso di default
        document.getElementById('notes-chevron').classList.replace('fa-chevron-up', 'fa-chevron-down');
    } else {
        notesContainer.classList.add('hidden');
    }
},
                 
                 renderStats: () => {
                     // Logic to build Chart.js
                     const history = app.state.history;
                     const ctxVol = document.getElementById('chart-volume').getContext('2d');
                     const ctxCon = document.getElementById('chart-consistency').getContext('2d');
         
                     if(window.chartVol) window.chartVol.destroy();
                     if(window.chartCon) window.chartCon.destroy();
         
                     // Data Prep
                     // Volume Last 7 Workouts
                     const lastLogs = history.slice(-7);
                     window.chartVol = new Chart(ctxVol, {
                         type: 'bar',
                         data: {
                             labels: lastLogs.map(l => new Date(l.date).toLocaleDateString(undefined, {weekday:'short'})),
                             datasets: [{ label: 'Volume (kg)', data: lastLogs.map(l => l.totalVolume), backgroundColor: '#5127f2', borderRadius: 4 }]
                         },
                         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
                     });
         
                     // Consistency (Last 12 months count)
                     // Simplified: Just workouts per month
                     const monthCounts = {};
                     history.forEach(h => {
                         const k = new Date(h.date).toLocaleDateString(undefined, {month:'short'});
                         monthCounts[k] = (monthCounts[k] || 0) + 1;
                     });
                     
                     window.chartCon = new Chart(ctxCon, {
                         type: 'line',
                         data: {
                             labels: Object.keys(monthCounts),
                             datasets: [{ label: 'Sessioni', data: Object.values(monthCounts), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }]
                         },
                         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: {stepSize: 1} } } }
                     });
         
         // Calories Chart
         
         const ctxCal = document.getElementById('chart-calories');
         if (!ctxCal) return; // Safety check
         const ctxCalContext = ctxCal.getContext('2d');
         if(window.chartCal) window.chartCal.destroy();
         
         const logsWithCalories = lastLogs.filter(l => l.caloriesBurned && l.caloriesBurned > 0);
         if (logsWithCalories.length > 0) {
         window.chartCal = new Chart(ctxCalContext, {
         type: 'line',
         data: {
             labels: logsWithCalories.map(l => new Date(l.date).toLocaleDateString(undefined, {weekday:'short'})),
             datasets: [{ 
                 label: 'Calorie', 
                 data: logsWithCalories.map(l => l.caloriesBurned), 
                 borderColor: '#f97316', 
                 backgroundColor: 'rgba(249, 115, 22, 0.1)',
                 tension: 0.4, 
                 fill: true 
             }]
         },
         options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
         });
         } else {
         // Show message if no calorie data
         const container = ctxCal.parentElement;
         container.innerHTML = '<div class="bg-darkBg bg-darkCard p-4 rounded-xl shadow-sm"><h3 class="font-semibold mb-4 text-sm text-gray-500 uppercase">Calorie Bruciate (kcal)</h3><p class="text-gray-400 text-center py-8 text-sm">üí° Imposta peso corporeo nelle impostazioni per vedere le calorie</p></div>';
         }
         
         // Calcolo totali storici
         let totalHistoricalCal = 0;
         history.forEach(h => {
         const cal = parseFloat(h.caloriesBurned);
         if (!isNaN(cal)) totalHistoricalCal += cal;
         });
         const totalFatGrams = Math.round((totalHistoricalCal / 7500) * 1000);
         
         document.getElementById('total-calories').innerText = Math.round(totalHistoricalCal).toLocaleString();
         document.getElementById('total-fat-burned').innerText = totalFatGrams.toLocaleString();
         
                     // List
                     const list = document.getElementById('history-list');
list.innerHTML = history.slice().reverse().slice(0, 10).map((h, index) => {
   const date = new Date(h.date);
   const isToday = date.toDateString() === new Date().toDateString();
   const isYesterday = date.toDateString() === new Date(Date.now() - 86400000).toDateString();
   
   let dateLabel;
   if (isToday) {
      dateLabel = 'üü¢ Oggi';
   } else if (isYesterday) {
      dateLabel = 'Ieri';
   } else {
      dateLabel = date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
   }
   
   const timeLabel = date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
   
   return `
      <div class="bg-darkCard rounded-xl p-4  ${isToday ? 'border-green-500' : 'border-primary'} shadow-sm hover:shadow-md transition-all">
         <!-- Header Row -->
         <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
             
               <div>
                  <h4 class="font-bold text-white">${h.workoutName}</h4>
                  <div class="flex items-center gap-2 text-xs text-gray-400 mt-0.5">
                     <i class="fa-regular fa-calendar"></i>
                     <span>${dateLabel}</span>
                     <span class="text-gray-600">‚Ä¢</span>
                     <i class="fa-regular fa-clock"></i>
                     <span>${timeLabel}</span>
                  </div>
               </div>
            </div>
            ${index === 0 ? '<span class="text-xs bg-primary/50 text-white/70 px-2 py-1 rounded-full font-semibold">Recente</span>' : ''}
         </div>
         
         <!-- Stats Row -->
         <div class="grid grid-cols-3 gap-3">
            <div class="bg-gray-900/50 rounded-lg p-2 text-center">
               <div class="text-xs text-gray-400 mb-1">Volume</div>
               <div class="font-bold  flex items-center justify-center gap-1">
                  <i class="fa-solid fa-weight-hanging text-xs"></i>
                  <span>${Math.round(h.totalVolume).toLocaleString()}</span>
                  <span class="text-xs">kg</span>
               </div>
            </div>
            
            ${h.caloriesBurned ? `
               <div class="bg-gray-900/50 rounded-lg p-2 text-center">
                  <div class="text-xs text-gray-400 mb-1">Calorie</div>
                  <div class="font-bold text-orange-500 flex items-center justify-center gap-1">
                     <i class="fa-solid fa-fire text-xs"></i>
                     <span>${Math.round(h.caloriesBurned).toLocaleString()}</span>
                  </div>
               </div>
            ` : `
               <div class="bg-gray-900/50 rounded-lg p-2 text-center opacity-50">
                  <div class="text-xs text-gray-400 mb-1">Calorie</div>
                  <div class="font-bold text-gray-600 text-xs">N/D</div>
               </div>
            `}
            
            <div class="bg-gray-900/50 rounded-lg p-2 text-center">
               <div class="text-xs text-gray-400 mb-1">Durata</div>
               <div class="font-bold text-blue-400 flex items-center justify-center gap-1">
                  <i class="fa-solid fa-stopwatch text-xs"></i>
                  <span>${h.durationMinutes || 0}</span>
                  <span class="text-xs">min</span>
               </div>
            </div>
         </div>
      </div>
   `;
}).join('');

 app.handlers.switchStatsTab('statistics');
                 }
             },
         
             handlers: {
                 // Editor Handlers
                 createNewWorkout: () => {
                     app.state.editingWorkout = {
                         id: 'w_' + Date.now(),
                         name: '',
                         exercises: [],
						  preferredDays: []
                     };
                     document.getElementById('editor-name').value = '';
                     document.getElementById('btn-delete-workout').classList.add('hidden');
                     app.ui.renderEditorExercises();
					 app.ui.renderEditorPreferredDays();
                     app.router.go('editor');
                 },
         
openWorkoutEditor: (id) => {
    const w = app.state.workouts.find(w => w.id === id);
    // Clone to avoid ref issues
    app.state.editingWorkout = JSON.parse(JSON.stringify(w));
    document.getElementById('editor-name').value = w.name;
    document.getElementById('btn-delete-workout').classList.remove('hidden');
    app.ui.renderEditorExercises();
    app.ui.renderEditorPreferredDays(); // ‚úÖ AGGIUNGI QUESTA RIGA
    app.router.go('editor');
},         
         
         // --- Sostituisci addExerciseToEditor ---
         addExerciseToEditor: () => {
         app.state.editingExerciseIndex = null; // Stiamo creando, non modificando
         
         // Reset form
         document.getElementById('modal-ex-name').value = '';
         document.getElementById('modal-ex-sets').value = '';
         document.getElementById('modal-ex-reps').value = '';
         document.getElementById('modal-ex-rest').value = '60';
         document.getElementById('modal-ex-weight').value = '';
         document.getElementById('modal-ex-double').checked = false;
         document.getElementById('modal-ex-notes').value = '';
         
         // Cambia testo bottone
         document.querySelector('#exercise-modal button.bg-primary').innerText = "Aggiungi";
         
         document.getElementById('exercise-modal').classList.remove('hidden');
         document.getElementById('modal-ex-name').focus();
         },
         
         // --- AGGIUNGI QUESTA NUOVA FUNZIONE ---
         editExercise: (idx) => {
         app.state.editingExerciseIndex = idx; // Salviamo l'indice che stiamo modificando
         const ex = app.state.editingWorkout.exercises[idx];
         
         // Popola il form con i dati esistenti
         document.getElementById('modal-ex-name').value = ex.name;
         document.getElementById('modal-ex-sets').value = ex.sets;
         document.getElementById('modal-ex-reps').value = ex.reps;
         document.getElementById('modal-ex-rest').value = ex.rest;
         document.getElementById('modal-ex-weight').value = ex.lastWeight || 0;
         document.getElementById('modal-ex-double').checked = ex.isDouble || false;
         document.getElementById('modal-ex-notes').value = ex.notes || '';
         
         // Cambia testo bottone per chiarezza
         document.querySelector('#exercise-modal button.bg-primary').innerText = "Salva Modifiche";
         
         document.getElementById('exercise-modal').classList.remove('hidden');
         },
         
         // --- Sostituisci confirmAddExercise ---
         confirmAddExercise: () => {
         const name = document.getElementById('modal-ex-name').value;
         if(!name) return;
         
         const exerciseData = {
         name,
         sets: document.getElementById('modal-ex-sets').value,
         reps: document.getElementById('modal-ex-reps').value,
         rest: document.getElementById('modal-ex-rest').value,
         lastWeight: document.getElementById('modal-ex-weight').value,
         isDouble: document.getElementById('modal-ex-double').checked,
         notes: document.getElementById('modal-ex-notes').value || ''
         };
         
         if (app.state.editingExerciseIndex !== null) {
         // MODIFICA ESISTENTE
         app.state.editingWorkout.exercises[app.state.editingExerciseIndex] = exerciseData;
         app.state.editingExerciseIndex = null; // Reset
         } else {
         // AGGIUNTA NUOVO
         app.state.editingWorkout.exercises.push(exerciseData);
         }
         
         document.getElementById('exercise-modal').classList.add('hidden');
         app.ui.renderEditorExercises();
         },
         
                 removeExercise: (idx) => {
                     if(confirm('Rimuovere esercizio?')) {
                         app.state.editingWorkout.exercises.splice(idx, 1);
                         app.ui.renderEditorExercises();
                     }
                 },
         
                 saveWorkout: async () => {
                     const name = document.getElementById('editor-name').value || 'Workout Senza Nome';
                     app.state.editingWorkout.name = name;
                     
                     // Save to DB
                     await app.db.put('workouts', app.state.editingWorkout);
                     
                     // Update Local State
                     await app.loadData();
                     app.router.go('dashboard');
                 },
         
                 deleteWorkout: async () => {
                     if(confirm('Sei sicuro di voler cancellare questo workout?')) {
                         await app.db.delete('workouts', app.state.editingWorkout.id);
                         await app.loadData();
                         app.router.go('dashboard');
                     }
                 },
         
                 // Execution Handlers
         startWorkout: (id) => {
         const w = app.state.workouts.find(w => w.id === id);
         app.state.activeSession = {
         workout: JSON.parse(JSON.stringify(w)), // Clone
         currentExIdx: 0,
         currentSet: 0,
         status: 'work',
         startTime: Date.now(),
         exerciseStartTime: Date.now(), // ‚ú® AGGIUNGI QUESTO
         logs: [] // Track actual reps/weight
         };
         app.router.go('active');
         
         // Delay per permettere il rendering prima di attivare animazioni
         setTimeout(() => {
         app.ui.updateActiveView();
         app.handlers.startTotalTimer();
         app.handlers.startExerciseTimer(); // ‚ú® AGGIUNGI QUESTO
		 app.handlers.setRandomMotivation();
         }, 250);
         },
         
// CERCA QUESTA FUNZIONE (circa riga 1040)
adjustWeight: (delta) => {
  const session = app.state.activeSession;
  const ex = session.workout.exercises[session.currentExIdx];
  let w = parseFloat(ex.lastWeight);
  if (isNaN(w)) w = 0;
  w += delta;
  if(w < 0) w = 0;
  ex.lastWeight = w;
  app.ui.updateActiveView();
  
  // ‚ú® AGGIUNGI QUI SE VUOI: (opzionale)
  // app.handlers.startExerciseTimer(); // Resetta il timer quando cambi peso
},
         
                 completeSet: () => {
                     const session = app.state.activeSession;
                     const ex = session.workout.exercises[session.currentExIdx];
                     
                     // Log the set
         const weight = parseFloat(ex.lastWeight);
         // Extract first number from reps string (e.g., "8-10" -> 8, "10" -> 10)
         const repsStr = String(ex.reps).split('-')[0].trim();
         const reps = parseFloat(repsStr);
         const multiplier = ex.isDouble ? 2 : 1;
         
         console.log('Completing set:', { exercise: ex.name, weight, reps, multiplier });
         
         session.logs.push({
         exercise: ex.name,
         weight: isNaN(weight) ? 0 : weight,
         reps: isNaN(reps) ? 0 : reps,
         multiplier: multiplier
         });
         
                     // Persist new weight to main DB so next time it's updated
                     // We do this by updating the base workout object
                     const baseWorkout = app.state.workouts.find(w => w.id === session.workout.id);
                     if(baseWorkout) {
                         baseWorkout.exercises[session.currentExIdx].lastWeight = ex.lastWeight;
                         app.db.put('workouts', baseWorkout);
                     }
         
                     // Check if exercise finished
                     if (session.currentSet < ex.sets - 1) {
                         // Start Rest
                         app.handlers.startExerciseTimer();
    // Start Rest
    app.handlers.startRest(ex.rest);
                     } else {
                         // Exercise Finished
                         if (session.currentExIdx < session.workout.exercises.length - 1) {
							  app.handlers.startExerciseTimer();
                             // Move to next exercise (with rest)
                             app.handlers.startRest(ex.rest, true);
                         } else {
                             // Workout Finished
                             app.handlers.finishWorkout();
                         }
                     }
					 
					 app.handlers.setRandomMotivation();
                 },
         
         startRest: (seconds, isNextExercise = false) => {
         const session = app.state.activeSession;
         session.status = 'rest';
         app.ui.updateActiveView();
         
         // ‚ú® CARICA STATO TOGGLE
         const autoNextCheckbox = document.getElementById('auto-next-toggle');
         if (autoNextCheckbox) {
         autoNextCheckbox.checked = app.state.settings.autoNext || false;
         }
         
         let timeLeft = parseInt(seconds);
         const timerEl = document.getElementById('rest-timer-text');
         const circle = document.getElementById('rest-timer-circle');
         
         const maxOffset = 452;
         circle.style.strokeDasharray = maxOffset;
         
         app.restInterval = setInterval(() => {
         timeLeft--;
         const mins = Math.floor(timeLeft / 60).toString().padStart(2, '0');
         const secs = (timeLeft % 60).toString().padStart(2, '0');
         timerEl.innerText = `${mins}:${secs}`;
         
         const offset = maxOffset - ((timeLeft / seconds) * maxOffset);
         circle.style.strokeDashoffset = offset;
         
         if (timeLeft <= 0) {
            clearInterval(app.restInterval);
         
         const restText = document.getElementById('rest-timer-text');
         restText.classList.add('rest-blink');
         
            
            // ‚ú® LOGICA AUTO-NEXT
            const isAutoNext = document.getElementById('auto-next-toggle')?.checked || false;
            
            if (isAutoNext) {
                // Suono dedicato per auto-next
                if(app.state.settings.sound) {
                    document.getElementById('audio-auto-next').play().catch(e=>{});
                }
                if(app.state.settings.vibrate && navigator.vibrate) {
                    navigator.vibrate([300, 100, 300]);
                }
                
                // Continua automaticamente dopo 1 secondo
                setTimeout(() => {
                    app.handlers.skipRest(null, isNextExercise);
					app.handlers.setRandomMotivation();
                }, 1000);
            } else {
                // Comportamento normale
                app.handlers.notify();
            }
         }
         }, 1000);
         },
         
// CERCA QUESTA FUNZIONE (circa riga 1100)
skipRest: (_, isNextExercise = false) => {
  if (app.restInterval) clearInterval(app.restInterval);
  const session = app.state.activeSession;
  
  const ex = session.workout.exercises[session.currentExIdx];
  
  if(session.currentSet < ex.sets - 1) {
    session.currentSet++;
  } else {
    session.currentExIdx++;
    session.currentSet = 0;
  }
  
  // ‚ú® SPOSTA QUI: Resetta il timer PRIMA di cambiare status
  app.handlers.startExerciseTimer();
  app.handlers.setRandomMotivation();
  
  session.status = 'work';
  app.ui.updateActiveView();
},
         
// CERCA QUESTA FUNZIONE (circa riga 1150)
skipExercise: () => {
  const session = app.state.activeSession;
  if (session.currentExIdx < session.workout.exercises.length - 1) {
    session.currentExIdx++;
    session.currentSet = 0;
    // ‚ú® AGGIUNGI QUI:
    app.handlers.startExerciseTimer();
    session.status = 'work';
    if (app.restInterval) clearInterval(app.restInterval);
    app.ui.updateActiveView();
  } else {
    app.handlers.finishWorkout();
  }
},
         
                 finishWorkoutEarly: () => {
                     if(confirm("Terminare l'allenamento ora?")) {
                         app.handlers.finishWorkout();
                     }
                 },
         
                 confirmExitWorkout: () => {
                     if(confirm("Vuoi uscire senza salvare?")) {
                         if (app.restInterval) clearInterval(app.restInterval);
                         if (app.totalTimerInt) clearInterval(app.totalTimerInt);
         if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);
                         app.router.go('dashboard');
                     }
                 },
         
                 finishWorkout: async () => {
                     if (app.restInterval) clearInterval(app.restInterval);
                     if (app.totalTimerInt) clearInterval(app.totalTimerInt);
         if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);
                     
                     document.getElementById('audio-complete').play().catch(e=>{});
                     if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
         
                     const session = app.state.activeSession;
                     
                     // Calc Stats
         const volume = session.logs.reduce((acc, l) => {
         const weight = parseFloat(l.weight);
         const reps = parseFloat(l.reps);
         const multiplier = l.multiplier || 1;
         if (!isNaN(weight) && !isNaN(reps)) {
         return acc + (weight * reps * multiplier);
         }
         return acc;
         }, 0);
         const duration = Math.round((Date.now() - session.startTime) / 1000 / 60);
         const calories = app.calculateCalories(session);
         
         const historyItem = {
         id: 'h_' + Date.now(),
         workoutId: session.workout.id,
         workoutName: session.workout.name,
         date: new Date().toISOString(),
         totalVolume: volume,
         durationMinutes: duration,
         caloriesBurned: calories,
         logs: session.logs
         };
         
                     await app.db.put('history', historyItem);
					 // Check badges
await app.checkBadges(historyItem);
                     await app.loadData(); // Reload history for dashboard
                     
                     const statsMsg = calories > 0 
         ? `Ottimo lavoro! Allenamento completato.\n\nüìä Stats:\n‚Ä¢ Volume: ${Math.round(volume)}kg\n‚Ä¢ Durata: ${duration} min\n‚Ä¢ Calorie: ~${calories} kcal`
         : `Ottimo lavoro! Allenamento completato.\n\nüìä Stats:\n‚Ä¢ Volume: ${Math.round(volume)}kg\n‚Ä¢ Durata: ${duration} min\n\nüí° Imposta peso corporeo nelle impostazioni per vedere le calorie bruciate!`;
         alert(statsMsg);
                     app.router.go('dashboard');
                 },
         
                 startTotalTimer: () => {
                     const start = Date.now();
                     const el = document.getElementById('active-timer-total');
                     app.totalTimerInt = setInterval(() => {
                         const diff = Math.floor((Date.now() - start) / 1000);
                         const m = Math.floor(diff / 60).toString().padStart(2, '0');
                         const s = (diff % 60).toString().padStart(2, '0');
                         el.innerText = `${m}:${s}`;
                     }, 1000);
                 },
         
// CERCA QUESTA FUNZIONE (circa riga 1300)
startExerciseTimer: () => {
  const session = app.state.activeSession;
  if (!session) return;

  // ‚ú® MODIFICA: Resetta SEMPRE il tempo di inizio esercizio
  session.exerciseStartTime = Date.now();

  const el = document.getElementById('exercise-timer');
  if (!el) return;

  // ‚ú® AGGIUNGI: Reset immediato del display
  el.innerText = '00:00';

  // Pulisci eventuale timer precedente
  if (app.exerciseTimerInt) clearInterval(app.exerciseTimerInt);

  app.exerciseTimerInt = setInterval(() => {
    if (!app.state.activeSession || app.state.activeSession.status === 'rest') {
      // ‚ú® MODIFICA: Durante il riposo, NON nascondere, ma mostra "00:00"
      el.innerText = '00:00';
      return;
    }

    const diff = Math.floor((Date.now() - session.exerciseStartTime) / 1000);
    const m = Math.floor(diff / 60).toString().padStart(2, '0');
    const s = (diff % 60).toString().padStart(2, '0');
    el.innerText = `${m}:${s}`;
  }, 1000);
},
         
                 // Notifications & Sounds
                 requestNotificationPermission: () => {
                     if ("Notification" in window && Notification.permission !== "granted") {
                         Notification.requestPermission();
                     }
                 },
         
                 notify: () => {
                     // Sound
                     if(app.state.settings.sound) {
                         document.getElementById('audio-beep').play().catch(e=>{});
                     }
                     // Vibrate
                     if(app.state.settings.vibrate && navigator.vibrate) {
                         navigator.vibrate([500]);
                     }
                     // Web Notification
                     if ("Notification" in window && Notification.permission === "granted") {
                         new Notification("Riposo Terminato!", { body: "Inizia la prossima serie." });
                     }
                 },
         showWorkoutPreview: () => {
         const session = app.state.activeSession;
         if (!session) return;
         
         const content = document.getElementById('workout-preview-content');
         content.innerHTML = session.workout.exercises.map((ex, idx) => {
         const isCurrent = idx === session.currentExIdx;
         const isPast = idx < session.currentExIdx;
         
         return `
         <div class="bg-gray-${isCurrent ? '700 border-2 border-primary' : isPast ? '900' : '800'} p-4 rounded-xl ${isPast ? 'opacity-60' : ''}">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    ${isPast ? '<i class="fa-solid fa-check text-green-500"></i>' : isCurrent ? '<i class="fa-solid fa-arrow-right text-primary"></i>' : '<i class="fa-solid fa-circle text-gray-600 text-xs"></i>'}
                    <span class="font-bold text-lg">${ex.name}</span>
                </div>
                ${isCurrent ? '<span class="text-xs bg-primary px-2 py-1 rounded-full" style="white-space: nowrap;">IN CORSO</span>' : ''}
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm mt-3">
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Serie</div>
                    <div class="font-bold">${ex.sets}</div>
                </div>
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Reps</div>
                    <div class="font-bold">${ex.reps}</div>
                </div>
                <div class="bg-gray-900 px-3 py-2 rounded-lg text-center">
                    <div class="text-gray-400 text-xs mb-1">Peso</div>
                    <div class="font-bold">${ex.lastWeight || 0}kg${ex.isDouble ? ' x2' : ''}</div>
                </div>
            </div>
            ${isCurrent ? `<div class="mt-2 text-xs font-semibold">Serie ${session.currentSet + 1}/${ex.sets}</div>` : ''}
         </div>
         `;
         }).join('');
		 
		

         
         document.getElementById('workout-preview-modal').classList.remove('hidden');
         },
                 
                 toggleSound: () => {
                     app.state.settings.sound = !app.state.settings.sound;
                     const icon = document.getElementById('sound-toggle').querySelector('i');
                     icon.className = app.state.settings.sound ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-xmark';
                 },
				 
				 setRandomMotivation: () => {
    const phrases = app.state.motivationalPhrases;
    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
    const el = document.getElementById('motivational-text');
    if (el) {
        el.innerText = randomPhrase;
    }
},


toggleNotes: () => {
    const content = document.getElementById('exercise-notes-content');
    const chevron = document.getElementById('notes-chevron');
    const scrollContainer = document.querySelector('#view-active > div.flex-1.overflow-y-auto');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
        
        // ‚ú® Scrolla in fondo dopo che il contenuto si √® espanso
        setTimeout(() => {
            if (scrollContainer) {
                scrollContainer.scrollTo({
                    top: scrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }, 100);
    } else {
        content.classList.add('hidden');
        chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
        
        // ‚ú® Torna in alto quando chiudi
        if (scrollContainer) {
            scrollContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }
},

dismissBadge: () => {
    app.state.pendingBadges.shift();
    document.getElementById('badge-notification').classList.add('hidden');
    
    // Show next badge if any
    if (app.state.pendingBadges.length > 0) {
        setTimeout(() => app.ui.showBadgeNotification(), 500);
    }
},
switchStatsTab: (tabName) => {
   // Update buttons
   document.querySelectorAll('.stats-tab').forEach(btn => {
      btn.classList.remove('active');
   });
   document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
   
   // Update content
   document.querySelectorAll('.stats-tab-content').forEach(content => {
      content.classList.add('hidden');
   });
   document.getElementById(`stats-tab-${tabName}`).classList.remove('hidden');
},
         
                 // Settings Handlers
                 resetAllData: async () => {
                     const confirmTxt = prompt("Scrivi 'DELETE' per cancellare tutti i dati permanentemente.");
                     if (confirmTxt === 'DELETE') {
                         await app.db.clearAll();
                         location.reload();
                     }
                 },
				 resetStatistics: async () => {
    const confirmTxt = prompt("Scrivi 'RESET' per cancellare SOLO lo storico allenamenti. I workout non verranno eliminati.");
    if (confirmTxt === 'RESET') {
        // Cancella solo la tabella history
        const tx = app.db.db.transaction('history', 'readwrite');
        await tx.objectStore('history').clear();
		
		// Reset anche i badge
        const txBadges = app.db.db.transaction('badges', 'readwrite');
        await txBadges.objectStore('badges').clear();
        
        // Reset state
        for (const key in app.state.badges) {
            app.state.badges[key] = { count: 0, lastUnlocked: null, seen: false };
            if (key === 'bench100') app.state.badges[key].oneTime = true;
        }
        
        // Ricarica i dati
        await app.loadData();
        
        // Aggiorna la vista
        app.ui.renderStats();
        
        alert('‚úÖ Statistiche cancellate! I tuoi workout sono al sicuro.');
    }
},
                 
         exportData: async () => {
         const settingsArray = await app.db.getAll('settings'); // AGGIUNTO
		 const badgesArray = await app.db.getAll('badges');
         const data = {
         workouts: app.state.workouts,
         history: app.state.history,
         settings: settingsArray,
		 badges: badgesArray
         };
         const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `fit_tracker_backup_${new Date().toISOString().slice(0,10)}.json`;
                     a.click();
                 },
         
                 importData: (input) => {
         const file = input.files[0];
         if(!file) return;
         const reader = new FileReader();
         reader.onload = async (e) => {
         try {
            const data = JSON.parse(e.target.result);
            if(data.workouts) {
                for (const w of data.workouts) await app.db.put('workouts', w);
            }
            if(data.history) {
                for (const h of data.history) await app.db.put('history', h);
            }
            // ‚úÖ AGGIUNGI QUESTE 3 RIGHE
            if(data.settings) {
                for (const s of data.settings) await app.db.put('settings', s);
            }
			if(data.badges) {
    for (const b of data.badges) await app.db.put('badges', b);
}
            alert("Importazione completata!");
            location.reload();
                         } catch(err) {
                             alert("Errore nel file JSON.");
                         }
                     };
                     reader.readAsText(file);
                 }
             }
         };
         
         
         
         
         // Personal Settings Listeners
         ['setting-body-weight', 'setting-height', 'setting-age', 'setting-gender', 'setting-training-level'].forEach(id => {
         const el = document.getElementById(id);
         const key = id.replace('setting-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
         
         // Load saved value
         if (app.state.settings[key]) {
         el.value = app.state.settings[key];
         }
         
         // Save on change
         el.addEventListener('change', () => {
         app.state.settings[key] = el.value;
         app.db.put('settings', { key: key, value: el.value });
         });
         });
         
         
         // Init App
         window.addEventListener('DOMContentLoaded', async () => {
         await app.init();
		 
		 const lastResetWeek = localStorage.getItem('lastResetWeek');
const lastResetMonth = localStorage.getItem('lastResetMonth');
const now = new Date();
const weekNum = Math.floor((now - new Date(now.getFullYear(), 0, 1)) / 604800000);
const monthKey = `${now.getFullYear()}-${now.getMonth()}`;

if (lastResetWeek !== String(weekNum)) {
    app.resetWeeklyBadges();
    localStorage.setItem('lastResetWeek', weekNum);
}

if (lastResetMonth !== monthKey) {
    app.resetMonthlyBadges();
    localStorage.setItem('lastResetMonth', monthKey);
}
         
         // Personal Settings Listeners (after init so settings are loaded)
         ['setting-body-weight', 'setting-height', 'setting-age', 'setting-gender'].forEach(id => {
         const el = document.getElementById(id);
         const key = id.replace('setting-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
         
         // Load saved value
         if (app.state.settings[key]) {
             el.value = app.state.settings[key];
         }
         
         // Save on change
         el.addEventListener('change', () => {
             app.state.settings[key] = el.value;
             app.db.put('settings', { key: key, value: el.value });
         });
         });
         
         document.addEventListener('change', (e) => {
         if (e.target.id === 'auto-next-toggle') {
         app.state.settings.autoNext = e.target.checked;
         app.db.put('settings', { key: 'autoNext', value: e.target.checked });
         }
         });
         
         });
         
      </script>
   </body>
</html>
